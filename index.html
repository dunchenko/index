<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="camera=(self), microphone=(), geolocation=(self)">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https://www.google-analytics.com; frame-src https://www.google.com/maps/; connect-src 'self' https://script.google.com/ https://script.googleusercontent.com/ https://www.google-analytics.com https://analytics.google.com https://api.ipify.org;">
    <meta name="description" content="Professional legal advocacy and notary services in Ontario. Specializing in Provincial Offences and Administrative Tribunals. Accessible, expert representation tailored to your needs.">
    <title>Hanna Dunchenko Paralegal Services | Ontario</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23ffffff%22>PS</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <!-- Schema.org (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LegalService",
      "name": "Hanna Dunchenko Paralegal Services",
      "image": "https://hannadunchenko.com/logo.png",
      "@id": "https://hannadunchenko.com",
      "url": "https://hannadunchenko.com",
      "telephone": "+14372396833",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Toronto",
        "addressRegion": "ON",
        "addressCountry": "CA"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": 43.6532,
        "longitude": -79.3832
      },
      "openingHoursSpecification": {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday"
        ],
        "opens": "10:00",
        "closes": "17:00"
      },
      "description": "Professional legal advocacy and notary services in Ontario. Specializing in Provincial Offences, LTB, and Traffic Ticket Defense. Expert representation in Toronto, Mississauga, and province-wide."
    }
    </script>
    
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMMKRZ3VBV"></script>
    <script>
        // --- Book Button Animation Logic ---
        const IS_LOW_END_DEVICE_FOR_JUMP = (
            (typeof navigator.hardwareConcurrency === 'number' && navigator.hardwareConcurrency > 0 && navigator.hardwareConcurrency <= 4) ||
            (typeof navigator.deviceMemory === 'number' && navigator.deviceMemory > 0 && navigator.deviceMemory <= 4)
        );

        function startBookBtnJumping(btnId, preloaderId) {
            const btn = document.getElementById(btnId);
            const preloader = document.getElementById(preloaderId);
            if (!btn) return;

            // Добавим CSS-анимацию подпрыгивания
            if (!document.getElementById('book-btn-jump-style')) {
                const style = document.createElement('style');
                style.id = 'book-btn-jump-style';
                style.innerHTML = `
                @keyframes bookBtnJump {
                    0% { transform: scale(1) translateY(0); }
                    10% { transform: scale(1.08, 0.92) translateY(-6px); }
                    20% { transform: scale(0.95, 1.05) translateY(-12px); }
                    30% { transform: scale(1.05, 0.95) translateY(-8px); }
                    40% { transform: scale(1, 1) translateY(0); }
                    100% { transform: scale(1, 1) translateY(0); }
                }
                .footer-book-btn.book-btn-jump {
                    animation: bookBtnJump 0.7s cubic-bezier(.36,1.56,.64,1) 1;
                }
                `;
                document.head.appendChild(style);
            }

            let jumpedOnce = false;
            function doJumpWithSparks() {
                if (btn.style.opacity === '1' && btn.style.pointerEvents !== 'none') {
                    btn.classList.add('book-btn-jump');
                    createSparks(btn);
                    setTimeout(() => btn.classList.remove('book-btn-jump'), 800);
                }
            }
            function scheduleJump() {
                const min = IS_LOW_END_DEVICE_FOR_JUMP ? 9000 : 5000;
                const max = IS_LOW_END_DEVICE_FOR_JUMP ? 18000 : 12000;
                const delay = Math.floor(Math.random() * (max - min + 1)) + min;
                setTimeout(() => {
                    if (!document.hidden) {
                        doJumpWithSparks();
                    }
                    scheduleJump();
                }, delay);
            }
            // Ждём исчезновения прелоадера и появления кнопки
            const observer = new MutationObserver(() => {
                if (preloader && preloader.style.opacity === '0' && btn.style.opacity === '1' && !jumpedOnce) {
                    jumpedOnce = true;
                    setTimeout(() => {
                        doJumpWithSparks(); // первый прыжок сразу с появлением
                        scheduleJump();
                    }, 400); // чуть быстрее, чтобы не было задержки
                }
            });
            if (preloader) {
                observer.observe(preloader, { attributes: true, attributeFilter: ['style'] });
            }
        }

        // Запуск для headerBookBtn и footerBookBtn
        document.addEventListener('DOMContentLoaded', function() {
            startBookBtnJumping('headerBookBtn', 'headerBookBtnPreloader');
            startBookBtnJumping('footerBookBtn', 'footerBookBtnPreloader');
        });
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ZMMKRZ3VBV');
    </script>
    <style>
                        /* Smooth fade-in for booking modal */
                        #bookingModal {
                            opacity: 0;
                            transform: translateY(40px) scale(0.98);
                            pointer-events: none;
                            transition: opacity 0.5s cubic-bezier(.4,1.6,.6,1), transform 0.5s cubic-bezier(.4,1.6,.6,1);
                        }
                        #bookingModal.modal--active {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                            pointer-events: auto;
                        }
                h1, h2, h3,
                .section-title,
                .header__content-header,
                .header__content-subheader,
                .faq__question,
                .modal__title,
                .modal__section-title {
                    font-family: 'Lato', sans-serif;
                    color: #fff;
                    font-weight: 800;
                    text-transform: uppercase;
                    letter-spacing: 1.5px;
                    margin-top: 0;
                    margin-bottom: 1.3rem;
                    line-height: 1.2;
                    text-align: left;
                }
                h1, .section-title, .modal__title {
                    font-size: clamp(1.7rem, 5vw, 2.2rem);
                }
                h2, .header__content-header {
                    font-size: clamp(1.3rem, 4vw, 1.7rem);
                }
                h3, .header__content-subheader, .faq__question, .modal__section-title {
                    font-size: clamp(1.05rem, 3vw, 1.25rem);
                    margin-bottom: 2rem; /* Increased spacing between question and answer */
                }
                p, .header__content-text, .faq__answer, .modal__text, .footer__hours, .footer__copyright {
                    font-family: 'Lato', sans-serif;
                    font-size: 1rem;
                    font-weight: 400;
                    color: rgba(255,255,255,0.92);
                    line-height: 1.6;
                    margin-bottom: 1.3rem;
                    text-align: left;
                    letter-spacing: 0.01em;
                }
                ul, ol {
                    margin-bottom: 2rem;
                }
                .header__content-block, .header__service-item, .contact-form, .footer {
                    margin-bottom: 2.5rem !important;
                }
                .footer-book-btn, .contact-form__submit-button {
                    font-size: 1rem;
                    font-weight: 600;
                    padding: 0.8rem 2rem;
                    border-radius: 2rem;
                    margin: 0 auto 2.5rem auto;
                    display: block;
                }
                @media (max-width: 700px) {
                    h1, .section-title, .modal__title { font-size: 1.2rem; }
                    h2, .header__content-header { font-size: 1.05rem; }
                    h3, .header__content-subheader, .faq__question, .modal__section-title { font-size: 0.97rem; }
                    p, .header__content-text, .faq__answer, .modal__text, .footer__hours, .footer__copyright {
                        font-size: 0.97rem;
                        text-align: left;
                    }
                    .footer-book-btn, .contact-form__submit-button { font-size: 0.97rem; padding: 0.7rem 1.2rem; }
                }
        /* Standard Scaling */
        html {
            font-size: 16px;
        }
        body {
            font-size: 1rem;
        }

        /* ------------------- CORE STYLES ------------------- */
        :root {
            --bg-dark: #bfa792;
            --text-white: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.15);
            --placeholder-color: rgba(255, 255, 255, 0.6);
            --accent-gold: #6B5B4A;
            --accent-hover: #8B6F5A;
            --input-bg: rgba(255, 255, 255, 0.05);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body, button, input, select, textarea {
            font-family: 'Lato', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes pulseText {
            0% { opacity: 0.4; }
            50% { opacity: 0.8; }
            100% { opacity: 0.4; }
        }

        .pulseText {
            animation: pulseText 2s infinite ease-in-out;
            font-weight: 800;
        }
        
        @keyframes blurReveal {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        body { 
            font-family: 'Lato', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-white); 
            line-height: 1.6; 
            min-height: 100vh;
            padding-bottom: 9.4rem; /* Space for bottom bar */
            animation: blurReveal 4s ease-out forwards;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Custom Scrollbar */
        html {
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: #5a3d2a transparent; /* thumb track */
        }
        body::-webkit-scrollbar {
            width: 0.5rem;
        }
        body::-webkit-scrollbar-track {
            background: transparent;
        }
        body::-webkit-scrollbar-thumb {
            background-color: #5a3d2a;
            border-radius: 0.6rem;
        }
        body::-webkit-scrollbar-thumb:hover {
            background-color: #6B5B4A;
        }
        ::-webkit-scrollbar-button { display: none; }

        /* Scroll Fade-in Animation */
        .fade-in-section {
            opacity: 1; /* Was 0 */
            transform: none; /* Was translateY(1.9rem) */
            transition: opacity 1s ease-out, transform 1s ease-out;
        }
        .fade-in-section.is-hidden {
            opacity: 0;
            transform: translateY(1.9rem);
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .blur-in-section {
            opacity: 0;
            filter: blur(1.3rem); /* 20px approx */
            transition: opacity 1.5s ease-out, filter 1.5s ease-out;
            transform: none !important; /* Disable slide-up */
        }
        .blur-in-section.is-visible {
            opacity: 1;
            filter: blur(0);
        }

        /* ------------------- BLOCKS ------------------- */

        /* Block: background */
        .background { 
            position: fixed; 
            inset: 0; 
            z-index: -1; 
            overflow: hidden; 
            background: #bfa792; 
        }

        .background__svg {
            width: 100%;
            height: 100%;
        }

        .background__stripe { 
            animation: anim-stripes 30s ease-in-out infinite; 
            will-change: transform; 
        }
        
        .background__stripe--delay-1 { animation-duration: 40s; animation-delay: -10s; }
        .background__stripe--delay-2 { animation-duration: 50s; animation-delay: -20s; }
        
        @keyframes anim-stripes {
            0%, 50%, 100% { transform: translate(0, 0) scaleX(1); }
            25% { transform: translate(2.5%, 1.5%) scaleX(1.06); }
            75% { transform: translate(-2.5%, -1.5%) scaleX(0.94); }
        }

        body.modal-is-open .background__stripe {
            animation-play-state: paused;
        }

        .background__stripes-overlay {
            mix-blend-mode: overlay;
        }
        
        /* Block: header */
        .header { 
            text-align: center; 
            padding: 2rem 1.3rem 2.5rem;
            max-width: 50rem;
            margin: 0 auto;
        }

        .header__title { 
            font-size: clamp(1.35rem, 5.2vw, 2.05rem); 
            font-weight: 800; 
            margin-bottom: 0.3rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .header__subtitle { 
            font-size: clamp(2rem, 10vw, 4.2rem); 
            font-weight: 800; 
            text-transform: uppercase;
            margin-bottom: 2rem;
            letter-spacing: -2px;
            line-height: 0.9;
        }

        .header__contact {
            margin: 0.3rem 0 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }

        .header__contact-label {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: 800;
            color: var(--text-white);
        }

        .header__phone-link { 
            font-size: clamp(1.5rem, 5vw, 2.3rem); 
            font-weight: 800; 
            color: #ffffff; 
            text-decoration: none; 
            transition: opacity 0.3s;
        }

        .header__phone-link:hover { opacity: 0.8; }

        /* Updated Header Content Styles */
        .header__content-block {
            margin: 3rem auto;
            text-align: left;
            max-width: 41rem;
            color: #ffffff;
            font-family: inherit;
        }

        .header__content-header {
            font-size: clamp(1.4rem, 5vw, 1.8rem);
            font-weight: 800;
            margin: 4rem 0 2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #ffffff;
            text-align: center;
        }

        .header__content-subheader {
            font-size: clamp(1.1rem, 3.5vw, 1.3rem);
            font-weight: 800;
            margin: 2rem 0 0.8rem;
            color: #ffffff;
            text-transform: uppercase;
        }

        .header__content-text {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 1.3rem;
            color: rgba(255,255,255,0.92);
            font-weight: 400;
            text-align: left;
            letter-spacing: 0.01em;
        }

        .header__content-text strong {
            color: #ffffff;
            font-weight: 800;
        }

        .header__description {
            --h1-fit-scale: 1;
            font-size: calc(clamp(1.05rem, 3.6vw, 1.35rem) * var(--h1-fit-scale));
            font-weight: 900;
            color: rgba(255, 255, 255, 0.92);
            margin: 0 auto 2.5rem;
            max-width: 41rem;
            line-height: 1.35;
            padding: 0 1.5rem;
            text-align: center;
            letter-spacing: 0.06em;
            font-family: 'Lato', sans-serif;
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
            align-items: center;
        }
        
        .header__description span {
            display: block;
            white-space: nowrap;
            text-wrap: nowrap;
            overflow-wrap: normal;
            word-break: keep-all;
        }

        .header__description br {
            display: none;
        }

        /* Block: layout-container */
        .layout-container { 
            max-width: 41rem; 
            margin: 0 auto 0; 
            padding: 0 1.2rem; 
        }
        
        /* Block: contact-form */
        .contact-form {
            width: 100%;
            background: transparent;
            border: none;
            padding: 0;
            box-shadow: none;
            border-radius: 0;
        }

        .contact-form__outside-title { 
            font-size: clamp(1.4rem, 5vw, 1.8rem); 
            margin-bottom: 2rem; 
            text-align: center; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            color: var(--text-white);
        }

        .contact-form__title { 
            display: none;
            font-size: clamp(1.4rem, 5vw, 1.8rem); 
            margin-bottom: 2rem; 
            text-align: center; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
        }

        .contact-form__group { 
            margin-bottom: 2rem; 
            position: relative; 
        }

        .contact-form__label-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 0.5rem; 
        }

        .contact-form__label { 
            font-weight: 800; 
            text-transform: uppercase; 
            font-size: 0.9rem; 
            letter-spacing: 1px; 
        }

        .contact-form__input, 
        .contact-form__textarea, 
        .contact-form__select { 
            width: 100%; 
            padding: 1rem; 
            background: var(--input-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: 0.8rem; 
            color: var(--text-white);
            font-size: 1rem; 
            outline: none; 
            transition: all 0.3s ease; 
            font-family: inherit; 
            -webkit-appearance: none;
            appearance: none;
            box-shadow: none; /* Remove iOS inner shadow */
            line-height: 1.3;
        }

        .contact-form__input,
        .contact-form__select,
        .custom-select__trigger {
            min-height: 3.3rem;
            height: 3.3rem;
            box-sizing: border-box;
        }

        .file-attach__btn {
            min-height: 5.25rem;
            height: 5.25rem;
            box-sizing: border-box;
        }

        .contact-form__input:focus, 
        .contact-form__textarea:focus, 
        .contact-form__input--has-content {
            background: #ffffff;
            color: #5a3d2a;
            caret-color: #5a3d2a;
            box-shadow: 0 2px 0.5rem rgba(0, 0, 0, 0.12);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .contact-form__input::placeholder, 
        .contact-form__textarea::placeholder { 
            color: var(--placeholder-color); 
        }
        
        .contact-form__input:focus::placeholder, 
        .contact-form__textarea:focus::placeholder { 
            color: transparent; 
        }

        .contact-form__textarea { 
            resize: none; 
            min-height: 7.9rem;
            overflow-y: hidden;
        }
        
        .contact-form__char-counter {
            font-size: 0.8rem;
            opacity: 0.6;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }

        .contact-form__group:has(.contact-form__textarea:focus) .contact-form__char-counter {
            color: var(--accent-hover);
            opacity: 0.9;
        }

        .contact-form__textarea-accessories {
            position: relative;
        }

        .contact-form__file-upload {
            position: absolute;
            bottom: 1.3rem;
            right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.3rem; 
            cursor: pointer;
            z-index: 2;
        }

        .contact-form__upload-icon {
            width: 1.5rem;
            height: 1.5rem;
            color: rgba(255, 255, 255, 0.5);
            stroke: currentColor;
            fill: none;
            transition: all 0.3s ease;
            display: block;
            stroke-width: 1.5;
            opacity: 0.7;
        }

        .contact-form__file-upload:hover { transform: scale(1.1); }
        .contact-form__file-upload:hover .contact-form__upload-icon { stroke: var(--text-white); }
        
        .contact-form__textarea:focus ~ .contact-form__textarea-accessories .contact-form__upload-icon,
        .contact-form__group:has(.contact-form__textarea:focus) .contact-form__upload-icon {
            stroke: var(--accent-hover);
        }

        .contact-form__checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .contact-form__checkbox {
            width: 1.8rem; height: 1.8rem;
            padding: 0;
            appearance: none; -webkit-appearance: none;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 0.5rem;
            cursor: pointer;
            display: grid; place-content: center;
            flex-shrink: 0;
        }

        .contact-form__checkbox:checked { 
            background: var(--accent-hover); 
            border-color: var(--accent-hover); 
        }
        
        .contact-form__checkbox:checked::before {
            content: ""; width: 0.4rem; height: 0.6rem; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); margin-top: -2px;
        }

        .contact-form__checkbox-label {
            font-size: 0.9rem;
            font-weight: 800;
            cursor: pointer;
        }
        
        .contact-form__terms-link {
            color: #ffffff;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.3s ease;
            font-weight: 800;
        }

        .contact-form__terms-link:hover { color: #D4B89A; }

        .contact-form__submit-button { 
            width: 100%;
            padding: 0.8rem 2rem;
            background: #5a3d2a;
            color: #ffffff;
            border: none;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto 2rem auto;
            position: relative;
            box-shadow: 0 2px 12px 0 rgba(90, 61, 42, 0.08);
        }

        #confirmBookingBtn {
            padding: 1.35rem 1rem;
            min-height: 4.4rem;
            line-height: 1.1;
            font-weight: 900;
            font-size: 1.08rem;
            background: #5a3d2a;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #confirmBookingBtn:hover {
            background: #4f3526 !important;
            transform: translateY(-1px);
        }

        #confirmBookingBtn:active {
            background: #563a2a !important;
            transform: translateY(0);
        }
        
        .contact-form__submit-button:hover { 
            transform: translateY(-2px); 
            background: var(--accent-gold); 
            box-shadow: 0 0.5rem 1.3rem rgba(0, 0, 0, 0.25); 
        }

        /* Shadow Removal for Buttons inside Modals */
        .modal .contact-form__submit-button,
        .modal .contact-form__submit-button:hover {
            box-shadow: none !important;
        }

        .contact-form__note {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.75;
            margin-top: 1rem;
        }

        /* Block: section-title */
        .section-title { 
            font-size: clamp(1.4rem, 5vw, 1.8rem); font-weight: 800; 
            text-transform: uppercase; letter-spacing: 2px; 
            text-align: center; 
            margin: 5rem 0 2.5rem;
        }
        
        /* Block: faq */
        .faq { margin-top: 0; }

        .faq__item {
            margin-bottom: 2rem;
            padding: 0;
            text-align: left; /* Align FAQ content to the left */
            position: relative;
        }


        .faq__question { 
            font-weight: 800; 
            font-size: clamp(1.05rem, 3.1vw, 1.24rem); 
            text-transform: uppercase; 
            display: flex; 
            align-items: flex-start; 
            gap: 1rem; 
            cursor: pointer;
            margin-bottom: 1rem;
            list-style: none;
            line-height: 1.35;
        }

        .faq__question::-webkit-details-marker { display: none; }
        .faq__question { list-style: none; }

        .faq__answer { 
            font-size: 1rem;
            color: rgba(255,255,255,0.92);
            padding-left: 0;
            padding-bottom: 0;
            line-height: 1.7;
            font-weight: 400;
            text-align: left;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem;
        }

        .faq--accordion .faq__question {
            margin-bottom: 0;
            padding: 0.55rem 0;
            user-select: none;
            will-change: transform, opacity;
        }

        .faq--accordion .faq__question::before {
            content: "";
            flex: 0 0 1.06em;
            width: 1.06em;
            height: 1.06em;
            border: 2px solid rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            margin-top: 0.22em;
            margin-left: -0.52rem;
            opacity: 0.95;
        }

        .faq--accordion .faq__question::after {
            content: "";
            margin-left: auto;
            margin-top: 0.4em;
            width: 0.62rem;
            height: 0.62rem;
            border-right: 2.2px solid rgba(255,255,255,0.9);
            border-bottom: 2.2px solid rgba(255,255,255,0.9);
            transform: rotate(45deg);
            transition: transform 0.45s ease, opacity 0.3s ease;
            opacity: 0.85;
        }

        .faq--accordion .faq__answer {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(0.9rem) scale(0.985);
            filter: blur(2px);
            margin-bottom: 0;
            padding-left: 1.65rem;
            transition: max-height 0.75s cubic-bezier(0.22, 0.9, 0.24, 1), opacity 0.5s ease, transform 0.65s ease, filter 0.65s ease;
            pointer-events: none;
        }

        .faq--accordion .faq__item.is-open .faq__question {
            animation: faqHypnoticOpen 0.8s ease forwards;
        }

        .faq--accordion .faq__item.is-open .faq__question::after {
            transform: rotate(225deg);
            opacity: 1;
        }

        .faq--accordion .faq__item.is-open .faq__answer {
            max-height: 120rem;
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: blur(0);
            margin-bottom: 1.15rem;
            pointer-events: auto;
        }

        @keyframes faqHypnoticOpen {
            0% {
                text-shadow: 0 0 0 rgba(255,255,255,0);
                transform: translateY(0.08rem);
                opacity: 0.92;
            }
            45% {
                text-shadow: 0 0 0.9rem rgba(255,255,255,0.34), 0 0 0.3rem rgba(255,255,255,0.18);
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                text-shadow: 0 0 0.45rem rgba(255,255,255,0.18);
                transform: translateY(0);
                opacity: 1;
            }
        }



        .price-note {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem;
            display: block;
            margin-top: 0;
        }


        /* Block: modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(0.3rem);
            -webkit-backdrop-filter: blur(0.3rem);
            z-index: 20000; /* Increased to be above top-bar */
            align-items: center;
            justify-content: center;
            padding: 0.6rem;
            /* Ensure it covers screen */
            inset: 0;
            overflow-y: auto; /* Changed to auto to prevent unnecessary scrollbar */
        }

        #termsModal {
            z-index: 20001;
        }

        #termsModal .modal__content {
            max-width: 50rem;
            background: #3a2a1a; /* Darker background for contrast */
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 1.3rem 3.1rem rgba(0,0,0,0.5);
        }

        #termsModal .modal__title {
            text-align: center;
            color: #D4B89A; /* Lighter gold for dark background */
            margin-bottom: 2rem;
            font-size: clamp(1.5rem, 6vw, 2.2rem);
        }
        
        #termsModal .modal__section-title {
            color: #ffffff;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        #termsModal .modal__text {
            color: rgba(255,255,255,0.92);
            text-align: left;
            margin-bottom: 1.3rem;
            line-height: 1.7;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.01em;
        }

        #termsModal .modal__footer-text {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            margin-top: 2.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 1.3rem;
            font-weight: 800;
        }

        /* When active, use Flexbox to center */
        .modal--active { 
            display: flex !important; 
            align-items: flex-start !important;
            justify-content: center !important;
            padding-top: 5vh;
            padding-bottom: 5vh;
        }

        .modal__content {
            background: var(--accent-gold);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 37.5rem;
            text-align: center; /* Symmetrically center content */
            box-sizing: border-box;            
            display: flex;
            flex-direction: column;
            
            position: relative;
            box-shadow: 0 1.9rem 5.6rem rgba(0, 0, 0, 0.7), 0 0 1.2rem rgba(255, 255, 255, 0.05);
            animation: modalScaleIn 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            
            /* Ensure it centers if flex alignment fails for some reason */
            margin: auto; /* Let flexbox handle centering perfectly */
        }

        @keyframes modalScaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal__close {
            position: absolute;
            top: 1.3rem;
            left: 1.3rem;
            right: auto;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-white);
            cursor: pointer;
            padding: 0;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
            z-index: 10;
        }

        .modal__close:hover { color: #D4B89A; }

        .modal__title {
            font-size: clamp(1.1rem, 4vw, 1.4rem);
            font-weight: 800;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        .modal__body {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem;
            padding: 0 0.3rem;
        }

        /* Sticky modal action area anchored to viewport bottom while modal body scrolls */
        .modal-sticky-actions {
            position: sticky;
            bottom: max(0.5rem, env(safe-area-inset-bottom));
            z-index: 25;
            padding-top: 0.5rem;
            padding-bottom: 0.1rem;
            margin-top: 0.9rem;
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        #bookingModal .modal-sticky-actions .contact-form__submit-button {
            margin: 0 !important;
        }

        #bookingModal .modal-sticky-actions .contact-form__checkbox-wrapper {
            margin-top: 0.7rem !important;
            margin-bottom: 0 !important;
            padding-bottom: 0.2rem;
        }

        .modal__section-title {
            font-size: 1.2rem;
            font-weight: 800;
            margin-top: 1.3rem;
            margin-bottom: 0.6rem;
            text-transform: uppercase;
        }
        
        .modal__text { 
            margin-bottom: 1.3rem; 
            color: rgba(255,255,255,0.92);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
        }

        /* Booking modal typography aligned with FAQ first Q/A style */
        #bookingModal,
        #bookingModal * {
            font-family: 'Lato', sans-serif !important;
        }

        #bookingModal .modal__title,
        #bookingModal .modal__title span {
            font-family: 'Lato', sans-serif !important;
            font-size: clamp(1rem, 3vw, 1.2rem) !important;
            font-weight: 800 !important;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            line-height: 1.4 !important;
            color: #ffffff;
        }

        #bookingModal .modal__body,
        #bookingModal .modal__body p,
        #bookingModal .contact-form__label,
        #bookingModal .contact-form__checkbox-label,
        #bookingModal .contact-form__terms-link,
        #bookingModal .file-attach__name,
        #bookingModal .file-attach__remove,
        #bookingModal .contact-form__input::placeholder,
        #bookingModal .contact-form__textarea::placeholder,
        #bookingModal #bookingStatus {
            font-family: 'Lato', sans-serif !important;
            font-size: 1.2rem !important;
            font-weight: 400 !important;
            color: rgba(255,255,255,0.92) !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em !important;
        }

        /* Occupation-like style for every editable control in booking modal */
        #bookingModal .contact-form__input,
        #bookingModal .contact-form__textarea,
        #bookingModal .custom-select__trigger,
        #bookingModal .file-attach__btn {
            font-family: 'Lato', sans-serif !important;
            font-size: 1rem !important;
            font-weight: 800 !important;
            line-height: 1.3 !important;
            letter-spacing: 0.01em !important;
        }

        #bookingModal .contact-form__input,
        #bookingModal .custom-select__trigger {
            min-height: 3.3rem !important;
            height: 3.3rem !important;
        }

        #bookingModal .file-attach__btn {
            min-height: 5.25rem !important;
            height: 5.25rem !important;
        }

        #bookingModal .custom-select__trigger {
            border: none !important;
            box-shadow: 0 4px 0 rgba(58, 42, 26, 0.35) !important;
        }

        #bookingModal .contact-form__input:focus,
        #bookingModal .contact-form__textarea:focus,
        #bookingModal .contact-form__input--has-content {
            background: #ffffff !important;
            color: #5a3d2a !important;
            -webkit-text-fill-color: #5a3d2a !important;
            caret-color: #5a3d2a !important;
        }

        #bookingModal .file-attach__btn:hover,
        #bookingModal .file-attach__btn:focus-visible {
            color: #5a3d2a !important;
        }

        /* Dropdown text must stay brown on white background */
        #bookingModal .custom-option {
            font-weight: 800 !important;
            color: rgba(80, 60, 40, 0.9) !important;
        }

        #bookingModal .file-attach__title,
        #bookingModal .file-attach__hint {
            font-weight: 800 !important;
        }

        #bookingModal .custom-option:hover,
        #bookingModal .custom-option.selected {
            color: #3a2a1a !important;
        }

        #bookingModal .custom-select.open .custom-select__trigger,
        #bookingModal .custom-select.open .custom-select__trigger span {
            color: #5a3d2a !important;
        }

        #bookingStatus {
            min-height: 1.5rem;
            margin: 0 0 1rem 0 !important;
            padding: 0;
            border-radius: 0.8rem;
            border: 1px solid transparent;
            background: transparent;
            color: #fff3f3 !important;
            font-size: 0.95rem !important;
            font-weight: 900 !important;
            line-height: 1.2 !important;
            letter-spacing: 0.02em !important;
            text-align: center;
            opacity: 0;
            transform: translateY(-3px);
            transition: opacity 0.18s ease, transform 0.18s ease;
            pointer-events: none;
        }

        #bookingStatus.status-alert--visible {
            padding: 0.55rem 0.9rem;
            border-color: rgba(255, 138, 138, 0.7);
            background: rgba(255, 82, 82, 0.18);
            opacity: 1;
            transform: translateY(0);
            animation: bookingStatusPulse 1.15s ease-in-out infinite;
        }

        @keyframes bookingStatusPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 90, 90, 0.0); }
            50% { box-shadow: 0 0 0 6px rgba(255, 90, 90, 0.16); }
        }

        .contact-form__input.field-invalid,
        .contact-form__textarea.field-invalid,
        .custom-select__trigger.field-invalid,
        .contact-form__checkbox-wrapper.field-invalid {
            animation: invalidFieldShake 0.34s cubic-bezier(0.36, 0.07, 0.19, 0.97);
            box-shadow: 0 0 0 2px rgba(255, 106, 106, 0.35), 0 0.8rem 1.8rem rgba(120, 20, 20, 0.2) !important;
        }

        @keyframes invalidFieldShake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-3px); }
            40%, 60% { transform: translateX(3px); }
        }

        .final-result-form {
            padding: 0.45rem 0.1rem 0.2rem;
            text-align: left;
        }

        .final-result-form__icon {
            color: var(--accent-gold);
            margin: 0 auto 0.95rem;
            position: relative;
            display: flex;
            width: 4.25rem;
            height: 4.25rem;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .final-result-form__hello {
            font-size: 1.12rem;
            font-weight: 900;
            margin: 0 0 0.7rem 0;
            text-align: left;
        }

        .final-result-form__lead {
            font-size: 1rem;
            line-height: 1.55;
            margin: 0 0 1rem 0;
            text-align: left;
        }

        .final-result-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.72rem;
            margin: 0 0 1rem 0;
        }

        .final-result-field {
            padding: 0.68rem 0.78rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.22);
            background: rgba(255, 255, 255, 0.08);
            min-height: 4.1rem;
        }

        .final-result-field--full {
            grid-column: 1 / -1;
        }

        .final-result-label {
            display: block;
            margin-bottom: 0.35rem;
            font-size: 0.76rem;
            font-weight: 900;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.8);
        }

        .final-result-value {
            font-size: 0.98rem;
            line-height: 1.45;
            color: #fff;
            word-break: break-word;
        }

        .final-result-warning {
            font-size: 0.94rem;
            line-height: 1.55;
            margin: 0 0 0.88rem 0;
            text-align: left;
            padding: 0.78rem 0.85rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.22);
            background: rgba(255, 255, 255, 0.09);
        }

        .final-result-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.1rem;
        }

        .final-result-call {
            width: 100%;
            margin: 0 !important;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 900 !important;
            letter-spacing: 0.02em;
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.2) !important;
        }

        .final-result-done {
            width: 100%;
            margin: 0 !important;
            background: rgba(255,255,255,0.16) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            color: #fff !important;
            font-weight: 800 !important;
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.16) !important;
        }

        #bookingModal .contact-form__submit-button.final-result-call,
        #bookingModal .contact-form__submit-button.final-result-call:hover {
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.2) !important;
        }

        #bookingModal .contact-form__submit-button.final-result-done,
        #bookingModal .contact-form__submit-button.final-result-done:hover {
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.16) !important;
        }

        @media (max-width: 650px) {
            .final-result-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .modal__highlight { font-weight: 800; color: #D4B89A; }
        
        .modal__footer-text {
            margin-top: 2rem; 
            padding-top: 1.3rem; 
            border-top: 1px solid rgba(255, 255, 255, 0.2); 
            font-size: 1.2rem; 
            color: #ffffff; 
            font-weight: 800;
        }

        /* Block: footer */
        .footer {
            text-align: center;
            padding: 5rem 1.3rem 1.3rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        .footer__container { margin-bottom: 3.1rem; }
        
        .footer__button {
            width: 100%;
            padding: 1.3rem;
            background: #5a3d2a;
            color: #ffffff;
            border: none;
            border-radius: 0.6rem; 
            font-weight: 800;
            font-size: 1.1rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 0.3rem 1rem rgba(0, 0, 0, 0.2);
            max-width: 20rem;
            margin: 0 auto;
        }

        .footer__button:hover {
             transform: translateY(-2px); 
             background: var(--accent-gold); 
             box-shadow: 0 0.5rem 1.3rem rgba(0, 0, 0, 0.25); 
        }

        .footer__contact-link {
            display: block;
            color: #ffffff; 
            font-size: clamp(1.4rem, 5vw, 1.8rem);
            font-weight: 800;
            text-decoration: none;
            margin: 2rem 0 0.6rem;
        }

        .footer__hours {
            font-size: 1rem;
            color: rgba(255,255,255,0.92);
            margin-bottom: 1.3rem;
            white-space: pre-line;
            line-height: 1.7;
            font-weight: 400;
            text-align: center;
            letter-spacing: 0.01em;
        }

        /* Block: map-container */
        .map-container {
            width: 100%; 
            height: 28rem; 
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHZpZXdCb3g9IjAgMCA4MDAgNDAwIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIj48cmVjdCB3aWR0aD0iODAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2UzZTNTzIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM1NTUiPk1hcCBMb2FkaW5nLi4uPC90ZXh0Pjwvc3ZnPg=='); 
            background-size: cover; 
            border-radius: 0.6rem; 
            overflow: hidden;
        }

        .map-container__iframe {
            border: 0;
            width: 100%;
            height: 100%;
        }


        /* ------------------- CUSTOM CALENDAR (Liquid Glass Design) ------------------- */
        .calendar-wrapper {
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 3rem;
            padding: clamp(1rem, 5vw, 2.5rem);
            margin-top: 0;
            position: relative; /* Added for loader overlay */
            opacity: 0;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .calendar-wrapper.calendar--loaded {
            opacity: 1;
        }
        .calendar-wrapper.calendar--loading {
            background: transparent !important;
            border: 0 !important;
            border-color: transparent !important;
            outline: 0 !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        .calendar-wrapper.calendar--loading #calendarLoaderOverlay {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border-radius: 0 !important;
        }
        .calendar-wrapper.calendar--loading .calendar-header,
        .calendar-wrapper.calendar--loading .calendar-grid,
        .calendar-wrapper.calendar--loading .slots-nav,
        .calendar-wrapper.calendar--loading .slots-block,
        .calendar-wrapper.calendar--loading .loading-separator {
            opacity: 0 !important;
            visibility: hidden;
            pointer-events: none;
        }
        .contact-form__outside-title.calendar-title--loading {
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        .slots-block {
            padding: 0;
            margin-top: 0;
            display: none;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            text-align: center;
            padding: 0 0.6rem;
        }

        .calendar-title {
            font-size: 2rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #ffffff;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            align-items: center;
        }

        /* "Wait..." Animation */
        .loading-text {
            font-size: 1.2rem;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 1px;
            animation: pulseText 1.5s infinite ease-in-out;
        }
        
        
        .calendar-title span { display: block; }
        .calendar-title .cal-month { font-size: clamp(3.4rem, 13vw, 6.8rem); font-weight: 900; line-height: 0.9; }
        .calendar-title .cal-selected-day {
            font-size: clamp(1.05rem, 4.5vw, 2rem);
            line-height: 1.02;
            font-weight: 900;
            white-space: nowrap;
        }
        .calendar-title .cal-year { font-size: clamp(1.35rem, 4.8vw, 2.3rem); opacity: 0.92; font-weight: 900; letter-spacing: 2px; margin-top: -0.15rem; }


        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent;
            color: #ffffff;
            width: 3rem;
            height: 3rem;
            min-width: 3rem;
            min-height: 3rem;
            flex: 0 0 3rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.55rem;
            line-height: 1;
            padding: 0;
            transition: all 0.3s ease;
            display: inline-grid;
            place-items: center;
            opacity: 0.7;
        }

        #prevBtn { text-indent: -1px; }
        #nextBtn { text-indent: 1px; }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            opacity: 1;
        }

        /* Calendar Loader Overlay */
        #calendarLoaderOverlay {
            position: absolute;
            inset: 0;
            background: rgba(191, 167, 146, 0.4);
            display: none;
            flex-direction: column; /* Added to support text below spinner */
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 3rem;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            gap: 15px; /* Space between spinner and text */
        }
        
        #calendarLoaderOverlay span {
            color: #ffffff;
            font-weight: 800;
            font-size: 0.9rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .cal-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: calSpin 0.8s linear infinite;
        }
        
        @keyframes calSpin {
            to { transform: rotate(360deg); }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: clamp(0.2rem, 1.5vw, 0.8rem);
            text-align: center;
        }

        .cal-day-name {
            font-weight: 800;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            line-height: 1.1;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Reverted to circular shape */
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.1); 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-size: 1rem;
            border: 1px solid transparent;
            font-weight: 800; /* Normal weight */
        }

        .cal-day:hover:not(.cal-day--empty):not(.cal-day--disabled):not(.cal-day--closed) {
            background: rgba(255, 255, 255, 0.25); /* Increased from 0.15 */
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .cal-day--disabled {
            opacity: 0.38 !important;
            cursor: default;
            pointer-events: none;
        }

        .cal-day--busy {
            opacity: 0.3 !important;
            cursor: default;
            pointer-events: none;
        }

        .cal-day--closed {
            opacity: 0.3 !important;
            cursor: pointer;
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.08);
            border-color: transparent;
        }

        .cal-day--closed:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: transparent;
            transform: none;
        }

        .cal-day--selected {
            background: #ffffff !important;
            color: #6B5B4A !important;
            font-weight: 800;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }

        @keyframes pulseActive {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(224, 112, 32, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 0.6rem rgba(224, 112, 32, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(224, 112, 32, 0); }
        }


        .cal-key {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.4rem;
            height: 1.4rem;
            margin-top: 0.1rem; /* Visual compensation to push it down slightly */
        }

        .cal-key svg {
            width: 100%;
            height: 100%;
        }

        @keyframes keyRotate {
            0% { transform: rotate(45deg); }
            100% { transform: rotate(405deg); }
        }


        
        
        .cal-day--today {
            border: 0.2rem solid #ffffff; /* Reverted from 0.35rem */
            box-shadow: 0 0 0.5rem rgba(255, 255, 255, 0.4) !important;
            opacity: 1 !important;
        }

        .cal-day--has-slots {
            background: rgba(255, 255, 255, 0.2);
            opacity: 1 !important;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Slots Section */
        .slots-container {
            margin-top: 0;
            margin-bottom: 0.3rem;
            padding-top: 0;
            display: block;
            position: relative;
        }

        /* Loading Progress Bar Separator */
        .loading-separator {
            position: absolute;
            top: 0;
            left: 10%; /* Centered at 80% width */
            width: 80%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1); 
            overflow: hidden;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.5s ease;
            
            -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
            mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
        }

        .loading-separator--active {
            opacity: 1;
        }

        /* Animated bar */
        .loading-separator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #ffffff, transparent);
            box-shadow: 0 0 1rem rgba(255, 255, 255, 1);
            opacity: 0; /* Hidden by default */
            transition: opacity 0.8s ease-out; /* Smooth fade out */
            
            animation: loadingScan 1.5s infinite linear;
        }

        .loading-separator--active::after {
            opacity: 1;
        }

        @keyframes loadingScan {
            0% { transform: translateX(-100%); }
            15% { transform: translateX(200%); } /* Quick scan */
            100% { transform: translateX(200%); } /* Wait */
        }

        .loading-separator::after {
            animation: loadingScan 10s infinite linear; /* Run every 10s */
        }

        .slots-title {
            font-size: 1.4rem; /* Increased from 1.1rem */
            font-weight: 800; /* Increased from 600 */
            margin-bottom: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 1px;
            display: none; /* Hidden by default */
            animation: fadeTitle 0.5s ease forwards;
        }

        .cal-cta {
            font-size: 1.4rem; /* Increased from 1.1rem */
            font-weight: 800; /* Increased from 600 */
            margin-bottom: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 1px;
            display: none; /* Hidden by default */
        }

        @keyframes fadeTitle { from { opacity: 0; transform: translateY(0.6rem); } to { opacity: 1; transform: translateY(0); } }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem; 
            margin-top: 0.2rem;
        }

        .slots-grid .slot-btn {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0.5rem 1rem;
            height: clamp(3.8rem, 10vw, 4.7rem);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 2.5rem;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            font-family: 'Lato', sans-serif !important;
            backdrop-filter: blur(0.6rem);
            -webkit-backdrop-filter: blur(0.6rem);
            gap: 1rem;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
            width: 100%;
            position: relative;
            overflow: hidden;
            isolation: isolate;
            transform: translateZ(0);
        }

        .slot-btn--hypnotic {
            border-color: rgba(255, 255, 255, 0.22);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.18),
                0 8px 18px rgba(64, 44, 26, 0.12);
            animation:
                slotRevealRise 560ms cubic-bezier(0.18, 0.88, 0.25, 1) both,
                slotBreathFloat 4.3s ease-in-out infinite;
            animation-delay:
                calc(var(--slot-idx, 0) * 55ms),
                calc(700ms + var(--slot-idx, 0) * 130ms);
        }

        .slot-btn--hypnotic::before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background: linear-gradient(
                120deg,
                rgba(255, 255, 255, 0) 12%,
                rgba(255, 255, 255, 0.08) 36%,
                rgba(255, 255, 255, 0.58) 50%,
                rgba(255, 255, 255, 0.08) 64%,
                rgba(255, 255, 255, 0) 88%
            );
            transform: translateX(-165%);
            opacity: 0.95;
            pointer-events: none;
            z-index: 0;
            animation: slotShimmerSweep 5.6s ease-in-out infinite;
            animation-delay: calc(850ms + var(--slot-idx, 0) * 130ms);
        }

        .slot-btn--hypnotic::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            z-index: 0;
            opacity: 0.78;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18);
            animation: slotHaloPulse 3.6s ease-in-out infinite;
            animation-delay: calc(var(--slot-idx, 0) * 90ms);
        }

        .slot-btn--hypnotic > * {
            position: relative;
            z-index: 1;
        }

        .slot-btn--hypnotic .slot-icon-wrapper {
            animation: slotIconSway 4.8s ease-in-out infinite;
            animation-delay: calc(650ms + var(--slot-idx, 0) * 110ms);
            will-change: transform;
        }

        .slot-btn--hypnotic:hover,
        .slot-btn--hypnotic:focus-visible {
            background: rgba(255, 255, 255, 0.16);
            border-color: rgba(255, 255, 255, 0.42);
            transform: translateY(-3px) scale(1.015);
            animation-play-state: paused;
            box-shadow:
                0 12px 24px rgba(63, 43, 24, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        .slot-btn--hypnotic:hover::after,
        .slot-btn--hypnotic:focus-visible::after {
            box-shadow:
                inset 0 0 0 1px rgba(255, 255, 255, 0.5),
                0 0 0 6px rgba(255, 255, 255, 0.07);
        }

        @keyframes slotRevealRise {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.96);
                filter: blur(2px);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        @keyframes slotBreathFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        @keyframes slotShimmerSweep {
            0%, 74%, 100% {
                transform: translateX(-165%);
                opacity: 0;
            }
            10% {
                opacity: 0.82;
            }
            36% {
                transform: translateX(165%);
                opacity: 0.82;
            }
            46% {
                opacity: 0;
            }
        }

        @keyframes slotHaloPulse {
            0%, 100% {
                box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15), 0 0 0 0 rgba(255,255,255,0);
            }
            50% {
                box-shadow: inset 0 0 0 1px rgba(255,255,255,0.35), 0 0 0 4px rgba(255,255,255,0.05);
            }
        }

        @keyframes slotIconSway {
            0%, 100% {
                transform: translateY(0) rotate(0deg) scale(1);
            }
            25% {
                transform: translateY(-1px) rotate(4deg) scale(1.02);
            }
            75% {
                transform: translateY(1px) rotate(-4deg) scale(0.98);
            }
        }

        .slot-btn > div, .slot-btn > span {
            flex-grow: 0 !important;
            flex-shrink: 0 !important;
        }


        .slot-icon-wrapper {
            width: 2.5rem;
            height: 2.5rem;
            flex-shrink: 0;
        }

        .slot-icon-wrapper svg {
            width: 100% !important;
            height: 100% !important;
        }

        .slot-time {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            font-weight: 800;
            letter-spacing: 1px;
            text-align: center;
        }


        .slot-btn:hover::after { opacity: 1; }


        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(0.9rem); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes constantGlow {
            0% { 
                background: rgba(255, 255, 255, 0.25); 
                box-shadow: 0 0 1rem rgba(255, 255, 255, 0.3);
                border-color: rgba(255, 255, 255, 0.5);
            }
            50% { 
                background: rgba(255, 255, 255, 0.15); 
                box-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.25);
            }
        }


        @keyframes rotateIcon {
            0% { transform: rotate(0deg); }
            30% { transform: rotate(360deg); }
            100% { transform: rotate(360deg); }
        }

        .slot-icon-wrapper {
            display: inline-block;
            line-height: 0;
        }

        .clock-hand {
            transform-origin: 50% 50%;
            transform: rotate(var(--start));
        }

        .slot-btn--clicked .clock-hand {
            animation: none;
        }

        @keyframes handSweepClick {
            to { transform: rotate(var(--end)); }
        }

        @keyframes handRotateContinuous {
            from { transform: rotate(var(--start)); }
            to { transform: rotate(calc(var(--start) + 360deg)); }
        }

        .slot-btn:hover:not(.slot-btn--clicked) .minute-hand {
            animation: none;
        }
        .slot-btn:hover:not(.slot-btn--clicked) .hour-hand {
            animation: none;
        }

        .slot-btn--clicked {
            animation: slotClickBurst 0.55s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
            pointer-events: none;
        }

        .slot-btn--clicked::before,
        .slot-btn--clicked::after {
            animation: none !important;
            opacity: 0.2;
        }

        @keyframes slotClickBurst {
            0% {
                transform: translateY(0) scale(1);
                filter: saturate(1);
            }
            35% {
                transform: translateY(-2px) scale(1.04);
                filter: saturate(1.2);
            }
            100% {
                transform: translateY(0) scale(0.985);
                filter: saturate(1);
            }
        }

        @keyframes btnClickScale {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }


        /* Breathing Glow Animation */
        @keyframes breathingGlow {
            0% { 
                text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); 
                opacity: 0.6; 
            }
            50% { 
                text-shadow: 0 0 1.3rem rgba(255, 255, 255, 0.8), 0 0 0.6rem rgba(255, 255, 255, 0.6); 
                opacity: 1; 
                color: #fff; 
            }
            100% { 
                text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); 
                opacity: 0.6; 
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .slot-btn--hypnotic,
            .slot-btn--hypnotic::before,
            .slot-btn--hypnotic::after,
            .slot-btn--hypnotic .slot-icon-wrapper {
                animation: none !important;
            }

            .slots-grid .slot-btn {
                transition: none !important;
            }
        }

        /* Loader */
        .calendar-loader {
            text-align: center;
            padding: 3.1rem;
            font-weight: 800;
            color: rgba(255,255,255,0.6);
            display: none;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: breathingGlow 2s infinite ease-in-out;
        }
        /* Modal Specific Input Styles */
        .modal .contact-form__input,
        .modal .contact-form__textarea {
            text-align: left; /* Left align on all devices */
        }
        .modal .contact-form__input::placeholder,
        .modal .contact-form__textarea::placeholder {
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: left;
        }



        /* Next Available Message */
        .next-available-msg {
            text-align: center;
            margin-top: 1.3rem;
            font-size: 1rem;
            color: #fff;
            font-weight: 800;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .next-available-msg--visible { opacity: 1; }

        /* File Attachment Styles */
        .file-attach {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 0.3rem;
            width: 100%;
        }

        .file-attach__controls {
            width: 100%;
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            gap: 0.7rem;
            align-items: stretch;
        }

        .file-attach__btn {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.35rem;
            width: 100%;
            padding: 1rem;
            background: var(--input-bg);
            border: 2px dashed rgba(255, 255, 255, 0.65);
            border-radius: 0.8rem;
            color: var(--placeholder-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 800;
            line-height: 1.3;
            text-align: center;
        }

        .file-attach__btn--camera {
            border-style: solid;
            border-width: 2px;
            border-color: rgba(255, 255, 255, 0.42);
            background: rgba(255, 255, 255, 0.1);
            width: 5.25rem;
            min-width: 5.25rem;
            height: 5.25rem;
            min-height: 5.25rem;
            padding: 0.5rem;
            gap: 0.2rem;
            flex-direction: column;
        }

        .file-attach__btn--camera .file-attach__hint {
            display: none;
        }

        .file-attach__btn--camera .file-attach__title {
            font-size: 0;
            letter-spacing: 0;
            text-transform: none;
            gap: 0;
            margin: 0;
            line-height: 1;
        }

        .file-attach__btn--camera .file-attach__icon {
            font-size: 2rem;
        }

        .file-attach__btn--camera .file-attach__icon-svg,
        .file-attach__icon-svg--camera {
            width: 2.1em !important;
            height: 2.1em !important;
            animation: none !important;
        }

        .file-attach__btn:hover,
        .file-attach__btn:focus-visible {
            background: #ffffff;
            border-color: rgba(255, 255, 255, 0.5);
            color: #5a3d2a;
            box-shadow: 0 2px 0.5rem rgba(0, 0, 0, 0.12);
        }

        @media (max-width: 520px) {
            .file-attach__controls {
                grid-template-columns: 1fr;
            }
        }

        .file-attach--drag-over .file-attach__btn {
            background: #ffffff;
            border-color: #5a3d2a;
            color: #5a3d2a;
            box-shadow: 0 0 0 3px rgba(90, 61, 42, 0.2), 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .file-attach__title {
            font-size: 1.02rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            line-height: 1.15;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .file-attach__hint {
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 0.01em;
            line-height: 1.2;
            opacity: 0.9;
            text-transform: none;
        }

        /* Paperclip Attention Animation */
        @keyframes paperclipAttention {
            0%, 90%, 100% { transform: rotate(0deg) scale(1); }
            92% { transform: rotate(5deg) scale(1.05); }
            94% { transform: rotate(-5deg) scale(1.05); }
            96% { transform: rotate(5deg) scale(1.05); }
            98% { transform: rotate(-2deg) scale(1.02); }
        }

        .file-attach__icon-svg {
            display: inline-block;
            transform-origin: center center;
            animation: paperclipAttention 8s infinite ease-in-out;
            width: 1.1em !important; 
            height: 1.1em !important;
        }

        .file-attach__icon {
            font-size: 1rem;
            line-height: 1;
            display: flex;
        }

        .file-attach__terms {
            margin-top: 0.1rem;
            margin-bottom: 0.3rem;
        }

        .file-attach__list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-attach__item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.9rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            overflow: hidden;
        }

        .file-attach__name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 80%;
        }

        .file-attach__remove {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.3rem; 
            transition: color 0.3s;
        }

        .file-attach__remove:hover {
            color: #ff6b6b;
        }

        .file-attach__progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 0.2rem;
            background: rgba(255, 255, 255, 0.6);
            width: 0%;
            transition: width 0.5s ease-out;
        }

        .camera-capture-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 21050;
            background: rgba(0, 0, 0, 0.78);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .camera-capture-modal--active {
            display: flex;
        }

        .camera-capture__panel {
            width: min(35rem, 96vw);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.24);
            background: #3a2a1a;
            box-shadow: 0 1.5rem 2.8rem rgba(0, 0, 0, 0.38);
            padding: 1rem;
        }

        .camera-capture__title {
            margin: 0 0 0.7rem 0;
            color: #fff;
            font-size: 1.02rem;
            font-weight: 900;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            text-align: center;
        }

        .camera-capture__video-wrap {
            border-radius: 0.78rem;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4 / 3;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .camera-capture__video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .camera-capture__status {
            margin: 0.6rem 0 0.7rem;
            font-size: 0.85rem;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.86);
            text-align: center;
            min-height: 1.05rem;
        }

        .camera-capture__actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }

        .camera-capture__actions .contact-form__submit-button {
            margin: 0 !important;
            width: 100%;
        }

        /* Custom Dropdown (Select Replacement) */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
            margin-bottom: 0;
        }

        .custom-select {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .custom-select__trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            padding-right: 2.8rem; /* Space for arrow */
            font-size: 1rem;
            color: var(--text-white);
            background: var(--input-bg);
            border: none;
            border-radius: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box;
            line-height: 1.3;
            font-weight: 800;
            box-shadow: 0 4px 0 rgba(58, 42, 26, 0.35);
        }

        /* Arrow indicator */
        .custom-select__trigger::after {
            content: '';
            position: absolute;
            right: 1.1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem; height: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            transition: transform 0.3s ease;
        }

        .custom-select.open .custom-select__trigger {
            background: #f4ece2;
            color: #5a3d2a;
            box-shadow: 0 4px 0 rgba(58, 42, 26, 0.45);
        }

        .custom-select.open .custom-select__trigger::after {
            transform: translateY(-50%) rotate(180deg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%235a3d2a' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        .custom-select__trigger span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 800;
        }

        .custom-options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0; right: 0;
            background: rgba(242, 231, 218, 0.97);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            border: none;
            border-radius: 1.6rem; /* All corners rounded */
            box-shadow: 0 5px 0 rgba(58, 42, 26, 0.28);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(0);
            transition: all 0.3s ease;
            max-height: none;
            overflow: visible;
            padding: 0.5rem 0;
        }

        .custom-select.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
            transform: translateY(0);
        }

        .custom-option {
            position: relative;
            display: block;
            padding: 0.8rem 1.6rem;
            font-size: 1.1rem;
            font-weight: 800;
            color: rgba(80, 60, 40, 0.85);
            cursor: pointer;
            transition: background 0.2s;
            text-align: left;
        }

        .custom-option:hover, 
        .custom-option.selected {
            background-color: rgba(139, 111, 90, 0.12);
            color: #3a2a1a;
        }

        .custom-option.selected::after {
            content: '\2713';
            position: absolute;
            right: 1.1rem; top: 50%;
            transform: translateY(-50%);
            color: var(--accent-gold);
        }



        .footer-book-btn {
            position: relative;
            display: inline-block;
            padding: 0.6rem 1.3rem;
            background: transparent;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 800;
            border: none;
            border-radius: 3.1rem;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            margin: 0 auto;
            overflow: visible;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.1);
            isolation: isolate;
        }
        .footer-book-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(90, 61, 42, 0.5);
            backdrop-filter: blur(0.6rem);
            -webkit-backdrop-filter: blur(0.6rem);
            border-radius: 3.1rem;
            border: none;
            z-index: -1;
            transition: background 0.2s;
        }
        .footer-book-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0.8rem 2.2rem rgba(0, 0, 0, 0.15);
        }
        .footer-book-btn:hover::before {
            background: rgba(90, 61, 42, 0.75);
        }

        #headerBookBtn {
            padding: 1.6rem 2.5rem !important;
            font-size: 1.3rem !important;
            width: auto !important;
            max-width: 90% !important;
        }

        /* Top book button typography: match FAQ first answer style */
        #headerBookBtn,
        #headerBookBtnText,
        #headerBookBtnText span {
            font-family: 'Lato', sans-serif !important;
            font-size: 1.2rem !important;
            font-weight: 400 !important;
            color: rgba(255,255,255,0.92) !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em !important;
            text-transform: none !important;
        }

        #headerBookBtnText .header-book-line1 {
            font-weight: 900 !important;
        }

        #footerBookBtn {
            padding: 1.5rem 3rem !important;
            width: auto !important;
            min-width: 18.8rem !important; /* 300px equivalent rounded */
            max-width: 95% !important;
        }

        /* Bottom book button: same font, keep existing dynamic sizes */
        #footerBookBtn,
        #footerBookBtnText,
        #footerBookBtnText span {
            font-family: 'Lato', sans-serif !important;
        }

        .spark {
            position: absolute;
            width: 0.34rem;
            height: 0.34rem;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            background: rgba(255, 236, 210, 0.98);
            z-index: 3;
            box-shadow: 0 0 0.55rem rgba(255, 245, 230, 0.8);
            will-change: transform, opacity;
            transform: translate3d(0, 0, 0);
            animation: sparkle var(--spark-duration, 500ms) cubic-bezier(0.2, 0.75, 0.25, 1) var(--spark-delay, 0ms) forwards;
        }

        @keyframes sparkle {
            0% { transform: translate3d(0, 0, 0) scale(0.55); opacity: 0; }
            12% { opacity: 1; }
            100% { transform: translate3d(var(--vx), var(--vy), 0) scale(1.85); opacity: 0; }
        }

        @keyframes hypnoticPulse {
            0% { text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); opacity: 0.6; }
            50% { text-shadow: 0 0 1.3rem rgba(255, 255, 255, 0.9), 0 0 0.6rem rgba(255, 255, 255, 0.7); opacity: 1; color: #fff; }
            100% { text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); opacity: 0.6; }
        }

        .hypnotic-text {
            animation: hypnoticPulse 1.5s infinite ease-in-out;
        }

        /* Day Navigation in Slots Section */
        .slots-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2.5rem 0 2rem;
            padding: 0 0.6rem;
            width: 100%;
        }

        .slots-nav--loading .slots-nav-arrow {
            display: none;
        }

        .slots-nav-arrow {
            background: rgba(255, 255, 255, 0);
            border: none;
            color: #ffffff;
            font-size: 1.8rem; /* Consistent with calendar nav */
            cursor: pointer;
            width: 3.1rem;
            height: 3.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            opacity: 0.7;
            user-select: none;
            padding: 0;
            line-height: 1;
        }

        .slots-nav-arrow:hover {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
            transform: scale(1.1);
        }

        .slots-nav-arrow:active {
            transform: scale(0.95);
        }

        #slotsDayDisplay {
            font-size: 1.4rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ffffff;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            text-align: center;
            flex-grow: 1;
            margin: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            line-height: 1.2;
            display: flex; 
            align-items: center;
            justify-content: center;
            min-height: 3.1rem;
        }

        /* Block: Global Spinner Overlay */
        .global-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75); /* Darker backdrop as before */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 99999;
            display: none;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

        .global-spinner__ring-wrap {
            width: 11.3rem;
            height: 11.3rem;
            position: relative;
            display: grid;
            place-items: center;
        }

        .global-spinner__svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            overflow: visible;
        }

        .global-spinner__track {
            fill: transparent;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 12;
        }

        .global-spinner__glow {
            fill: none;
            stroke: #ffffff;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 302;
            stroke-dashoffset: 0;
            animation: globalSpinnerGlow 1.5s ease-in-out infinite;
        }

        @keyframes globalSpinnerGlow {
            0%, 100% {
                filter: drop-shadow(0 0 10px rgba(212, 184, 154, 0.45));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 30px rgba(255, 255, 255, 1));
                transform: scale(1.05);
            }
        }

        .dot-jump {
            display: inline-block;
            animation: dotJump 1.4s infinite ease-in-out both;
        }
        .dot-jump:nth-child(2) { animation-delay: 0.2s; }
        .dot-jump:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotJump {
            40% { transform: translateY(-0.6rem); }
        }

        .fade-out {
            opacity: 0;
            transform: translateY(-0.6rem);
        }
        .fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Preloader Error State Text */
        .book-btn-preloader--error .book-btn-preloader__text {
            color: #ff2f45;
            font-size: 1.08rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2.2px;
            position: absolute;
            left: 50%;
            bottom: -1.72rem;
            transform: translateX(-50%);
            width: max-content;
            white-space: nowrap;
            text-shadow: 0 0 14px rgba(255, 47, 69, 0.6), 0 0 28px rgba(255, 47, 69, 0.28);
            animation: slotNotFoundPulse 0.9s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes slotNotFoundPulse {
            0%, 100% {
                opacity: 0.62;
                transform: translateX(-50%) scale(1);
                filter: drop-shadow(0 0 0 rgba(255, 76, 76, 0));
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.12);
                filter: drop-shadow(0 0 12px rgba(255, 47, 69, 0.6));
            }
        }

        @keyframes hypnoticCirclePulse {
            0% { filter: drop-shadow(0 0 10px rgba(212, 184, 154, 0.5)); stroke: #D4B89A; transform: scale(1); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 255, 255, 1)); stroke: #ffffff; transform: scale(1.05); }
            100% { filter: drop-shadow(0 0 10px rgba(212, 184, 154, 0.5)); stroke: #D4B89A; transform: scale(1); }
        }

        .book-btn-preloader--hypnotic .book-btn-preloader__progress {
            /* Keep it visually at 100% */
            stroke-dashoffset: 0 !important;
            animation: hypnoticCirclePulse 1.5s ease-in-out infinite !important;
        }
        
        .book-btn-preloader--error .book-btn-preloader__progress {
            stroke: #ff4c4c !important;
            filter: drop-shadow(0 0 15px rgba(255, 76, 76, 0.8)) !important;
            animation: none !important;
            stroke-dashoffset: 0 !important; /* Force fully filled */
        }

        /* Book Button Error State */
        .book-btn-preloader--error .book-btn-preloader__circle {
            stroke: rgba(255, 51, 51, 0.15); /* Light red track */
            animation: pulseError 1.5s infinite ease-in-out;
        }

        @keyframes pulseError {
            0%, 100% { stroke-opacity: 0.5; stroke-width: 3; }
            50% { stroke-opacity: 1; stroke-width: 4; }
        }

        /* Hide Spinners on Number Inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        /* Playful Jump Animation for Last Slot Text */
        @keyframes playfulJump {
            0%, 30%, 100% { transform: scale(1); }
            15% { transform: scale(1.02); }
        }

        /* ------------------- TOP BAR & NAVIGATION (Auto-hiding) ------------------- */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 7.5rem;
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            z-index: 10000;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.9rem 1.3rem 0;
            border-bottom: 1px solid var(--glass-border);
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            transition: opacity 0.25s ease, transform 0.25s ease;
            -webkit-mask-image: linear-gradient(to bottom, black, transparent);
            mask-image: linear-gradient(to bottom, black, transparent);
        }

        .top-bar--visible {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 2.5s ease-in-out, transform 2.5s ease-in-out;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 7.5rem;
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            z-index: 10000;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 1.3rem 0.9rem;
            border-top: 1px solid var(--glass-border);
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            transition: opacity 0.25s ease, transform 0.25s ease;
            -webkit-mask-image: linear-gradient(to top, black, transparent);
            mask-image: linear-gradient(to top, black, transparent);
        }

        .services-content {
            text-align: left;
            margin: 3.8rem 0;
            padding: 2.5rem;
        }
        .services-content ul {
            list-style: none;
            padding: 0;
        }
        .services-content li {
            padding-bottom: 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .services-content li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .services-content h3 {
            color: var(--text-white);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-transform: uppercase;
            font-weight: 800;
        }
        .services-content p {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem;
        }

        .bottom-bar--visible {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 2.5s ease-in-out, transform 2.5s ease-in-out;
        }

        /* Preloader for Book Button */
        .book-btn-preloader {
            display: grid;
            place-items: center;
            width: 11.3rem;
            height: 11.3rem;
            position: relative;
            margin: 0 auto;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .book-btn-preloader__text {
            font-size: 1rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            text-align: center;
            line-height: 1.3;
            z-index: 2;
            position: relative;
        }

        .book-btn-preloader__svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg); /* Start from top */
            overflow: visible; /* Prevent glow from clipping square box */
        }

        .book-btn-preloader__circle {
            fill: transparent;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 12;
            backdrop-filter: blur(0.6rem);
            -webkit-backdrop-filter: blur(0.6rem);
        }

        .book-btn-preloader__progress {
            fill: none;
            stroke: #ffffff;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 302; /* Circumference: 2 * pi * 48 */
            stroke-dashoffset: 302; 
            animation: 
                fillProgress 19s ease-out forwards, /* Increased by 5s */
                hypnoticCircleGlow 3s infinite ease-in-out 22s;
        }

        @keyframes fillProgress {
            0% { stroke-dashoffset: 302; }
            100% { stroke-dashoffset: 0; } 
        }

        @keyframes hypnoticCircleGlow {
            0%, 100% { filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.1)); }
            50% { filter: drop-shadow(0 0 1rem rgba(255, 255, 255, 0.9)); }
        }

        .book-btn-container {
            position: relative;
            height: 11.3rem; /* Adjust height to fit preloader */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2.5rem auto;
        }

        .book-btn-wrapper .book-btn-container {
            margin: 1.3rem auto;
        }


        .footer__copyright { 
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: center;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem; 
            margin-top: 0;
            transition: opacity 2s ease 1s; /* 1s delay */
        }
        
        /* Specialized fade-in class for elements needing a delay */
        .fade-in-delayed {
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 2s ease 1s, transform 2s ease 1s; /* 1s delay */
        }

        .fade-in-delayed.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Unified paragraph style (matches "Identification Requirement" text blocks) */
        .header__content-text,
        .services-content p,
        .faq__answer,
        .faq__answer p,
        .privacy-block p,
        .modal__text,
        .price-note {
            font-family: 'Lato', sans-serif;
            font-size: 1.2rem !important;
            font-weight: 400 !important;
            color: rgba(255, 255, 255, 0.92) !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em;
            text-align: left;
            margin-bottom: 1.3rem;
            opacity: 1 !important;
        }

        .footer__hours,
        .footer__copyright {
            font-family: 'Lato', sans-serif !important;
            font-size: 1.2rem !important;
            font-weight: 400 !important;
            color: rgba(255, 255, 255, 0.92) !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em !important;
            text-align: center !important;
            width: 100%;
        }

        .footer .blur-in-section {
            margin-top: 26rem !important;
        }

        /* Slightly larger spacing between major content blocks */
        .header__content-block,
        .header__service-item,
        .contact-form,
        .footer {
            margin-bottom: 3.2rem !important;
        }

        .faq__item {
            margin-bottom: 2.4rem;
        }

        .layout-container > .contact-form,
        .layout-container > .faq,
        .layout-container > .privacy-block {
            margin-bottom: 3rem;
        }

        /* Standalone privacy block under the map */
        .privacy-block--map {
            max-width: calc(45.25rem - 10px);
            margin: 4rem auto 0;
            padding: 0 1.3rem;
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
            line-height: 1.6;
            text-align: left;
        }
    </style>
</head>

<body id="top">

<!-- TOP BAR -->
<div class="top-bar">
</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
</div>

<div class="background">
    <svg class="background__svg" viewBox="0 0 528 816" preserveAspectRatio="xMidYMid slice">
        <defs>
            <radialGradient id="g" cx="50%" cy="100%" r="100%">
                <stop offset="0" stop-color="#D4B89A"/><stop offset="1" stop-color="#8B6F5A"/>
            </radialGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)"/>
        <g style="mix-blend-mode:overlay" fill-opacity=".15">
            <path class="background__stripe" d="M-100 300L600-100V200L-100 600Z" fill="#fff"/>
            <path class="background__stripe background__stripe--delay-1" d="M-100 700L600 200V400L-100 900Z" fill="#fff" fill-opacity=".1"/>
            <path class="background__stripe background__stripe--delay-2" d="M100-100L500 900H300L-100-100Z" fill="#fff" fill-opacity=".08"/>
        </g>
    </svg>
</div>

<header class="header fade-in-section">
    <div class="header__title dynamic-text" data-i18n="name">Hanna&nbsp;Dunchenko</div>
    <div class="header__subtitle dynamic-text" data-i18n="subtitle">Paralegal Services</div>
    <h1 class="header__description">
        <span data-i18n="desc1">Licensed Paralegal &amp; Notary Public Services </span><br>
        <span data-i18n="desc2">Traffic Ticket Defense, LTB, WSIB Matters </span><br>
        <span data-i18n="desc3">Toronto, Richmond Hill, Mississauga, London </span><br>
        <span data-i18n="desc4">Online meetings are available province-wide</span>
    </h1>

    <div class="header__contact" style="margin-top: 0.5rem; margin-bottom: 2rem; max-width: 45rem; width: 100%; margin-left: auto; margin-right: auto; padding: 0 1.3rem; text-align: center;">
        <br>
        <a href="tel:+14372396833" class="header__phone-link dynamic-text">+1 (437) 239-6833</a>
    </div>

    <div class="book-btn-wrapper">
        <div class="book-btn-container">
            <div class="book-btn-preloader" id="headerBookBtnPreloader" style="position: absolute;">
                <svg class="book-btn-preloader__svg" viewBox="0 0 120 120">
                    <circle class="book-btn-preloader__circle" cx="60" cy="60" r="48"/>
                    <circle class="book-btn-preloader__progress" cx="60" cy="60" r="48"/>
                </svg>
                <div class="book-btn-preloader__text" style="text-align: center; line-height: 1.2; display: none;"></div>
            </div>
            <button class="footer-book-btn" id="headerBookBtn" onclick="bookNearestSlot()" style="opacity: 0; transform: scale(0.9); pointer-events: none;">
                <span id="headerBookBtnText">Book Appointment</span>
            </button>
        </div>
    </div>

    <div class="header__content-block">
        <h2 class="header__content-header" style="font-size: clamp(1.6rem, 6vw, 2.2rem);">SERVICES</h2>
        
        <ul class="services-list" style="padding-left: 1.65rem; margin-top: 1.5rem; display: flex; flex-direction: column; gap: 2rem;">
            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">Notary Public & Commissioner of Oaths</h3>
                    <p class="header__content-text">Operating as a Commissioner of Oaths in Ontario involves strictly assessing documents to establish the required level of notarization or commissioning. This requires formally verifying the deponent's identity utilizing valid, government-issued identification. The process continues with administering oaths, affirmations, or solemn declarations for documents including, but not limited to, an <strong>Affidavit</strong>, a <strong>Statutory Declaration</strong>, or a <strong>Consent Letter for Children Travelling Abroad</strong>. Providing certification to verify documents as true copies of the original is also conducted, where legally permissible under Ontario regulations.</p>
                </div>
            </li>

            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">WSIB & Workplace Injury Claims</h3>
                    <p class="header__content-text">Providing representation for injured workers in matters involving the Workplace Safety and Insurance Board falls under the strict authorization of licensed Ontario paralegals. The procedure initiates with reviewing the workplace injury circumstances, strictly analyzing the <strong>Form 6 Worker's Report of Injury</strong> or any existing WSIB decisions. This encompasses assisting with comprehensive claim management, submitting required documentation, and actively advising on <strong>Loss of Earnings (LOE)</strong> or <strong>Non-Economic Loss (NEL)</strong> entitlements. In instances of dispute, services include directly representing clients at hearings to address <strong>Return to Work (RTW)</strong> obligations or formally appealing adverse decisions before the Workplace Safety and Insurance Appeals Tribunal (WSIAT).</p>
                </div>
            </li>

            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">Provincial Offences & Traffic Ticket Defense</h3>
                    <p class="header__content-text">Representing clients in Provincial Offences Court for matters under the <strong>Highway Traffic Act (HTA)</strong> is strictly authorized under the unique regulatory framework for Ontario paralegals. Counsel begins by formally requesting and critically examining the prosecuting officer's disclosure and evidence. This is followed by formulating a precise case strategy for defending charges such as speeding, careless driving, or stunt driving by exploring potential procedural or charter defenses. Efforts initially focus on pursuing resolution through negotiating with the municipal prosecutor to seek withdrawing charges or reducing penalties (e.g., demerit points). Should a negotiated resolution not be attainable, the process culminates in providing formal representation at the trial hearing.</p>
                </div>
            </li>

            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">Landlord & Tenant Board (LTB)</h3>
                    <p class="header__content-text">Holding a specific license enables Ontario paralegals to represent landlords and tenants before the Landlord and Tenant Board under the strict guidelines of the <strong>Residential Tenancies Act (RTA)</strong>. The procedure involves precisely preparing and serving statutory notices, such as an <strong>N4 Notice to End your Tenancy Early for Non-payment of Rent</strong> or an <strong>N12 Notice to End your Tenancy Because the Landlord, a Purchaser or a Family Member Requires the Rental Unit</strong>. This is followed by filing the appropriate application, such as an <strong>L1 Application to Evict a Tenant for Non-payment of Rent</strong> or a <strong>T2 Application about Tenant Rights</strong>. Furthermore, the process includes rigorously preparing documentary evidence and witness testimony, culminating in directly representing clients during case management hearings or formal eviction hearings before an LTB adjudicator.</p>
                </div>
            </li>
        </ul>
        <style>
            .services-list {
                list-style: none !important;
                padding-left: 0 !important;
                overflow: visible;
            }
            .services-list li {
                display: flex;
                align-items: flex-start;
                gap: 1.05rem;
                padding-left: 0;
                overflow: visible;
            }
            .services-list li::before {
                content: "";
                flex: 0 0 1.12rem;
                width: 1.12rem;
                height: 1.12rem;
                border: 2px solid rgba(255, 255, 255, 0.96);
                border-radius: 50%;
                margin-top: 0.16rem;
                opacity: 0.95;
                pointer-events: none;
                animation: servicesBulletHypnotic 4.8s ease-in-out infinite;
                will-change: transform, opacity;
            }
            .services-list li:nth-child(2)::before { animation-delay: 0.75s; }
            .services-list li:nth-child(3)::before { animation-delay: 1.5s; }
            .services-list li:nth-child(4)::before { animation-delay: 2.25s; }

            .services-list .header__service-item {
                flex: 1 1 auto;
                min-width: 0;
            }

            .services-list .header__content-subheader {
                margin-top: 0;
                margin-bottom: 0.8rem;
            }

            @keyframes servicesBulletHypnotic {
                0%, 100% {
                    transform: translate3d(0, 0, 0) scale(1);
                    opacity: 0.9;
                }
                38% {
                    transform: translate3d(-1px, 0, 0) scale(1.08);
                    opacity: 1;
                }
                72% {
                    transform: translate3d(1px, 0, 0) scale(0.94);
                    opacity: 0.82;
                }
            }

            @media (prefers-reduced-motion: reduce) {
                .services-list li::before {
                    animation: none;
                }
            }
        </style>
    </div>

    <div class="header__content-block" style="margin-top: 5rem;">
        <h2 class="header__content-header" style="font-size: clamp(1.6rem, 6vw, 2.2rem);">Intake Notice</h2>
        
        <div class="faq__item">
            <h3 class="faq__question" style="font-size: 1.3rem;">Intake Appointment</h3>
            <div class="faq__answer">
                <p class="header__content-text" style="font-size: 1.2rem;">Before we can confirm and book your intake appointment, it is strongly recommended that you be ready to present all documents relevant to your matter, such as contracts, agreements, court notices, orders or any other paperwork.</p>
                <p class="header__content-text" style="font-size: 1.2rem;">If you are uncertain whether a document is relevant, we can review it together. Copies of supporting documents should be prepared in advance, but originals may also be requested for verification.</p>
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question" style="font-size: 1.3rem;">Identification Requirement</h3>
            <div class="faq__answer">
                <p class="header__content-text" style="font-size: 1.2rem;">At the time of your intake appointment, you must be ready to present any valid government-issued identification document and provide following information:</p>
                <p class="header__content-text" style="font-size: 1.2rem;">Full name; date of birth; home address and telephone number; occupation; and/or business address and business telephone number; organization’s incorporation or business identification number and it’s place of issue.</p>
            </div>
        </div>
    </div>
</header>






<div class="layout-container">
    <div class="contact-form fade-in-section">
        <h2 class="contact-form__outside-title" id="calendarHeaderTitle">AVAILABILITY</h2>
        <div class="calendar-wrapper fade-in-section" id="bookingCalendar">
            <!-- Loading Overlay -->
            <div id="calendarLoaderOverlay">
                <div class="book-btn-preloader" style="position: relative; width: 120px; height: 120px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                    <svg class="book-btn-preloader__svg" viewBox="0 0 120 120" width="120" height="120">
                        <circle class="book-btn-preloader__circle" cx="60" cy="60" r="48"/>
                        <circle class="book-btn-preloader__progress" cx="60" cy="60" r="48"/>
                    </svg>
                </div>
            </div>
            <!-- Header -->
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="prevBtn">&#10094;</button>
                <div class="calendar-title" id="monthDisplay"></div>
                <button class="calendar-nav-btn" id="nextBtn">&#10095;</button>
            </div>
            <!-- Progress bar -->
            <div id="loadingSeparator" class="loading-separator"></div>
            <!-- Day grid -->
            <div class="calendar-grid" id="calendarGrid"></div>
            <!-- Slot label -->
            <div class="slots-nav" id="slotsNav">
                <span id="slotsDayDisplay"></span>
            </div>
            <!-- Slots -->
            <div class="slots-block" id="slotsBlock">
                <div class="slots-container" id="slotsContainer">
                    <div class="slots-grid" id="slotsGrid" style="grid-template-columns:1fr;"></div>
                </div>
            </div>
        </div><!-- /calendar-wrapper -->
    </div>

    <h2 class="section-title fade-in-section" data-i18n="faqTitle">FAQ</h2>
    <div class="faq faq--accordion fade-in-section">
        <div class="faq__item">
            <h3 class="faq__question">Is online as effective as in-person?</h3>
            <div class="faq__answer">
                Yes! You’ll receive the same professional services, with the convenience of connecting remotely. All online consultations are available province-wide.
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question">What are the symbols on the calendar?</h3>
            <div class="faq__answer">
                The lock symbols on the calendar above indicate that the office is closed on those days. In exceptional circumstances, meetings may still be arranged by appointment and proceed with an in-person consultation to outline strategy and next steps.
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question">Was there an earlier way to register?</h3>
            <div class="faq__answer">
                The prior registration process remains accessible at its original URL and existing links will continue to direct users to the original <a href="https://docs.google.com/forms/d/1brLzvNv2tR9jDvG4Z9vUZLvzzpgZHmOhHPZ7_x8g8Qo" target="_blank" rel="noopener noreferrer" style="color:white; text-decoration: underline;">Google Form</a>. Please note that Google registration is required there.
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question">WHERE IS THE OFFICE?</h3>
            <div class="faq__answer">
                <p class="header__content-text" style="margin-bottom: 15px;">146 Thirtieth St, Suite 29, Toronto, ON M8W 3C4</p>
                <div class="map-container">
                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d378393.2825310128!2d-80.40792372435779!3d43.21332219277207!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x882b362142436423%3A0x6a0532729e2f4772!2s146%20Thirtieth%20St%2C%20Suite%2029%2C%20Toronto%20ON%20M8W%203C4!5e0!3m2!1sen!2sca" class="map-container__iframe" allowfullscreen="" loading="eager"></iframe>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 15px; flex-wrap: wrap;">
                    <span style="opacity: 1; font-size: 1.2rem; font-weight: 400; color: rgba(255,255,255,0.92); line-height: 1.6; letter-spacing: 0.01em; display: inline-block;">Just tap</span>
                    <a id="directionsBtn" href="https://www.google.com/maps/dir//146+Thirtieth+St,+Suite+29,+Toronto,+ON+M8W+3C4" target="_blank" rel="noopener noreferrer" onclick="return logDirectionsClick(event)" style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); color: #fff; font-weight: 800; border-radius: 50px; text-decoration: none; font-size: 0.9rem; white-space: nowrap; transition: transform 0.2s;">Directions</a>
                    <span style="opacity: 1; font-size: 1.2rem; font-weight: 400; color: rgba(255,255,255,0.92); line-height: 1.6; letter-spacing: 0.01em; display: inline-block;">to start driving</span>
                </div>
            </div>
        </div>
    </div>

    <div class="privacy-block privacy-block--map fade-in-section">
        <h3 style="font-size: 1.4rem; font-weight: 800; text-transform: uppercase; margin-bottom: 1rem; color: #fff;">Privacy Policy</h3>
        <p><strong>Data Collection:</strong> Personal details you submit (name, phone, email, case summary etc) are gathered through this form.</p>
        <p style="margin-top: 10px;"><strong>How It's Used:</strong> Your information helps deliver paralegal services, answer your questions, and maintain contact, with your consent.</p>
        <p style="margin-top: 10px;"><strong>Your Rights:</strong> Request access to or removal of your data by calling <a href="tel:+14372396833" style="color: #ffffff; text-decoration: none; font-weight: 400; white-space: nowrap; display: inline-block;">+1&nbsp;(437)&nbsp;239-6833</a> or emailing <strong><a href="mailto:paralegal@hannadunchenko.com" style="color: #ffffff; text-decoration: none;">paralegal@hannadunchenko.com</a></strong>.</p>
    </div>
</div>

<!-- ----------------------------------------------------------- -->
<!-- TERMS OF SERVICE MODAL -->
<!-- ----------------------------------------------------------- -->
<div id="termsModal" class="modal">
    <div class="modal__content">
        <button class="modal__close" onclick="closeTermsModal()">&times;</button>
        <h2 class="modal__title" data-i18n="termsModalTitle">Terms of Service</h2>
        <div class="modal__body">
            <h3 class="modal__section-title" data-i18n="noLegalAdvice">1. No Legal Advice</h3>
            <p class="modal__text">The information provided on this website is for general informational purposes only and does not constitute legal advice. You should not rely on, or take or fail to take any action, based upon this information. Always seek the advice of a qualified legal professional licensed in your jurisdiction regarding your specific legal situation. This website is intended solely for intake purposes.</p>
            
            <h3 class="modal__section-title" data-i18n="noParalegalRelationship">2. No Paralegal-Client Relationship</h3>
            <p class="modal__text">Accessing or using this website, or contacting Hanna Dunchenko via email, phone, or the booking form, does not create a paralegal-client relationship. A professional relationship is only established upon the execution of a formal written Retainer Agreement signed by both parties.</p>
            
            <h3 class="modal__section-title" data-i18n="confidentiality">3. Confidentiality</h3>
            <p class="modal__text">While we respect your privacy, please be aware that information transmitted to us through this website or via email prior to the establishment of a formal paralegal-client relationship may not be privileged or confidential. Please avoid sending sensitive or confidential information until a retainer is in place.</p>
            
            <h3 class="modal__section-title" data-i18n="noGuarantee">4. No Guarantee of Results</h3>
            <p class="modal__text">In accordance with professional standards and applicable regulations, we do not and cannot guarantee the outcome of any legal matter. Past results are not indicative of future outcomes, and every case is unique.</p>
            
            <h3 class="modal__section-title" data-i18n="feesAndRetainers">5. Fees and Retainers</h3>
            <p class="modal__text">Fees for legal services are determined based on the scope and complexity of the matter and will be clearly outlined in a Retainer Agreement. All fees and billing practices comply with professional regulatory guidelines.</p>

            <h3 class="modal__section-title" data-i18n="limitationOfLiability">6. Limitation of Liability</h3>
            <p class="modal__text">Your use of this website is at your own risk. The content is provided "as is" without warranties of any kind. We are not liable for any damages arising from your use of this site.</p>

            <h3 class="modal__section-title" data-i18n="formSubmission">7. Form Submission & Response Disclaimer</h3>
            <p class="modal__text">Submitting the inquiry form on this website is for informational purposes only and allows us to review your case files. It does not guarantee that a case will be opened, nor does it guarantee a response. While we aim to reply within 48 hours, a response is not guaranteed, and no legal rights are preserved by the mere act of submission. To expedite your request, we strongly recommend contacting our paralegal by phone immediately after submitting this form.</p>

            <h2 class="modal__title" style="margin-top: 50px; margin-bottom: 20px; font-size: 1.8rem;" data-i18n="privacyPolicy">Privacy Policy</h2>

            <h3 class="modal__section-title" data-i18n="infoCollection">1. Information Collection</h3>
            <p class="modal__text">We collect personal information (such as name and contact details) only when you voluntarily provide it. This information is used solely to communicate with you and assess your potential legal needs.</p>

            <h3 class="modal__section-title" data-i18n="useOfInfo">2. Use of Information</h3>
            <p class="modal__text">Your data is used to facilitate communication and legal representation. We do not sell, trade, or otherwise transfer your personally identifiable information to outside parties.</p>

            <h3 class="modal__section-title" data-i18n="analyticsAds">3. Analytics & Advertising</h3>
            <p class="modal__text">This website uses services like Google Analytics, Google Ads, YouTube, and Facebook. These third-party vendors may use cookies to analyze traffic, serve relevant advertisements based on past visits, and improve user experience. You may opt out of personalized advertising by visiting Google's Ad Settings.</p>

            <h3 class="modal__section-title" data-i18n="contactUs">4. Contacting Us</h3>
            <p class="modal__text">If there are any questions regarding this privacy policy or if you wish to exercise your rights to access or delete your data, you may contact us at paralegal@hannadunchenko.com.</p>

            <p class="modal__footer-text">
                By using this website, you acknowledge that you have read and understood these Terms of Service.
            </p>
        </div>
    </div>
</div>

<footer class="footer fade-in-section">
    <div class="footer__container">
        
        <div class="footer__hours" data-i18n="hours">
            <strong>Hours of Operation:</strong><br>Sunday: Closed<br>Monday - Saturday: 10:00 AM - 4:00 PM
        </div>
        <div style="text-align: center; margin: 2rem 0;">
            <div class="book-btn-container">
                <div class="book-btn-preloader" id="footerBookBtnPreloader" style="position: absolute;">
                    <svg class="book-btn-preloader__svg" viewBox="0 0 120 120">
                        <circle class="book-btn-preloader__circle" cx="60" cy="60" r="48"/>
                        <circle class="book-btn-preloader__progress" cx="60" cy="60" r="48"/>
                    </svg>
                    <div class="book-btn-preloader__text" style="text-align: center; line-height: 1.2; display: none;"></div>
                </div>
                <button class="footer-book-btn" id="footerBookBtn" onclick="bookNearestSlot()" style="opacity: 0; transform: scale(0.9); pointer-events: none;">
                    <span id="footerBookBtnText">Book Appointment</span>
                </button>
            </div>
        </div>

        <a href="tel:+14372396833" class="footer__contact-link">+1 (437) 239-6833</a>
    </div>
    <div class="blur-in-section" style="margin-top: 10rem;">
        <p class="footer__copyright" style="margin-bottom: 5px;">My only official website:</p>
        <p class="footer__copyright" style="margin-top: 0;">&copy; <span id="currentYear"></span> Hanna Dunchenko Paralegal Services</p>
    </div>
</footer>

<!-- BOOKING MODAL -->
<div id="bookingModal" class="modal">
    <div class="modal__content" style="max-width: 600px;">
        <button class="modal__close" onclick="closeBookingModal()" style="left: 20px; right: auto;">&times;</button>
        <h2 class="modal__title" style="text-align: center; margin-top: 10px; margin-bottom: 20px; padding-top: 0; line-height: 1.4;">REQUEST<br><span style="display: block; font-size: 1em; opacity: 0.9; margin-top: 5px;">TO BOOK YOUR APPOINTMENT:</span><span id="modalAppointmentTime" style="display: block; font-size: 1em; font-weight: 800; margin-top: 2px;"></span></h2>
        <div class="modal__body" style="padding-top: 5px; text-align: center;">
            
            <form id="bookingForm" onsubmit="handleBookingSubmit(event)">
                <!-- Honeypot: hidden from humans, visible to bots -->
                <div style="position: absolute; left: -9999px; top: -9999px;" aria-hidden="true">
                    <input type="text" name="website" tabindex="-1" autocomplete="off">
                </div>
                <input type="hidden" name="_timestamp" id="formTimestamp">
                
                <div class="contact-form__group">
                    <input type="text" class="contact-form__input" placeholder="Name" name="name" required minlength="2" maxlength="80" autocomplete="name" inputmode="text" spellcheck="false">
                </div>
                <div class="contact-form__group">
                    <input type="text" class="contact-form__input" placeholder="Occupation" name="occupation" required minlength="2" maxlength="100" autocomplete="organization-title" inputmode="text" spellcheck="false">
                </div>
                <div class="contact-form__group">
                    <input type="email" class="contact-form__input" placeholder="Email" name="email" required maxlength="120" autocomplete="email" inputmode="email" spellcheck="false">
                </div>

                <div class="contact-form__group">
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="customSelect">
                            <button class="custom-select__trigger" type="button">
                                <span>Choose Service</span>
                            </button>
                            <div class="custom-options">
                                <div class="custom-option" data-value="public-notary">Public Notary Services</div>
                                <div class="custom-option" data-value="employment">Employment Law</div>
                                <div class="custom-option" data-value="civil">Civil matter</div>
                                <div class="custom-option" data-value="wsib">WSIB related issue</div>
                                <div class="custom-option" data-value="ltb">LTB related issue</div>
                                <div class="custom-option" data-value="other">Other</div>
                            </div>
                        </div>
                        <input type="hidden" name="service" id="serviceInput" value="">
                    </div>
                </div>

                <div class="contact-form__group">
                    <input type="tel" class="contact-form__input" placeholder="Phone" name="phone" required maxlength="20" autocomplete="tel" inputmode="tel" spellcheck="false">
                </div>

                <div class="contact-form__group">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="contact-form__input" placeholder="Street, City, ON" name="address_street" required minlength="6" maxlength="150" autocomplete="street-address" inputmode="text" spellcheck="false" style="flex-grow: 1;">
                        <input type="text" class="contact-form__input" placeholder="ZIP" name="address_zip" required minlength="6" maxlength="7" autocomplete="postal-code" inputmode="text" spellcheck="false" style="width: 4.6ch; min-width: 4.6ch; text-align: center; padding-left: 0.25rem; padding-right: 0.25rem;">
                    </div>
                </div>

                <div class="contact-form__group">
                    <textarea class="contact-form__textarea" rows="3" maxlength="3000" placeholder="Brief details about your case area..." name="notes" style="text-align: left;"></textarea>
                    
                    <!-- File Attachment moved under Brief Case Area -->
                    <div class="file-attach" style="margin-top: 15px;">
                        <input type="file" id="fileAttachInput" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
                        <input type="file" id="cameraFallbackInput" accept="image/*" capture="environment" style="display: none;">
                        <div class="file-attach__controls">
                            <button type="button" class="file-attach__btn" onclick="document.getElementById('fileAttachInput').click()">
                                <span class="file-attach__title">
                                    <span class="file-attach__icon">
                                        <svg class="file-attach__icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25em; height: 1.25em;">
                                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                        </svg>
                                    </span>
                                    Attach Files
                                </span>
                                <span class="file-attach__hint">Attach any files you have<br>(drag &amp; drop or click)</span>
                            </button>
                            <button type="button" class="file-attach__btn file-attach__btn--camera" id="takePhotoBtn">
                                <span class="file-attach__title">
                                    <span class="file-attach__icon">
                                        <svg class="file-attach__icon-svg file-attach__icon-svg--camera" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25em; height: 1.25em;">
                                            <path d="M4 7h3l2-2h6l2 2h3a1 1 0 0 1 1 1v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a1 1 0 0 1 1-1z"></path>
                                            <circle cx="12" cy="13" r="4"></circle>
                                        </svg>
                                    </span>
                                </span>
                            </button>
                        </div>
                        <div class="file-attach__list" id="fileAttachList"></div>
                    </div>
                </div>

                <div class="contact-form__group">
                    <label class="contact-form__label" style="display:block; margin-bottom:8px; color:var(--text-white); text-align: center;">Date of Birth</label>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <input type="number" class="contact-form__input" placeholder="YYYY" name="dob_year" style="width: 30%;" required min="1900" max="2100" step="1" inputmode="numeric">
                        <input type="number" class="contact-form__input" placeholder="MM" name="dob_month" style="width: 30%;" required min="1" max="12" step="1" inputmode="numeric">
                        <input type="number" class="contact-form__input" placeholder="DD" name="dob_day" style="width: 30%;" required min="1" max="31" step="1" inputmode="numeric">
                    </div>
                </div>

                <p id="bookingStatus" aria-live="polite" aria-atomic="true"></p>

                <div class="modal-sticky-actions">
                    <button type="submit" class="contact-form__submit-button" id="confirmBookingBtn">Book Now</button>
                    <div class="contact-form__checkbox-wrapper file-attach__terms" style="margin-top: 12px; margin-bottom: 0;">
                        <input type="checkbox" id="agreeTerms" class="contact-form__checkbox" required>
                        <label for="agreeTerms" class="contact-form__checkbox-label">
                            I agree with <span class="contact-form__terms-link" onclick="openTermsModal()">Terms of Service</span>
                        </label>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="cameraCaptureModal" class="camera-capture-modal" aria-hidden="true">
    <div class="camera-capture__panel">
        <h3 class="camera-capture__title">Take Document Photo</h3>
        <div class="camera-capture__video-wrap">
            <video id="cameraPreview" class="camera-capture__video" autoplay playsinline muted></video>
        </div>
        <p class="camera-capture__status" id="cameraCaptureStatus">Allow camera access, then press Capture.</p>
        <div class="camera-capture__actions">
            <button type="button" class="contact-form__submit-button" id="cameraSnapBtn">Capture</button>
            <button type="button" class="contact-form__submit-button final-result-done" id="cameraCancelBtn">Cancel</button>
        </div>
    </div>
</div>

<script>
    // ------------------------------------------------------------------
    // GAZCONFIGURATION
    // ------------------------------------------------------------------
    // REPLACE THIS URL WITH YOUR GOOGLE APPS SCRIPT WEB APP URL
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVxnY1YTdQKwpKe1SRntjLg4Pdj7PB3f2X8QMWQxm4E9ODo9R3otgZlrWBCzMTe3Gptw/exec"; 
    // ------------------------------------------------------------------
    
    // ------------------------------------------------------------------
    // CALENDAR STATE
    // ------------------------------------------------------------------
    let currentDate   = new Date();
    let selectedDate  = null;
    let absoluteNearestDate   = null;
    let nearestSlotData       = null;
    let nearestDayLastSlotData= null;
    let availableDaysCount    = 0;
    let availableSlotsCache   = {};
    let availableSlotsMeta    = {};
    let availableDaysIndexCache = {};
    let monthFetchPromises    = {};
    let calendarNavInProgress = false;
    let calendarListenersBound = false;
    let calendarRenderToken = 0;
    let calendarCacheLoaded = false;
    let calendarCachePersistTimer = null;

    const CALENDAR_CACHE_STORAGE_KEY = 'hd_calendar_cache_v2';
    const CALENDAR_CACHE_TTL_MS = 5 * 60 * 1000;
    const CALENDAR_CACHE_MAX_MONTHS = 18;
    const CALENDAR_PREFETCH_MONTHS_AHEAD = 2;

    const MONTH_NAMES = ["January","February","March","April","May","June",
                        "July","August","September","October","November","December"];
    const DAY_NAMES_FULL  = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const DAY_NAMES_SHORT = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    // DOM refs (resolved after DOMContentLoaded)
    let calGrid, calOverlay, calLoaderStatus, monthDisplay,
        slotsGrid, slotsBlock, slotsNav, slotsDayDisplay, headerTitle;

    // ------------------------------------------------------------------
    // FETCH
    // ------------------------------------------------------------------
    function getMonthKey(year, month) {
        return `${year}-${month}`;
    }

    function isMonthCacheFresh(key) {
        const ts = availableSlotsMeta[key];
        return Number.isFinite(ts) && (Date.now() - ts) < CALENDAR_CACHE_TTL_MS;
    }

    function pruneCalendarCache() {
        const now = Date.now();
        const keys = Object.keys(availableSlotsCache);

        keys.forEach(key => {
            const ts = Number(availableSlotsMeta[key]);
            if (!Number.isFinite(ts) || (now - ts) > CALENDAR_CACHE_TTL_MS) {
                delete availableSlotsCache[key];
                delete availableSlotsMeta[key];
                delete availableDaysIndexCache[key];
            }
        });

        const sorted = Object.keys(availableSlotsMeta).sort((a, b) => availableSlotsMeta[b] - availableSlotsMeta[a]);
        if (sorted.length > CALENDAR_CACHE_MAX_MONTHS) {
            sorted.slice(CALENDAR_CACHE_MAX_MONTHS).forEach(key => {
                delete availableSlotsCache[key];
                delete availableSlotsMeta[key];
                delete availableDaysIndexCache[key];
            });
        }
    }

    function persistCalendarCache() {
        try {
            pruneCalendarCache();
            const months = {};
            Object.keys(availableSlotsCache).forEach(key => {
                const ts = Number(availableSlotsMeta[key]);
                const slots = availableSlotsCache[key];
                if (!Number.isFinite(ts) || !Array.isArray(slots)) return;
                months[key] = { ts, slots };
            });
            localStorage.setItem(CALENDAR_CACHE_STORAGE_KEY, JSON.stringify({ version: 2, months }));
        } catch (e) {
            // localStorage can fail in private mode/quota pressure.
        }
    }

    function scheduleCalendarCachePersist() {
        clearTimeout(calendarCachePersistTimer);
        calendarCachePersistTimer = setTimeout(persistCalendarCache, 120);
    }

    function hydrateCalendarCacheFromStorage() {
        if (calendarCacheLoaded) return;
        calendarCacheLoaded = true;

        try {
            const raw = localStorage.getItem(CALENDAR_CACHE_STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (!parsed || parsed.version !== 2 || typeof parsed.months !== 'object' || !parsed.months) return;

            Object.entries(parsed.months).forEach(([key, entry]) => {
                if (!entry || !Array.isArray(entry.slots)) return;
                const ts = Number(entry.ts);
                if (!Number.isFinite(ts)) return;
                availableSlotsCache[key] = entry.slots;
                availableSlotsMeta[key] = ts;
            });

            pruneCalendarCache();
        } catch (e) {
            // Ignore malformed cache and continue with network fetches.
        }
    }

    function setMonthCache(key, slots) {
        availableSlotsCache[key] = Array.isArray(slots) ? slots : [];
        availableSlotsMeta[key] = Date.now();
        delete availableDaysIndexCache[key];
        pruneCalendarCache();
        scheduleCalendarCachePersist();
    }

    function clearCalendarCache() {
        availableSlotsCache = {};
        availableSlotsMeta = {};
        availableDaysIndexCache = {};
        monthFetchPromises = {};
        clearTimeout(calendarCachePersistTimer);
        try {
            localStorage.removeItem(CALENDAR_CACHE_STORAGE_KEY);
        } catch (e) {}
    }

    async function fetchMonth(year, month, applyMonthJump = true, showProgress = true) {
        hydrateCalendarCacheFromStorage();
        const key = getMonthKey(year, month);
        if (availableSlotsCache[key] !== undefined && isMonthCacheFresh(key)) return; // Fresh cache hit
        if (monthFetchPromises[key]) {
            await monthFetchPromises[key];
            return;
        }
        const separator = document.getElementById('loadingSeparator');
        if (showProgress && separator) separator.classList.add('loading-separator--active');
        monthFetchPromises[key] = (async () => {
            try {
            const res  = await fetch(`${APPS_SCRIPT_URL}?year=${year}&month=${month}`);
            const data = await res.json();
            if (data.success && Array.isArray(data.slots)) {
                const ay = data.resultYear  ?? year;
                const am = data.resultMonth ?? month;
                const returnedKey = getMonthKey(ay, am);
                if (ay === year && am === month) {
                    // Backend found a later month with free slots — jump there
                    setMonthCache(key, data.slots);
                } else {
                    setMonthCache(key, []);
                    setMonthCache(returnedKey, data.slots);
                    if (applyMonthJump) {
                        currentDate = new Date(ay, am, 1);
                    }
                }
            } else {
                setMonthCache(key, []);
            }
        } catch(e) {
            // Do not poison cache on silent prefetch failures; allow retries later.
            if (showProgress && availableSlotsCache[key] === undefined) setMonthCache(key, []);
        } finally {
                if (showProgress && separator) separator.classList.remove('loading-separator--active');
                delete monthFetchPromises[key];
            }
        })();

        await monthFetchPromises[key];
    }

    function prefetchNextMonthFrom(year, month) {
        // Warm upcoming months for smoother arrow navigation.
        for (let offset = 1; offset <= CALENDAR_PREFETCH_MONTHS_AHEAD; offset++) {
            const target = new Date(year, month + offset, 1);
            const targetYear = target.getFullYear();
            const targetMonth = target.getMonth();
            const targetKey = getMonthKey(targetYear, targetMonth);
            if ((availableSlotsCache[targetKey] !== undefined && isMonthCacheFresh(targetKey)) || monthFetchPromises[targetKey]) continue;
            fetchMonth(targetYear, targetMonth, false, false).catch(() => {});
        }
    }

    function getMinBookableDate() {
        const d = new Date();
        d.setDate(d.getDate() + 2);
        d.setHours(0, 0, 0, 0);
        return d;
    }

    function getAvailableDaysForMonth(year, month) {
        const key = getMonthKey(year, month);
        if (Array.isArray(availableDaysIndexCache[key])) {
            return availableDaysIndexCache[key];
        }
        const slots = availableSlotsCache[key] || [];
        const minDate = getMinBookableDate();
        const daysMap = new Map();

        slots.forEach(slot => {
            if (slot.status === 'busy') return;
            const day = Number(slot.date);
            if (!Number.isFinite(day)) return;
            const date = new Date(year, month, day);
            date.setHours(0, 0, 0, 0);
            const dow = date.getDay();
            if (date < minDate) return;
            if (dow === 0 || dow === 6) return;
            if (!daysMap.has(day)) daysMap.set(day, true);
        });

        const indexedDays = Array.from(daysMap.keys()).sort((a, b) => a - b);
        availableDaysIndexCache[key] = indexedDays;
        return indexedDays;
    }

    async function findAdjacentAvailableDate(direction) {
        if (direction !== 1 && direction !== -1) return null;

        const minDate = getMinBookableDate();
        const pivot = selectedDate ? new Date(selectedDate) : new Date(minDate);
        pivot.setHours(0, 0, 0, 0);
        if (pivot < minDate) pivot.setTime(minDate.getTime());
        // No valid dates exist before min bookable date, so do not scan months.
        if (direction === -1 && pivot <= minDate) return null;

        const maxMonthsToScan = 12;
        for (let offset = 0; offset < maxMonthsToScan; offset++) {
            const monthCursor = new Date(pivot.getFullYear(), pivot.getMonth() + (offset * direction), 1);
            const year = monthCursor.getFullYear();
            const month = monthCursor.getMonth();
            await fetchMonth(year, month, false, false);

            const days = getAvailableDaysForMonth(year, month);
            if (!days.length) continue;

            let candidateDay = null;
            if (offset === 0) {
                const pivotDay = pivot.getDate();
                if (direction === 1) {
                    candidateDay = selectedDate
                        ? (days.find(d => d > pivotDay) ?? null)
                        : (days.find(d => d >= pivotDay) ?? null);
                } else {
                    const before = days.filter(d => d < pivotDay);
                    candidateDay = before.length ? before[before.length - 1] : null;
                }
            } else {
                candidateDay = direction === 1 ? days[0] : days[days.length - 1];
            }

            if (candidateDay == null) continue;
            const candidate = new Date(year, month, candidateDay);
            candidate.setHours(0, 0, 0, 0);
            if (candidate < minDate) continue;
            return candidate;
        }

        return null;
    }

    function getAdjacentRenderedAvailableDayEl(direction) {
        const availableEls = Array.from(document.querySelectorAll('.cal-day.cal-day--has-slots'));
        if (!availableEls.length) return null;

        availableEls.sort((a, b) => Number(a.dataset.day) - Number(b.dataset.day));

        const renderedYear = Number(calGrid?.dataset.year);
        const renderedMonth = Number(calGrid?.dataset.month);
        const hasRenderedMeta = Number.isFinite(renderedYear) && Number.isFinite(renderedMonth);

        const sameMonthSelection = selectedDate && hasRenderedMeta &&
            selectedDate.getFullYear() === renderedYear &&
            selectedDate.getMonth() === renderedMonth;

        if (!sameMonthSelection) {
            return direction === 1 ? availableEls[0] : availableEls[availableEls.length - 1];
        }

        const pivotDay = selectedDate.getDate();
        if (direction === 1) {
            return availableEls.find(el => Number(el.dataset.day) > pivotDay) || null;
        }

        for (let i = availableEls.length - 1; i >= 0; i--) {
            if (Number(availableEls[i].dataset.day) < pivotDay) return availableEls[i];
        }
        return null;
    }

    // ------------------------------------------------------------------
    // RENDER CALENDAR
    // ------------------------------------------------------------------
    function setCalendarInnerTitle(dateValue) {
        if (!monthDisplay || !(dateValue instanceof Date) || Number.isNaN(dateValue.getTime())) return;
        monthDisplay.innerHTML = `<span class="cal-month cal-selected-day">${DAY_NAMES_FULL[dateValue.getDay()]} ${dateValue.getDate()}</span>`;
    }

    async function renderCalendar() {
        const renderToken = ++calendarRenderToken;
        const calWrapper = document.getElementById('bookingCalendar');

        // Show spinner
        calGrid.innerHTML = '';
        slotsGrid.innerHTML = '';
        slotsBlock.style.display = 'none';
        slotsDayDisplay.textContent = '';
        if (calWrapper) calWrapper.classList.add('calendar--loading');
        if (headerTitle) headerTitle.classList.add('calendar-title--loading');
        calOverlay.style.display = 'flex';
        if (calLoaderStatus) calLoaderStatus.textContent = 'Loading...';

        // Fetch (may update currentDate if backend jumps month)
        await fetchMonth(currentDate.getFullYear(), currentDate.getMonth());
        if (renderToken !== calendarRenderToken) return;

        const year  = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const slots = availableSlotsCache[getMonthKey(year, month)] || [];
        if (calGrid) {
            calGrid.dataset.year = String(year);
            calGrid.dataset.month = String(month);
        }
        prefetchNextMonthFrom(year, month);
        // Ensure no residual days from a stale parallel render.
        calGrid.innerHTML = '';

        // Update external title
        headerTitle.textContent = MONTH_NAMES[month].toUpperCase();

        // Build slot map
        const minDate = getMinBookableDate();

        const slotsMap = {};
        slots.forEach(s => {
            const d = new Date(year, month, s.date);
            d.setHours(0,0,0,0);
            if (d >= minDate) {
                if (!slotsMap[s.date]) slotsMap[s.date] = [];
                slotsMap[s.date].push(s);
            }
        });

        // Find nearest free weekday
        let nearestDay = null;
        for (const d of Object.keys(slotsMap).map(Number).sort((a,b)=>a-b)) {
            const date = new Date(year, month, d);
            if (date >= minDate && date.getDay() !== 0 && date.getDay() !== 6) {
                const free = slotsMap[d].filter(s => s.status !== 'busy');
                if (free.length) {
                    nearestDay = d;
                    absoluteNearestDate    = date;
                    nearestSlotData        = free[0];
                    nearestDayLastSlotData = free[free.length - 1];
                    break;
                }
            }
        }
        updateFooterBookBtn();

        // Inner title always uses "Weekday Day" and never switches to Month/Year.
        const selectedInViewMonth = selectedDate &&
            selectedDate.getMonth() === month &&
            selectedDate.getFullYear() === year;
        const fallbackDay = Number.isFinite(nearestDay)
            ? nearestDay
            : ((minDate.getFullYear() === year && minDate.getMonth() === month) ? minDate.getDate() : 1);
        const titleDate = selectedInViewMonth
            ? new Date(year, month, selectedDate.getDate())
            : new Date(year, month, fallbackDay);
        setCalendarInnerTitle(titleDate);

        // Day-name headers
        DAY_NAMES_SHORT.forEach(n => {
            const el = document.createElement('div');
            el.className = 'cal-day-name';
            el.textContent = n;
            calGrid.appendChild(el);
        });

        // Padding blanks
        const firstDow = new Date(year, month, 1).getDay();
        for (let i = 0; i < firstDow; i++) {
            const el = document.createElement('div');
            el.className = 'cal-day cal-day--empty';
            calGrid.appendChild(el);
        }

        // Toronto "today"
        const torNow = new Date(new Date().toLocaleString('en-US', {timeZone:'America/Toronto'}));
        torNow.setHours(0,0,0,0);

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        availableDaysCount = 0;
        let autoSelected = false;

        for (let day = 1; day <= daysInMonth; day++) {
            const el   = document.createElement('div');
            const date = new Date(year, month, day);
            el.className   = 'cal-day';
            el.dataset.day = day;
            const isPast   = date < torNow;
            const isSunday = date.getDay() === 0;
            const isSaturday = date.getDay() === 6;
            const isToday  = date.getTime() === torNow.getTime();

            if (isSaturday) {
                el.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
            } else {
                el.textContent = day;
            }

            if (isToday) el.classList.add('cal-day--today');

            if (isPast || isSunday) {
                el.classList.add('cal-day--disabled');
            } else if (isSaturday) {
                el.classList.add('cal-day--closed');
                el.onclick = () => selectClosedSaturday(day, el);
            } else if (slotsMap[day]) {
                const allBusy = slotsMap[day].every(s => s.status === 'busy');
                if (allBusy) {
                    el.classList.add('cal-day--busy', 'cal-day--disabled');
                } else {
                    el.classList.add('cal-day--has-slots');
                    el.style.setProperty('--i', availableDaysCount++);
                    el.dataset.slots = JSON.stringify(slotsMap[day]);
                    el.onclick = () => selectDay(day, el);

                    const isCurrentSelectedDay = selectedDate &&
                        selectedDate.getFullYear() === year &&
                        selectedDate.getMonth() === month &&
                        selectedDate.getDate() === day;

                    // Keep explicit selection when navigating; otherwise fallback to nearest free day.
                    if (!autoSelected && isCurrentSelectedDay) {
                        autoSelected = true;
                        setTimeout(() => selectDay(day, el, true), 200);
                    } else if (!autoSelected && day === nearestDay) {
                        autoSelected = true;
                        setTimeout(() => selectDay(day, el, true), 200);
                    }
                }
            } else {
                el.classList.add('cal-day--disabled');
            }

            calGrid.appendChild(el);
        }

        if (!autoSelected) {
            slotsDayDisplay.textContent = nearestDay
                ? 'Select a day to see available times'
                : 'No available slots this month.';
        }

        calOverlay.style.display = 'none';
        if (calWrapper) calWrapper.classList.remove('calendar--loading');
        if (headerTitle) headerTitle.classList.remove('calendar-title--loading');
        // Плавно показать календарь при загрузке слотов
        if (calWrapper) {
            setTimeout(() => {
                calWrapper.classList.add('calendar--loaded');
            }, 50);
        }

        // If no nearest day found this month, background-search next month
        if (!nearestDay) {
            let nextM = month + 1, nextY = year;
            if (nextM > 11) { nextM = 0; nextY++; }
            fetchMonth(nextY, nextM, false, false).then(() => {
                const nextSlots = availableSlotsCache[getMonthKey(nextY, nextM)];
                if (Array.isArray(nextSlots)) {
                    const minDate = getMinBookableDate();
                    for (const slot of nextSlots.filter(s => s.status !== 'busy').sort((a,b)=>a.date-b.date)) {
                        const d = new Date(nextY, nextM, slot.date);
                        if (d >= minDate && d.getDay() !== 0 && d.getDay() !== 6) {
                            absoluteNearestDate = d;
                            nearestSlotData = slot;
                            nearestDayLastSlotData = slot;
                            break;
                        }
                    }
                    updateFooterBookBtn();
                }
            });
        }
    }

    // ------------------------------------------------------------------
    // SELECT DAY -> show slots
    // ------------------------------------------------------------------
    function selectDay(day, el, isAuto = false) {
        document.querySelectorAll('.cal-day').forEach(d => d.classList.remove('cal-day--selected'));
        el.classList.add('cal-day--selected');

        selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        logEvent('Date Selected', selectedDate.toDateString());

        // Update nav title
        setCalendarInnerTitle(selectedDate);

        const raw = el.dataset.slots ? JSON.parse(el.dataset.slots) : [];
        const free = raw.filter(s => s.status !== 'busy');

        // Label
        slotsDayDisplay.textContent = free.length ? 'CHOOSE TIME:' : 'No available slots for this day.';
        slotsDayDisplay.style.opacity = '1';

        // Build slot buttons
        slotsGrid.innerHTML = '';
        free.forEach((slot, idx) => {
            const btn = document.createElement('button');
            btn.className = 'slot-btn slot-btn--hypnotic';
            const svg = getClockIcon(slot.text);
            let t = slot.text.split(/[-–]/)[0].trim().toUpperCase();
            const end = getEndTime(t).toUpperCase();
            btn.innerHTML = `<div class="slot-icon-wrapper">${svg}</div><div class="slot-time"><span style="font-weight: 800">${t} - ${end}</span></div>`;
            btn.style.setProperty('--i', availableDaysCount + idx);
            btn.style.setProperty('--slot-idx', idx);
            btn.onclick = () => { btn.classList.add('slot-btn--clicked'); setTimeout(() => openBookingModal(slot), 600); };
            slotsGrid.appendChild(btn);
        });

        slotsBlock.style.display = free.length ? 'block' : 'none';
        if (!free.length) {
            slotsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#fff;font-weight: 800;font-size:1.1rem;margin-top:16px">No available slots for this day.<br>Please select another day.</p>`;
            slotsBlock.style.display = 'block';
        }
    }

    function selectClosedSaturday(day, el) {
        document.querySelectorAll('.cal-day').forEach(d => d.classList.remove('cal-day--selected'));
        selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        logEvent('Closed Saturday Clicked', selectedDate.toDateString());

        setCalendarInnerTitle(selectedDate);
        slotsDayDisplay.textContent = 'SATURDAY IS CLOSED';
        slotsDayDisplay.style.opacity = '1';
        slotsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#fff;font-weight: 800;font-size:1.1rem;margin-top:16px">This day is closed.<br>Please choose another day.</p>`;
        slotsBlock.style.display = 'block';
    }

    // ------------------------------------------------------------------
    // EVENT LISTENERS
    // ------------------------------------------------------------------
    function setupEventListeners() {
        if (calendarListenersBound) return;
        calendarListenersBound = true;

        document.getElementById('prevBtn').addEventListener('click', async () => {
            if (calendarNavInProgress) return;
            calendarNavInProgress = true;
            try {
                const prevRenderedEl = getAdjacentRenderedAvailableDayEl(-1);
                if (prevRenderedEl) {
                    selectDay(Number(prevRenderedEl.dataset.day), prevRenderedEl, true);
                    return;
                }

                const prevAvailable = await findAdjacentAvailableDate(-1);
                if (!prevAvailable) return;
                selectedDate = prevAvailable;
                currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                await renderCalendar();
            } finally {
                calendarNavInProgress = false;
            }
        });
        document.getElementById('nextBtn').addEventListener('click', async () => {
            if (calendarNavInProgress) return;
            calendarNavInProgress = true;
            try {
                const nextRenderedEl = getAdjacentRenderedAvailableDayEl(1);
                if (nextRenderedEl) {
                    selectDay(Number(nextRenderedEl.dataset.day), nextRenderedEl, true);
                    return;
                }

                const nextAvailable = await findAdjacentAvailableDate(1);
                if (!nextAvailable) return;
                selectedDate = nextAvailable;
                currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                await renderCalendar();
            } finally {
                calendarNavInProgress = false;
            }
        });
    }


    let userIP = "Unknown";
    let userCountryCode = "CA";

    function detectCountryCode() {
        const lang = String(navigator.language || navigator.userLanguage || "").trim();
        const parts = lang.split("-");
        if (parts.length > 1 && /^[A-Za-z]{2}$/.test(parts[1])) {
            return parts[1].toUpperCase();
        }
        return "CA";
    }

    function detectOsLabel() {
        const ua = String(navigator.userAgent || "").toLowerCase();
        if (ua.includes("windows")) return "Windows";
        if (ua.includes("mac os") || ua.includes("macintosh")) return "macOS";
        if (ua.includes("android")) return "Android";
        if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ios")) return "iOS";
        if (ua.includes("linux")) return "Linux";
        return String(navigator.platform || "Unknown");
    }

    function getNetworkLabel() {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        if (!connection) return "Unknown";
        const type = connection.effectiveType || "n/a";
        const downlink = Number.isFinite(connection.downlink) ? `${connection.downlink}Mbps` : "n/a";
        const rtt = Number.isFinite(connection.rtt) ? `${connection.rtt}ms` : "n/a";
        return `${type}/${downlink}/${rtt}`;
    }

    function getClientContext() {
        const cores = Number.isFinite(navigator.hardwareConcurrency) ? navigator.hardwareConcurrency : "";
        const memoryGB = Number.isFinite(navigator.deviceMemory) ? navigator.deviceMemory : "";
        return {
            countryCode: userCountryCode || "CA",
            ip: userIP || "Unknown",
            lang: String(navigator.language || ""),
            os: detectOsLabel(),
            screenResolution: `${window.screen.width}x${window.screen.height}`,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            timezone: String((Intl.DateTimeFormat().resolvedOptions() || {}).timeZone || ""),
            cores: cores,
            memoryGB: memoryGB,
            network: getNetworkLabel(),
            touchPoints: Number.isFinite(navigator.maxTouchPoints) ? navigator.maxTouchPoints : 0,
            colorDepth: Number.isFinite(window.screen.colorDepth) ? window.screen.colorDepth : "",
            pageUrl: window.location.href,
            referrer: document.referrer || ""
        };
    }

    async function fetchUserIP() {
        userCountryCode = detectCountryCode();
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3500);
            const response = await fetch("https://api.ipify.org?format=json", { signal: controller.signal });
            clearTimeout(timeoutId);
            const data = await response.json();
            if (data && typeof data.ip === "string" && data.ip.trim()) {
                userIP = data.ip.trim();
            }
        } catch(e) {}
    }
    fetchUserIP();

    function getDetailedDeviceInfo() {
        const ctx = getClientContext();
        return `${ctx.countryCode}:${ctx.ip} | Lang: ${ctx.lang} | OS: ${ctx.os} | Res: ${ctx.screenResolution} | Viewport: ${ctx.viewport} | TZ: ${ctx.timezone} | Cores: ${ctx.cores || "n/a"} | Mem: ${ctx.memoryGB || "n/a"}GB | Net: ${ctx.network}`;
    }

    function getFingerprint() {
        // Simple persistent fingerprint using browser properties and localStorage
        let fp = localStorage.getItem('site_fp');
        if (!fp) {
            fp = 'fp_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('site_fp', fp);
        }
        return fp;
    }
    /**
     * Sends usage logs to the Google Apps Script spreadsheet.
     */
     async function logEvent(event, details = "", isSuspicious = false, severity = "", extra = {}) {
        const safeExtra = (extra && typeof extra === 'object') ? extra : {};
        const ctx = getClientContext();
        const getExtra = (key, fallback = "") => (Object.prototype.hasOwnProperty.call(safeExtra, key) ? safeExtra[key] : fallback);
        try {
            fetch(APPS_SCRIPT_URL, {
                method: "POST",
                keepalive: true,
                body: JSON.stringify({
                    action: "log",
                    event: event,
                    details: details,
                    suspicious: isSuspicious,
                    fingerprint: getFingerprint(),
                    userInfo: getDetailedDeviceInfo(),
                    severity: severity,
                    locationMapUrl: getExtra("locationMapUrl"),
                    locationCoords: getExtra("locationCoords"),
                    countryCode: ctx.countryCode,
                    ip: ctx.ip,
                    lang: ctx.lang,
                    os: ctx.os,
                    screenResolution: ctx.screenResolution,
                    viewport: ctx.viewport,
                    timezone: ctx.timezone,
                    cores: ctx.cores,
                    memoryGB: ctx.memoryGB,
                    network: ctx.network,
                    touchPoints: ctx.touchPoints,
                    colorDepth: ctx.colorDepth,
                    pageUrl: ctx.pageUrl,
                    referrer: ctx.referrer,
                    perfLoadPercent: getExtra("perfLoadPercent"),
                    perfProcess: getExtra("perfProcess"),
                    perfScript: getExtra("perfScript"),
                    perfBlockedMs: getExtra("perfBlockedMs"),
                    perfWindowMs: getExtra("perfWindowMs")
                })
            });
        } catch (e) { /* silent fail */ }
    }

    function initPerformanceHealthMonitor() {
        if (window.__hdPerfMonitorInitialized) return;
        window.__hdPerfMonitorInitialized = true;

        const monitor = {
            windowMs: 7000,
            remoteLogCooldownMs: 120000,
            highLoadThresholdPct: 28,
            startedAt: performance.now(),
            blockedLongTaskMs: 0,
            blockedFrameMs: 0,
            buckets: new Map(),
            lastRemoteLogAt: 0
        };

        function clipText(value, maxLen) {
            const text = String(value || "");
            if (text.length <= maxLen) return text;
            return text.slice(0, maxLen - 3) + "...";
        }

        function addBucket(processName, scriptName, durationMs) {
            const process = clipText(processName || "main-thread", 90);
            const script = clipText(scriptName || "inline/self", 180);
            const key = `${process}::${script}`;
            const existing = monitor.buckets.get(key) || { process, script, durationMs: 0, hits: 0 };
            existing.durationMs += durationMs;
            existing.hits += 1;
            monitor.buckets.set(key, existing);
        }

        function getTopBucket() {
            let top = null;
            monitor.buckets.forEach((bucket) => {
                if (!top || bucket.durationMs > top.durationMs) {
                    top = bucket;
                }
            });
            return top || { process: "idle", script: "none", durationMs: 0, hits: 0 };
        }

        function deriveLongTaskSource(entry) {
            const attribution = entry && Array.isArray(entry.attribution) && entry.attribution.length ? entry.attribution[0] : null;
            const process = attribution && attribution.name ? attribution.name : (entry && entry.name ? entry.name : "longtask");
            const script = attribution && (attribution.containerSrc || attribution.containerName || attribution.containerId)
                ? (attribution.containerSrc || attribution.containerName || attribution.containerId)
                : "inline/self";
            return { process, script };
        }

        if (window.PerformanceObserver) {
            try {
                const observer = new PerformanceObserver((list) => {
                    const entries = list.getEntries();
                    for (let i = 0; i < entries.length; i++) {
                        const entry = entries[i];
                        const duration = Number(entry.duration || 0);
                        if (!Number.isFinite(duration) || duration <= 0) continue;
                        monitor.blockedLongTaskMs += duration;
                        const src = deriveLongTaskSource(entry);
                        addBucket(src.process, src.script, duration);
                    }
                });
                observer.observe({ entryTypes: ["longtask"] });
            } catch (e) {
                console.warn("[PERF] Long Task observer is unavailable:", e && e.message ? e.message : e);
            }
        }

        let lastFrameTs = performance.now();
        const frameTick = (now) => {
            const delta = now - lastFrameTs;
            lastFrameTs = now;
            const overrun = delta - 16.7;
            if (overrun > 12) {
                monitor.blockedFrameMs += overrun;
                addBucket("frame-jank", "animation-frame", overrun);
            }
            requestAnimationFrame(frameTick);
        };
        requestAnimationFrame(frameTick);

        function flushPerfWindow() {
            const now = performance.now();
            const elapsedMs = Math.max(1, now - monitor.startedAt);
            const blockedMs = Math.max(monitor.blockedLongTaskMs, monitor.blockedFrameMs);
            const loadPercent = Math.min(100, (blockedMs / elapsedMs) * 100);
            const top = getTopBucket();

            console.log(
                `[PERF] Load ${loadPercent.toFixed(1)}% | Blocked ${blockedMs.toFixed(0)}ms/${elapsedMs.toFixed(0)}ms | Process: ${top.process} | Script: ${top.script}`
            );

            const nowTs = Date.now();
            const shouldRemoteLog = loadPercent >= monitor.highLoadThresholdPct && top.durationMs >= 120;
            if (shouldRemoteLog && (nowTs - monitor.lastRemoteLogAt) >= monitor.remoteLogCooldownMs) {
                monitor.lastRemoteLogAt = nowTs;
                logEvent(
                    "Performance Bottleneck",
                    `Load ${loadPercent.toFixed(1)}% | Blocked ${blockedMs.toFixed(0)}ms/${elapsedMs.toFixed(0)}ms | Process: ${top.process} | Script: ${top.script}`,
                    false,
                    "warning",
                    {
                        perfLoadPercent: loadPercent.toFixed(1),
                        perfBlockedMs: blockedMs.toFixed(0),
                        perfWindowMs: elapsedMs.toFixed(0),
                        perfProcess: top.process,
                        perfScript: top.script
                    }
                );
            }

            monitor.startedAt = now;
            monitor.blockedLongTaskMs = 0;
            monitor.blockedFrameMs = 0;
            monitor.buckets.clear();
        }

        setInterval(flushPerfWindow, monitor.windowMs);
        setTimeout(flushPerfWindow, monitor.windowMs + 900);
    }

    // --- Global Error Logging ---
    window.addEventListener('error', function(e) {
        logEvent('Frontend Error', `${e.message} at ${e.filename}:${e.lineno}`, false, "critical");
    });
    window.addEventListener('unhandledrejection', function(e) {
        logEvent('Unhandled Promise Rejection', e.reason ? e.reason.toString() : 'Unknown Reason', false, "critical");
    });

    // Input Visual State (keep white background if has text)
    const inputs = document.querySelectorAll('.contact-form__input, .contact-form__textarea');
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            if(input.value.trim() !== '') input.classList.add('contact-form__input--has-content');
            else input.classList.remove('contact-form__input--has-content');
            input.classList.remove('field-invalid');
        });
    });

    // Terms of Service Modal
    function openTermsModal() {
        const modal = document.getElementById('termsModal');
        if (modal) {
            modal.classList.add('modal--active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-is-open');
        }
    }

    function closeTermsModal() {
        const modal = document.getElementById('termsModal');
        if (modal) {
            modal.classList.remove('modal--active');
            document.body.style.overflow = 'auto';
            document.body.classList.remove('modal-is-open');
        }
    }

    function initFaqAccordionScrollReveal() {
        const faqRoot = document.querySelector('.faq--accordion');
        if (!faqRoot) return;

        const items = Array.from(faqRoot.querySelectorAll('.faq__item'));
        if (!items.length) return;

        // Start with all FAQ items collapsed.
        items.forEach((item) => item.classList.remove('is-open'));
        let activeItem = null;

        const syncA11y = () => {
            items.forEach((item) => {
                const q = item.querySelector('.faq__question');
                if (!q) return;
                q.setAttribute('aria-expanded', item.classList.contains('is-open') ? 'true' : 'false');
            });
        };

        const setOpenItem = (targetItem) => {
            if (activeItem === targetItem) return;
            activeItem = targetItem || null;
            items.forEach((item) => {
                item.classList.toggle('is-open', item === targetItem);
            });
            syncA11y();
        };

        const getCenteredVisibleItem = () => {
            const viewportCenter = window.innerHeight * 0.5;
            let closest = null;
            let minDistance = Number.POSITIVE_INFINITY;

            items.forEach((item) => {
                const rect = item.getBoundingClientRect();
                if (rect.bottom <= 0 || rect.top >= window.innerHeight) return;

                const itemCenter = rect.top + rect.height / 2;
                const distance = Math.abs(itemCenter - viewportCenter);
                if (distance < minDistance) {
                    minDistance = distance;
                    closest = item;
                }
            });

            return closest;
        };

        const faqIntersectsViewport = () => {
            const rect = faqRoot.getBoundingClientRect();
            return rect.bottom > 0 && rect.top < window.innerHeight;
        };

        let rafQueued = false;
        const syncOpenItemToViewportCenter = () => {
            rafQueued = false;
            if (!faqIntersectsViewport()) {
                setOpenItem(null);
                return;
            }
            setOpenItem(getCenteredVisibleItem());
        };

        const scheduleCenterSync = () => {
            if (rafQueued) return;
            rafQueued = true;
            requestAnimationFrame(syncOpenItemToViewportCenter);
        };

        items.forEach((item) => {
            const q = item.querySelector('.faq__question');
            if (!q) return;
            q.setAttribute('role', 'button');
            q.setAttribute('tabindex', '0');
            q.setAttribute('aria-expanded', 'false');

            q.addEventListener('click', () => {
                setOpenItem(item);
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                scheduleCenterSync();
            });

            q.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    q.click();
                }
            });
        });

        window.addEventListener('scroll', scheduleCenterSync, { passive: true });
        window.addEventListener('resize', scheduleCenterSync, { passive: true });
        syncA11y();
    }

    // Init
    window.addEventListener('DOMContentLoaded', () => {
        // Initialize custom select dropdown
        initializeCustomSelects();
        initFaqAccordionScrollReveal();
        initPerformanceHealthMonitor();
        attachFormAutoSave();
        initAutoGrowTextareas();
        
        // Midnight Reload: Reload the page at 00:00 every day
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() === 0) {
                location.reload();
            }
        }, 1000);

        // FAQ Long Press (8s) to enable/disable booking
        let faqTimer;
        const faqTitle = document.querySelector('.section-title[data-i18n="faqTitle"]');
        if (faqTitle) {
            const startFaqTimer = () => { 
                faqTimer = setTimeout(() => { 
                    const status = localStorage.getItem('booking_enabled') === 'false' ? 'ENABLED' : 'DISABLED';
                    localStorage.setItem('booking_enabled', status === 'ENABLED' ? 'true' : 'false');
                    alert(`System: Booking has been ${status} successfully.`);
                }, 8000); 
            };
            const stopFaqTimer = () => { clearTimeout(faqTimer); };
            faqTitle.addEventListener('mousedown', startFaqTimer);
            faqTitle.addEventListener('mouseup', stopFaqTimer);
            faqTitle.addEventListener('touchstart', startFaqTimer);
            faqTitle.addEventListener('touchend', stopFaqTimer);
        }

        // selectedDate starts as null — auto-select will pick the nearest available day

        // Resolve calendar DOM refs
        calGrid          = document.getElementById('calendarGrid');
        calOverlay       = document.getElementById('calendarLoaderOverlay');
        calLoaderStatus  = document.getElementById('calLoaderStatus') || { textContent: '' };
        monthDisplay     = document.getElementById('monthDisplay');
        slotsGrid        = document.getElementById('slotsGrid');
        slotsBlock       = document.getElementById('slotsBlock');
        slotsNav         = document.getElementById('slotsNav');
        slotsDayDisplay  = document.getElementById('slotsDayDisplay');
        headerTitle      = document.getElementById('calendarHeaderTitle');

        const termsCheckbox = document.getElementById('agreeTerms');
        if (termsCheckbox) {
            termsCheckbox.addEventListener('change', function() {
                const modalBody = document.querySelector('#bookingModal .modal__body');
                const termsWrap = document.querySelector('.contact-form__checkbox-wrapper.file-attach__terms');
                if (termsWrap) termsWrap.classList.remove('field-invalid');
                if (modalBody) modalBody.scrollTop = modalBody.scrollHeight;
            });
        }

        normalizeSlotNotFoundText();
        const preloaderTextObserver = new MutationObserver(() => normalizeSlotNotFoundText());
        document.querySelectorAll('.book-btn-preloader__text').forEach(el => {
            preloaderTextObserver.observe(el, { childList: true, characterData: true, subtree: true });
        });

        hydrateCalendarCacheFromStorage();
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        setupEventListeners();
        renderCalendar();
        scaleCalendar();
        document.body.setAttribute('role', 'main');
    });

    /**
     * Downscales the calendar section on small screens so proportions
     * look exactly like on the reference (desktop/loaded) image.
     * On wide screens no scaling is applied (scale = 1).
     */
    function scaleCalendar() {
        const inner = document.getElementById('calendarScaleInner');
        const wrapper = document.getElementById('calendarScaleWrapper');
        if (!inner || !wrapper) return;

        // Reset first to measure the natural width
        inner.style.transform = '';
        inner.style.width = '';
        wrapper.style.height = '';

        // Natural width of the calendar block (what it would be without scaling)
        const naturalWidth = inner.scrollWidth;
        // Available screen width (accounting for body padding/margin)
        const availableWidth = wrapper.offsetWidth;

        if (naturalWidth > availableWidth && availableWidth > 0) {
            const scale = availableWidth / naturalWidth;
            inner.style.transform = `scale(${scale})`;
            inner.style.transformOrigin = 'top left';
            inner.style.width = (naturalWidth) + 'px';
            // Collapse the wrapper to the scaled height so nothing below is pushed down
            // Increased buffer from 10px to 30px to prevent bottom border clipping
            const naturalHeight = inner.scrollHeight;
            wrapper.style.height = (naturalHeight * scale + 30) + 'px';
        } else {
            inner.style.transform = 'scale(1)';
            inner.style.width = '';
            wrapper.style.height = '';
        }
    }

    // Re-scale on window resize (orientation change etc.)
    window.addEventListener('resize', scaleCalendar);

    // Re-scale whenever the calendar content changes (slots load dynamically)
    const _calObserver = new MutationObserver(() => {
        // Debounce slightly to allow layout to settle
        clearTimeout(window._scaleTimer);
        window._scaleTimer = setTimeout(scaleCalendar, 80);
    });
    const _calTarget = document.getElementById('bookingCalendar');
    if (_calTarget) {
        _calObserver.observe(_calTarget, { childList: true, subtree: true, attributes: true });
    }

    function getClockIcon(timeRangeStr) {
        // Parse start time "10:00 AM" or "10:00 AM - ..."
        const startTime = timeRangeStr.split(/[–-]/)[0].trim(); // Get "10:00 AM"
        
        let hours = 12;
        let minutes = 0;
        
        // Robust parsing for "10:00", "10:00 AM", "10 AM", "10"
        const timeMatch = startTime.match(/(\d+)(?::(\d+))?/);
        if (timeMatch) {
            hours = parseInt(timeMatch[1]);
            minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
        }
        
        // Calculate angles
        // Hour hand: (Hours % 12) * 30deg + Minutes * 0.5deg
        const hourAngle = ((hours % 12) * 30) + (minutes * 0.5);
        
        // Minute hand: Minutes * 6deg
        const minuteAngle = minutes * 6;

        return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 100%; height: 100%;">
  <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2.2"/>
  <line x1="12" y1="12" x2="12" y2="8.2" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" style="transform-origin: 12px 12px; transform: rotate(${hourAngle}deg);" />
  <line x1="12" y1="12" x2="12" y2="5.3" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" style="transform-origin: 12px 12px; transform: rotate(${minuteAngle}deg);" />
</svg>`;
    }


    // (legacy renderCalendar removed — single version above is used)

    function selectDate(day, element, isAutoSelection = false) {
        // redirect to the canonical selectDay function
        selectDay(day, element, isAutoSelection);
    }

    // Modal & Form Handling
    let liveDraftTimer = null;
    let selectedSlotData = null;
    const modal = document.getElementById('bookingModal');
    const bookingTimeDisplay = document.getElementById('bookingTimeDisplay');
    const bookingStatus = document.getElementById('bookingStatus');
    const confirmBtn = document.getElementById('confirmBookingBtn');

    function openBookingModal(slot, triggerAttach = false) {

        try {
            selectedSlotData = slot;
            logEvent("Form Opened", slot.text);
            const tsInput = document.getElementById('formTimestamp');
            if (tsInput) tsInput.value = Date.now().toString();

            if (!selectedDate) {
                console.error("Selected date is null");
                return;
            }

            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const dateFormatted = `${year}.${month}.${day}`;

            let startTime = slot.text;
            if (startTime && (startTime.includes('-') || startTime.includes('–'))) {
                startTime = startTime.split(/[-–]/)[0].trim();
            }
            
            let endTime = "1 hr later";
            try {
                endTime = getEndTime(startTime); 
            } catch(e) {
                console.warn("Could not calculate end time", e);
                logEvent('Time Calc Warning', e.message, false, "warning");
            }
            
            if(bookingTimeDisplay) {
                bookingTimeDisplay.innerHTML = `${dateFormatted} at <strong>${startTime} - ${endTime}</strong>`;
            }
            
            const modalAppointmentTime = document.getElementById('modalAppointmentTime');
            if(modalAppointmentTime) {
                modalAppointmentTime.innerHTML = `${dateFormatted} at <strong style="font-weight: 800;">${startTime} - ${endTime}</strong>`;
            }
            
            if(modal) {
                window.scrollTo(0, 0);
                modal.classList.add('modal--active');
                modal.dataset.state = 'form';
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-is-open');
            }

            clearBookingError();
            document.querySelectorAll('.field-invalid').forEach(el => el.classList.remove('field-invalid'));
            if(confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Book Now';
            }
            
            loadFormData();
            initAutoGrowTextareas();

            if (triggerAttach) {
                setTimeout(() => {
                    const fileInput = document.getElementById('fileAttachInput');
                    if (fileInput) fileInput.click();
                }, 800);
            }

            // Start live drafting (Debounced on-demand saving)
            const form = document.querySelector('#bookingForm');
            if (form) {
                // Debounce helper to prevent network spam while typing
                function debounce(func, wait) {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                }

                const triggerDraftSave = debounce(() => {
                    const formData = new FormData(form);
                    const draftData = {
                        action: 'draft',
                        name: sanitize(formData.get('name')),
                        email: sanitize(formData.get('email')),
                        phone: sanitize(formData.get('phone')),
                        service: sanitize(formData.get('service')),
                        notes: sanitize(formData.get('notes')),
                        userInfo: getDetailedDeviceInfo(),
                        fingerprint: getFingerprint()
                    };

                    // Only send if at least one meaningful field is partially filled
                    if (draftData.name || draftData.email || draftData.phone || draftData.service || draftData.notes) {
                        fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify(draftData)
                        }).catch(e => console.error('Draft HTTP error:', e));
                    }
                }, 2000); // 2 seconds of zero typing before sending

                // Listen to any input changes inside the form
                form.addEventListener('input', triggerDraftSave);
                form.addEventListener('change', triggerDraftSave);
            }
        } catch (error) {
            console.error("Error opening booking modal:", error);
            alert("Sorry, could not open the booking form. " + error.message);
        }
    }

    function closeBookingModal() {
        closeCameraCaptureModal();
        const isSuccess = modal && modal.dataset.state === 'success';
        if(modal) modal.classList.remove('modal--active');
        document.body.style.overflow = 'auto';
        document.body.classList.remove('modal-is-open');

        // If we just successfully booked, reload the page to refresh slots
        if (isSuccess) {
            setTimeout(() => {
                location.reload();
            }, 500);
        }
    }

    // closeTermsModal is defined above (single version), removed duplicate here

    // --- Security: sanitize user input before sending ---
    function sanitize(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
    }

    // File Attachment Handling
    const MAX_FILE_SIZE = 99 * 1024 * 1024;  // 99 MB per file
    const MAX_TOTAL_SIZE = 250 * 1024 * 1024; // 250 MB total
    const MAX_FILE_COUNT = 10;
    const ALLOWED_MIME_TYPES = new Set([
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    ]);
    const ALLOWED_EXTENSIONS = new Set(['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'pdf', 'doc', 'docx']);

    let attachedFiles = [];
    const fileInput = document.getElementById('fileAttachInput');
    const cameraFallbackInput = document.getElementById('cameraFallbackInput');
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const fileListEl = document.getElementById('fileAttachList');
    const fileAttachZone = document.querySelector('.file-attach');
    const cameraCaptureModal = document.getElementById('cameraCaptureModal');
    const cameraPreviewEl = document.getElementById('cameraPreview');
    const cameraCaptureStatus = document.getElementById('cameraCaptureStatus');
    const cameraSnapBtn = document.getElementById('cameraSnapBtn');
    const cameraCancelBtn = document.getElementById('cameraCancelBtn');
    let cameraStream = null;

    function getTotalFileSize() {
        return attachedFiles.reduce((sum, f) => sum + f.size, 0);
    }

    function isAllowedFile(file) {
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        const mime = (file.type || '').toLowerCase();
        const imageAllowed = mime.startsWith('image/');
        return imageAllowed || ALLOWED_MIME_TYPES.has(mime) || ALLOWED_EXTENSIONS.has(ext);
    }

    function addSelectedFiles(newFiles) {
        if (!Array.isArray(newFiles) || !newFiles.length) return;
        const rejected = [];

        newFiles.forEach(f => {
            if (attachedFiles.length >= MAX_FILE_COUNT) {
                rejected.push(`${f.name}: max ${MAX_FILE_COUNT} files`);
            } else if (f.size > MAX_FILE_SIZE) {
                rejected.push(`${f.name}: exceeds 99 MB`);
            } else if (getTotalFileSize() + f.size > MAX_TOTAL_SIZE) {
                rejected.push(`${f.name}: total exceeds 250 MB`);
            } else if (!isAllowedFile(f)) {
                rejected.push(`${f.name}: unsupported file type`);
            } else {
                attachedFiles.push(f);
            }
        });

        if (rejected.length > 0) {
            alert('Some files were rejected:\n' + rejected.join('\n'));
        }
        logEvent("Files Attached", `${attachedFiles.length} files`);
        renderFileList();
    }

    function setCameraStatus(message) {
        if (cameraCaptureStatus) {
            cameraCaptureStatus.textContent = message || '';
        }
    }

    function stopCameraCaptureStream() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        if (cameraPreviewEl) {
            cameraPreviewEl.pause();
            cameraPreviewEl.srcObject = null;
        }
    }

    function closeCameraCaptureModal() {
        if (cameraCaptureModal) {
            cameraCaptureModal.classList.remove('camera-capture-modal--active');
            cameraCaptureModal.setAttribute('aria-hidden', 'true');
        }
        stopCameraCaptureStream();
        setCameraStatus('Allow camera access, then press Capture.');
    }

    async function openCameraCaptureModal() {
        if (!cameraCaptureModal || !cameraPreviewEl) {
            if (cameraFallbackInput) cameraFallbackInput.click();
            return;
        }

        cameraCaptureModal.classList.add('camera-capture-modal--active');
        cameraCaptureModal.setAttribute('aria-hidden', 'false');
        setCameraStatus('Requesting camera access...');

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setCameraStatus('Camera API is unavailable. Opening device camera...');
            if (cameraFallbackInput) cameraFallbackInput.click();
            return;
        }

        try {
            stopCameraCaptureStream();
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            });
            cameraPreviewEl.srcObject = cameraStream;
            await cameraPreviewEl.play();
            setCameraStatus('Frame the document and press Capture.');
        } catch (err) {
            setCameraStatus('Camera access denied/unavailable. Opening device camera...');
            if (cameraFallbackInput) cameraFallbackInput.click();
        }
    }

    async function capturePhotoFromCamera() {
        if (!cameraPreviewEl || !cameraPreviewEl.srcObject) {
            setCameraStatus('Camera is not ready yet.');
            return;
        }

        const width = cameraPreviewEl.videoWidth || 1280;
        const height = cameraPreviewEl.videoHeight || 720;
        if (!width || !height) {
            setCameraStatus('Camera frame is not available yet. Please try again.');
            return;
        }

        if (cameraSnapBtn) cameraSnapBtn.disabled = true;
        try {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                setCameraStatus('Could not capture image.');
                return;
            }
            ctx.drawImage(cameraPreviewEl, 0, 0, width, height);

            await new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    if (!blob) {
                        setCameraStatus('Could not create photo file.');
                        resolve();
                        return;
                    }

                    const stamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const photoFile = new File([blob], `document-photo-${stamp}.jpg`, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });

                    addSelectedFiles([photoFile]);
                    closeCameraCaptureModal();
                    resolve();
                }, 'image/jpeg', 0.9);
            });
        } finally {
            if (cameraSnapBtn) cameraSnapBtn.disabled = false;
        }
    }

    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const newFiles = Array.from(this.files || []);
            addSelectedFiles(newFiles);
            this.value = ''; // Reset input
        });
    }

    if (cameraFallbackInput) {
        cameraFallbackInput.addEventListener('change', function() {
            const newFiles = Array.from(this.files || []);
            addSelectedFiles(newFiles);
            this.value = '';
            closeCameraCaptureModal();
        });
    }

    if (takePhotoBtn) {
        takePhotoBtn.addEventListener('click', () => {
            openCameraCaptureModal();
        });
    }

    if (cameraCancelBtn) {
        cameraCancelBtn.addEventListener('click', () => {
            closeCameraCaptureModal();
        });
    }

    if (cameraSnapBtn) {
        cameraSnapBtn.addEventListener('click', () => {
            capturePhotoFromCamera();
        });
    }

    if (cameraCaptureModal) {
        cameraCaptureModal.addEventListener('click', (e) => {
            if (e.target === cameraCaptureModal) {
                closeCameraCaptureModal();
            }
        });
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && cameraCaptureModal && cameraCaptureModal.classList.contains('camera-capture-modal--active')) {
            closeCameraCaptureModal();
        }
    });

    if (fileAttachZone) {
        let dragDepth = 0;

        const onDragEnter = (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDepth++;
            fileAttachZone.classList.add('file-attach--drag-over');
        };

        const onDragOver = (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileAttachZone.classList.add('file-attach--drag-over');
        };

        const onDragLeave = (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDepth = Math.max(0, dragDepth - 1);
            if (dragDepth === 0) {
                fileAttachZone.classList.remove('file-attach--drag-over');
            }
        };

        const onDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDepth = 0;
            fileAttachZone.classList.remove('file-attach--drag-over');
            const droppedFiles = Array.from((e.dataTransfer && e.dataTransfer.files) || []);
            addSelectedFiles(droppedFiles);
        };

        fileAttachZone.addEventListener('dragenter', onDragEnter);
        fileAttachZone.addEventListener('dragover', onDragOver);
        fileAttachZone.addEventListener('dragleave', onDragLeave);
        fileAttachZone.addEventListener('drop', onDrop);
    }

    function renderFileList() {
        if (!fileListEl) return;
        fileListEl.innerHTML = '';
        attachedFiles.forEach((file, i) => {
            const item = document.createElement('div');
            item.className = 'file-attach__item';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'file-attach__name';
            nameSpan.textContent = `${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            item.appendChild(nameSpan);
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'file-attach__remove';
            removeBtn.textContent = '\u00D7';
            removeBtn.addEventListener('click', () => removeFile(i));
            item.appendChild(removeBtn);
            
            const progress = document.createElement('div');
            progress.className = 'file-attach__progress';
            item.appendChild(progress);

            fileListEl.appendChild(item);
        });
    }

    function removeFile(index) {
        attachedFiles.splice(index, 1);
        renderFileList();
    }

    async function processFiles() {
        const filesData = [];
        if (attachedFiles.length > 0) {
            const fileItems = document.getElementById('fileAttachList').children;

            for (let i = 0; i < attachedFiles.length; i++) {
                const file = attachedFiles[i];
                if (fileItems[i]) {
                    const bar = fileItems[i].querySelector('.file-attach__progress');
                    if (bar) bar.style.width = '100%';
                }
                await new Promise(r => setTimeout(r, 300)); // Visual delay

                const base64 = await fileToBase64(file);
                filesData.push({
                    name: file.name,
                    type: file.type,
                    data: base64
                });
            }
        }
        return filesData;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data:... prefix
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Rate limiting: track last submission time
    let lastBookingTime = 0;

    // localStorage Form Data Management
    const FORM_STORAGE_KEY = 'bookingFormData';

    function saveFormData() {
        try {
            const form = document.getElementById('bookingForm');
            if (!form) return;
            
            const formData = new FormData(form);
            const data = {
                name: formData.get('name') || '',
                email: formData.get('email') || '',
                phone: formData.get('phone') || '',
                service: formData.get('service') || '',
                notes: formData.get('notes') || '',
                address_street: formData.get('address_street') || '',
                address_zip: formData.get('address_zip') || '',
                dob_year: formData.get('dob_year') || '',
                dob_month: formData.get('dob_month') || '',
                dob_day: formData.get('dob_day') || '',
                agreeTerms: document.getElementById('agreeTerms')?.checked || false
            };
            
            localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(data));
        } catch (err) {
            console.warn('Could not save form data:', err);
        }
    }

    function loadFormData() {
        try {
            const savedData = localStorage.getItem(FORM_STORAGE_KEY);
            if (!savedData) return;
            
            const data = JSON.parse(savedData);
            const form = document.getElementById('bookingForm');
            if (!form) return;
            
            // Populate form fields
            if (data.name) form.name.value = data.name;
            if (data.email) form.email.value = data.email;
            if (data.phone) form.phone.value = data.phone;
            if (data.address_full) form.address_full.value = data.address_full;
            if (data.notes) form.notes.value = data.notes;
            if (data.dob_year) form.dob_year.value = data.dob_year;
            if (data.dob_month) form.dob_month.value = data.dob_month;
            if (data.dob_day) form.dob_day.value = data.dob_day;
            
            if (data.agreeTerms) {
                document.getElementById('agreeTerms').checked = true;
            }
            
            // Restore service selection
            if (data.service) {
                const serviceInput = document.getElementById('serviceInput');
                if (serviceInput) serviceInput.value = data.service;
                
                const trigger = document.querySelector('.custom-select__trigger span');
                if (trigger) trigger.textContent = data.service;
                
                const options = document.querySelectorAll('.custom-option');
                options.forEach(opt => {
                    if (opt.textContent.trim() === data.service) {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });
            }

            initAutoGrowTextareas();
        } catch (err) {
            console.warn('Could not load form data:', err);
        }
    }

    function clearFormData() {
        try {
            localStorage.removeItem(FORM_STORAGE_KEY);
        } catch (err) {
            console.warn('Could not clear form data:', err);
        }
    }

    function fitTextareaHeight(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto';
        const minHeight = parseFloat(window.getComputedStyle(textarea).minHeight) || 0;
        textarea.style.height = `${Math.max(textarea.scrollHeight, minHeight)}px`;
    }

    function initAutoGrowTextareas() {
        const textareas = document.querySelectorAll('#bookingForm .contact-form__textarea');
        textareas.forEach(textarea => {
            if (!textarea._autoGrowBound) {
                textarea.addEventListener('input', () => fitTextareaHeight(textarea));
                textarea._autoGrowBound = true;
            }
            fitTextareaHeight(textarea);
        });
    }

    function attachFormAutoSave() {
        const inputs = document.querySelectorAll('#bookingForm input, #bookingForm textarea, #bookingForm select');
        inputs.forEach(input => {
            input.addEventListener('change', saveFormData);
            input.addEventListener('input', saveFormData);
        });
        // Also save when custom select changes
        const customOptions = document.querySelectorAll('.custom-option');
        customOptions.forEach(option => {
            option.addEventListener('click', () => {
                setTimeout(saveFormData, 100);
            });
        });
    }

    function normalizeSingleLine(value) {
        return String(value || '').replace(/\s+/g, ' ').trim();
    }

    function normalizeMultiLine(value) {
        return String(value || '').replace(/\r\n/g, '\n').replace(/[ \t]+\n/g, '\n').trim();
    }

    function clearBookingError() {
        if (!bookingStatus) return;
        bookingStatus.textContent = '';
        bookingStatus.classList.remove('status-alert--visible');
    }

    function markInvalidField(fieldEl) {
        if (!fieldEl || !fieldEl.classList) return;
        fieldEl.classList.remove('field-invalid');
        // Force reflow so repeated invalid attempts replay the animation.
        void fieldEl.offsetWidth;
        fieldEl.classList.add('field-invalid');
        if (typeof fieldEl.focus === 'function') {
            try { fieldEl.focus({ preventScroll: true }); } catch (e) { fieldEl.focus(); }
        }
    }

    function setBookingError(message, fieldEl = null) {
        if (!bookingStatus) return;
        bookingStatus.textContent = message;
        bookingStatus.classList.remove('status-alert--visible');
        void bookingStatus.offsetWidth;
        bookingStatus.classList.add('status-alert--visible');
        markInvalidField(fieldEl);
    }

    function validateAndNormalizeBookingForm(form) {
        const name = normalizeSingleLine(form.name?.value);
        const occupation = normalizeSingleLine(form.occupation?.value);
        const email = normalizeSingleLine(form.email?.value).toLowerCase();
        const phone = normalizeSingleLine(form.phone?.value);
        const street = normalizeSingleLine(form.address_street?.value);
        const zip = normalizeSingleLine(form.address_zip?.value).toUpperCase();
        const notes = normalizeMultiLine(form.notes?.value);
        const serviceInput = document.getElementById('serviceInput');
        const service = normalizeSingleLine(serviceInput?.value);
        const serviceTrigger = document.querySelector('#customSelect .custom-select__trigger');
        const termsWrap = document.querySelector('.contact-form__checkbox-wrapper.file-attach__terms');

        if (name.length < 2 || name.length > 80 || /[<>]/.test(name)) {
            setBookingError('Please enter a valid name (2-80 characters).', form.name);
            return false;
        }
        if (occupation.length < 2 || occupation.length > 100 || /[<>]/.test(occupation)) {
            setBookingError('Please enter a valid occupation (2-100 characters).', form.occupation);
            return false;
        }

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
        if (email.length > 120 || !emailPattern.test(email)) {
            setBookingError('Please enter a valid email address.', form.email);
            return false;
        }

        const phoneDigits = phone.replace(/\D/g, '');
        if (!/^[+\d().\-\s]+$/.test(phone) || phoneDigits.length < 10 || phoneDigits.length > 15) {
            setBookingError('Please enter a valid phone number.', form.phone);
            return false;
        }

        if (street.length < 6 || street.length > 150 || /[<>]/.test(street)) {
            setBookingError('Please enter a valid street address (6-150 characters).', form.address_street);
            return false;
        }

        const zipPattern = /^[A-Z]\d[A-Z]\d[A-Z]\d$/;
        if (!zipPattern.test(zip.replace(/\s/g, ''))) {
            setBookingError('Please enter a valid postal code (e.g., M5V 2T6).', form.address_zip);
            return false;
        }

        if (notes.length > 3000 || /[<>]/.test(notes)) {
            setBookingError('Brief details are too long or contain invalid characters.', form.notes);
            return false;
        }

        const allowedServices = new Set(
            Array.from(document.querySelectorAll('.custom-option')).map(opt => normalizeSingleLine(opt.textContent))
        );
        if (!service || !allowedServices.has(service)) {
            setBookingError('Please choose a valid service from the list.', serviceTrigger);
            return false;
        }

        const dobYear = Number(form.dob_year?.value);
        const dobMonth = Number(form.dob_month?.value);
        const dobDay = Number(form.dob_day?.value);
        const currentYear = new Date().getFullYear();
        if (!Number.isInteger(dobYear) || dobYear < 1900 || dobYear > currentYear) {
            setBookingError('Please enter a valid birth year.', form.dob_year);
            return false;
        }
        if (!Number.isInteger(dobMonth) || dobMonth < 1 || dobMonth > 12) {
            setBookingError('Please enter a valid birth month.', form.dob_month);
            return false;
        }
        if (!Number.isInteger(dobDay) || dobDay < 1 || dobDay > 31) {
            setBookingError('Please enter a valid birth day.', form.dob_day);
            return false;
        }

        if (!document.getElementById('agreeTerms')?.checked) {
            setBookingError('Please confirm Terms of Service.', termsWrap);
            return false;
        }

        clearBookingError();
        form.name.value = name;
        form.occupation.value = occupation;
        form.email.value = email;
        form.phone.value = phone;
        form.address_street.value = street;
        form.address_zip.value = zip;
        form.notes.value = notes;
        if (serviceInput) serviceInput.value = service;
        fitTextareaHeight(form.notes);
        return true;
    }

    // Final booking result helpers.
    // Usage:
    // 1) Submit flow calls buildFinalResultMarkup(summary) after a successful API response.
    // 2) The returned markup is injected into #bookingModal .modal__body.
    // 3) summary must contain: name, email, phone, service, address, dob, dateStr, slotText, filesCount.
    function formatFinalDate(isoValue) {
        if (!isoValue || typeof isoValue !== 'string') return '';
        const datePart = isoValue.split('T')[0];
        const parts = datePart.split('-');
        if (parts.length !== 3) return datePart;
        return `${parts[0]}.${parts[1]}.${parts[2]}`;
    }

    function formatFinalFieldValue(value, fallback = 'Not provided') {
        const raw = value == null ? '' : String(value).trim();
        const fallbackRaw = fallback == null ? '' : String(fallback).trim();
        return sanitize(raw || fallbackRaw || 'Not provided');
    }

    function buildFinalResultMarkup(summary) {
        const appointmentDate = formatFinalDate(summary.dateStr);
        const appointmentRaw = appointmentDate && summary.slotText
            ? `${appointmentDate} at ${summary.slotText}`
            : (appointmentDate || summary.slotText || '');
        const filesCount = Number.isInteger(summary.filesCount) ? summary.filesCount : 0;

        return `
            <div class="final-result-form">
                <div class="final-result-form__icon">
                    <svg width="62" height="62" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 12px rgba(90, 61, 42, 0.4));">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <p class="final-result-form__hello">Thank you, ${formatFinalFieldValue(summary.name, 'Client')}.</p>
                <p class="final-result-form__lead">Your intake request was submitted successfully.</p>

                <div class="final-result-grid">
                    <div class="final-result-field">
                        <span class="final-result-label">Name</span>
                        <div class="final-result-value">${formatFinalFieldValue(summary.name)}</div>
                    </div>
                    <div class="final-result-field">
                        <span class="final-result-label">Email</span>
                        <div class="final-result-value">${formatFinalFieldValue(summary.email)}</div>
                    </div>
                    <div class="final-result-field">
                        <span class="final-result-label">Phone</span>
                        <div class="final-result-value">${formatFinalFieldValue(summary.phone)}</div>
                    </div>
                    <div class="final-result-field">
                        <span class="final-result-label">Service</span>
                        <div class="final-result-value">${formatFinalFieldValue(summary.service)}</div>
                    </div>
                    <div class="final-result-field final-result-field--full">
                        <span class="final-result-label">Appointment</span>
                        <div class="final-result-value">${formatFinalFieldValue(appointmentRaw, 'Not available')}</div>
                    </div>
                    <div class="final-result-field final-result-field--full">
                        <span class="final-result-label">Address</span>
                        <div class="final-result-value">${formatFinalFieldValue(summary.address)}</div>
                    </div>
                    <div class="final-result-field">
                        <span class="final-result-label">Date of Birth</span>
                        <div class="final-result-value">${formatFinalFieldValue(summary.dob)}</div>
                    </div>
                    <div class="final-result-field">
                        <span class="final-result-label">Files</span>
                        <div class="final-result-value">${formatFinalFieldValue(`${filesCount} attached`)}</div>
                    </div>
                </div>

                <p class="final-result-warning">
                    This intake form is for preliminary review only and does not create a paralegal-client relationship.
                </p>
                <p class="final-result-warning">
                    <strong>Important (Ontario):</strong> Submitting this form does not create a paralegal-client relationship. Please call during business hours to confirm your details and next steps.
                </p>
                <p class="final-result-warning">
                    If your matter is time-sensitive and you cannot reach us promptly, please do not wait - contact another licensed Ontario paralegal or lawyer right away.
                </p>
                <div class="final-result-actions modal-sticky-actions">
                    <a href="tel:+14372396833" class="contact-form__submit-button final-result-call">Call +1 (437) 239-6833</a>
                    <button type="button" onclick="location.reload()" class="contact-form__submit-button final-result-done">Done</button>
                </div>
            </div>
        `;
    }

    // Main submit entrypoint for #bookingForm.
    // Flow: validate -> send -> on success render final read-only summary in the same modal.
    async function handleBookingSubmit(e) {
        e.preventDefault();
        const form = e.target;
        clearBookingError();
        document.querySelectorAll('.field-invalid').forEach(el => el.classList.remove('field-invalid'));
        if (!validateAndNormalizeBookingForm(form)) return;

        const formData = new FormData(form);
        if (!formData.get('service')) {
            const serviceTrigger = document.querySelector('#customSelect .custom-select__trigger');
            setBookingError('Please choose a service from the list.', serviceTrigger);
            return;
        }

        // Age Validation: Must be 18+
        const dobYear = parseInt(formData.get('dob_year'));
        const dobMonth = parseInt(formData.get('dob_month'));
        const dobDay = parseInt(formData.get('dob_day'));
        const maxDays = new Date(dobYear, dobMonth, 0).getDate();
        if (dobDay < 1 || dobDay > maxDays || isNaN(dobDay)) {
            setBookingError('Invalid date of birth. Please check the day and month.', form.dob_day);
            return;
        }

        const today = new Date();
        let age = today.getFullYear() - dobYear;
        const m = (today.getMonth() + 1) - dobMonth;
        if (m < 0 || (m === 0 && today.getDate() < dobDay)) {
            age--;
        }
        if (age < 18) {
            setBookingError('You must be at least 18 years old to book services.', form.dob_year);
            return;
        }

        const now = Date.now();
        if (now - lastBookingTime < 60000) {
            setBookingError('Please wait 60 seconds before booking again.', form.name);
            return;
        }

        const summary = {
            name: String(formData.get('name') || '').trim(),
            email: String(formData.get('email') || '').trim(),
            phone: String(formData.get('phone') || '').trim(),
            service: String(formData.get('service') || '').trim(),
            address: `${String(formData.get('address_street') || '').trim()}, ${String(formData.get('address_zip') || '').trim()}`,
            dob: `${String(formData.get('dob_year') || '').trim()}-${String(formData.get('dob_month') || '').trim()}-${String(formData.get('dob_day') || '').trim()}`,
            dateStr: selectedSlotData ? selectedSlotData.iso : '',
            slotText: selectedSlotData ? String(selectedSlotData.text || '').trim() : '',
            filesCount: 0
        };

        const globalSpinner = document.getElementById('globalSpinner');
        if (globalSpinner) globalSpinner.style.display = 'flex';
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Submitting...';
        }

        let isSuccess = false;
        try {
            const filesPayload = await processFiles();
            summary.filesCount = filesPayload.length;

            const bookingData = {
                year: selectedSlotData.iso.split('T')[0].split('-')[0],
                month: parseInt(selectedSlotData.iso.split('T')[0].split('-')[1]) - 1,
                day: parseInt(selectedSlotData.iso.split('T')[0].split('-')[2]),
                hour: parseInt(selectedSlotData.iso.split('T')[1].split(':')[0]),
                minute: parseInt(selectedSlotData.iso.split('T')[1].split(':')[1]),
                name: sanitize(summary.name),
                occupation: sanitize(formData.get('occupation')),
                email: sanitize(summary.email),
                phone: sanitize(summary.phone),
                service: sanitize(summary.service),
                notes: sanitize(formData.get('notes')),
                dateStr: selectedSlotData.iso,
                dob: sanitize(summary.dob),
                address: sanitize(summary.address),
                files: filesPayload,
                fingerprint: getFingerprint(),
                userInfo: getDetailedDeviceInfo(),
                _honeypot: formData.get('website') || '',
                _timestamp: formData.get('_timestamp') || ''
            };

            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(bookingData),
            });
            const result = await response.json();

            if (result.success) {
                isSuccess = true;
                playSuccessSound();
                lastBookingTime = Date.now();
                clearFormData();
                clearCalendarCache();

                const modalBody = document.querySelector('#bookingModal .modal__body');
                const modalTitle = document.querySelector('#bookingModal .modal__title');
                if (modalTitle) modalTitle.innerHTML = 'INTAKE REQUEST SUBMITTED';
                if (modalBody) modalBody.innerHTML = buildFinalResultMarkup(summary);
                if (modal) modal.dataset.state = 'success';

                logEvent('Booking Success', `Client: ${bookingData.name} | Slot: ${bookingData.dateStr}`);
            } else if (result.error === 'SLOT_TAKEN') {
                alert("This slot was just taken! We are assigning you to the nearest available slot so you don't have to fill the form again.");
                bookNearestSlot();
                return;
            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error(err);
            setBookingError('Error: ' + err.message);
            logEvent('Booking Submit Error', err.message, false, "critical");
        } finally {
            if (globalSpinner) globalSpinner.style.display = 'none';
            if (!isSuccess && confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Book Now';
            }
        }
    }

    // ------------------------------------------------------------------
    // AUDIO SYSTEM (Glassy Chimes)
    // ------------------------------------------------------------------
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playTone(freq, type, duration, delay = 0) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + delay);
        osc.stop(audioCtx.currentTime + delay + duration);
    }

    function playSuccessSound() {
        playTone(523.25, 'sine', 1.5, 0);   // C5
        playTone(659.25, 'sine', 1.5, 0.1); // E5
        playTone(783.99, 'sine', 1.5, 0.2); // G5
        playTone(1046.50, 'sine', 2.5, 0.3); // C6
    }
    
    document.addEventListener('click', function initAudio() {
        if(audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        document.removeEventListener('click', initAudio);
    }, { once: true });

    // Heart animation and click counter on coffee cups
    let coffeeClicks = 0;
    
    const coffeeCupsEl = document.getElementById('coffeeCups');
    if (coffeeCupsEl) {
        coffeeCupsEl.addEventListener('click', function() {
      const heart = document.getElementById('heartAnimation');
      const counter = document.getElementById('coffeeLikeCount');
      
      coffeeClicks++;
      
      // Update counter text with the heart SVG
      const heartIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="#a18570" stroke="white" stroke-width="1.5" style="vertical-align: -2px; margin-left: 4px;"><path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
      if (coffeeClicks >= 1000000) {
          counter.innerHTML = "Win Win!" + heartIcon;
      } else {
          counter.innerHTML = coffeeClicks.toLocaleString() + heartIcon;
      }
      
      // Heart Animation
      heart.style.transition = 'none';
      heart.style.transform = 'translate(-50%, -50%) scale(0)';
      heart.style.opacity = '1';
      
      // Counter Animation
      counter.style.transition = 'none';
      counter.style.transform = 'translateY(5px) scale(0.9)';
      counter.style.opacity = '1';
      
      requestAnimationFrame(() => {
        // Pop the heart (using custom bezier for a bounce effect)
        heart.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s ease';
        heart.style.transform = 'translate(-50%, -50%) scale(1.6)'; // Bigger heart
        heart.style.opacity = '0';
        
        // Pop the counter
        counter.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        counter.style.transform = 'translateY(0) scale(1)';
        
        // Fade out slightly after a delay, or keep it visible
        setTimeout(() => {
            counter.style.transition = 'all 0.8s ease';
            if(coffeeClicks < 1000000) {
              counter.style.opacity = '0.7'; // Keeps it slightly visible when idle
            }
        }, 500);
        });
      });
    }

    function getEndTime(startTime) {
        try {
            const [time, modifier] = startTime.split(' ');
            let [hours, minutes] = time.split(':');
            
             const d = new Date();
             let h = parseInt(hours);
             if (modifier === 'PM' && h !== 12) h += 12;
             if (modifier === 'AM' && h === 12) h = 0;
             
             d.setHours(h);
             d.setMinutes(parseInt(minutes));
             // Add 50 minutes instead of 1 hour
             d.setMinutes(d.getMinutes() + 50);
             
             return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
        } catch(e) {
            return "50 min later";
        }
    }

    window.addEventListener('load', () => {
        // Run UI adjustments and permission requests immediately so they don't cause late layout shifts
        adjustDynamicText();
        
        // Send the initial Page Load event asynchronously to guarantee correct row color
        logEvent("Page Load", window.location.href);
    });

    function scrollToCalendar() {
        const cal = document.getElementById('bookingCalendar');
        if (cal) cal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            const nearestEl = document.querySelector('.cal-day--nearest');
            if (nearestEl) nearestEl.click();
        }, 600);
    }

    // Lightweight particle burst: throttled and adaptive for low-end devices.
    const sparkBurstState = new WeakMap();
    function createSparks(container) {
        if (!container) return;
        if (document.hidden) return;
        const prefersReducedMotion = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);

        const isLowEndDevice = (
            (typeof navigator.hardwareConcurrency === 'number' && navigator.hardwareConcurrency > 0 && navigator.hardwareConcurrency <= 4) ||
            (typeof navigator.deviceMemory === 'number' && navigator.deviceMemory > 0 && navigator.deviceMemory <= 4)
        );

        const now = performance.now();
        const lastBurstAt = sparkBurstState.get(container) || 0;
        const minIntervalMs = prefersReducedMotion ? 900 : (isLowEndDevice ? 700 : 260);
        if (now - lastBurstAt < minIntervalMs) return;
        sparkBurstState.set(container, now);

        if (!container.style.position) {
            container.style.position = 'relative';
        }

        const burstCount = prefersReducedMotion ? 3 : (isLowEndDevice ? 6 : 10);
        const minRadius = isLowEndDevice ? 20 : 28;
        const maxRadius = isLowEndDevice ? 38 : 56;
        const minVelocity = isLowEndDevice ? 34 : 54;
        const maxVelocity = isLowEndDevice ? 72 : 118;
        const maxDelay = prefersReducedMotion ? 50 : (isLowEndDevice ? 70 : 110);
        const durationMs = prefersReducedMotion ? 240 : (isLowEndDevice ? 280 : 360);

        const fragment = document.createDocumentFragment();
        const sparks = [];

        for (let i = 0; i < burstCount; i++) {
            const spark = document.createElement('div');
            spark.className = 'spark';

            const angle = Math.random() * Math.PI * 2;
            const radius = minRadius + Math.random() * (maxRadius - minRadius);
            const startX = Math.cos(angle) * radius;
            const startY = Math.sin(angle) * radius;
            spark.style.left = `calc(50% + ${startX.toFixed(1)}px)`;
            spark.style.top = `calc(50% + ${startY.toFixed(1)}px)`;
            spark.style.transform = 'translate(-50%, -50%)';

            const velocity = minVelocity + Math.random() * (maxVelocity - minVelocity);
            const vx = Math.cos(angle) * velocity;
            const vy = Math.sin(angle) * velocity;
            spark.style.setProperty('--vx', `${vx.toFixed(1)}px`);
            spark.style.setProperty('--vy', `${vy.toFixed(1)}px`);
            spark.style.setProperty('--spark-delay', `${Math.floor(Math.random() * maxDelay)}ms`);
            spark.style.setProperty('--spark-duration', `${durationMs}ms`);

            fragment.appendChild(spark);
            sparks.push(spark);
        }

        container.appendChild(fragment);

        setTimeout(() => {
            for (let i = 0; i < sparks.length; i++) {
                if (sparks[i] && sparks[i].parentNode) {
                    sparks[i].parentNode.removeChild(sparks[i]);
                }
            }
        }, durationMs + maxDelay + 80);
    }

    function normalizeSlotNotFoundText() {
        const nodes = document.querySelectorAll('.book-btn-preloader__text');
        nodes.forEach(node => {
            const raw = String(node.textContent || '').trim();
            if (!raw) return;
            if (/slot\s*no\s*found/i.test(raw) || /slots\s*no\s*found/i.test(raw) || /slot\s*not\s*fount/i.test(raw)) {
                node.textContent = 'SLOT NO FOUND';
            }
        });
    }
    
    function updateFooterBookBtn() {
        normalizeSlotNotFoundText();
        const targets = [
            { btn: document.getElementById('footerBookBtn'), txt: document.getElementById('footerBookBtnText'), preloader: document.getElementById('footerBookBtnPreloader') },
            { btn: document.getElementById('headerBookBtn'), txt: document.getElementById('headerBookBtnText'), preloader: document.getElementById('headerBookBtnPreloader') }
        ];

        targets.forEach(t => {
            if (!t.btn || !t.preloader) return;

            if (absoluteNearestDate && nearestSlotData) {
                const dayOfWeekShort = absoluteNearestDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dayOfWeekFull = absoluteNearestDate.toLocaleDateString('en-US', { weekday: 'long' });
                
                let htmlContent = '';
                
                if (t.btn.id === 'headerBookBtn') {
                    // Header button: Original format (Line 1: Slot!, Line 2: Day, Time)
                    let timeStr = '';
                    if (nearestSlotData && nearestSlotData.text) {
                        timeStr = nearestSlotData.text.split(/[-–]/)[0].trim();
                    }
                    const slotWord = nearestSlotData ? 'Slot' : 'Slots';
                    htmlContent = timeStr 
                        ? `<span class="header-book-line1">Available ${slotWord}!</span><br><span style="font-size: 1rem; font-weight: 800; opacity: 0.95;">${dayOfWeekShort} ${nearestSlotData.date} at ${timeStr}</span>` 
                        : `<span class="header-book-line1">Available ${slotWord}!</span><br><span style="font-size: 0.9rem; font-weight: 800; opacity: 0.9;">${dayOfWeekShort} ${nearestSlotData.date}</span>`;
                } else {
                    // Footer button: 3-line format
                    let lastTimeStr = '';
                    const fallbackSlot = nearestDayLastSlotData || nearestSlotData;
                    if (fallbackSlot && fallbackSlot.text) {
                        lastTimeStr = fallbackSlot.text.split(/[-–]/)[0].trim();
                    }
                    
                    htmlContent = `Available Slot!<br>` +
                                 `<span style="font-size: 2.2rem; font-weight: 800; display: block; margin: 5px 0; line-height: 1;">${lastTimeStr}</span>` +
                                 `<span style="font-size: 0.9rem; font-weight: 800; opacity: 0.9;">${dayOfWeekFull} ${fallbackSlot.date}</span>`;
                }
                
                t.preloader.style.transition = 'opacity 0.5s';
                t.preloader.style.opacity = '0';
                t.preloader.style.transform = 'scale(0.9)';
                t.preloader.style.pointerEvents = 'none';

                t.txt.innerHTML = htmlContent;
                t.btn.style.transition = 'opacity 0.5s, transform 0.5s';
                t.btn.style.opacity = '1';
                t.btn.style.transform = 'scale(1)';
                t.btn.style.pointerEvents = 'auto';

                // Удалено: createSparks вызывается только во время прыжка
            } else {
                // No data yet: keep neutral loading state
                t.preloader.style.opacity = '1';
                t.preloader.style.transform = 'scale(1)';
                t.preloader.style.pointerEvents = 'none';
                t.btn.style.opacity = '0';
                t.btn.style.pointerEvents = 'none';

                // Cancel any previously scheduled error timer for this target
                if (t._errorTimer) {
                    clearTimeout(t._errorTimer);
                    t._errorTimer = null;
                    // Reset error state if re-trying
                    t.preloader.classList.remove('book-btn-preloader--error');
                    const svg = t.preloader.querySelector('.book-btn-preloader__svg');
                    if (svg) svg.style.animation = '';
                    const errText = t.preloader.querySelector('.book-btn-preloader__text');
                    if (errText) { errText.textContent = 'Loading...'; errText.style.display = 'none'; }
                }

                t.preloader.classList.remove('book-btn-preloader--error');
                const svg = t.preloader.querySelector('.book-btn-preloader__svg');
                if (svg) svg.style.animation = '';
                const errText = t.preloader.querySelector('.book-btn-preloader__text');
                if (errText) {
                    errText.textContent = 'Loading...';
                    errText.style.display = 'none';
                    errText.style.opacity = '0';
                }

                t._errorTimer = setTimeout(() => {
                    t.preloader.classList.add('book-btn-preloader--error');
                    const errSvg = t.preloader.querySelector('.book-btn-preloader__svg');
                    if (errSvg) errSvg.style.animation = 'none';
                    const errNode = t.preloader.querySelector('.book-btn-preloader__text');
                    if (errNode) {
                        errNode.textContent = 'SLOT NO FOUND';
                        errNode.style.display = 'block';
                        errNode.style.opacity = '1';
                    }
                }, 20000);
            }
        });
        normalizeSlotNotFoundText();
    }

    function bookNearestSlot() {
        if (absoluteNearestDate && nearestSlotData) {
            selectedDate = absoluteNearestDate;
            openBookingModal(nearestSlotData);
        } else {
            scrollToCalendar();
        }
    }

    function bookNearestSlotLast(triggerAttach = false) {
        if (absoluteNearestDate && nearestDayLastSlotData) {
            selectedDate = absoluteNearestDate;
            openBookingModal(nearestDayLastSlotData, triggerAttach);
        } else {
            scrollToCalendar();
        }
    }



    // Periodic Progress Bar Scan
    setInterval(() => {
        const separator = document.getElementById('loadingSeparator');
        if (separator && !separator.classList.contains('loading-separator--active')) {
            separator.classList.add('loading-separator--active');
            setTimeout(() => {
                separator.classList.remove('loading-separator--active');
            }, 3000); // Pulse for 3 seconds
        }
    }, 18000); // Every ~18 seconds

    // Custom Select Initialization
    function initializeCustomSelects() {
        const selectElement = document.getElementById('customSelect');
        if (!selectElement) return;
        
        const trigger = selectElement.querySelector('.custom-select__trigger');
        const options = selectElement.querySelectorAll('.custom-option');
        const hiddenInput = document.getElementById('serviceInput');
        const wrapper = selectElement.closest('.custom-select-wrapper');
        trigger.addEventListener('click', (e) => {
            e.preventDefault();
            trigger.classList.remove('field-invalid');
            selectElement.classList.toggle('open');
        });
        options.forEach(option => {
            option.addEventListener('click', () => {
                const value = option.getAttribute('data-value') || option.textContent;
                const text = option.textContent.trim();
                
                // Update trigger text
                trigger.querySelector('span').textContent = text;
                
                if (hiddenInput) hiddenInput.value = text;
                
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                
                selectElement.classList.remove('open');
                trigger.classList.remove('field-invalid');
            });
        });
        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) {
                selectElement.classList.remove('open');
            }
        });
    }

    function adjustDynamicText() {
        const elements = document.querySelectorAll('.dynamic-text');
        elements.forEach(el => {
            el.style.fontSize = ''; // Reset to CSS value
            
            if (el.scrollWidth > el.clientWidth) {
                const style = window.getComputedStyle(el);
                const currentSize = parseFloat(style.fontSize);
                const rootSize = parseFloat(window.getComputedStyle(document.documentElement).fontSize);
                const ratio = el.clientWidth / el.scrollWidth;
                const newRemSize = (currentSize * ratio * 0.95) / rootSize;
                el.style.fontSize = newRemSize + 'rem';
            }
        });

        // Keep hero H1 in 4 stable lines on mobile: no wrapping, shrink if needed.
        const heroH1 = document.querySelector('.header__description');
        if (!heroH1) return;
        const lines = Array.from(heroH1.querySelectorAll('span'));
        if (!lines.length) return;

        heroH1.style.setProperty('--h1-fit-scale', '1');
        const availableWidth = heroH1.clientWidth;
        if (!availableWidth) return;

        let maxLineWidth = 0;
        lines.forEach(line => {
            maxLineWidth = Math.max(maxLineWidth, line.scrollWidth);
        });
        if (!maxLineWidth) return;

        const ratio = availableWidth / maxLineWidth;
        const scale = Math.max(0.52, Math.min(1, ratio));
        heroH1.style.setProperty('--h1-fit-scale', scale.toFixed(4));
    }

    // (Load listener consolidated above)

    window.addEventListener('resize', adjustDynamicText);

    // ------------------------------------------------------------------
    // PERSISTENT TOP/BOTTOM BARS
    // ------------------------------------------------------------------
    (function keepBarsAlwaysVisible() {
        const topBar = document.querySelector('.top-bar');
        const bottomBar = document.querySelector('.bottom-bar');
        if (topBar) topBar.classList.add('top-bar--visible');
        if (bottomBar) bottomBar.classList.add('bottom-bar--visible');
    })();

    // Scroll Fade-in Observer
    // Scroll Fade-in Observer
    var revealObserver;

    function triggerReveal() {
        var revealElements = document.querySelectorAll('.fade-in-section, .blur-in-section, .fade-in-delayed');
        if (!revealElements.length) return;

        if (!revealObserver && window.IntersectionObserver) {
            revealObserver = new IntersectionObserver(function(entries, observerInstance) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove('is-hidden');
                        entry.target.classList.add('is-visible');
                        observerInstance.unobserve(entry.target);
                    }
                });
            }, {
                root: null,
                rootMargin: '0px 0px 200px 0px',
                threshold: 0
            });
        }

        revealElements.forEach(function(el) {
            // Initial state: hide if not in view
            var rect = el.getBoundingClientRect();
            if (rect.top > window.innerHeight) {
                el.classList.add('is-hidden');
            } else {
                el.classList.add('is-visible');
            }

            if (revealObserver) {
                revealObserver.observe(el);
            }
        });
    }

    // Run trigger
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', triggerReveal);
    } else {
        triggerReveal();
    }
    window.addEventListener('load', triggerReveal);


    // Location static logging
    function openDirectionsTarget(directionsLink) {
        const targetUrl = directionsLink && directionsLink.href ? directionsLink.href : "https://www.google.com/maps/dir//146+Thirtieth+St,+Suite+29,+Toronto,+ON+M8W+3C4";
        if (directionsLink && directionsLink.target === "_blank") {
            const newTab = window.open(targetUrl, "_blank", "noopener,noreferrer");
            if (!newTab) {
                window.location.href = targetUrl;
            }
            return;
        }
        window.location.href = targetUrl;
    }

    function logDirectionsClick(event) {
        const directionsLink = (event && event.currentTarget) ? event.currentTarget : document.getElementById("directionsBtn");

        if (!navigator.geolocation) {
            logEvent("Directions Clicked", "Geolocation is not supported by this browser.", false, "", {
                locationMapUrl: "",
                locationCoords: ""
            });
            openDirectionsTarget(directionsLink);
            return false;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = Number(position.coords.latitude).toFixed(6);
                const lng = Number(position.coords.longitude).toFixed(6);
                const locationMapUrl = `https://www.google.com/maps?q=${encodeURIComponent(lat + ',' + lng)}`;
                logEvent("Directions Clicked", `User location captured: ${lat}, ${lng}`, false, "", {
                    locationMapUrl: locationMapUrl,
                    locationCoords: `${lat},${lng}`
                });
                openDirectionsTarget(directionsLink);
            },
            (geoError) => {
                const errorMessage = geoError && geoError.message ? geoError.message : 'Unknown geolocation error';
                logEvent("Directions Clicked", `Geolocation denied/failed: ${errorMessage}`, false, "", {
                    locationMapUrl: "",
                    locationCoords: ""
                });
                openDirectionsTarget(directionsLink);
            },
            {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 60000
            }
        );

        return false;
    }
</script>

<!-- Global Spinner for Finalizing -->
<div id="globalSpinner" class="global-spinner">
    <div class="global-spinner__ring-wrap" aria-label="Loading">
        <svg viewBox="0 0 120 120" class="global-spinner__svg" role="presentation">
            <circle class="global-spinner__track" cx="60" cy="60" r="48"></circle>
            <circle class="global-spinner__glow" cx="60" cy="60" r="48"></circle>
        </svg>
    </div>
</div>

</body>
</html>

